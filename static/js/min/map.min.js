var sb=sb||{};sb.map=function(f,e,n){var g=org.polymaps;var o=d3.dispatch("boundsUpdated"),i=0.5;var d="http://tile.stamen.com/toner/{Z}/{X}/{Y}.png";var b=d3.select(f).append("div")[0][0];d3.select(f).append("div").attr("class","render");var h=g.image().url(g.url(d).hosts(["a","b","c","d"]));o.dispatch=d3.dispatch("show");var l=[{name:"San Francisco",lat:37.775,lon:-122.43,zoom:13},{name:"New York City",lat:40.718,lon:-73.997,zoom:14},{name:"London",lat:51.506325,lon:-0.127144,zoom:13},{name:"Paris",lat:48.85693,lon:2.3412,zoom:14},{name:"Moscow",lat:55.75,lon:37.614975,zoom:14},{name:"Montreal",lat:45.512303,lon:-73.554431,zoom:13},{name:"Tokyo",lat:35.7,lon:139.774414,zoom:14}];var m=b.appendChild(g.svg("svg"));var k=Math.floor(Math.random()*l.length);o.map=g.map().container(m).zoom(l[k].zoom).center({lat:l[k].lat,lon:l[k].lon});o.map.size({x:$(f).width(),y:$(f).height()});var a=$("body").hasClass("print");if(a){o.map.zoom(1.9).center({lat:40,lon:-35})}else{o.map.add(h)}var j=$("body").hasClass("postcard");d3.select(m).attr("width",e).attr("height",j?"100%":"600px").select("rect").attr("visibility","visible").attr("fill",a?"#e7e7e7":"white");o.frame=function(){return b};o.show=function(){if(!h.map()){o.map.add(h)}};o.hide=function(){if(h.map()){o.map.remove(h)}};o.buffer=function(c){i=c;return o};o.centerOn=function(q,p){var c=o.l2p(q);c.x-=p||0;q=o.p2l(c);o.map.center(q)};o.updateBounds=function(v,u,q,p){if(v.length==0||u.length==0){return}if(v.length==1&&u.length==1){o.centerOn({lat:v[0],lon:u[0]},p);o.boundsUpdated();return}var r=[{lat:d3.min(v),lon:d3.min(u)},{lat:d3.max(v),lon:d3.max(u)}];o.map.extent(r);if(p){var c=$(f).width()-p;var t=o.l2p(r[1]).x-o.l2p(r[0]).x;if(t>c){o.map.zoom(o.map.zoom()-0.5)}o.centerOn(o.map.center(),p)}offset=q||0;var s=Math.floor(o.map.zoom())+offset;if(s!=o.map.zoom()){o.map.zoom(s)}o.boundsUpdated()};o.getBounds=function(){var p=o.map.extent();var c=o.map.locationPoint(p[0]);var q=o.map.locationPoint(p[1]);return{t:q.y,b:c.y,l:c.x,r:q.x}};o.getExtent=function(){return o.map.extent()};o.getMapRadius=function(){var c=o.map.extent();return{lat:Math.abs(c[0].lat-c[1].lat)/3,lon:Math.abs(c[0].lon-c[1].lon)/3}};o.l2p=function(c){return o.map.locationPoint(c)};o.p2l=function(c){return o.map.pointLocation(c)};return o};