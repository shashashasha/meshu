var sb=sb||{};sb.map=function(f,e,m){var g=org.polymaps;var n=d3.dispatch("boundsUpdated"),i=0.5;var d="http://tile.stamen.com/toner/{Z}/{X}/{Y}.png";var b=d3.select(f).append("div")[0][0];d3.select(f).append("div").attr("class","render");var h=g.image().url(g.url(d).hosts(["a","b","c","d"]));n.dispatch=d3.dispatch("show");var k=[{name:"San Francisco",lat:37.775,lon:-122.43,zoom:13},{name:"New York City",lat:40.718,lon:-73.997,zoom:14},{name:"London",lat:51.506325,lon:-0.127144,zoom:13},{name:"Paris",lat:48.85693,lon:2.3412,zoom:14},{name:"Moscow",lat:55.75,lon:37.614975,zoom:14},{name:"Montreal",lat:45.512303,lon:-73.554431,zoom:13},{name:"Tokyo",lat:35.7,lon:139.774414,zoom:14}];var l=b.appendChild(g.svg("svg"));var j=Math.floor(Math.random()*k.length);n.map=g.map().container(l).zoom(k[j].zoom).center({lat:k[j].lat,lon:k[j].lon});n.map.size({x:$(f).width(),y:$(f).height()});var a=$("body").hasClass("print");if(a){n.map.add(g.geoJson().url("/static/lib/world.json"));n.map.zoom(2).center({lat:35,lon:5})}else{n.map.add(h)}d3.select(l).attr("width","100%").attr("height","100%").select("rect").attr("visibility","visible").attr("fill","white");n.frame=function(){return b};n.show=function(){if(!h.map()){n.map.add(h)}};n.hide=function(){if(h.map()){n.map.remove(h)}};n.buffer=function(c){i=c;return n};n.centerOn=function(p,o){var c=n.l2p(p);c.x-=o||0;p=n.p2l(c);n.map.center(p)};n.updateBounds=function(u,t,p,o){console.log("updatebounds",u,t,p,o);if(u.length==0||t.length==0){return}if(u.length==1&&t.length==1){n.centerOn({lat:u[0],lon:t[0]},o);n.boundsUpdated();return}var q=[{lat:d3.min(u),lon:d3.min(t)},{lat:d3.max(u),lon:d3.max(t)}];n.map.extent(q);if(o){var c=$(f).width()-o;var s=n.l2p(q[1]).x-n.l2p(q[0]).x;if(s>c){n.map.zoom(n.map.zoom()-0.5)}n.centerOn(n.map.center(),o)}offset=p||0;var r=Math.floor(n.map.zoom())+offset;if(r!=n.map.zoom()){n.map.zoom(r)}n.boundsUpdated()};n.resizeContainer=function(o,r){var w=[{lat:d3.min(o),lon:d3.min(r)},{lat:d3.max(o),lon:d3.max(r)}];n.map.zoom(10).center({lat:0,lon:0});var p=n.map.locationPoint(w[0]);var s=n.map.locationPoint(w[1]);var c=Math.abs(s.x-p.x);var v=Math.abs(s.y-p.y);var t=430;var q=c>v?t/c:t/v;c*=q;v*=q;b.style.width=(c)+"px";b.style.height=(v)+"px";n.map.extent(w);var u=n.l2p(w[0]).y-n.l2p(n.map.extent()[0]).y;if(u){b.style.top=(150-u)+"px"}};n.getBounds=function(){var o=n.map.extent();var c=n.map.locationPoint(o[0]);var p=n.map.locationPoint(o[1]);return{t:p.y,b:c.y,l:c.x,r:p.x}};n.getMapRadius=function(){var c=n.map.extent();return{lat:Math.abs(c[0].lat-c[1].lat)/3,lon:Math.abs(c[0].lon-c[1].lon)/3}};n.l2p=function(c){return n.map.locationPoint(c)};n.p2l=function(c){return n.map.pointLocation(c)};return n};