var sb=sb||{};sb.ui=sb.ui||{};sb.ui.orderer=function(){var d=d3.dispatch("updated"),e=null,b=null,f={};d.on("updated",function(){c();a()});d.initialize=function(i,j){e=i,b=j;$("#postcard-note-form").keyup(function(l){var k=l.target.value;$("#postcard-note").val(k)});$("#save-and-view").click(function(){var k=function(){saver.createOrUpdateMeshu(function(l){window.location.href=l.meshu_url})};if(!user.loggedIn){h();user.afterLogIn=k}else{k()}});$("#add-to-cart").click(function(){d.updated();$("#order-form")[0].submit()})};function g(){if(!user.loggedIn){h(g);return}d.updated();d.validated();return false}function h(i){user.showModal();user.afterLogIn=function(){if(i){saver.createOrUpdateMeshu(function(){setTimeout(i,200)})}}}function c(){var l=sb.materializer.product(),j=sb.materializer.material(),i=sb.materializer.color(),k=b.getPrice(l,j)*100;$("#object-type").val(l);$("#object-material").val(j);$("#object-color").val(i?i.toLowerCase():"");$("#object-amount").val(k);$("#svg-theta").val(sb.rotator?sb.rotator.getRotation():0);$("#svg-file").val(e.outputSVG());$("#meshu-data").val(e.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:e.outputTitle());$("#meshu-renderer").val(e.mesh().name);$("#meshu-metadata").val(e.mesh().outputStyle());$("#postcard-note").val($("#postcard-note-form").val());$("#order-metadata").val(d.outputMetadata())}function a(){var p=sb.materializer.product(),n=sb.materializer.material(),k=sb.materializer.color(),m=b.getPrice(p,n),o=e.mesh().name,q=$("#review");var r=sb.rotator?sb.rotator.getRotation()-sb.rotator.getBaseRotation():0;if(o!="print"&&p&&p.split("_")[1]=="poster"){r=sb.transforms.getOrientation(p,"product").rotation}var i="translate(75, 75) scale(.25) rotate("+r+")";var j=$("#product-preview .selected .product-transformer").clone().attr("class","review-delaunay").attr("transform",i);q.find(".review-svg").empty().append(j);if(p){if(p=="ring"){var s=sb.ui.orderer.metadata().ringSize?sb.ui.orderer.metadata().ringSize:"<span class='inactive'>not chosen</span>";q.find(".review-product").removeClass("inactive").html(p+" â€” size "+s)}else{var l=p.replace("_"," ");if(l.indexOf("Dense")!=-1){l=l.split(" ")[1]}q.find(".review-product").removeClass("inactive").text(l)}}if(k&&n){q.find(".review-material").removeClass("inactive").text(sb.materializer.color()+" "+n)}else{q.find(".review-material").addClass("inactive").text("not chosen")}if((p&&k&&n)||(o=="print"&&p)){q.find(".review-price").html("<span class='dollar'>$</span>"+m+".00");q.find(".review-make-time").text(b.getMakeTime(n));if(o=="facet"&&j.children().length||o=="radial"&&$(".meshu-svg .radial").children().length||o=="print"||o=="orbit"||o=="streets"){if(p=="ring"&&!sb.ui.orderer.metadata().ringSize){return}q.find("#add-to-cart").removeClass("inactive")}}else{q.find(".review-price").text("");q.find(".review-make-time").text("");q.find("#add-to-cart").addClass("inactive")}}d.metadata=function(k){if(!arguments.length){return f}for(var j in k){f[j]=k[j]}};d.clearMetadata=function(i){if(f[i]){delete f[i]}};d.outputMetadata=function(){var k=[];for(var j in f){k.push(j+":"+f[j])}return k.join("|")};return d}();