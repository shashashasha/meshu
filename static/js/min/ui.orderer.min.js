var sb=sb||{};sb.ui=sb.ui||{};sb.ui.orderer=function(c){var b=d3.dispatch("validated","updated");b.on("updated",function(){a();e()});$("#shipping-destination li").click(function(){var h=$(this).attr("id").split("-").pop();var g=$("#shipping-destination");$("#checkout").attr("class",h);g.find("li").removeClass("active");$(this).addClass("active");orderer.shippingMode(h)});$("#postcard-note-form").keyup(function(h){var g=h.target.value;$("#postcard-note").val(g)});$("#coupon-code").submit(function(){var g=$("#coupon-code-value").val();orderer.applyCoupon(g,function(j){if(j.success){var k=parseFloat(j.amount);if(k<1&&k>0){var h=Math.floor(orderer.getPrice()*(1-k));var i=parseInt((1-k)*100);$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>"+i+"% off! -$"+h+".00</span>").insertAfter("#subtotal-price")}else{if(k>1){$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>-$"+k+".00</span>").insertAfter("#subtotal-price")}}$("#coupon-message").fadeIn("fast").html(g+" discount applied!");$(".coupon-form").hide()}else{$("#coupon-message").fadeIn("fast").html("Invalid code.")}b.updated()});return false});$("#payment-form").validate({rules:{card_number:{creditcard:true},card_cvc:{digits:true,minlength:3},card_month:{digits:true,minlength:2},card_year:{digits:true,minlength:4,}},messages:{shipping_state:"Please enter the two-letter state abbreviation.",card_cvc:"Sorry, that is not a valid CVC code",card_month:{minlength:"Please enter the month as a two-digit number."},card_year:{minlength:"Please enter the year as a four-digit number.",},},submitHandler:d});$("#save-and-view").click(function(){var g=function(){saver.createOrUpdateMeshu(function(h){window.location.href=h.meshu_url})};if(!user.loggedIn){f();user.afterLogIn=g}else{g()}});$("#review-button").click(function(){if(!user.loggedIn){f()}});$("#submit-button").click(function(g){if(!user.loggedIn){f();return false}orderer.submit()});function d(){if(!user.loggedIn){f(d);return}b.updated();b.validated();return false}function f(g){user.showModal();user.afterLogIn=function(){if(g){saver.createOrUpdateMeshu(function(){setTimeout(g,200)})}}}function a(){orderer.updateProduct(sb.materializer.product(),sb.materializer.material(),orderer.getShipping());$("#object-type").val(sb.materializer.productName());$("#object-material").val(sb.materializer.material());$("#object-color").val(sb.materializer.color().toLowerCase());$("#object-amount").val(orderer.getTotalCents());$("#svg-theta").val(sb.rotator?sb.rotator.rotation():0);$("#svg-file").val(c.outputSVG());$("#meshu-data").val(c.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:c.outputTitle());$("#meshu-renderer").val(c.mesh().name);$("#meshu-metadata").val(c.mesh().outputStyle());$("#postcard-note").val($("#postcard-note-form").val())}function e(){var h="One "+sb.materializer.displayName();var i=sb.materializer.color().toLowerCase()+" "+sb.materializer.material();$("#review-description").text(h+", made out of "+i);$("#subtotal-price span").text(orderer.getPriceString());$("#shipping-price span").text("$"+orderer.getShipping()+".00");$("#total-price span").text(orderer.getTotalString());$("#review-shipping").empty();$(".ship-row input").each(function(){var k;var j=function(l){return l.replace(/\w\S*/g,function(m){return m.charAt(0).toUpperCase()+m.substr(1).toLowerCase()})};this.value=j(this.value);switch(this.id){case"ship-city":case"ship-zip":k=$("<span>");break;case"ship-state":this.value=this.value.toUpperCase();k=$("<span>");break;default:k=$("<p>");break}k.text($(this).val()).appendTo("#review-shipping")});var g=$("#card-number").val();$("#review-payment").text("XXXX-XXXX-XXXX-"+g.substring(12,16))}return b};