var sb=sb||{};sb.ui=sb.ui||{};sb.ui.orderer=function(c){var b=d3.dispatch("validated","updated");b.on("updated",function(){a();f()});$("#shipping-destination li").click(function(){var i=$(this).attr("id").split("-").pop();var h=$("#shipping-destination");$("#shipping-form").attr("class",i);h.find("li").removeClass("active");$(this).addClass("active");orderer.shippingMode(i)});$("#postcard-note-form").keyup(function(i){var h=i.target.value;$("#postcard-note").val(h)});$("#coupon-code").submit(function(){var h=$("#coupon-code-value").val();orderer.applyCoupon(h,function(k){if(k.success){var l=parseFloat(k.amount);if(l<1&&l>0){var i=Math.round(orderer.getPrice()*(1-l));var j=Math.round((1-l)*100);$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>"+j+"% off! -$"+i+".00</span>").insertAfter("#subtotal-price")}else{if(l>1){$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>-$"+l+".00</span>").insertAfter("#subtotal-price")}}$("#coupon-message").fadeIn("fast").html(h+" discount applied!");$(".coupon-form").hide();$("#coupon").val(h)}else{$("#coupon-message").fadeIn("fast").html("Invalid code.")}b.updated()});return false});var e=$("#payment-form").validate({rules:{card_number:{creditcard:true},card_cvc:{digits:true,minlength:3},card_month:{digits:true,minlength:2},card_year:{digits:true,minlength:4,}},messages:{shipping_state:"Please enter the two-letter state abbreviation.",card_cvc:"Sorry, that is not a valid CVC code",card_month:{minlength:"Please enter the month as a two-digit number."},card_year:{minlength:"Please enter the year as a four-digit number.",},},submitHandler:d});$("#save-and-view").click(function(){var h=function(){saver.createOrUpdateMeshu(function(i){window.location.href=i.meshu_url})};if(!user.loggedIn){g();user.afterLogIn=h}else{h()}});$("#review-button").click(function(){if(!user.loggedIn){g()}var h=e.valid();if(h){b.updated();b.validated()}});$("#submit-button").click(function(h){if(!user.loggedIn){g();return false}orderer.submit()});function d(){if(!user.loggedIn){g(d);return}b.updated();b.validated();return false}function g(h){user.showModal();user.afterLogIn=function(){if(h){saver.createOrUpdateMeshu(function(){setTimeout(h,200)})}}}function a(){var i=sb.materializer.product(),h=sb.materializer.material();orderer.updateProduct(i,h,orderer.getShipping());$("#object-type").val(i);$("#object-material").val(h);$("#object-color").val(sb.materializer.color().toLowerCase());$("#object-amount").val(orderer.getTotalCents());$("#svg-theta").val(sb.rotator?sb.rotator.rotation():0);$("#svg-file").val(c.outputSVG());$("#meshu-data").val(c.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:c.outputTitle());$("#meshu-renderer").val(c.mesh().name);$("#meshu-metadata").val(c.mesh().outputStyle());$("#postcard-note").val($("#postcard-note-form").val())}function f(){var i="One "+sb.materializer.displayName();var j=sb.materializer.color().toLowerCase()+" "+sb.materializer.material();$("#review-description").text(i+", made out of "+j);$("#subtotal-price span").text(orderer.getPriceString());$("#shipping-price span").text("$"+orderer.getShipping()+".00");$("#total-price span").text(orderer.getTotalString());$("#review-shipping").empty();$(".ship-row input").each(function(){if(this.value.length==0){return}var k=function(m){return m.replace(/\w\S*/g,function(n){return n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()})};this.value=k(this.value);var l;switch(this.id){case"ship-city":case"ship-zip":l=$("<span>");break;case"ship-state":this.value=this.value.toUpperCase();l=$("<span>");break;default:l=$("<p>");break}l.text($(this).val()).appendTo("#review-shipping")});var h=$("#card-number").val();$("#review-payment").text("XXXX-XXXX-XXXX-"+h.substring(12,16))}return b};