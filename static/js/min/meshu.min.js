var sb=sb||{};var app_key="dj0yJmk9M1hsekZBSDY1ZjRxJmQ9WVdrOU5uUjZiRzE0TXpRbWNHbzlNVEV5TURZMU1qRTJNZy0tJnM9Y29uc3VtZXJzZWNyZXQmeD00OQ--";sb.meshu=function(h,n,g){var i={},k=$(h).width()+"px",j=$(h).height()+"px",q=g||sb.map(h,k,j),n=n||"facet",b=sb.mesh[n](h,q,k,j),d=$("#cases");$(h).append("<div class='mapui'><div id='zoomin'></div><div id='zoomout'></div></div>");$("#zoomin").mousedown(function(s){q.map.zoom(q.map.zoom()+1);b.refresh()});$("#zoomout").mousedown(function(s){q.map.zoom(q.map.zoom()-1);b.refresh()});var a=$("#searchbox");a.focus(function(){d.fadeOut()});a.keypress(function(s){if(s.which==13){p()}});$("#search-button").click(function(){p()});i.checkAdded=function(){var t=b.points();var s=3;if($("body").hasClass("radial")){s=1}if(t.length>=s){$("#finish-button").addClass("active")}else{$("#finish-button").removeClass("active")}};function p(){var s=a.val();if(s=="add a city, place, or address"){return}var u=s.replace("&","and").replace(/[^\w ]/ig,"").replace(" ","+");var t=$("body").hasClass("ie")?"/proxy/geocoder/?location="+u:"http://where.yahooapis.com/geocode?location="+u+"&flags=J&appid="+app_key;a.val("");$.ajax({url:t,cache:false,dataType:"json",error:function(v,x,w){console.log(w)},success:function(y){var w=y.ResultSet.Results||[y.ResultSet.Result];var x=$("#content");d.empty().hide();if(typeof w=="undefined"){a.blur();d.append($("<p>").text("Hrm, we weren't able to find your search. Try again?")).fadeIn()}else{if(w.length>0){l(w[0],s);if(b.points().length==1){var v=w[0].radius;if(v>1000000){q.map.zoom(3)}else{if(v>100000){q.map.zoom(4)}else{if(v>10000){q.map.zoom(13)}else{if(v>400){q.map.zoom(14)}}}}}}}}})}function l(s,t){b.add(s.latitude,s.longitude,t);i.updateBounds()}i.locations=function(s,u){for(var t=0;t<s.length;t++){if(u){l(s[t],s[t].name)}else{setTimeout(function(v){return function(){l(v,v.name)}}(s[t]),t*400)}}};function c(x){var s=x.split("|");var w=[],u={};for(var v=0;v<s.length;v++){var t=s[v].split("\t");if(t.length<3){continue}var y=t[0]+"-"+t[1];if(u[y]){continue}else{u[y]=true}w.push({latitude:parseFloat(t[0]),longitude:parseFloat(t[1]),name:t[2]})}return w}i.initializeFromData=function(v,u,t){b.prerender(t);var s=c(v);b.locations(s);if(u){b.applyStyle(u)}return i};i.mesh=function(){return b};i.map=function(){return q};var f=0,e=1,o=0,m=0;var r;i.animateTransform=function(y,x,v,t){if(r){clearInterval(r)}var u=0;var w=d3.select(".delaunay");r=setInterval(function(){if(++u<30){f+=(y-f)*0.33;e+=(x-e)*0.5;o+=(v-o)*0.5;m+=(t-m)*0.5;var s="rotate("+f+", 300, 300)";var A="scale("+e+")";var z="translate("+o+","+m+")";w.attr("transform",A+z+s)}else{clearInterval(r)}},40)};i.refreshWithBounds=function(t,s){q.updateBounds(t,s,i.zoomOffset)};i.updateBounds=function(){i.refreshWithBounds(b.lats(),b.lons())};b.on("added",i.checkAdded);q.on("boundsUpdated",function(){b.updatePixelBounds();b.refresh()});b.on("locationsSet",i.updateBounds);i.getFrame=function(){return h};i.updateTitle=function(s){b.updateTitle(s)};i.outputTitle=function(){return b.outputTitle()};i.outputSVG=function(){return b.output()};i.outputMapSVG=function(){return $(q.map.container()).html()};i.hideMesh=function(){return i};i.showMesh=function(){return i};i.outputLocationData=function(){var s=[];var u=b.places(),v=b.lats(),t=b.lons();$.each(u,function(x){var w=v[x]+"\t"+t[x]+"\t"+u[x];s.push(w)});return s.join("|")};i.xhr=function(){return{xhr:"true",title:i.outputTitle(),svg:i.outputSVG(),location_data:i.outputLocationData(),renderer:b.name,metadata:b.outputStyle(),promo:meshu.promo}};return i};