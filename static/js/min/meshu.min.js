var sb=sb||{};var mapzenapi="search-HWoiFxs";var routingapi="valhalla-Gap3BYU";var mapquestapi="Fmjtd|luub2002n0,bx=o5-9urx5r";sb.meshu=function(n,w,j){var o={},u=$(n).width()+"px",p=$(n).height()+"px",z=j||sb.map(n,u,p),w=w||"facet";mesh=sb.mesh[w](n,z,u,p),searchError=$("#search-error"),loadingGif=$(".loading");o.offsetX=0;$(n).append("<div class='mapui'><div id='zoomin'></div><div id='zoomout'></div></div>");var s=(w=="print")?0.5:1;$("#zoomin").mousedown(function(B){z.map.zoom(z.map.zoom()+s);mesh.refresh("zoomed")});$("#zoomout").mousedown(function(B){z.map.zoom(z.map.zoom()-s);mesh.refresh("zoomed")});var a=$("#searchbox"),k=-1,l;a.keyup(function(C){searchError.fadeOut();var B=a.val();if(C.keyCode==8){l=null}if(!B.length){m()}else{if(C.keyCode==40){k=Math.min(k+1,$(".hit").length-1);d3.selectAll(".hit").classed("selected",function(F,D){if(D==k){var E=F.bbox?F.bbox:null;l=[F.geometry.coordinates,F.properties.label,E,F.properties.country_a]}return D==k});a.val($(".hit:eq("+k+")").text())}else{if(C.keyCode==38){k=Math.max(k-1,0);d3.selectAll(".hit").classed("selected",function(F,D){if(D==k){var E=F.bbox?F.bbox:null;l=[F.geometry.coordinates,F.properties.label,E,F.properties.country_a]}return D==k});a.val($(".hit:eq("+k+")").text())}else{if(C.keyCode==13){if(l){r(l[0],l[1],l[2],l[3]);m()}else{q(B)}}else{e(B)}}}}});$("#search-button").click(function(){var B=a.val();q(B)});function q(C){if(C.split("|").length>2){var B=C.split("|");for(var D=0;D<B.length;D++){setTimeout(function(E){return function(){y(E)}}(B[D]),D*1000)}}else{y(C)}}var d,t=false;function e(B){var C="https://search.mapzen.com/v1/autocomplete?text="+B+"&api_key="+mapzenapi;if(d){d.abort()}if(!t){d=d3.json(C,function(D){c(D.features)});t=true;setTimeout(function(){t=false},50)}}function c(C){if($("#searchbox").val()==""){C=[]}var D=d3.select("#autocomplete"),B=D.selectAll(".hit").data(C);B.enter().append("div").attr("class","hit");B.exit().remove();B.text(function(E){return E.properties.label}).on("click",function(F){var E=F.bbox?F.bbox:null;r(F.geometry.coordinates,F.properties.label,E,F.properties.country_a);m()})}function m(){k=-1;l=null;if(d){d.abort()}a.val("");c([])}o.findCountry=function(C){var B="http://open.mapquestapi.com/geocoding/v1/reverse?key="+mapquestapi+"&location="+C[1]+","+C[0];$.ajax({url:B,cache:false,crossDomain:false,dataType:"json",error:function(D,F,E){console.log(E)},success:function(E){var D=E.results;if(typeof D=="undefined"||D[0].locations.length==0){return}else{if(D.length){var F=D[0].locations[0];mesh.addCountry(F.adminArea1)}}}})};function y(B){if(B=="add a city, place, or address"){return}if(B.split(",").length==2&&Number(B.split(",")[0])&&Number(B.split(",")[1])){mesh.add(B.split(",")[0],B.split(",")[1],B);o.updateBounds();return}var D=B;var C="https://search.mapzen.com/v1/search?text="+D+"&api_key="+mapzenapi;m();$.ajax({url:C,cache:false,crossDomain:false,dataType:"json",beforeSend:function(){loadingGif.show()},error:function(E,G,F){console.log(F)},success:function(F){var E=F.features;loadingGif.hide();if(typeof E=="undefined"||E[0].geometry.length==0){searchError.fadeIn();a.focus();return}else{if(E.length){var G=E[0].bbox?E[0].bbox:null;r(E[0].geometry.coordinates,B,G,E[0].properties.country_a)}}}})}function r(E,B,D,C){switch(mesh.name){case"facet":case"orbit":mesh.add(E[1],E[0],B);o.updateBounds();if(mesh.points().length==1){f(E.geocodeQuality)}break;case"print":mesh.add(E[1],E[0],B);o.updateBounds();mesh.addCountry(C);if(mesh.points().length==1){f(12)}break;case"streets":mesh.zoomTo(E,D);mesh.add(E[1],E[0],B);z.map.center({lat:E[1],lon:E[0]});break;case"radial":f(12,12);mesh.add(E[1],E[0],B);break}}function i(B){switch(B){case"POINT":case"ADDRESS":case"INTERSECTION":case"STREET":return 14;case"ZIP":case"ZIP_EXTENDED":return 13;case"CITY":return 12;case"COUNTY":return 10;case"STATE":case"REGION":return 6;case"COUNTRY":return 4;default:return 12}}function f(D,B){var C=Math.max(B||4,i(D));if(C!=z.map.zoom()){z.map.zoom(C)}}o.locations=function(B,D){for(var C=0;C<B.length;C++){if(D){mesh.add(B[C].latitude,location[C].longitude,B[C].name)}else{setTimeout(function(E){return function(){mesh.add(E.latitude,E.longitude,E.name);o.updateBounds()}}(B[C]),C*400)}}if(D){o.updateBounds()}};function b(G,I){var B=G.split("|");var F=[],D={};for(var E=0;E<B.length;E++){var C=B[E].split("\t");if(C.length<3){continue}if(I){var H=C[0]+"-"+C[1];if(D[H]){continue}else{D[H]=true}}F.push({latitude:parseFloat(C[0]),longitude:parseFloat(C[1]),name:C[2]})}return F}o.initializeFromData=function(E,D,C){mesh.prerender(C);var B=b(E,(D.length<20));mesh.locations(B,E);if(D){mesh.applyStyle(D)}return o};o.mesh=function(){return mesh};o.map=function(){return z};var h=0,g=1,x=0,v=0;var A;o.animateTransform=function(G,F,D,B){if(A){clearInterval(A)}var C=0;var E=d3.select(".delaunay");A=setInterval(function(){if(++C<30){h+=(G-h)*0.33;g+=(F-g)*0.5;x+=(D-x)*0.5;v+=(B-v)*0.5;var H="rotate("+h+", 300, 300)";var J="scale("+g+")";var I="translate("+x+","+v+")";E.attr("transform",J+I+H)}else{clearInterval(A)}},40)};o.refreshWithBounds=function(C,B){z.updateBounds(C,B,o.zoomOffset,o.offsetX)};o.updateBounds=function(){if(mesh.dirty){o.refreshWithBounds(mesh.lats(),mesh.lons());mesh.dirty=false}};z.on("boundsUpdated",function(){if(mesh.updatePixelBounds){mesh.updatePixelBounds()}mesh.refresh()});mesh.on("locationsSet",o.updateBounds);o.getFrame=function(){return n};o.getRenderer=function(){return w};o.updateTitle=function(B){mesh.updateTitle(B)};o.outputTitle=function(){return mesh.outputTitle()};o.outputG=function(){return mesh.outputG()};o.outputSVG=function(){return mesh.output()};o.outputMapSVG=function(){return $(z.map.container()).html()};o.hideMesh=function(){return o};o.showMesh=function(){return o};o.outputLocationData=function(){var B=[];var D=mesh.places(),E=mesh.lats(),C=mesh.lons();$.each(D,function(G){var F=E[G]+"\t"+C[G]+"\t"+D[G];B.push(F)});return B.join("|")};o.xhr=function(){return{xhr:"true",title:o.outputTitle(),svg:o.outputSVG(),location_data:o.outputLocationData(),renderer:mesh.name,metadata:mesh.outputStyle()}};return o};