var sb=sb||{};var app_key="dj0yJmk9M1hsekZBSDY1ZjRxJmQ9WVdrOU5uUjZiRzE0TXpRbWNHbzlNVEV5TURZMU1qRTJNZy0tJnM9Y29uc3VtZXJzZWNyZXQmeD00OQ--";sb.meshu=function(d){var l={},c=$(d).width()+"px",j=$(d).height()+"px",a=sb.map(d,c,j),m=sb.mesh(d,a,c,j),k=$("#cases");$(d).append("<div class='mapui'><div id='zoomin'></div><div id='zoomout'></div></div>");$("#zoomin").mousedown(function(n){a.map.zoom(a.map.zoom()+1);m.refresh()});$("#zoomout").mousedown(function(n){a.map.zoom(a.map.zoom()-1);m.refresh()});var i=$("#searchbox");i.focus(function(){k.fadeOut()});i.keypress(function(n){if(n.which==13){e()}});$("#search-button").click(function(){e()});m.on("added",f);function f(){var n=m.points();if(n.length>3){$("#finish-button").addClass("active")}else{$("#finish-button").removeClass("active")}}function e(){var n=i.val();if(n=="add a city, place, or address"){return}var p=n.replace("&","and").replace(/[^\w ]/ig,"").replace(" ","+");var o=$("body").hasClass("ie")?"/proxy/geocoder/?location="+p:"http://where.yahooapis.com/geocode?location="+p+"&flags=J&appid="+app_key;i.val("");$.ajax({url:o,cache:false,dataType:"json",error:function(q,s,r){console.log(r)},success:function(t){var r=t.ResultSet.Results;var s=$("#content");k.empty().hide();if(typeof r=="undefined"){i.blur();k.append($("<p>").text("Hrm, we weren't able to find your search. Try again?")).fadeIn()}else{if(r.length==1){b(r[0],n);if(m.points().length==1){var q=r[0].radius;if(q>1000000){a.map.zoom(3)}else{if(q>100000){a.map.zoom(4)}else{if(q>10000){a.map.zoom(12)}else{if(q>400){a.map.zoom(14)}}}}}}else{k.append($("<p>").text("Oops, we're not sure which place you meant. Try a more specific search?")).fadeIn();i.blur()}}}})}function b(n,o){m.add(n.latitude,n.longitude,o);l.updateBounds();f()}l.locations=function(n,p){for(var o=0;o<n.length;o++){if(p){b(n[o],n[o].name)}else{setTimeout(function(q){return function(){b(q,q.name)}}(n[o]),o*400)}}};l.locationData=function(r){var n=r.split("|");var q=[];for(var p=0;p<n.length;p++){var o=n[p].split("\t");if(o.length!=3){continue}q.push({latitude:parseFloat(o[0]),longitude:parseFloat(o[1]),name:o[2]})}m.locations(q);l.updateBounds();return l};l.mesh=function(){return m};var g=0;var h;l.animateTransform=function(p){if(h){clearInterval(h)}var n=0;var o=d3.select(".delaunay");h=setInterval(function(){if(++n<30){g+=(p-g)*0.33;var q="rotate("+g+",300,300)";o.attr("transform",q)}else{clearInterval(h)}},40)};l.updateBounds=function(){a.updateBounds(m.lats(),m.lons());m.updatePixelBounds();m.refresh()};l.updateTitle=function(n){m.updateTitle(n)};l.outputTitle=function(){return m.outputTitle()};l.outputSVG=function(){return m.output()};l.outputLocationData=function(){var n=[];var p=m.places(),q=m.lats(),o=m.lons();$.each(p,function(s){var r=q[s]+"\t"+o[s]+"\t"+p[s];n.push(r)});return n.join("|")};return l};