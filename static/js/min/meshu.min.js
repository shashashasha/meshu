var sb=sb||{};var mapzenapi="search-HWoiFxs",routingapi="valhalla-Gap3BYU",mapquestapi="zp2249S80Har3WjiYTzWFRFy2SafTrud";sb.meshu=function(h,o,f){var i={},m=$(h).width()+"px",j=$(h).height()+"px",r=f||sb.map(h,m,j),o=o||"facet";mesh=sb.mesh[o](h,r,m,j),searchError=$("#search-error"),loadingGif=$(".loading");i.offsetX=0;$(h).append("<div class='mapui'><div id='zoomin'></div><div id='zoomout'></div></div>");var l=(o=="print")?0.5:1;$("#zoomin").mousedown(function(t){r.map.zoom(r.map.zoom()+l);mesh.refresh("zoomed")});$("#zoomout").mousedown(function(t){r.map.zoom(r.map.zoom()-l);mesh.refresh("zoomed")});var a=$("#searchbox");a.keypress(function(u){searchError.fadeOut();if(u.which==13){var t=a.val();k(t)}});$("#search-button").click(function(){var t=a.val();k(t)});function k(u){if(u.split("|").length>2){var t=u.split("|");for(var v=0;v<t.length;v++){setTimeout(function(w){return function(){q(w)}}(t[v]),v*1000)}}else{q(u)}}i.findCountry=function(u){var t="http://open.mapquestapi.com/geocoding/v1/reverse?key="+mapquestapi+"&location="+u[1]+","+u[0];$.ajax({url:t,cache:false,crossDomain:false,dataType:"json",error:function(v,x,w){console.log(w)},success:function(w){var v=w.results;if(typeof v=="undefined"||v[0].locations.length==0){return}else{if(v.length){var x=v[0].locations[0];mesh.addCountry(x.adminArea1)}}}})};function q(t){if(t=="add a city, place, or address"){return}if(t.split(",").length==2&&Number(t.split(",")[0])&&Number(t.split(",")[1])){mesh.add(t.split(",")[0],t.split(",")[1],t);i.updateBounds();return}var v=t.replace("&","and").replace(/[^\w ]/ig,"").replace(" ","+");var u="https://search.mapzen.com/v1/search?text="+v+"&api_key="+mapzenapi;a.val("");$.ajax({url:u,cache:false,crossDomain:false,dataType:"json",beforeSend:function(){loadingGif.show()},error:function(w,y,x){console.log(x)},success:function(x){var w=x.features;loadingGif.hide();if(typeof w=="undefined"||w[0].geometry.length==0){searchError.fadeIn();a.focus();return}else{if(w.length){var y=w[0].geometry.coordinates;switch(mesh.name){case"facet":case"orbit":mesh.add(y[1],y[0],t);i.updateBounds();if(mesh.points().length==1){c(y.geocodeQuality)}break;case"print":mesh.add(y[1],y[0],t);i.updateBounds();mesh.addCountry(w[0].properties.country_a);if(mesh.points().length==1){c(12)}break;case"radial":c(12,12);mesh.add(y[1],y[0],t);break}}}}})}function g(t){switch(t){case"POINT":case"ADDRESS":case"INTERSECTION":case"STREET":return 14;case"ZIP":case"ZIP_EXTENDED":return 13;case"CITY":return 12;case"COUNTY":return 10;case"STATE":return 6;case"COUNTRY":return 4;default:return 12}}function c(v,t){var u=Math.max(t||4,g(v));if(u!=r.map.zoom()){r.map.zoom(u)}}i.locations=function(t,v){for(var u=0;u<t.length;u++){if(v){mesh.add(t[u].latitude,location[u].longitude,t[u].name)}else{setTimeout(function(w){return function(){mesh.add(w.latitude,w.longitude,w.name);i.updateBounds()}}(t[u]),u*400)}}if(v){i.updateBounds()}};function b(y,A){var t=y.split("|");var x=[],v={};for(var w=0;w<t.length;w++){var u=t[w].split("\t");if(u.length<3){continue}if(A){var z=u[0]+"-"+u[1];if(v[z]){continue}else{v[z]=true}}x.push({latitude:parseFloat(u[0]),longitude:parseFloat(u[1]),name:u[2]})}return x}i.initializeFromData=function(w,v,u){mesh.prerender(u);var t=b(w,(v.length<20));mesh.locations(t,w);if(v){mesh.applyStyle(v)}return i};i.mesh=function(){return mesh};i.map=function(){return r};var e=0,d=1,p=0,n=0;var s;i.animateTransform=function(y,x,v,t){if(s){clearInterval(s)}var u=0;var w=d3.select(".delaunay");s=setInterval(function(){if(++u<30){e+=(y-e)*0.33;d+=(x-d)*0.5;p+=(v-p)*0.5;n+=(t-n)*0.5;var z="rotate("+e+", 300, 300)";var B="scale("+d+")";var A="translate("+p+","+n+")";w.attr("transform",B+A+z)}else{clearInterval(s)}},40)};i.refreshWithBounds=function(u,t){r.updateBounds(u,t,i.zoomOffset,i.offsetX)};i.updateBounds=function(){if(mesh.dirty){i.refreshWithBounds(mesh.lats(),mesh.lons());mesh.dirty=false}};r.on("boundsUpdated",function(){if(mesh.updatePixelBounds){mesh.updatePixelBounds()}mesh.refresh()});mesh.on("locationsSet",i.updateBounds);i.getFrame=function(){return h};i.getRenderer=function(){return o};i.updateTitle=function(u){mesh.updateTitle(u)};i.outputTitle=function(){return mesh.outputTitle()};i.outputSVG=function(){return mesh.output()};i.outputMapSVG=function(){return $(r.map.container()).html()};i.hideMesh=function(){return i};i.showMesh=function(){return i};i.outputLocationData=function(){var t=[];var v=mesh.places(),w=mesh.lats(),u=mesh.lons();$.each(v,function(y){var x=w[y]+"\t"+u[y]+"\t"+v[y];t.push(x)});return t.join("|")};i.xhr=function(){return{xhr:"true",title:i.outputTitle(),svg:i.outputSVG(),location_data:i.outputLocationData(),renderer:mesh.name,metadata:mesh.outputStyle(),promo:meshu.promo}};return i};