var sb=sb||{};sb.rasterizer=function(){var h=d3.dispatch("rasterized","rasterizedThumbnail"),e=false,g=[];var d=function(k,l){var j=document.createElement("canvas");j.width=400;j.height=400;j.style.position="absolute";j.style.top="0";j.style.left="0";j.className=k;$(j).addClass("hidden");if(!l){g.push(j)}return j};var c=function(j,k){j.fillStyle="rgba(255, 255, 255, "+k+")";j.fillRect(0,0,j.width,j.height);j.fill()};var i=function(j){var k=new XMLSerializer();return k.serializeToString(j)};var b=function(k){var m=k.map().map,l=m.zoom(),j=Math.round(l);if(l!=j){m.zoom(j);k.mesh().refresh()}};var f=function(m,l,j,k,o){var n=d();m.appendChild(n);k.mesh().bakeStyles();canvg(n,k.outputSVG(),{renderCallback:function(){k.mesh().unBakeStyles();j.drawImage(n,0,0,l.width,l.height);var p=new Image();p.onload=function(){j.drawImage(p,l.width-130,l.height-35,117,22);a(m,l,k,o)};p.src="/static/images/logo_io.png"}})};var a=function(m,k,j,n){var l=j.xhr();l.csrfmiddlewaretoken=$("#csrf input").val();l.dataurl=k.toDataURL();if(j.id){l.id=j.id}h.clearCanvases();$.post("to_png",l,function(p){var o=document.createElement("img");o.src=p.image_url;$(o).addClass("hidden");m.appendChild(o);h.generated=true;h.rasterized(p);if(n){n(p)}},"json")};h.clearCanvases=function(){while(g.length){var j=g.pop();$(j).remove()}};h.rasterize=function(l,o){b(l);var k=d(),n=l.getFrame(),j=k.getContext("2d"),m=i(l.map().map.container());n.appendChild(k);canvg(k,m,{renderCallback:function(){c(j,0.7);f(n,k,j,l,o)}})};h.thumbnail=function(l,o){l.mesh().bakeStyles();var k=d(),n=l.getFrame(),j=k.getContext("2d"),m=l.outputSVG();n.appendChild(k);canvg(k,m,{renderCallback:function(){l.mesh().unBakeStyles();if(o){o(k)}}})};h.ringPreview=function(G,q){var C=G.mesh().points(),D=0,w=[];for(var E=0;E<C.length;E++){for(var A=E;A<C.length;A++){var t=(C[E][0]-C[A][0]);var r=(C[E][1]-C[A][1]);var v=Math.sqrt((t*t)+(r*r));if(v>D){D=v;w=[{lat:C[A][1],lon:C[A][0]},{lat:C[E][1],lon:C[E][0]}]}}}var n=G.map().l2p(w[0]),m=G.map().l2p(w[1]),I=m.y-n.y,J=m.x-n.x;var H=Math.atan2(I,J)*(180/Math.PI),p=-H+180,l=Math.sqrt((J*J)+(I*I)),F=(600/l),k=600*F/2,z=(600-(600*F))/4,K="scale("+(600/l)+") ",s="translate("+z+","+z+") ",B="rotate("+[p,k,k].join(",")+") ";G.mesh().bakeStyles();d3.select(".delaunay").attr("stroke-width",30).attr("transform",K+s+B);var o=d("ring-canvas",true),u=G.getFrame(),y=o.getContext("2d"),x=G.outputSVG();u.appendChild(o);canvg(o,x,{renderCallback:function(){G.mesh().unBakeStyles();d3.select(".delaunay").attr("stroke-width",5);d3.selectAll(".ring-canvas").remove();var j=document.getCSSCanvasContext("2d","ring-preview",600,200);j.clearRect(0,0,600,200);j.fillStyle="rgba(255, 255, 255, .75)";j.fillRect(0,0,600,200);j.drawImage(o,0,0,600,200);if(q){q(o)}}})};return h}();