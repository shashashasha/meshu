var sb=sb||{};sb.rasterizer=function(){var e=d3.dispatch("rasterized"),d=false;var f=function(){var i=document.createElement("canvas");i.width=400;i.height=400;i.style.position="absolute";i.style.top="0";i.style.left="0";return i};var h=function(i,j){i.fillStyle="rgba(255, 255, 255, "+j+")";i.fillRect(0,0,i.width,i.height);i.fill()};var g=function(i){var j=new XMLSerializer();return j.serializeToString(i)};var b=function(i){var j=i.map().map.zoom();i.map().map.zoom(Math.round(j));i.mesh().refresh()};var a=function(l,k,i,j,n){var m=document.createElement("canvas");m.width=k.width;m.height=k.height;l.appendChild(m);canvg(m,j.outputSVG(),{renderCallback:function(){i.drawImage(m,0,0,k.width,k.height);c(l,k,i,j,n)}})};var c=function(m,l,i,k,n){var j={xhr:"true",csrfmiddlewaretoken:$("#csrf input").val(),dataurl:l.toDataURL(),title:k.outputTitle(),location_data:k.outputLocationData(),svg:k.outputSVG()};if(k.id){j.id=k.id}$.post("to_png",j,function(p){var o=document.createElement("img");o.src=p.url;m.appendChild(o);e.generated=true;e.rasterized(p);if(n){n(p)}},"json")};e.rasterize=function(k,n){console.log("rasterizing inside rasterizer");b(k);var j=f(),m=k.getFrame(),i=j.getContext("2d"),l=g(k.map().map.container());m.appendChild(j);canvg(j,l,{renderCallback:function(){h(i,0.7);a(m,j,i,k,n)}})};return e}();