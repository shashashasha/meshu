var sb=sb||{};sb.rasterizer=function(){var n=d3.dispatch("rasterized","rasterizedThumbnail"),j=false,l=[];var g=function(q,r){var p=document.createElement("canvas");p.width=400;p.height=400;p.style.position="absolute";p.style.top="0";p.style.left="0";p.className=q;$(p).addClass("hidden");if(!r){l.push(p)}return p};var f=function(p,q){p.fillStyle="rgba(255, 255, 255, "+q+")";p.fillRect(0,0,p.width,p.height);p.fill()};var o=function(p){var q=new XMLSerializer();return q.serializeToString(p)};var e=function(q){var s=q.map().map,r=s.zoom(),p=Math.round(r);if(r!=p){s.zoom(p);q.mesh().refresh()}};var k=function(s,r,p,q,u){var t=g();s.appendChild(t);q.mesh().bakeStyles();canvg(t,q.outputSVG(),{renderCallback:function(){q.mesh().unBakeStyles();p.drawImage(t,0,0,r.width,r.height);var v=new Image();v.onload=function(){p.drawImage(v,r.width-130,r.height-35,117,22);b(s,r,q,u)};v.src="/static/images/logo_io.png"}})};var b=function(s,q,p,t){var r=p.xhr();r.csrfmiddlewaretoken=$("#csrf input").val();r.dataurl=q.toDataURL();if(p.id){r.id=p.id}n.clearCanvases();$.post("to_png",r,function(v){var u=document.createElement("img");u.src=v.image_url;$(u).addClass("hidden");s.appendChild(u);n.generated=true;n.rasterized(v);if(t){t(v)}},"json")};n.clearCanvases=function(){while(l.length){var p=l.pop();$(p).remove()}};n.rasterize=function(r,u){e(r);var q=g(),t=r.getFrame(),p=q.getContext("2d"),s=o(r.map().map.container());t.appendChild(q);canvg(q,s,{renderCallback:function(){f(p,0.7);k(t,q,p,r,u)}})};n.thumbnail=function(r,u){r.mesh().bakeStyles();var q=g(),t=r.getFrame(),p=q.getContext("2d"),s=r.outputSVG();t.appendChild(q);canvg(q,s,{renderCallback:function(){r.mesh().unBakeStyles();if(u){u(q)}}})};var h=function(p,x){var w=0,q=[];for(var t=0;t<x.length;t++){var u=p.l2p({lat:x[t][1],lon:x[t][0]});for(var r=t+1;r<x.length;r++){var s=p.l2p({lat:x[r][1],lon:x[r][0]});var z=u.x-s.x;var y=u.y-s.y;var v=Math.sqrt((z*z)+(y*y));if(v>w){w=v;q=[s,u]}}}return q};var i=function(r,q){var s=q.y-r.y,p=q.x-r.x;return Math.atan2(s,p)*(180/Math.PI)};var a=function(r,q){var s=q.y-r.y,p=q.x-r.x;return Math.sqrt((p*p)+(s*s))};var m=function(r,q){var p=q.getTransformToElement(q.ownerSVGElement);return r.matrixTransform(p)};var c=function(q,r){var p=[];r.forEach(function(s){p.push(q.l2p({lat:s[1],lon:s[0]}))});return p};var d=function(t,w){var v=i(w[0],w[1]),r=i(w[0],t),q=v-r>0,u=a(w[0],t),s=Math.abs(v-r)*Math.PI/180,p=Math.sin(s)*u;return q?-p:p};n.ringPreview=function(H,v){H.mesh().bakeStyles();if(H.mesh().points().length<3){return}var L=H.map(),E=H.mesh().points(),z=h(L,E),I=i(z[0],z[1]),t=-I+180,F="rotate("+[t,300,300].join(",")+") ";d3.select("#delaunay-ui").attr("transform",F);var D=[],G=c(L,E),x=[],w=[];var u=d3.selectAll("#delaunay-ui circle").each(function(P,M){var O=this.ownerSVGElement.createSVGPoint();O.x=G[M].x;O.y=G[M].y;var N=m(O,this);x.push(N.x);w.push(N.y);D.push([N.x,N.y])});var p={top:d3.min(w),left:d3.min(x),right:d3.max(x),bottom:d3.max(w)},q=p.right-p.left,K=p.bottom-p.top,J=600/q,r=200/K;var B=d3.select("#ring-preview-delaunay-container").selectAll("path").data(d3.geom.delaunay(D));B.enter().append("svg:path");B.exit().remove();B.attr("stroke-width",30).attr("d",function(R){var N=R.length;var M=[];for(var Q=0;Q<N;Q++){var P=(R[Q][0]-p.left)*J,O=(R[Q][1]-p.top)*r;M.push([P,O])}return"M"+M.join(" L")+"Z"});var s=g("ring-canvas",true),y=H.getFrame(),C=s.getContext("2d"),A=H.outputSVG();y.appendChild(s);canvg(s,A,{renderCallback:function(){H.mesh().unBakeStyles();d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");d3.selectAll(".ring-canvas").remove();var M=document.getCSSCanvasContext("2d","ring-preview",600,200);M.clearRect(0,0,600,200);M.fillStyle="rgba(255, 255, 255, .75)";M.fillRect(0,0,600,200);M.drawImage(s,0,0,600,200);if(v){v(s)}}})};return n}();