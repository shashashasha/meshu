var sb=sb||{};sb.rasterizer=function(){var h=d3.dispatch("rasterized","rasterizedThumbnail"),e=false,g=[];var d=function(k,l){var j=document.createElement("canvas");j.width=600;j.height=600;j.style.position="absolute";j.style.top="0";j.style.left="0";if(!l){g.push(j)}return j};var c=function(j,k){j.fillStyle="rgba(255, 255, 255, "+k+")";j.fillRect(0,0,j.width,j.height);j.fill()};var i=function(j){var k=new XMLSerializer();return k.serializeToString(j)};var b=function(k){var m=k.map().map,l=m.zoom(),j=Math.round(l);if(l!=j){m.zoom(j);k.mesh().refresh()}};var f=function(m,l,j,k,o){var n=d();m.appendChild(n);k.mesh().bakeStyles();canvg(n,k.outputSVG(),{renderCallback:function(){k.mesh().unBakeStyles();j.drawImage(n,0,0,l.width,l.height);var p=new Image();p.onload=function(){j.drawImage(p,l.width-130,l.height-35,117,22);a(m,l,k,o)};p.src="/static/images/logo_io.png"}})};var a=function(m,k,j,n){var l=j.xhr();l.csrfmiddlewaretoken=$("#csrf input").val();l.dataurl=k.toDataURL();if(j.id){l.id=j.id}h.clearCanvases();$.post("to_png",l,function(p){var o=document.createElement("img");o.src=p.image_url;$(o).addClass("hidden");m.appendChild(o);h.generated=true;h.rasterized(p);if(n){n(p)}},"json")};h.clearCanvases=function(){while(g.length){var j=g.pop();$(j).remove()}};h.rasterize=function(l,o){b(l);var k=d(),n=l.getFrame(),j=k.getContext("2d"),m=i(l.map().map.container());n.appendChild(k);canvg(k,m,{renderCallback:function(){c(j,0.7);f(n,k,j,l,o);h.clearCanvases()}})};h.thumbnail=function(q,p){q.mesh().bakeStyles();var k=new XMLSerializer().serializeToString(document.getElementById("streets-svg"));var l=d();var r=l.getContext("2d");var m=window.URL||h.webkitURL||h;var n=new Image();var o=new Blob([k],{type:"image/svg+xml;charset=utf-8"});var j=m.createObjectURL(o);n.onload=function(){r.drawImage(n,0,0);var s=l.toDataURL("image/png");d3.selectAll(".product-transformer").attr("src",s);m.revokeObjectURL(s)};n.src=j;q.mesh().unBakeStyles()};h.ringPreview=function(s,q){s.mesh().bakeStyles();if(s.mesh().points().length<3){return}var l=s.mesh().getLongestRotation(),p=s.mesh().projectPoints(l),n=500,r=110,m=10;s.mesh().transformedDelaunay(p,n,r-m,m/2);var k=d("ring-canvas",true),j=s.getFrame(),t=k.getContext("2d"),o=s.outputSVG();j.appendChild(k);canvg(k,o,{renderCallback:function(){s.mesh().unBakeStyles();s.mesh().refresh();d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");d3.select("#ring-img").style("display","none");d3.selectAll(".ring-canvas").remove();var y=40,x=0,w;if(typeof document.getCSSCanvasContext!="function"){w=d3.select("#ring-preview-canvas").node().getContext("2d");$(".strip div").css("background-image","-moz-element(#ring-preview-canvas)")}else{w=document.getCSSCanvasContext("2d","ring-preview",n,r+x+y)}var u=$("body").hasClass("chrome");w.clearRect(0,0,n,r+x+y);w.fillStyle="rgba(255, 255, 255, "+(u?1:0.8)+")";w.fillRect(0,0,n,r+x+y);w.drawImage(k,0,0,n,r,0,x,n,r);if(u){var v=d3.select("#ring-preview-canvas").node().toDataURL("image/jpeg");$(".strip div").css("background-image","url("+v+")")}if(q){q(k)}}})};return h}();