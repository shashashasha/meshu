var sb=sb||{};sb.rasterizer=function(){var h=d3.dispatch("rasterized"),e=false,g=[];var d=function(){var j=document.createElement("canvas");j.width=400;j.height=400;j.style.position="absolute";j.style.top="0";j.style.left="0";$(j).addClass("hidden");g.push(j);return j};var c=function(j,k){j.fillStyle="rgba(255, 255, 255, "+k+")";j.fillRect(0,0,j.width,j.height);j.fill()};var i=function(j){var k=new XMLSerializer();return k.serializeToString(j)};var b=function(j){var k=j.map().map.zoom();j.map().map.zoom(Math.round(k));j.mesh().refresh()};var f=function(m,l,j,k,o){var n=d();m.appendChild(n);canvg(n,k.outputSVG(),{renderCallback:function(){j.drawImage(n,0,0,l.width,l.height);a(m,l,j,k,o)}})};var a=function(n,m,j,l,p){var k={xhr:"true",csrfmiddlewaretoken:$("#csrf input").val(),dataurl:m.toDataURL(),title:l.outputTitle(),location_data:l.outputLocationData(),svg:l.outputSVG()};if(l.id){k.id=l.id}while(g.length){var o=g.pop();$(o).remove()}$.post("to_png",k,function(r){var q=document.createElement("img");q.src=r.image_url;$(q).addClass("hidden");n.appendChild(q);h.generated=true;h.rasterized(r);if(p){p(r)}},"json")};h.rasterize=function(l,o){b(l);var k=d(),n=l.getFrame(),j=k.getContext("2d"),m=i(l.map().map.container());n.appendChild(k);canvg(k,m,{renderCallback:function(){c(j,0.7);f(n,k,j,l,o)}})};return h}();