var sb=sb||{};sb.rasterizer=function(){var k=d3.dispatch("rasterized","rasterizedThumbnail"),h=false,j=[];var e=function(n,o){var m=document.createElement("canvas");m.width=400;m.height=400;m.style.position="absolute";m.style.top="0";m.style.left="0";m.className=n;$(m).addClass("hidden");if(!o){j.push(m)}return m};var d=function(m,n){m.fillStyle="rgba(255, 255, 255, "+n+")";m.fillRect(0,0,m.width,m.height);m.fill()};var l=function(m){var n=new XMLSerializer();return n.serializeToString(m)};var c=function(n){var p=n.map().map,o=p.zoom(),m=Math.round(o);if(o!=m){p.zoom(m);n.mesh().refresh()}};var i=function(p,o,m,n,r){var q=e();p.appendChild(q);n.mesh().bakeStyles();canvg(q,n.outputSVG(),{renderCallback:function(){n.mesh().unBakeStyles();m.drawImage(q,0,0,o.width,o.height);var s=new Image();s.onload=function(){m.drawImage(s,o.width-130,o.height-35,117,22);b(p,o,n,r)};s.src="/static/images/logo_io.png"}})};var b=function(p,n,m,q){var o=m.xhr();o.csrfmiddlewaretoken=$("#csrf input").val();o.dataurl=n.toDataURL();if(m.id){o.id=m.id}k.clearCanvases();$.post("to_png",o,function(s){var r=document.createElement("img");r.src=s.image_url;$(r).addClass("hidden");p.appendChild(r);k.generated=true;k.rasterized(s);if(q){q(s)}},"json")};k.clearCanvases=function(){while(j.length){var m=j.pop();$(m).remove()}};k.rasterize=function(o,r){c(o);var n=e(),q=o.getFrame(),m=n.getContext("2d"),p=l(o.map().map.container());q.appendChild(n);canvg(n,p,{renderCallback:function(){d(m,0.7);i(q,n,m,o,r)}})};k.thumbnail=function(o,r){o.mesh().bakeStyles();var n=e(),q=o.getFrame(),m=n.getContext("2d"),p=o.outputSVG();q.appendChild(n);canvg(n,p,{renderCallback:function(){o.mesh().unBakeStyles();if(r){r(n)}}})};var f=function(m,u){var t=0,n=[];if(u.length<2){return}for(var q=0;q<u.length;q++){var r=m.l2p({lat:u[q][1],lon:u[q][0]});for(var o=q+1;o<u.length;o++){var p=m.l2p({lat:u[o][1],lon:u[o][0]});var w=r.x-p.x;var v=r.y-p.y;var s=Math.sqrt((w*w)+(v*v));if(s>t){t=s;n=[p,r]}}}return n};var g=function(o,n){var p=n.y-o.y,m=n.x-o.x;return Math.atan2(p,m)*(180/Math.PI)};var a=function(o,n){var p=n.y-o.y,m=n.x-o.x;return Math.sqrt((m*m)+(p*p))};k.ringPreview=function(A,z){A.mesh().bakeStyles();if(A.mesh().points().length<3){return}var m=A.map(),x=A.mesh().points(),s=f(m,x),q=g(s[0],s[1]),p=-q+180,t="rotate("+[p,300,300].join(",")+") ";var w=A.mesh().projectPoints(t),u=600,y=150,r=20;A.mesh().transformedDelaunay(w,u,y-r,r/2);var o=e("ring-canvas",true),n=A.getFrame(),B=o.getContext("2d"),v=A.outputSVG();n.appendChild(o);canvg(o,v,{renderCallback:function(){A.mesh().unBakeStyles();A.mesh().refresh();d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");d3.selectAll(".ring-canvas").remove();var C=document.getCSSCanvasContext("2d","ring-preview",u,y+100);C.clearRect(0,0,u,y+100);C.fillStyle="rgba(255, 255, 255, .75)";C.fillRect(0,0,u,y+100);C.drawImage(o,0,0,u,y,0,50,u,y);if(z){z(o)}}})};return k}();