$(function(){$("body").detect();var p={earrings:{acrylic:{price:75,colors:["Black","Grey","White"]},wood:{price:80,colors:["Amber","Blonde"]},nylon:{price:90,colors:["Black","Grey","White"]},silver:{price:150}},pendant:{acrylic:{price:75,colors:["Black","Grey","White"]},wood:{price:80,colors:["Amber","Blonde"]},nylon:{price:90,colors:["Black","Grey","White"]},silver:{price:130}},necklace:{acrylic:{price:80,colors:["Black","Grey","White"]},wood:{price:85,colors:["Amber","Blonde"]},nylon:{price:95,colors:["Black","Grey","White"]},silver:{price:150}},cufflinks:{stainless:{price:85},silver:{price:160}}};var d={earrings:"pair of earrings",pendant:"small pendant necklace",necklace:"large necklace",cufflinks:"pair of cufflinks"};var m={earrings:"earrings",pendant:"pendant necklace",necklace:"large necklace",cufflinks:"cufflinks"};var h=4;var l=["edit","product","make","account","checkout","review"];var g=$("#content");orderer.options(p);sb.materializer.initialize(p,d,m);var k=sb.meshu($("#meshu-container")[0]);k.isReadymade=loadedMeshu&&loadedMeshu.product!="";if(loadedMeshu){saver.initialize(k,loadedMeshu.view_url);if($("html").hasClass("svg")){k.locationData(loadedMeshu.location_data)}user.updateLogoutActions(pageType);sb.product.initialize(".delaunay");switch(pageType){case"edit":l=["edit","product","make","account","checkout","review"];break;case"view":l=["view"];break;case"product":var j=$("#product");j.find(".nav").remove();j.find(".make-wrapper").removeClass("make-wrapper");l=["product","make","account","checkout","review"];break;default:l=["readymade","account","checkout","review"];$("#materials").addClass("ready");var j=loadedMeshu.product.length?loadedMeshu.product:"necklace";sb.materializer.product(j);break}$("#finish-button").addClass("active");$("#meshu-container").removeClass("inactive");var o=loadedMeshu.location_data.split("|");$.each(o,function(r,t){var s=t.split("\t");if(s.length==3){var u=document.createElement("div");u.innerHTML=s[2];var q=u.firstChild.nodeValue;$("<li>").html(q).appendTo($("#display-places"))}});d3.select("#place-number").attr("class","").select(".title-text").html(function(q){q.title=loadedMeshu.title;k.updateTitle(q.title);return q.title})}else{saver.initializeNewMeshu(k)}if(user.loggedIn){n()}if(!user.loggedIn&&!(loadedMeshu&&pageType!="edit")&&window.location.hash!="#skipintro"){$("#edit-help").fadeIn();$("#modal-bg").fadeIn();$("#close-help").click(function(){$("#edit-help").fadeOut();$("#modal-bg").fadeOut()})}else{if(window.location.hash=="#skipintro"){window.location.hash=""}}$(".next").live("click",function(){if(!$(this).hasClass("active")){return}var t=$(this);var q=g.attr("class");var r=l.indexOf(q);var s=function(){g.attr("class",l[r+1])};if(q=="edit"&&user.loggedIn){saver.createOrUpdateMeshu()}if(q=="make"||q=="readymade"){n()}if(q=="account"&&!user.loggedIn){user.afterLogIn=function(){saver.createOrUpdateMeshu(function(){t.click()})};return}c(q);user.updateLogoutActions(q);s()});$(".back").click(function(){var q=g.attr("class");if(q=="checkout"){n()}var r=l.indexOf(q);var s=l[r-1];g.attr("class",s);a(s)});$("#save-and-view").click(function(){var q=function(){saver.createOrUpdateMeshu(function(r){window.location.href=r.meshu_url})};if(!user.loggedIn){e();user.afterLogIn=q}else{q()}});$("#product-preview svg").live("click",function(){var q=$(this).attr("id").split("-")[1];$(".make-option").hide();$("#make-"+q).show();sb.rotator.update(q);sb.materializer.product(q);sb.rotator.on("rotated",sb.product.rotation)});function c(q){switch(q){case"edit":k.updateBounds();k.mesh().updateCircleBehavior();sb.product.initialize(".delaunay");break;case"make":k.mesh().updateCircleBehavior(true);k.animateTransform(sb.rotator?sb.rotator.rotation():0);break;case"readymade":k.mesh().updateCircleBehavior(true);break;case"review":i();break}}function a(q){switch(q){case"edit":k.mesh().updateCircleBehavior();break;case"make":case"readymade":k.mesh().updateCircleBehavior();k.animateTransform(0);break}}function n(){var q=l.indexOf("account");if(user.loggedIn){if(q>=0){l.splice(q,1)}$("#account").css("visibility","hidden")}else{if(q==-1){l.splice(-2,0,"account")}$("#account").css("visibility","visible")}}$(".show-places").click(function(){$("#display-places").slideToggle();$(".show-places").toggle()});$("#payment-form").validate({rules:{shipping_zip:{digits:true,minlength:5},shipping_state:{minlength:2},card_number:{creditcard:true},card_cvc:{digits:true,minlength:3},card_month:{digits:true,minlength:2},card_year:{digits:true,minlength:4,}},messages:{shipping_state:"Please enter the two-letter state abbreviation.",card_cvc:"Sorry, that is not a valid CVC code",card_month:{minlength:"Please enter the month as a two-digit number."},card_year:{minlength:"Please enter the year as a four-digit number.",},},submitHandler:f});$("#coupon-code").submit(function(){var q=$("#coupon-code-value").val();orderer.applyCoupon(q,function(r){if(r.success){var s=r.amount;$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>-$"+s+".00</span>").insertAfter("#subtotal-price");$("#coupon-message").fadeIn("fast").html(q+" discount applied!");$(".coupon-form").hide()}else{$("#coupon-message").fadeIn("fast").html("Oops, invalid code.")}i()});return false});$("#review-button").click(function(){if(!user.loggedIn){e()}});$("#submit-button").click(function(q){if(!user.loggedIn){e();return false}orderer.submit()});function f(){if(!user.loggedIn){e(f);return}g.attr("class","review");c("review")}function e(q){user.showModal();user.afterLogIn=function(){if(q){saver.createOrUpdateMeshu(function(){setTimeout(q,200)})}}}function i(){orderer.updateProduct(sb.materializer.product(),sb.materializer.material(),h);$("#object-type").val(sb.materializer.productName());$("#object-material").val(sb.materializer.material());$("#object-color").val(sb.materializer.color().toLowerCase());$("#object-amount").val(orderer.getTotalCents());$("#svg-theta").val(sb.rotator?sb.rotator.rotation():0);$("#svg-file").val(k.outputSVG());$("#meshu-data").val(k.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:k.outputTitle());b();$("#review-shipping").empty();$(".ship-row input").each(function(){var s;var r=function(t){return t.replace(/\w\S*/g,function(u){return u.charAt(0).toUpperCase()+u.substr(1).toLowerCase()})};this.value=r(this.value);switch(this.id){case"ship-city":case"ship-zip":s=$("<span>");break;case"ship-state":this.value=this.value.toUpperCase();s=$("<span>");break;default:s=$("<p>");break}s.text($(this).val()).appendTo("#review-shipping")});var q=$("#card-number").val();$("#review-payment").text("XXXX-XXXX-XXXX-"+q.substring(12,16))}function b(){var q="One "+sb.materializer.displayName();var r=sb.materializer.color().toLowerCase()+" "+sb.materializer.material();$("#review-description").text(q+", made out of "+r);$("#subtotal-price span").text(orderer.getPriceString());$("#shipping-price span").text("$"+h+".00");$("#total-price span").text(orderer.getTotalString())}});$.fn.detect=function(){var e=navigator.userAgent,d={ie:e.match(/MSIE\s([^;]*)/)?true:false,ios:e.match(/like Mac OS X/i)?true:false,iphone:e.match(/iPhone/i)?true:false,ipad:e.match(/iPad/i)?true:false,android:e.match(/Android/i)?true:false,webos:e.match(/WebOS/i)?true:false,firefox:e.match(/Firefox/i)?true:false,webkit:e.match(/WebKit/i)?true:false,safari:e.match(/Safari/i)?true:false,chrome:e.match(/Chrome/i)?true:false,opera:e.match(/Opera/i)?true:false};if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)){var b=Math.floor(new Number(RegExp.$1));var c="ie"+b}d.mobile=d.iphone||d.android;for(var a in d){if(a=="ie"){this.addClass(c)}this.toggleClass(a,d[a])}return this};