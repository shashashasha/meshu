$(function(){var p={earrings:{wood:{price:75,colors:["Amber"]},acrylic:{price:80,colors:["Black","White"]},nylon:{price:90,colors:["Black","White"]},silver:{price:150,colors:["Sterling Silver"]}},pendant:{wood:{price:75,colors:["Amber"]},acrylic:{price:85,colors:["Black","White"]},nylon:{price:90,colors:["Black","White"]},silver:{price:130,colors:["Sterling Silver"]}},necklace:{wood:{price:80,colors:["Amber"]},acrylic:{price:90,colors:["Black","White"]},nylon:{price:95,colors:["Black","White"]},silver:{price:150,colors:["Sterling Silver"]}},cufflinks:{stainless:{price:85},silver:{price:160}}};var e={earrings:"pair of earrings",pendant:"small pendant necklace",necklace:"large necklace",cufflinks:"pair of cufflinks"};var m={earrings:"earrings",pendant:"pendant necklace",necklace:"large necklace",cufflinks:"cufflinks"};var l=["edit","product","make","account","checkout","review"];var h=$("#content");orderer.options(p);sb.materializer.initialize(p,e,m);var k=sb.meshu($("#meshu-container")[0]);k.isReadymade=loadedMeshu&&loadedMeshu.product!="";if(loadedMeshu){saver.initialize(k);saver.updateMeshuData(loadedMeshu);if($("html").hasClass("svg")){if(k.isReadymade){readymade.initialize(k)}if(pageType=="view"){k.map().buffer(0)}k.locationData(loadedMeshu.location_data)}user.updateLogoutActions(pageType);sb.product.initialize(".delaunay");switch(pageType){case"edit":l=["edit","product","make","account","checkout","review"];break;case"view":l=["view"];break;case"product":var j=$("#product");j.find(".nav").remove();j.find(".make-wrapper").removeClass("make-wrapper");l=["product","make","account","checkout","review"];break;default:l=["readymade","account","checkout","review"];$("#materials").addClass("ready");var j=loadedMeshu.product.length?loadedMeshu.product:"necklace";sb.materializer.product(j);break}$("#finish-button").addClass("active");$("#meshu-container").removeClass("inactive");var o=loadedMeshu.location_data.split("|");$.each(o,function(r,t){var s=t.split("\t");if(s.length==3){var u=document.createElement("div");u.innerHTML=s[2];var q=u.firstChild.nodeValue;$("<li>").html(q).appendTo($("#display-places"))}});d3.select("#place-number").attr("class","").select(".title-text").html(function(q){q.title=loadedMeshu.title;k.updateTitle(q.title);return q.title})}else{saver.initializeNewMeshu(k)}if(user.loggedIn){n()}if(!user.loggedIn&&!loadedMeshu&&window.location.hash!="#skipintro"){$("#edit-help").fadeIn();$("#modal-bg").fadeIn();$("#close-help").click(function(){$("#edit-help").fadeOut();$("#modal-bg").fadeOut()})}else{if(window.location.hash=="#skipintro"){window.location.hash=""}}$(".next").live("click",function(){if(!$(this).hasClass("active")){return}var t=$(this);var q=h.attr("class");var r=l.indexOf(q);var s=function(){h.attr("class",l[r+1])};if(q=="edit"&&user.loggedIn){saver.createOrUpdateMeshu()}if(q=="make"||q=="readymade"){n()}if(q=="account"&&!user.loggedIn){user.afterLogIn=function(){saver.createOrUpdateMeshu(function(){t.click()})};return}d(q);user.updateLogoutActions(q);s()});$(".back").click(function(){var q=h.attr("class");if(q=="checkout"){n()}var r=l.indexOf(q);var s=l[r-1];h.attr("class",s);a(s)});$("#save-and-view").click(function(){var q=function(){saver.createOrUpdateMeshu(function(r){window.location.href=r.meshu_url})};if(!user.loggedIn){f();user.afterLogIn=q}else{q()}});$("#product-preview svg").live("click",function(){var q=$(this).attr("id").split("-")[1];$(".make-option").hide();$("#make-"+q).show();sb.rotator.update(q);sb.materializer.product(q);sb.rotator.on("rotated",sb.product.rotation)});function d(q){switch(q){case"edit":k.updateBounds();k.mesh().updateCircleBehavior();sb.product.initialize(".delaunay");sb.rasterizer.rasterize(k);break;case"make":case"readymade":k.mesh().updateCircleBehavior(true);var s=sb.materializer.product();var r=sb.transforms[s]["render"];k.animateTransform(sb.rotator?sb.rotator.rotation():0,r.scale,r.transform.x,r.transform.y);var u=static_url+"images/render/"+s+"_preview.jpg";$(".render").css("background-image","url("+u+")");break;case"review":i();break}}function a(q){switch(q){case"edit":k.mesh().updateCircleBehavior();break;case"make":case"readymade":k.mesh().updateCircleBehavior();k.animateTransform(0,1,0,0);break}}function n(){var q=l.indexOf("account");if(user.loggedIn){if(q>=0){l.splice(q,1)}$("#account").css("visibility","hidden")}else{if(q==-1){l.splice(-2,0,"account")}$("#account").css("visibility","visible");$("#account li").click(function(){var s=$(this).attr("id").split("-")[1];var r=$("#account");r.attr("class",s);r.find("li").removeClass("active");$(this).addClass("active");self.mode=s})}}$(".show-places").click(function(){$("#display-places").slideToggle();$(".show-places").toggle()});$(".share-facebook").click(function(){if(!sb.rasterizer.generated){sb.rasterizer.rasterize(k,b)}else{b()}});sb.rasterizer.on("rasterized",function(s){saver.updateMeshuData(s);var u="https://twitter.com/intent/tweet?text=";var w="http://pinterest.com/pin/create/button/?url=";var r="http://"+window.location.host;var v=r+k.image_url;var q=encodeURIComponent(r+k.view_url);var t="Check out this meshu I just made of the places I've been ";$(".share-pinterest").attr("href",w+q+"&media="+v);$(".share-twitter").attr("href",u+t+"&url="+q);$(".social-media").fadeIn()});var b=function(){var q="http://"+window.location.host;FB.ui({method:"feed",link:q+k.view_url,picture:q+k.image_url,name:k.outputTitle()+" on meshu.io",caption:"meshu turns your places into beautiful objects.",description:""},function(r){if(!r||r.error){}else{}})};$("#shipping-destination li").click(function(){var r=$(this).attr("id").split("-").pop();var q=$("#shipping-destination");$("#checkout").attr("class",r);q.find("li").removeClass("active");$(this).addClass("active");orderer.shippingMode(r)});$("#payment-form").validate({rules:{card_number:{creditcard:true},card_cvc:{digits:true,minlength:3},card_month:{digits:true,minlength:2},card_year:{digits:true,minlength:4,}},messages:{shipping_state:"Please enter the two-letter state abbreviation.",card_cvc:"Sorry, that is not a valid CVC code",card_month:{minlength:"Please enter the month as a two-digit number."},card_year:{minlength:"Please enter the year as a four-digit number.",},},submitHandler:g});$("#postcard-note-form").keyup(function(r){var q=r.target.value;$("#postcard-note").val(q)});$("#coupon-code").submit(function(){var q=$("#coupon-code-value").val();orderer.applyCoupon(q,function(t){if(t.success){var u=parseFloat(t.amount);if(u<1&&u>0){var r=Math.floor(orderer.getPrice()*(1-u));var s=parseInt((1-u)*100);$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>"+s+"% off! -$"+r+".00</span>").insertAfter("#subtotal-price")}else{if(u>1){$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>-$"+u+".00</span>").insertAfter("#subtotal-price")}}$("#coupon-message").fadeIn("fast").html(q+" discount applied!");$(".coupon-form").hide()}else{$("#coupon-message").fadeIn("fast").html("Invalid code.")}i()});return false});$("#review-button").click(function(){if(!user.loggedIn){f()}});$("#submit-button").click(function(q){if(!user.loggedIn){f();return false}orderer.submit()});function g(){if(!user.loggedIn){f(g);return}h.attr("class","review");d("review")}function f(q){user.showModal();user.afterLogIn=function(){if(q){saver.createOrUpdateMeshu(function(){setTimeout(q,200)})}}}function i(){orderer.updateProduct(sb.materializer.product(),sb.materializer.material(),orderer.getShipping());$("#object-type").val(sb.materializer.productName());$("#object-material").val(sb.materializer.material());$("#object-color").val(sb.materializer.color().toLowerCase());$("#object-amount").val(orderer.getTotalCents());$("#svg-theta").val(sb.rotator?sb.rotator.rotation():0);$("#svg-file").val(k.outputSVG());$("#meshu-data").val(k.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:k.outputTitle());$("#postcard-note").val($("#postcard-note-form").val());c();$("#review-shipping").empty();$(".ship-row input").each(function(){var s;var r=function(t){return t.replace(/\w\S*/g,function(u){return u.charAt(0).toUpperCase()+u.substr(1).toLowerCase()})};this.value=r(this.value);switch(this.id){case"ship-city":case"ship-zip":s=$("<span>");break;case"ship-state":this.value=this.value.toUpperCase();s=$("<span>");break;default:s=$("<p>");break}s.text($(this).val()).appendTo("#review-shipping")});var q=$("#card-number").val();$("#review-payment").text("XXXX-XXXX-XXXX-"+q.substring(12,16))}function c(){var q="One "+sb.materializer.displayName();var r=sb.materializer.color().toLowerCase()+" "+sb.materializer.material();$("#review-description").text(q+", made out of "+r);$("#subtotal-price span").text(orderer.getPriceString());$("#shipping-price span").text("$"+orderer.getShipping()+".00");$("#total-price span").text(orderer.getTotalString())}});