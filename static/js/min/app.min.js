$(function(){var o={earrings:{acrylic:{price:75,colors:["Black","White"]},wood:{price:80,colors:["Amber","Blonde"]},nylon:{price:90,colors:["Black","White"]},silver:{price:150}},pendant:{acrylic:{price:75,colors:["Black","White"]},wood:{price:85,colors:["Amber","Blonde"]},nylon:{price:90,colors:["Black","White"]},silver:{price:130}},necklace:{acrylic:{price:80,colors:["Black","White"]},wood:{price:90,colors:["Amber","Blonde"]},nylon:{price:95,colors:["Black","White"]},silver:{price:150}},cufflinks:{stainless:{price:85},silver:{price:160}}};var d={earrings:"pair of earrings",pendant:"small pendant necklace",necklace:"large necklace",cufflinks:"pair of cufflinks"};var l={earrings:"earrings",pendant:"pendant necklace",necklace:"large necklace",cufflinks:"cufflinks"};var k=["edit","product","make","account","checkout","review"];var g=$("#content");orderer.options(o);sb.materializer.initialize(o,d,l);var j=sb.meshu($("#meshu-container")[0]);j.isReadymade=loadedMeshu&&loadedMeshu.product!="";if(loadedMeshu){saver.initialize(j,loadedMeshu.view_url);if($("html").hasClass("svg")){if(j.isReadymade){readymade.initialize(j)}j.locationData(loadedMeshu.location_data)}user.updateLogoutActions(pageType);sb.product.initialize(".delaunay");switch(pageType){case"edit":k=["edit","product","make","account","checkout","review"];break;case"view":k=["view"];break;case"product":var i=$("#product");i.find(".nav").remove();i.find(".make-wrapper").removeClass("make-wrapper");k=["product","make","account","checkout","review"];break;default:k=["readymade","account","checkout","review"];$("#materials").addClass("ready");var i=loadedMeshu.product.length?loadedMeshu.product:"necklace";sb.materializer.product(i);break}$("#finish-button").addClass("active");$("#meshu-container").removeClass("inactive");var n=loadedMeshu.location_data.split("|");$.each(n,function(q,s){var r=s.split("\t");if(r.length==3){var t=document.createElement("div");t.innerHTML=r[2];var p=t.firstChild.nodeValue;$("<li>").html(p).appendTo($("#display-places"))}});d3.select("#place-number").attr("class","").select(".title-text").html(function(p){p.title=loadedMeshu.title;j.updateTitle(p.title);return p.title})}else{saver.initializeNewMeshu(j)}if(user.loggedIn){m()}if(!user.loggedIn&&!loadedMeshu&&window.location.hash!="#skipintro"){$("#edit-help").fadeIn();$("#modal-bg").fadeIn();$("#close-help").click(function(){$("#edit-help").fadeOut();$("#modal-bg").fadeOut()})}else{if(window.location.hash=="#skipintro"){window.location.hash=""}}$(".next").live("click",function(){if(!$(this).hasClass("active")){return}var s=$(this);var p=g.attr("class");var q=k.indexOf(p);var r=function(){g.attr("class",k[q+1])};if(p=="edit"&&user.loggedIn){saver.createOrUpdateMeshu()}if(p=="make"||p=="readymade"){m()}if(p=="account"&&!user.loggedIn){user.afterLogIn=function(){saver.createOrUpdateMeshu(function(){s.click()})};return}c(p);user.updateLogoutActions(p);r()});$(".back").click(function(){var p=g.attr("class");if(p=="checkout"){m()}var q=k.indexOf(p);var r=k[q-1];g.attr("class",r);a(r)});$("#save-and-view").click(function(){var p=function(){saver.createOrUpdateMeshu(function(q){window.location.href=q.meshu_url})};if(!user.loggedIn){e();user.afterLogIn=p}else{p()}});$("#product-preview svg").live("click",function(){var p=$(this).attr("id").split("-")[1];$(".make-option").hide();$("#make-"+p).show();sb.rotator.update(p);sb.materializer.product(p);sb.rotator.on("rotated",sb.product.rotation)});function c(p){switch(p){case"edit":j.updateBounds();j.mesh().updateCircleBehavior();sb.product.initialize(".delaunay");break;case"make":case"readymade":j.mesh().updateCircleBehavior(true);var r=sb.materializer.product();var q=sb.transforms[r]["render"];j.animateTransform(sb.rotator?sb.rotator.rotation():0,q.scale,q.transform.x,q.transform.y);var s=static_url+"images/render/"+r+"_preview.jpg";$(".render").css("background-image","url("+s+")");break;case"review":h();break}}function a(p){switch(p){case"edit":j.mesh().updateCircleBehavior();break;case"make":case"readymade":j.mesh().updateCircleBehavior();j.animateTransform(0,1,0,0);break}}function m(){var p=k.indexOf("account");if(user.loggedIn){if(p>=0){k.splice(p,1)}$("#account").css("visibility","hidden")}else{if(p==-1){k.splice(-2,0,"account")}$("#account").css("visibility","visible")}}$(".show-places").click(function(){$("#display-places").slideToggle();$(".show-places").toggle()});$("#shipping-destination li").click(function(){var q=$(this).attr("id").split("-").pop();var p=$("#shipping-destination");$("#checkout").attr("class",q);p.find("li").removeClass("active");$(this).addClass("active");orderer.shippingMode(q)});$("#payment-form").validate({rules:{card_number:{creditcard:true},card_cvc:{digits:true,minlength:3},card_month:{digits:true,minlength:2},card_year:{digits:true,minlength:4,}},messages:{shipping_state:"Please enter the two-letter state abbreviation.",card_cvc:"Sorry, that is not a valid CVC code",card_month:{minlength:"Please enter the month as a two-digit number."},card_year:{minlength:"Please enter the year as a four-digit number.",},},submitHandler:f});$("#coupon-code").submit(function(){var p=$("#coupon-code-value").val();orderer.applyCoupon(p,function(s){if(s.success){var t=parseFloat(s.amount);if(t<1&&t>0){var q=Math.floor(orderer.getPrice()*(1-t));var r=parseInt((1-t)*100);$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>"+r+"% off! -$"+q+".00</span>").insertAfter("#subtotal-price")}else{if(t>1){$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>-$"+t+".00</span>").insertAfter("#subtotal-price")}}$("#coupon-message").fadeIn("fast").html(p+" discount applied!");$(".coupon-form").hide()}else{$("#coupon-message").fadeIn("fast").html("Oops, invalid code.")}h()});return false});$("#review-button").click(function(){if(!user.loggedIn){e()}});$("#submit-button").click(function(p){if(!user.loggedIn){e();return false}orderer.submit()});function f(){if(!user.loggedIn){e(f);return}g.attr("class","review");c("review")}function e(p){user.showModal();user.afterLogIn=function(){if(p){saver.createOrUpdateMeshu(function(){setTimeout(p,200)})}}}function h(){orderer.updateProduct(sb.materializer.product(),sb.materializer.material(),orderer.getShipping());$("#object-type").val(sb.materializer.productName());$("#object-material").val(sb.materializer.material());$("#object-color").val(sb.materializer.color().toLowerCase());$("#object-amount").val(orderer.getTotalCents());$("#svg-theta").val(sb.rotator?sb.rotator.rotation():0);$("#svg-file").val(j.outputSVG());$("#meshu-data").val(j.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:j.outputTitle());b();$("#review-shipping").empty();$(".ship-row input").each(function(){var r;var q=function(s){return s.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})};this.value=q(this.value);switch(this.id){case"ship-city":case"ship-zip":r=$("<span>");break;case"ship-state":this.value=this.value.toUpperCase();r=$("<span>");break;default:r=$("<p>");break}r.text($(this).val()).appendTo("#review-shipping")});var p=$("#card-number").val();$("#review-payment").text("XXXX-XXXX-XXXX-"+p.substring(12,16))}function b(){var p="One "+sb.materializer.displayName();var q=sb.materializer.color().toLowerCase()+" "+sb.materializer.material();$("#review-description").text(p+", made out of "+q);$("#subtotal-price span").text(orderer.getPriceString());$("#shipping-price span").text("$"+orderer.getShipping()+".00");$("#total-price span").text(orderer.getTotalString())}});