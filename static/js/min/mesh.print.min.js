var sb=sb||{};sb.mesh.print=function(b,x,a,d){var j=sb.mesh.base(b,x,a,d),q=parseInt(Math.random()*10000000000,10);j.name="print";var w=$("body").hasClass("processing");var c=[],r=[],u=[],A=[],D=[],L=[];var h=document.createElement("div");var f=d3.select(b||"body").append("div").attr("id",q).style("width",a).style("height",d).style("position","absolute").style("z-index","1").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var K=f.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var o=d3.select(b||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",a).style("height",d);var e=o.append("svg:svg").attr("width","100%").attr("height","100%");var F=e.append("svg:g").attr("class","delaunay-ui");var i=d3.select("#places");var s=i.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",j.removeInput)}var G=[],l=[],v=[],B=null;var n=$("#content");j.hittest=function(g){return d3.event.target!=e.node()};j.on("draggedMap",function(){z()});j.on("draggedPoint",function(M,N){M[0]=N[0];M[1]=N[1];var g=G.indexOf(M);r[g]=N[0];c[g]=N[1];j.dirty=true;z()});var J=d3.geo.mercator().scale(1).translate([0,0]);var p=d3.geo.path().projection(J);var k;$.getJSON("/static/lib/world_borders.json",function(M){E(parseInt(a),parseInt(d));k=M.features;var g=d3.select(".map").selectAll("path").data(M.features);g.enter().append("path").attr("d",p).attr("class",function(N){return N.properties.ISO2}).style("fill","#d7d7d7").style("stroke","#aaa").style("stroke-width","0");if(loadedMeshu){A.forEach(function(O,N){C(O,true)})}else{j.style({mapStyle:"light",dotColor:"FF3FB4",countryStyle:"on"})}if(w){j.copyMap();mesh.applyStyle(loadedMeshu.metadata);H(j.style().projection,j.style().zoom,j.style().translate)}});j.copyMap=function(){var O=$(".projection-preview").empty();var Q=$(".map").clone();var N=$(".delaunay").clone();var S=$(".delaunay-ui").clone();if(w){$(".delaunay").remove();$(".delaunay-ui").remove()}Q.find("rect").remove();Q=Q.html();var P=d3.selectAll(".projection-preview");var M=P.append("defs");M.append("path").datum({type:"Sphere"}).attr("id","sphere");M.append("clipPath").attr("id","clip").append("use").attr("xlink:href","#sphere");P.append("g").attr("class","projection-clip").append("use").attr("class","fill").attr("xlink:href","#sphere");var g=d3.selectAll(".projection-preview").append("g").attr("class","map");O.find(".map").html(Q);O.append(N);O.append(S);P.selectAll("circle").attr("r",2);var R="zoomed-to-fit";$(".proj").each(function(){if($(this).hasClass("selected")){R=$(this).attr("id")}});H(R)};function H(O,N,g){var P,M=w?parseInt(a):575,T=w?parseInt(d):425;switch(O){case"mercator":P=d3.geo.mercator().scale(M/6.25).translate([M/2,T/2]);break;case"hammer":P=d3.geo.hammer().scale(M/6).translate([M/2,T/2]);break;case"august":P=d3.geo.august().scale(M/11.5).translate([M/2,T/2]);break;case"lagrange":P=d3.geo.lagrange().scale(M/5.57).translate([M/2,T/2]);break;case"eckert1":P=d3.geo.eckert1().scale(M/6).translate([M/2,T/2]);break;case"butterfly":P=d3.geo.polyhedron.butterfly().scale(M/8.45).translate([M/2,5*T/7]);break;case"zoomed-to-fit":E(575,425);P=J;break}var Q=d3.selectAll(".projection-preview").attr("class","projection-preview meshu-svg").classed(O,true);var S=w?5:((O=="zoomed-to-fit")?3:2.5);Q.selectAll("circle").attr("r",S);var R=d3.geo.path().projection(P);var U=Q.select(".map").selectAll("path").data(k).attr("clip-path","url(#clip)").attr("d",R).attr("class",function(W){var V=d3.select("#meshu-container").select("."+W.properties.ISO2).classed("current");d3.select(this).style("fill",V?"white":"#d7d7d7").style("stroke-width",V?"1":"0");return V?(W.properties.ISO2+" current"):W.properties.ISO2});d3.selectAll(".projection-preview #sphere").attr("d",R);y("projection",P);y("design",P);t();m();if(w){J=P;y("meshu-container",J)}j.style({projection:O,scale:P.scale(),translate:P.translate()})}$(".proj").click(function(){$(".proj").removeClass("selected");$(this).addClass("selected");var g=$(this).attr("id");H(g)});$(".map-style li").click(function(){var g=$(this).attr("data-color");j.style({mapStyle:g});$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");t()});$(".dot-style li").click(function(){var g=$(this).attr("data-color");$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");j.style({dotColor:g});m()});$(".country-style li").click(function(){var g=$(this).attr("data-color");j.style({countryStyle:g});$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");t()});function t(O,M){var N=d3.select("#design .projection-preview");var Q,S,g,P,R;var O=j.style().mapStyle,M=j.style().countryStyle;switch(O){case"light":Q="#e7e7e7";S="#d7d7d7";g="#fff";P="#aaa";R="#555";break;case"dark":Q="#222";S="#000";g="#333";P="#666";R="#aaa";break;case"no":Q="#fff";S="#fff";g="#fff";g="#aaa";R="#000";break}N.style("background-color",S);N.select(".fill").attr("fill",Q);N.select(".map").selectAll("path").style("fill",S).style("stroke","none");if(M=="on"){N.select(".map").selectAll("path").filter(function(T){return(A.indexOf(T.properties.ISO2)!=-1)}).style("fill",g).style("stroke",P).each(function(){this.parentNode.appendChild(this)})}N.select(".delaunay").selectAll("path").style("stroke",R)}function m(){d3.select("#design .projection-preview").selectAll("circle").style("fill",j.style().dotColor)}j.addCountry=function(g){A.push(g);C(g,true)};function C(M,g){var N=d3.select(".map").selectAll("path").filter(function(O){return O.properties.ISO2==M}).classed("current",g).each(function(){this.parentNode.appendChild(this)}).style("fill",g?"white":"d7d7d7").style("stroke-width",g?"1":"0")}function E(M,P){J.scale(1).translate([0,0]);var Q=x.getExtent(),g=[J([Math.max(Q[0].lon,-180),Math.max(Q[0].lat,-90)]),J([Math.min(Q[1].lon,180),Math.min(Q[1].lat,90)])],O=0.99/Math.max((g[1][0]-g[0][0])/M,(g[1][1]-g[0][1])/P),N=[(M-O*(g[1][0]+g[0][0]))/2,(P-O*(g[1][1]+g[0][1]))/2];if(M==600){if(O<100){$("#zoomed-to-fit").hide();$("#hammer").css("display","inline-block")}else{$("#zoomed-to-fit").show();$("#hammer").hide()}J.scale(O).translate(N);d3.select("#meshu-container").select(".map").selectAll("path").attr("d",p)}else{J.scale(O).translate(N);d3.selectAll(".projection-preview").select(".map").selectAll("path").attr("d",p)}}j.on("clickedMap",function(g){meshu.findCountry(g);j.add(g[1],g[0],undefined,false)});j.on("removed",function(){if(G.length<3){$("#finish-button").removeClass("active")}if(G.length==1){$("#meshu-container").addClass("inactive")}});j.on("interactiveToggled",function(g){j.updateCircleBehavior(g)});function y(g,P){var N=d3.select("#"+g).select(".delaunay-ui");var O=d3.select("#"+g).select(".delaunay");var S=N.selectAll("circle").data(G);S.attr("cx",function(W){return P(W)[0]}).attr("cy",function(W){return P(W)[1]});var R=[];$.each(G,function(X,W){if(X==G.length-1){return}R.push({points:[G[X],G[X+1]],mode:L[X]})});var V=O.selectAll("path").data(R);var M=d3.scale.linear().domain([0,600]).range([0.5,0.65]);V.enter().append("svg:path");V.exit().remove();V.attr("d",function(ac){var aa=ac.points.length;var ae=[];for(var ab=0;ab<aa;ab++){var af=P(ac.points[ab]);ae.push(af)}var Z=this;if(ac.mode=="air"){var ad=Math.sqrt(Math.pow(ae[0][0]-ae[1][0],2)+Math.pow(ae[0][1]-ae[1][1],2));return"M"+ae[0]+" A "+ad*M(ad)+" "+ad*M(ad)+" 0 0 0 "+ae[1]}else{if(ac.mode=="road"){var X=null;D.forEach(function(ah,ag){if(ah.points[0][0]==ac.points[0][0]&&ah.points[1][1]==ac.points[1][1]){X=U(ah.wayPoints);return}});if(X){return X}var Y="http://open.mapquestapi.com/directions/v1/route?generalize=500&outFormat=json&shapeFormat=raw&generalize=200&from=";var W=Y+ac.points[0][1]+","+ac.points[0][0]+"&to="+ac.points[1][1]+","+ac.points[1][0]+"&key="+mapquestapi;$.ajax({url:W,dataType:"jsonp",success:function(ah){var ag=ah.route.shape.shapePoints;D.push({points:ac.points,wayPoints:ag});d3.select(Z).attr("d",U(ag))}})}else{return"M"+ae[0]+" L"+ae[1]}}}).attr("class",function(W){return W.mode}).style("stroke","#555").style("stroke-width",function(W){return T(W.mode)}).style("stroke-dasharray",function(W){return Q(W.mode)});function T(W){if(W=="air"){if(g=="meshu-container"){return 2}return 1.5}else{if(g=="meshu-container"){return 3}return 2.5}}function Q(W){if(W=="air"){if(g=="meshu-container"){return"4 4"}return"3 3"}return""}function U(Y){var W=[];var ab=Y.length;for(var X=0;X<ab;X+=2){var Z=P([Y[X+1],Y[X]]);W.push(Z)}var aa="M"+W.join("L");return aa}}j.updatePixelBounds=function(){if(c.length&&r.length){v=[J([d3.min(c),d3.min(r)]),J([d3.max(c),d3.min(r)]),J([d3.max(c),d3.max(r)]),J([d3.min(c),d3.max(r)]),]}else{v=[]}};function z(){E(parseInt(a),parseInt(d));var O=F.selectAll("circle").data(G);O.enter().append("svg:circle").attr("id",function(Q,P){return"c-"+P}).attr("r",4).attr("fill","#FF3FB4").on("mousedown",function(P){j.dragging=P;d3.event.stopPropagation()});O.exit().remove();var M=s.selectAll("li.place").data(G);var g=M.enter().append("li").attr("class","place").attr("id",function(Q,P){return"p-"+P});var N=g.append("span").attr("class","mode");N.append("span").attr("class","origin").html("Origin:");N.append("span").attr("class","air selected");N.append("span").attr("class","rail");N.append("span").attr("class","road");N.selectAll("span").on("click",function(S,R){var Q=$(this.parentNode.parentNode).index()-1,P=d3.select(this).attr("class");L[Q]=P;y("meshu-container",J);$(this.parentNode).find("span").removeClass("selected");$(this).addClass("selected")});g.append("span").attr("class","place-text").html(function(Q,P){h.innerHTML=u[P];return h.firstChild.nodeValue});g.append("span").attr("class","place-delete").html("x");M.exit().remove();M.each(function(P){P.edit=false}).attr("id",function(Q,P){return"p-"+P}).select(".place-text").html(function(R,P){var Q=$(this).parent().attr("id").split("-")[1];h.innerHTML=u[Q];return h.firstChild.nodeValue});M.select(".mode").each(function(R,P){if(P==0){return}var Q=d3.select(this).selectAll("span");Q.classed("selected",false);Q.classed("selected",function(T,S){return $(this).attr("class")==L[P-1]})});j.updateCircleBehavior();I();y("meshu-container",J)}j.updateCircleBehavior=function(O){var M=n.hasClass("edit");var g=$("#place-hover");var N=F.selectAll("circle");N.on("mouseover",function(Q,P){if(O){return}else{if(M){s.select("#p-"+P).attr("class","place highlight")}}});N.on("mouseout",function(Q,P){if(O){return}else{if(M){s.select("#p-"+P).attr("class","place")}}})};function I(){var g=s.selectAll("li.place");g.select(".place-delete").on("click",function(N,M){j.remove(M);j.updatePixelBounds();x.updateBounds(c,r);z()});g.on("mouseover",function(N,M){F.select("#c-"+M).attr("class","highlight")});g.on("mouseout",function(N,M){F.select("#c-"+M).attr("class","")});g.select(".place-edit").on("click",function(N,M){G[M].air=!G[M].air;z()});$("#places ul").sortable({axis:"y",cursor:"move"});$("#places ul").disableSelection();$(".place-text").mouseup(function(){var P=[],N=[],O=[],M=[];setTimeout(function(){$("#places li").each(function(R,Q){N.push($(this).find(".place-text").text());d3.select(this).each(function(S){P.push(S);M.push(S[0]);O.push(S[1])})});G=P;u=N;c=O;r=M;z()},100)})}j.add=function(R,N,P,g){var O=parseFloat(R);var Q=parseFloat(N);c.push(O);r.push(Q);x.updateBounds(c,r);if(P==undefined){u.push(R.toFixed(3)+", "+N.toFixed(3))}else{u.push(P)}if(G.length){$("#meshu-container").removeClass("inactive");l=[Q,O];L.push("air");if(g){G.push([l[0],l[1]]);j.updatePixelBounds();z();y("meshu-container",J)}else{var M=G[G.length-1];G.push([l[0],l[1]]);j.updatePixelBounds();z()}}else{G.push([Q,O]);z()}j.dirty=true;j.added();return j};j.remove=function(g){var M=A[g];G.splice(g,1);c.splice(g,1);r.splice(g,1);u.splice(g,1);A.splice(g,1);if(g==0){L.splice(g,1)}else{L.splice(g-1,1)}if(A.indexOf(M)==-1){C(M,false)}if(G.length<3){$("#finish-button").removeClass("active")}if(G.length==1){$("#meshu-container").addClass("inactive")}};j.lats=function(){return c};j.lons=function(){return r};j.places=function(){return u};j.points=function(g){if(!arguments.length){return G}G=g;return j};j.locations=function(M,g){mesh.applyStyle(loadedMeshu.metadata);A=j.style().countries.split(",");D=j.style().roadData.split(",");L=j.style().modes.split(",");G=[];c=[];r=[];u=[];$.each(M,function(N,O){G.push([O.longitude,O.latitude]);c.push(O.latitude);r.push(O.longitude);u.push(O.name)});j.locationsSet();if(w){d3.select(".map").attr("height","1275px").select(".layer").remove();d3.select("#meshu-container").append("svg").attr("class","projection-preview").attr("width",a).attr("height",d).style("position","absolute").style("top","0")}return j};j.refresh=function(){z();j.refreshed()};j.updateTitle=function(g){B=g};j.outputTitle=function(){return B||"My Meshu"};j.output=function(){var P=$(".projection-preview").last().clone();P.find(".map").remove();P.find("#sphere").attr("id","sphere-"+q);var M=P[0].outerHTML;M=M.split("#sphere").join("#sphere-"+q);var g=A.join(","),N=D.join(","),O=L.join(",");j.style({countries:g,roadData:N,modes:O});return M};j.getProjection=function(g){return J.invert(g)};return j};