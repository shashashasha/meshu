var sb=sb||{};sb.mesh.print=function(o,G,w,u){var t=sb.mesh.base(o,G,w,u),y=parseInt(Math.random()*10000000000,10);t.name="print";var v=$("body").hasClass("processing");var C=[],m=[],p=[],c=[],n=[],b=[];var k=document.createElement("div");var j=d3.select(o||"body").append("div").attr("id",y).style("width",w).style("height",u).style("position","absolute").style("z-index","1").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var E=j.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var d=d3.select(o||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",w).style("height",u);var s=d.append("svg:svg").attr("width","100%").attr("height","100%");var r=s.append("svg:g").attr("class","delaunay-ui");var q=d3.select("#places");var F=q.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",t.removeInput)}var B=[],A=[],x=[],a=null;var z=$("#content");t.hittest=function(g){return d3.event.target!=s.node()};t.on("draggedMap",function(){l()});t.on("draggedPoint",function(K,L){K[0]=L[0];K[1]=L[1];var g=B.indexOf(K);m[g]=L[0];C[g]=L[1];t.dirty=true;l()});var I=d3.geo.mercator().scale(1).translate([0,0]);var f=d3.geo.path().projection(I);var i;$.getJSON("/static/lib/world_borders.json",function(K){J(parseInt(w),parseInt(u));i=K.features;var g=d3.select(".map").selectAll("path").data(K.features);g.enter().append("path").attr("d",f).attr("class",function(L){return L.properties.ISO2}).style("fill","#d7d7d7").style("stroke","#aaa").style("stroke-width","0");if(loadedMeshu){c.forEach(function(M,L){e(M,true)})}if(v){t.copyMap();mesh.applyStyle(loadedMeshu.metadata);D(t.style().projection,t.style().zoom,t.style().translate)}});t.copyMap=function(){var M=$(".projection-preview").empty();var O=$(".map").clone();var L=$(".delaunay").clone();var Q=$(".delaunay-ui").clone();if(v){$(".delaunay").remove();$(".delaunay-ui").remove()}O.find("rect").remove();O=O.html();var N=d3.select(".projection-preview");var K=N.append("defs");K.append("path").datum({type:"Sphere"}).attr("id","sphere");K.append("clipPath").attr("id","clip").append("use").attr("xlink:href","#sphere");N.append("g").attr("class","projection-clip").append("use").attr("class","fill").attr("xlink:href","#sphere");var g=d3.select(".projection-preview").append("g").attr("class","map");M.find(".map").html(O);M.append(L);M.append(Q);N.selectAll("circle").attr("r",2);var P="zoomed-to-fit";$(".proj").each(function(){if($(this).hasClass("selected")){P=$(this).attr("id")}});D(P)};function D(M,L,g){var N,K=v?parseInt(w):575,R=v?parseInt(u):425;switch(M){case"mercator":N=d3.geo.mercator().scale(K/6.25).translate([K/2,R/2]);break;case"hammer":N=d3.geo.hammer().scale(K/6).translate([K/2,R/2]);break;case"august":N=d3.geo.august().scale(K/11.5).translate([K/2,R/2]);break;case"lagrange":N=d3.geo.lagrange().scale(K/5.57).translate([K/2,R/2]);break;case"eckert1":N=d3.geo.eckert1().scale(K/6).translate([K/2,R/2]);break;case"butterfly":N=d3.geo.polyhedron.butterfly().scale(K/8.45).translate([K/2,5*R/7]);break;case"zoomed-to-fit":J(425,275);N=I;break}var O=d3.select(".projection-preview").attr("class","projection-preview meshu-svg").classed(M,true);var Q=v?5:((M=="zoomed-to-fit")?3:2);O.selectAll("circle").attr("r",Q);var P=d3.geo.path().projection(N);var S=O.select(".map").selectAll("path").data(i).attr("clip-path","url(#clip)").attr("d",P).attr("class",function(U){var T=d3.select("#meshu-container").select("."+U.properties.ISO2).classed("current");d3.select(this).style("fill",T?"white":"#d7d7d7").style("stroke-width",T?"1":"0");return T?(U.properties.ISO2+" current"):U.properties.ISO2});d3.select(".projection-preview #sphere").attr("d",P);h("projection",N);if(v){I=N;h("meshu-container",I)}t.style({projection:M,scale:N.scale(),translate:N.translate()})}$(".proj").click(function(){$(".proj").removeClass("selected");$(this).addClass("selected");var g=$(this).attr("id");D(g)});t.addCountry=function(g){c.push(g);e(g,true)};function e(K,g){var L=d3.select(".map").selectAll("path").filter(function(M){return M.properties.ISO2==K}).classed("current",g).each(function(){this.parentNode.appendChild(this)}).style("fill",g?"white":"d7d7d7").style("stroke-width",g?"1":"0")}function J(K,N){I.scale(1).translate([0,0]);var O=G.getExtent(),g=[I([Math.max(O[0].lon,-180),Math.max(O[0].lat,-90)]),I([Math.min(O[1].lon,180),Math.min(O[1].lat,90)])],M=0.99/Math.max((g[1][0]-g[0][0])/K,(g[1][1]-g[0][1])/N),L=[(K-M*(g[1][0]+g[0][0]))/2,(N-M*(g[1][1]+g[0][1]))/2];if(parseInt(w)==600){if(M<100){$("#zoomed-to-fit").hide();$("#hammer").css("display","inline-block")}else{$("#zoomed-to-fit").show();$("#hammer").hide()}I.scale(M).translate(L);d3.select(o).select(".map").selectAll("path").attr("d",f)}else{L=[L[0]+75,L[1]+75];I.scale(M).translate(L);d3.select(".projection-preview").select(".map").selectAll("path").attr("d",f)}}t.on("clickedMap",function(g){meshu.findCountry(g);t.add(g[1],g[0],undefined,false)});t.on("removed",function(){if(B.length<3){$("#finish-button").removeClass("active")}if(B.length==1){$("#meshu-container").addClass("inactive")}});t.on("interactiveToggled",function(g){t.updateCircleBehavior(g)});function h(g,N){var L=d3.select("#"+g).select(".delaunay-ui");var M=d3.select("#"+g).select(".delaunay");var P=L.selectAll("circle").data(B);P.attr("cx",function(S){return N(S)[0]}).attr("cy",function(S){return N(S)[1]});var O=[];$.each(B,function(T,S){if(T==B.length-1){return}O.push({points:[B[T],B[T+1]],mode:b[T]})});var R=M.selectAll("path").data(O);var K=d3.scale.linear().domain([0,600]).range([0.5,0.65]);R.enter().append("svg:path");R.exit().remove();R.attr("d",function(Y){var W=Y.points.length;var aa=[];for(var X=0;X<W;X++){var ab=N(Y.points[X]);aa.push(ab)}var V=this;if(Y.mode=="air"){var Z=Math.sqrt(Math.pow(aa[0][0]-aa[1][0],2)+Math.pow(aa[0][1]-aa[1][1],2));return"M"+aa[0]+" A "+Z*K(Z)+" "+Z*K(Z)+" 0 0 0 "+aa[1]}else{if(Y.mode=="road"){var T=null;n.forEach(function(ad,ac){if(ad.points[0][0]==Y.points[0][0]&&ad.points[1][1]==Y.points[1][1]){T=Q(ad.wayPoints);return}});if(T){return T}var U="http://open.mapquestapi.com/directions/v1/route?generalize=500&outFormat=json&shapeFormat=raw&generalize=200&from=";var S=U+Y.points[0][1]+","+Y.points[0][0]+"&to="+Y.points[1][1]+","+Y.points[1][0]+"&key="+mapquestapi;$.ajax({url:S,dataType:"jsonp",success:function(ad){var ac=ad.route.shape.shapePoints;n.push({points:Y.points,wayPoints:ac});d3.select(V).attr("d",Q(ac))}})}else{return"M"+aa[0]+" L"+aa[1]}}}).attr("class",function(S){return S.mode}).style("stroke","#555").style("stroke-width",function(S){return(S.mode=="air")?2:3}).style("stroke-dasharray",function(S){return(S.mode=="air")?"4 4":""});function Q(U){var S=[];var X=U.length;for(var T=0;T<X;T+=2){var V=N([U[T+1],U[T]]);S.push(V)}var W="M"+S.join("L");return W}}t.updatePixelBounds=function(){if(C.length&&m.length){x=[I([d3.min(C),d3.min(m)]),I([d3.max(C),d3.min(m)]),I([d3.max(C),d3.max(m)]),I([d3.min(C),d3.max(m)]),]}else{x=[]}};function l(){J(parseInt(w),parseInt(u));var M=r.selectAll("circle").data(B);M.enter().append("svg:circle").attr("id",function(O,N){return"c-"+N}).attr("r",4).attr("fill","#FF3FB4").on("mousedown",function(N){t.dragging=N;d3.event.stopPropagation()});M.exit().remove();var K=F.selectAll("li.place").data(B);var g=K.enter().append("li").attr("class","place").attr("id",function(O,N){return"p-"+N});var L=g.append("span").attr("class","mode");L.append("span").attr("class","origin").html("Origin:");L.append("span").attr("class","air selected");L.append("span").attr("class","rail");L.append("span").attr("class","road");L.selectAll("span").on("click",function(Q,P){var O=$(this.parentNode.parentNode).index()-1,N=d3.select(this).attr("class");b[O]=N;h("meshu-container",I);$(this.parentNode).find("span").removeClass("selected");$(this).addClass("selected")});g.append("span").attr("class","place-text").html(function(O,N){k.innerHTML=p[N];return k.firstChild.nodeValue});g.append("span").attr("class","place-delete").html("x");K.exit().remove();K.each(function(N){N.edit=false}).attr("id",function(O,N){return"p-"+N}).select(".place-text").html(function(P,N){var O=$(this).parent().attr("id").split("-")[1];k.innerHTML=p[O];return k.firstChild.nodeValue});K.select(".mode").each(function(P,N){if(N==0){return}var O=d3.select(this).selectAll("span");O.classed("selected",false);O.classed("selected",function(R,Q){return $(this).attr("class")==b[N-1]})});t.updateCircleBehavior();H();h("meshu-container",I)}t.updateCircleBehavior=function(M){var K=z.hasClass("edit");var g=$("#place-hover");var L=r.selectAll("circle");L.on("mouseover",function(O,N){if(M){return}else{if(K){F.select("#p-"+N).attr("class","place highlight")}}});L.on("mouseout",function(O,N){if(M){return}else{if(K){F.select("#p-"+N).attr("class","place")}}})};function H(){var g=F.selectAll("li.place");g.select(".place-delete").on("click",function(L,K){t.remove(K);t.updatePixelBounds();G.updateBounds(C,m);l()});g.on("mouseover",function(L,K){r.select("#c-"+K).attr("class","highlight")});g.on("mouseout",function(L,K){r.select("#c-"+K).attr("class","")});g.select(".place-edit").on("click",function(L,K){B[K].air=!B[K].air;l()});$("#places ul").sortable({axis:"y",cursor:"move"});$("#places ul").disableSelection();$(".place-text").mouseup(function(){var N=[],L=[],M=[],K=[];setTimeout(function(){$("#places li").each(function(P,O){L.push($(this).find(".place-text").text());d3.select(this).each(function(Q){N.push(Q);K.push(Q[0]);M.push(Q[1])})});B=N;p=L;C=M;m=K;l()},100)})}t.add=function(P,L,N,g){var M=parseFloat(P);var O=parseFloat(L);C.push(M);m.push(O);G.updateBounds(C,m);if(N==undefined){p.push(P.toFixed(3)+", "+L.toFixed(3))}else{p.push(N)}if(B.length){$("#meshu-container").removeClass("inactive");A=[O,M];b.push("air");if(g){B.push([A[0],A[1]]);t.updatePixelBounds();l();h("meshu-container",I)}else{var K=B[B.length-1];B.push([A[0],A[1]]);t.updatePixelBounds();l()}}else{B.push([O,M]);l()}t.dirty=true;t.added();return t};t.remove=function(g){var K=c[g];B.splice(g,1);C.splice(g,1);m.splice(g,1);p.splice(g,1);c.splice(g,1);if(g==0){b.splice(g,1)}else{b.splice(g-1,1)}if(c.indexOf(K)==-1){e(K,false)}if(B.length<3){$("#finish-button").removeClass("active")}if(B.length==1){$("#meshu-container").addClass("inactive")}};t.lats=function(){return C};t.lons=function(){return m};t.places=function(){return p};t.points=function(g){if(!arguments.length){return B}B=g;return t};t.locations=function(K,g){mesh.applyStyle(loadedMeshu.metadata);c=t.style().countries.split(",");n=t.style().roadData.split(",");b=t.style().modes.split(",");B=[];C=[];m=[];p=[];$.each(K,function(L,M){B.push([M.longitude,M.latitude]);C.push(M.latitude);m.push(M.longitude);p.push(M.name)});t.locationsSet();if(v){d3.select(".map").attr("height","1275px").select(".layer").remove();d3.select("#meshu-container").append("svg").attr("class","projection-preview").attr("width",w).attr("height",u).style("position","absolute").style("top","0")}return t};t.refresh=function(){l();t.refreshed()};t.updateTitle=function(g){a=g};t.outputTitle=function(){return a||"My Meshu"};t.output=function(){var N=$(".projection-preview").clone();N.find(".map").remove();N.find("#sphere").attr("id","sphere-"+y);var K=N[0].outerHTML;K=K.split("#sphere").join("#sphere-"+y);var g=c.join(","),L=n.join(","),M=b.join(",");t.style({countries:g,roadData:L,modes:M});return K};t.getProjection=function(g){return I.invert(g)};return t};