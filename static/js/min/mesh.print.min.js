var sb=sb||{};sb.mesh.print=function(b,y,a,d){var j=sb.mesh.base(b,y,a,d),q=parseInt(Math.random()*10000000000,10);j.name="print";var x=$("body").hasClass("processing");var c=[],r=[],v=[],B=[],E=[],M=[];var h=document.createElement("div");var f=d3.select(b||"body").append("div").attr("id",q).style("width",a).style("height",d).style("position","absolute").style("z-index","1").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var L=f.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var o=d3.select(b||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",a).style("height",d);var e=o.append("svg:svg").attr("width","100%").attr("height","100%");var G=e.append("svg:g").attr("class","delaunay-ui");var i=d3.select("#places");var s=i.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",j.removeInput)}$(b).append($("<div>").attr("class","route-error").text("Sorry, no route found! Try another mode?"));var H=[],l=[],w=[],C=null;var n=$("#content");j.hittest=function(g){return d3.event.target!=e.node()};j.on("draggedMap",function(){A()});j.on("draggedPoint",function(N,O){N[0]=O[0];N[1]=O[1];var g=H.indexOf(N);r[g]=O[0];c[g]=O[1];j.dirty=true;A()});var K=d3.geo.mercator().scale(1).translate([0,0]);var p=d3.geo.path().projection(K);var k;$.getJSON("/static/lib/world_borders.json",function(N){F(parseInt(a),parseInt(d));k=N.features;var g=d3.select(".map").selectAll("path").data(N.features);g.enter().append("path").attr("d",p).attr("class",function(O){return O.properties.ISO2}).style("fill","#bbb").style("stroke","#aaa").style("stroke-width","0");if(loadedMeshu){B.forEach(function(P,O){D(P,true)});$("#"+j.style().projection).click();$(".map-style").find("li[data-color="+j.style().mapStyle+"]").click();$(".dot-style").find("li[data-color="+j.style().dotColor+"]").click();$(".country-style").find("li[data-color="+j.style().countryStyle+"]").click()}else{j.style({mapStyle:"light",dotColor:"FF3FB4",countryStyle:"on"})}if(x){j.copyMap();mesh.applyStyle(loadedMeshu.metadata);I(j.style().projection,j.style().zoom,j.style().translate);u("meshu-container");m("meshu-container")}});j.copyMap=function(){var P=$(".projection-preview").empty();var S=$(".map").clone();var U=$(".delaunay").clone();var R=$(".delaunay-ui").clone();if(x){$(".delaunay").remove();$(".delaunay-ui").remove()}S.find("rect").remove();var T=d3.select(S).node()[0];var Q=d3.selectAll(".projection-preview");var O=Q.append("defs");O.append("path").datum({type:"Sphere"}).attr("id","sphere-"+q);O.append("clipPath").attr("id","clip").append("use").attr("xlink:href","#sphere-"+q);Q.append("g").attr("class","projection-clip").append("use").attr("class","fill").attr("xlink:href","#sphere-"+q);var N=d3.selectAll(".projection-preview").append("g").attr("class","map");P.find(".map").html(T);P.append(U);P.append(R);Q.selectAll("circle").attr("r",2);var g="zoomed-to-fit";$(".proj").each(function(){if($(this).hasClass("selected")){g=$(this).attr("id")}});I(g)};function I(P,O,g){var Q,N=x?parseInt(a):575,V=x?parseInt(d):425;switch(P){case"mercator":Q=d3.geo.mercator().scale(N/6.25).translate([N/2,V/2]);break;case"hammer":Q=d3.geo.hammer().scale(N/6).translate([N/2,V/2]);break;case"august":Q=d3.geo.august().scale(N/11.5).translate([N/2,V/2]);break;case"lagrange":Q=d3.geo.lagrange().scale(N/5.57).translate([N/2,V/2]);break;case"eckert1":Q=d3.geo.eckert1().scale(N/6).translate([N/2,V/2]);break;case"butterfly":Q=d3.geo.polyhedron.butterfly().scale(N/8.45).translate([N/2,5*V/7]);break;case"zoomed-to-fit":F(N,V,0.8);Q=K;break}var R=d3.selectAll(".projection-preview").attr("class","projection-preview meshu-svg").classed(P,true);R.style("background-color",(P=="zoomed-to-fit")?"#e7e7e7":"#bbb");var T=11;R.selectAll("circle").attr("r",T);var U=x?parseInt(a)/2500:1;var S=d3.geo.path().projection(Q);var W=R.select(".map").selectAll("path").data(k).attr("clip-path","url(#clip)").attr("d",S).attr("class",function(Y){var X=d3.select("#meshu-container").select("."+Y.properties.ISO2).classed("current");d3.select(this).style("fill",X?"white":"#bbb").style("stroke-width",X?U:"0");return X?(Y.properties.ISO2+" current"):Y.properties.ISO2});d3.selectAll(".projection-preview #sphere-"+q).attr("d",S);z("projection",Q);z("design",Q);if(x){K=Q;z("meshu-container",K)}j.style({projection:P,scale:Q.scale(),translate:Q.translate()});u("design");m("design")}$(".proj").click(function(){$(".proj").removeClass("selected");$(this).addClass("selected");var g=$(this).attr("id");I(g)});$(".map-style li").click(function(){var g=$(this).attr("data-color");j.style({mapStyle:g});$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");u("design")});$(".dot-style li").click(function(){var g=$(this).attr("data-color");$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");j.style({dotColor:g});m("design")});$(".country-style li").click(function(){var g=$(this).attr("data-color");j.style({countryStyle:g});$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");u("design")});$(".frame-wrapper").click(function(){if($(this).attr("id").split("-")[1]!=sb.materializer.product()){return}if($(this).hasClass("selected")){sb.materializer.material("unframed");sb.ui.orderer.updated();$(this).removeClass("selected")}else{sb.materializer.material("framed");$(".frame-wrapper").removeClass("selected");$(this).addClass("selected");sb.ui.orderer.updated()}});function u(N){var O=d3.select("#"+N+" .projection-preview");var Q,R,S,U,T;var g=j.style().mapStyle,P=j.style().countryStyle;switch(g){case"light":Q="#e7e7e7";R="#bbb";S="#fff";U="#aaa";T="#555";break;case"dark":Q="#222";R="#000";S="#333";U="#666";T="#aaa";break;case"no":Q="#fff";R="#fff";S="#e7e7e7";U="#e7e7e7";T="#000";break}if(j.style().projection=="zoomed-to-fit"){O.style("background-color",Q)}else{O.style("background-color",R)}O.select(".fill").attr("fill",Q);O.select(".map").selectAll("path").style("fill",R).style("stroke","none");if(P=="on"){O.select(".map").selectAll("path").filter(function(V){return(B.indexOf(V.properties.ISO2)!=-1)}).style("fill",S).style("stroke",U).each(function(){this.parentNode.appendChild(this)})}O.select(".delaunay").selectAll("path").style("stroke",T)}function m(g){d3.select("#"+g+" .projection-preview").selectAll("circle").style("fill","#"+j.style().dotColor)}j.addCountry=function(g){B.push(g);D(g,true)};function D(N,g){var O=d3.select(".map").selectAll("path").filter(function(P){return P.properties.ISO2==N}).classed("current",g).each(function(){this.parentNode.appendChild(this)}).style("fill",g?"white":"#bbb").style("stroke-width",g?"1":"0")}function F(N,P,R){K.scale(1).translate([0,0]);var Q=y.getExtent(),g=[K([Math.max(Q[0].lon,-180),Math.max(Q[0].lat,-90)]),K([Math.min(Q[1].lon,180),Math.min(Q[1].lat,90)])],O=4000;t=[-3001.3382763718755,3232.9078758098653];console.log(t);if(N==600){if(O<100){$("#zoomed-to-fit").hide();$("#hammer").css("display","inline-block")}else{$("#zoomed-to-fit").show();$("#hammer").hide()}K.scale(O).translate(t);d3.select("#meshu-container").select(".map").selectAll("path").attr("d",p)}else{K.scale(O).translate(t);d3.selectAll(".projection-preview").select(".map").selectAll("path").attr("d",p)}}j.on("clickedMap",function(g){meshu.findCountry(g);j.add(g[1],g[0],undefined,false)});j.on("removed",function(){if(H.length<3){$("#finish-button").removeClass("active")}if(H.length==1){$("#meshu-container").addClass("inactive")}});function z(g,Q){var O=d3.select("#"+g).select(".delaunay-ui");var P=d3.select("#"+g).select(".delaunay");var T=O.selectAll("circle").data(H);T.attr("cx",function(X){return Q(X)[0]}).attr("cy",function(X){return Q(X)[1]});var S=[];$.each(H,function(Y,X){if(Y==H.length-1){return}S.push({points:[H[Y],H[Y+1]],mode:M[Y]})});var W=P.selectAll("path").data(S);var N=d3.scale.linear().domain([0,2600]).range([0.5,0.65]);W.enter().append("svg:path");W.exit().remove();W.attr("d",function(ad){var ab=ad.points.length;var af=[];for(var ac=0;ac<ab;ac++){var ag=Q(ad.points[ac]);af.push(ag)}var aa=this;if(ad.mode=="air"){var ae=Math.sqrt(Math.pow(af[0][0]-af[1][0],2)+Math.pow(af[0][1]-af[1][1],2));return"M"+af[0]+" A "+ae*N(ae)+" "+ae*N(ae)+" 0 0 0 "+af[1]}else{if(ad.mode=="road"){var Y=null;if(!loadedMeshu){E.forEach(function(ai,ah){if(ai.points[0][0]==ad.points[0][0]&&ai.points[1][1]==ad.points[1][1]){Y=V(ai.wayPoints);return}});if(Y=="undefined"){return""}else{if(Y){return Y}}}var Z="http://open.mapquestapi.com/directions/v1/route?generalize=500&outFormat=json&shapeFormat=raw&generalize=200&from=";var X=Z+ad.points[0][1]+","+ad.points[0][0]+"&to="+ad.points[1][1]+","+ad.points[1][0]+"&key="+mapquestapi;$.ajax({url:X,dataType:"jsonp",success:function(ai){var ah=[];if(ai.info.statuscode!=0){$(".route-error").fadeIn().delay(3000).fadeOut("slow");E.push({points:ad.points,wayPoints:ah});d3.select(aa).attr("d","")}else{ah=ai.route.shape.shapePoints;E.push({points:ad.points,wayPoints:ah});d3.select(aa).attr("d",V(ah))}}})}else{return"M"+af[0]+" L"+af[1]}}}).attr("class",function(X){return X.mode}).style("stroke","#555").style("stroke-width",function(X){return U(X.mode)}).style("stroke-dasharray",function(X){return R(X.mode)});function U(Y){if(x){var X=parseInt(a);return 9}if(Y=="air"){if(g=="meshu-container"){return 2}return 1.5}else{if(g=="meshu-container"){return 3}return 2.5}}function R(Y){if(Y!="air"){return}if(x){var X=parseInt(a);return"15 15"}if(g=="meshu-container"){return"4 4"}return"3 3"}function V(Z){var X=[];var ac=Z.length;for(var Y=0;Y<ac;Y+=2){var aa=Q([Z[Y+1],Z[Y]]);X.push(aa)}var ab="M"+X.join("L");return(Z.length==0)?"undefined":ab}}function A(){F(parseInt(a),parseInt(d));var P=G.selectAll("circle").data(H);P.enter().append("svg:circle").attr("id",function(R,Q){return"c-"+Q}).attr("r",4).attr("fill","#FF3FB4").on("mousedown",function(Q){j.dragging=Q;d3.event.stopPropagation()});P.exit().remove();var N=s.selectAll("li.place").data(H);var g=N.enter().append("li").attr("class","place").attr("id",function(R,Q){return"p-"+Q});var O=g.append("span").attr("class","mode");O.append("span").attr("class","origin").html("Origin:");O.append("span").attr("class","air selected");O.append("span").attr("class","rail");O.append("span").attr("class","road");O.selectAll("span").on("click",function(T,S){var R=$(this.parentNode.parentNode).index()-1,Q=d3.select(this).attr("class");M[R]=Q;z("meshu-container",K);$(this.parentNode).find("span").removeClass("selected");$(this).addClass("selected")});g.append("span").attr("class","place-text").html(function(R,Q){h.innerHTML=v[Q];return h.firstChild.nodeValue});g.append("span").attr("class","place-delete").html("x");N.exit().remove();N.each(function(Q){Q.edit=false}).attr("id",function(R,Q){return"p-"+Q}).select(".place-text").html(function(S,Q){var R=$(this).parent().attr("id").split("-")[1];h.innerHTML=v[R];return h.firstChild.nodeValue});N.select(".mode").each(function(S,Q){if(Q==0){return}var R=d3.select(this).selectAll("span");R.classed("selected",false);R.classed("selected",function(U,T){return $(this).attr("class")==M[Q-1]})});J();z("meshu-container",K)}function J(){var N=s.selectAll("li.place");N.select(".place-delete").on("click",function(P,O){j.remove(O);y.updateBounds(c,r);A()});var g=0;if(!x){$("#places ul").sortable({axis:"y",cursor:"move",start:function(O,P){g=P.item.index()},stop:function(P,Q){var O=Q.item.index();if(g==O){return}v.splice(O,0,v.splice(g,1)[0]);H.splice(O,0,H.splice(g,1)[0]);c.splice(O,0,c.splice(g,1)[0]);r.splice(O,0,r.splice(g,1)[0]);B.splice(O,0,B.splice(g,1)[0]);g=0}});$("#places ul").disableSelection()}}j.add=function(S,O,Q,g){var P=parseFloat(S);var R=parseFloat(O);c.push(P);r.push(R);y.updateBounds(c,r);if(Q==undefined){v.push(S.toFixed(3)+", "+O.toFixed(3))}else{v.push(Q)}if(H.length){$("#meshu-container").removeClass("inactive");l=[R,P];M.push("air");if(g){H.push([l[0],l[1]]);A();z("meshu-container",K)}else{var N=H[H.length-1];H.push([l[0],l[1]]);A()}}else{H.push([R,P]);A()}j.dirty=true;j.added();return j};j.remove=function(g){var N=B[g];H.splice(g,1);c.splice(g,1);r.splice(g,1);v.splice(g,1);B.splice(g,1);if(g==0){M.splice(g,1)}else{M.splice(g-1,1)}if(B.indexOf(N)==-1){D(N,false)}if(H.length<3){$("#finish-button").removeClass("active")}if(H.length==1){$("#meshu-container").addClass("inactive")}};j.lats=function(){return c};j.lons=function(){return r};j.places=function(){return v};j.points=function(g){if(!arguments.length){return H}H=g;return j};j.locations=function(N,g){mesh.applyStyle(loadedMeshu.metadata);B=j.style().countries.split(",");M=j.style().modes.split(",");H=[];c=[];r=[];v=[];$.each(N,function(O,P){H.push([P.longitude,P.latitude]);c.push(P.latitude);r.push(P.longitude);v.push(P.name)});j.locationsSet();if(x){d3.select(".map").attr("height","100%").select(".layer").remove();d3.select("#meshu-container").append("svg").attr("class","projection-preview").style("position","absolute").style("top","0")}return j};j.refresh=function(){A();j.refreshed()};j.updateTitle=function(g){C=g};j.outputTitle=function(){return C||"My Meshu"};j.output=function(){var O=$(".projection-preview").last().clone();O.find(".map").remove();var g=B.join(","),N=M.join(",");j.style({countries:g,modes:N});return new XMLSerializer().serializeToString(d3.select(O).node()[0])};j.getProjection=function(g){return K.invert(g)};return j};