var sb=sb||{};sb.mesh.print=function(o,F,v,t){var s=sb.mesh.base(o,F,v,t),x=parseInt(Math.random()*10000000000,10);s.name="print";var B=[],m=[],p=[],c=[],n=[],b=[];var k=document.createElement("div");var j=d3.select(o||"body").append("div").attr("id",x).style("width",v).style("height",t).style("position","absolute").style("z-index","1").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var D=j.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var d=d3.select(o||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",v).style("height",t);var u=d.append("svg:svg").attr("width","100%").attr("height","100%");var r=u.append("svg:g").attr("class","delaunay-ui");var q=d3.select("#places");var E=q.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",s.removeInput)}var A=[],z=[],w=[],a=null;var y=$("#content");s.hittest=function(g){return d3.event.target!=u.node()};s.on("draggedMap",function(){l()});s.on("draggedPoint",function(J,K){J[0]=K[0];J[1]=K[1];var g=A.indexOf(J);m[g]=K[0];B[g]=K[1];s.dirty=true;l()});var H=d3.geo.mercator().scale(1).translate([0,0]);var f=d3.geo.path().projection(H);var i;$.getJSON("/static/lib/world_borders.json",function(J){I(600,600);i=J.features;var g=d3.select(".map").selectAll("path").data(J.features);g.enter().append("path").attr("d",f).attr("class",function(K){return K.properties.ISO2}).style("fill","#d7d7d7").style("stroke","#aaa").style("stroke-width","0")});s.copyMap=function(){var L=$(".projection-preview").empty();var N=$(".map").clone();var K=$(".delaunay").clone();var P=$(".delaunay-ui").clone();N.find("rect").remove();N=N.html();var M=d3.select(".projection-preview");var J=M.append("defs");J.append("path").datum({type:"Sphere"}).attr("id","sphere");J.append("clipPath").attr("id","clip").append("use").attr("xlink:href","#sphere");M.append("use").attr("class","fill").attr("xlink:href","#sphere");var g=d3.select(".projection-preview").append("g").attr("class","map");L.find(".map").html(N);L.append(K);L.append(P);M.selectAll("circle").attr("r",2);var O="zoomed-to-fit";$(".proj").each(function(){if($(this).hasClass("selected")){O=$(this).attr("id")}});C(O)};function C(J){var M;switch(J){case"mercator":M=d3.geo.mercator().scale(92).translate([287,212]);break;case"hammer":M=d3.geo.hammer().scale(95).translate([287,212]);break;case"august":M=d3.geo.august().scale(50).translate([287,212]);break;case"lagrange":M=d3.geo.lagrange().scale(100).translate([287,212]);break;case"eckert1":M=d3.geo.eckert1().scale(95).translate([287,212]);break;case"butterfly":M=d3.geo.polyhedron.butterfly().scale(68).translate([287,310]);break;case"zoomed-to-fit":I(425,275);M=H;break}var L=d3.select(".projection-preview").attr("class","projection-preview").classed(J,true);L.selectAll("circle").attr("r",(J=="zoomed-to-fit")?3:2);var K=d3.geo.path().projection(M);var g=L.select(".map").selectAll("path").data(i).attr("clip-path","url(#clip)").attr("d",K).attr("class",function(O){var N=d3.select("#meshu-container").select("."+O.properties.ISO2).classed("current");d3.select(this).style("fill",N?"white":"#d7d7d7").style("stroke-width",N?"1":"0");return N?(O.properties.ISO2+" current"):O.properties.ISO2});d3.select(".projection-preview #sphere").attr("d",K);h("projection",M);s.style({projection:J,scale:M.scale(),translate:M.translate()})}$(".proj").click(function(){$(".proj").removeClass("selected");$(this).addClass("selected");var g=$(this).attr("id");C(g)});s.addCountry=function(g){c.push(g);e(g,true)};function e(J,g){var K=d3.select(".map").selectAll("path").filter(function(L){return L.properties.ISO2==J}).classed("current",g).each(function(){this.parentNode.appendChild(this)}).style("fill",g?"white":"d7d7d7").style("stroke-width",g?"1":"0")}function I(M,J){H.scale(1).translate([0,0]);var N=F.getExtent(),g=[H([Math.max(N[0].lon,-180),Math.max(N[0].lat,-90)]),H([Math.min(N[1].lon,180),Math.min(N[1].lat,90)])],L=0.9/Math.max((g[1][0]-g[0][0])/M,(g[1][1]-g[0][1])/J),K=[(M-L*(g[1][0]+g[0][0]))/2,(J-L*(g[1][1]+g[0][1]))/2];if(M==600){if(L<100){$("#zoomed-to-fit").hide();$("#hammer").css("display","inline-block")}else{$("#zoomed-to-fit").show();$("#hammer").hide()}H.scale(L).translate(K);d3.select(o).select(".map").selectAll("path").attr("d",f)}else{K=[K[0]+75,K[1]+75];H.scale(L).translate(K);d3.select(".projection-preview").select(".map").selectAll("path").attr("d",f)}}s.on("clickedMap",function(g){meshu.findCountry(g);s.add(g[1],g[0],undefined,false)});s.on("removed",function(){if(A.length<3){$("#finish-button").removeClass("active")}if(A.length==1){$("#meshu-container").addClass("inactive")}});s.on("interactiveToggled",function(g){s.updateCircleBehavior(g)});function h(g,M){var K=d3.select("#"+g).select(".delaunay-ui");var L=d3.select("#"+g).select(".delaunay");var O=K.selectAll("circle").data(A);O.attr("cx",function(R){return M(R)[0]}).attr("cy",function(R){return M(R)[1]});var N=[];$.each(A,function(S,R){if(S==A.length-1){return}N.push({points:[A[S],A[S+1]],mode:b[S]})});var Q=L.selectAll("path").data(N);var J=d3.scale.linear().domain([0,600]).range([0.5,0.65]);Q.enter().append("svg:path");Q.exit().remove();Q.attr("d",function(X){var V=X.points.length;var Z=[];for(var W=0;W<V;W++){var aa=M(X.points[W]);Z.push(aa)}var U=this;if(X.mode=="air"){var Y=Math.sqrt(Math.pow(Z[0][0]-Z[1][0],2)+Math.pow(Z[0][1]-Z[1][1],2));return"M"+Z[0]+" A "+Y*J(Y)+" "+Y*J(Y)+" 0 0 0 "+Z[1]}else{if(X.mode=="road"){var S=null;n.forEach(function(ac,ab){if(ac.points[0][0]==X.points[0][0]&&ac.points[1][1]==X.points[1][1]){S=P(ac.wayPoints);return}});if(S){return S}var T="http://open.mapquestapi.com/directions/v1/route?generalize=500&outFormat=json&shapeFormat=raw&generalize=200&from=";var R=T+X.points[0][1]+","+X.points[0][0]+"&to="+X.points[1][1]+","+X.points[1][0]+"&key="+mapquestapi;$.ajax({url:R,dataType:"jsonp",success:function(ac){var ab=ac.route.shape.shapePoints;n.push({points:X.points,wayPoints:ab});d3.select(U).attr("d",P(ab))}})}else{return"M"+Z[0]+" L"+Z[1]}}}).attr("class",function(R){return R.mode}).style("stroke","#555").style("stroke-width",function(R){return(R.mode=="air")?2:3}).style("stroke-dasharray",function(R){return(R.mode=="air")?"4 4":""});function P(T){var R=[];var W=T.length;for(var S=0;S<W;S+=2){var U=M([T[S+1],T[S]]);R.push(U)}var V="M"+R.join("L");return V}}s.updatePixelBounds=function(){if(B.length&&m.length){w=[H([d3.min(B),d3.min(m)]),H([d3.max(B),d3.min(m)]),H([d3.max(B),d3.max(m)]),H([d3.min(B),d3.max(m)]),]}else{w=[]}};function l(){I(600,600);var L=r.selectAll("circle").data(A);L.enter().append("svg:circle").attr("id",function(N,M){return"c-"+M}).attr("r",4).attr("fill","#FF3FB4").on("mousedown",function(M){s.dragging=M;d3.event.stopPropagation()});L.exit().remove();var J=E.selectAll("li.place").data(A);var g=J.enter().append("li").attr("class","place").attr("id",function(N,M){return"p-"+M});var K=g.append("span").attr("class","mode");K.append("span").attr("class","origin").html("Origin:");K.append("span").attr("class","air selected");K.append("span").attr("class","rail");K.append("span").attr("class","road");K.selectAll("span").on("click",function(P,O){var N=$(this.parentNode.parentNode).index()-1,M=d3.select(this).attr("class");b[N]=M;h("meshu-container",H);$(this.parentNode).find("span").removeClass("selected");$(this).addClass("selected")});g.append("span").attr("class","place-text").html(function(N,M){k.innerHTML=p[M];return k.firstChild.nodeValue});g.append("span").attr("class","place-delete").html("x");J.exit().remove();J.each(function(M){M.edit=false}).attr("id",function(N,M){return"p-"+M}).select(".place-text").html(function(O,M){var N=$(this).parent().attr("id").split("-")[1];k.innerHTML=p[N];return k.firstChild.nodeValue});J.select(".mode").each(function(O,M){if(M==0){return}var N=d3.select(this).selectAll("span");N.classed("selected",false);N.classed("selected",function(Q,P){return $(this).attr("class")==b[M-1]})});s.updateCircleBehavior();G();h("meshu-container",H)}s.updateCircleBehavior=function(L){var J=y.hasClass("edit");var g=$("#place-hover");var K=r.selectAll("circle");K.on("mouseover",function(N,M){if(L){return}else{if(J){E.select("#p-"+M).attr("class","place highlight")}}});K.on("mouseout",function(N,M){if(L){return}else{if(J){E.select("#p-"+M).attr("class","place")}}})};function G(){var g=E.selectAll("li.place");g.select(".place-delete").on("click",function(K,J){s.remove(J);s.updatePixelBounds();F.updateBounds(B,m);l()});g.on("mouseover",function(K,J){r.select("#c-"+J).attr("class","highlight")});g.on("mouseout",function(K,J){r.select("#c-"+J).attr("class","")});g.select(".place-edit").on("click",function(K,J){A[J].air=!A[J].air;l()});$("#places ul").sortable({axis:"y",cursor:"move"});$("#places ul").disableSelection();$(".place-text").mouseup(function(){var M=[],K=[],L=[],J=[];setTimeout(function(){$("#places li").each(function(O,N){K.push($(this).find(".place-text").text());d3.select(this).each(function(P){M.push(P);J.push(P[0]);L.push(P[1])})});A=M;p=K;B=L;m=J;l()},100)})}s.add=function(O,K,M,g){var L=parseFloat(O);var N=parseFloat(K);B.push(L);m.push(N);F.updateBounds(B,m);if(M==undefined){p.push(O.toFixed(3)+", "+K.toFixed(3))}else{p.push(M)}if(A.length){$("#meshu-container").removeClass("inactive");z=[N,L];b.push("air");if(g){A.push([z[0],z[1]]);s.updatePixelBounds();l();h("meshu-container",H)}else{var J=A[A.length-1];A.push([z[0],z[1]]);s.updatePixelBounds();l()}}else{A.push([N,L]);l()}s.dirty=true;s.added();return s};s.remove=function(g){var J=c[g];A.splice(g,1);B.splice(g,1);m.splice(g,1);p.splice(g,1);c.splice(g,1);if(g==0){b.splice(g,1)}else{b.splice(g-1,1)}if(c.indexOf(J)==-1){e(J,false)}if(A.length<3){$("#finish-button").removeClass("active")}if(A.length==1){$("#meshu-container").addClass("inactive")}};s.lats=function(){return B};s.lons=function(){return m};s.places=function(){return p};s.points=function(g){if(!arguments.length){return A}A=g;return s};s.locations=function(g){z=null;A=[];B=[];m=[];p=[];$.each(g,function(J,K){A.push([K.longitude,K.latitude]);B.push(K.latitude);m.push(K.longitude);p.push(K.name)});s.locationsSet();return s};s.refresh=function(){l();s.refreshed()};s.updateTitle=function(g){a=g};s.outputTitle=function(){return a||"My Meshu"};s.output=function(){var g=$(".projection-preview").clone();g.find(".map").remove();return g.html()};s.getProjection=function(g){return H.invert(g)};return s};