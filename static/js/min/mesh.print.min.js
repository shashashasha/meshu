var sb=sb||{};sb.mesh.print=function(b,x,a,d){var j=sb.mesh.base(b,x,a,d),q=parseInt(Math.random()*10000000000,10);j.name="print";var w=$("body").hasClass("processing");var c=[],r=[],u=[],A=[],D=[],L=[];var h=document.createElement("div");var f=d3.select(b||"body").append("div").attr("id",q).style("width",a).style("height",d).style("position","absolute").style("z-index","1").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var K=f.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var o=d3.select(b||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",a).style("height",d);var e=o.append("svg:svg").attr("width","100%").attr("height","100%");var F=e.append("svg:g").attr("class","delaunay-ui");var i=d3.select("#places");var s=i.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",j.removeInput)}$(b).append($("<div>").attr("class","route-error").text("Sorry, no route found! Try another mode?"));var G=[],l=[],v=[],B=null;var n=$("#content");j.hittest=function(g){return d3.event.target!=e.node()};j.on("draggedMap",function(){z()});j.on("draggedPoint",function(M,N){M[0]=N[0];M[1]=N[1];var g=G.indexOf(M);r[g]=N[0];c[g]=N[1];j.dirty=true;z()});var J=d3.geo.mercator().scale(1).translate([0,0]);var p=d3.geo.path().projection(J);var k;$.getJSON("/static/lib/world_borders.json",function(M){E(parseInt(a),parseInt(d));k=M.features;var g=d3.select(".map").selectAll("path").data(M.features);g.enter().append("path").attr("d",p).attr("class",function(N){return N.properties.ISO2}).style("fill","#bbb").style("stroke","#aaa").style("stroke-width","0");if(loadedMeshu){A.forEach(function(O,N){C(O,true)});$("#"+j.style().projection).click();$(".map-style").find("li[data-color="+j.style().mapStyle+"]").click();$(".dot-style").find("li[data-color="+j.style().dotColor+"]").click();$(".country-style").find("li[data-color="+j.style().countryStyle+"]").click()}else{j.style({mapStyle:"light",dotColor:"FF3FB4",countryStyle:"on"})}if(w){j.copyMap();mesh.applyStyle(loadedMeshu.metadata);H(j.style().projection,j.style().zoom,j.style().translate);t("meshu-container");m("meshu-container")}});j.copyMap=function(){var O=$(".projection-preview").empty();var R=$(".map").clone();var T=$(".delaunay").clone();var Q=$(".delaunay-ui").clone();if(w){$(".delaunay").remove();$(".delaunay-ui").remove()}R.find("rect").remove();var S=d3.select(R).node()[0];var P=d3.selectAll(".projection-preview");var N=P.append("defs");N.append("path").datum({type:"Sphere"}).attr("id","sphere-"+q);N.append("clipPath").attr("id","clip").append("use").attr("xlink:href","#sphere-"+q);P.append("g").attr("class","projection-clip").append("use").attr("class","fill").attr("xlink:href","#sphere-"+q);var M=d3.selectAll(".projection-preview").append("g").attr("class","map");O.find(".map").html(S);O.append(T);O.append(Q);P.selectAll("circle").attr("r",2);var g="zoomed-to-fit";$(".proj").each(function(){if($(this).hasClass("selected")){g=$(this).attr("id")}});H(g)};function H(O,N,g){var P,M=w?parseInt(a):575,U=w?parseInt(d):425;switch(O){case"mercator":P=d3.geo.mercator().scale(M/6.25).translate([M/2,U/2]);break;case"hammer":P=d3.geo.hammer().scale(M/6).translate([M/2,U/2]);break;case"august":P=d3.geo.august().scale(M/11.5).translate([M/2,U/2]);break;case"lagrange":P=d3.geo.lagrange().scale(M/5.57).translate([M/2,U/2]);break;case"eckert1":P=d3.geo.eckert1().scale(M/6).translate([M/2,U/2]);break;case"butterfly":P=d3.geo.polyhedron.butterfly().scale(M/8.45).translate([M/2,5*U/7]);break;case"zoomed-to-fit":E(M,U,0.8);P=J;break}var Q=d3.selectAll(".projection-preview").attr("class","projection-preview meshu-svg").classed(O,true);Q.style("background-color",(O=="zoomed-to-fit")?"#e7e7e7":"#bbb");var S=w?parseInt(a)/350:((O=="zoomed-to-fit")?3:2.5);Q.selectAll("circle").attr("r",S);var T=w?parseInt(a)/2500:1;var R=d3.geo.path().projection(P);var V=Q.select(".map").selectAll("path").data(k).attr("clip-path","url(#clip)").attr("d",R).attr("class",function(X){var W=d3.select("#meshu-container").select("."+X.properties.ISO2).classed("current");d3.select(this).style("fill",W?"white":"#bbb").style("stroke-width",W?T:"0");return W?(X.properties.ISO2+" current"):X.properties.ISO2});d3.selectAll(".projection-preview #sphere-"+q).attr("d",R);y("projection",P);y("design",P);if(w){J=P;y("meshu-container",J)}j.style({projection:O,scale:P.scale(),translate:P.translate()});t("design");m("design")}$(".proj").click(function(){$(".proj").removeClass("selected");$(this).addClass("selected");var g=$(this).attr("id");H(g)});$(".map-style li").click(function(){var g=$(this).attr("data-color");j.style({mapStyle:g});$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");t("design")});$(".dot-style li").click(function(){var g=$(this).attr("data-color");$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");j.style({dotColor:g});m("design")});$(".country-style li").click(function(){var g=$(this).attr("data-color");j.style({countryStyle:g});$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");t("design")});$(".frame-wrapper").click(function(){if($(this).attr("id").split("-")[1]!=sb.materializer.product()){return}if($(this).hasClass("selected")){sb.materializer.material("unframed");sb.ui.orderer.updated();$(this).removeClass("selected")}else{sb.materializer.material("framed");$(".frame-wrapper").removeClass("selected");$(this).addClass("selected");sb.ui.orderer.updated()}});function t(M){var N=d3.select("#"+M+" .projection-preview");var P,Q,R,T,S;var g=j.style().mapStyle,O=j.style().countryStyle;switch(g){case"light":P="#e7e7e7";Q="#bbb";R="#fff";T="#aaa";S="#555";break;case"dark":P="#222";Q="#000";R="#333";T="#666";S="#aaa";break;case"no":P="#fff";Q="#fff";R="#e7e7e7";T="#e7e7e7";S="#000";break}if(j.style().projection=="zoomed-to-fit"){N.style("background-color",P)}else{N.style("background-color",Q)}N.select(".fill").attr("fill",P);N.select(".map").selectAll("path").style("fill",Q).style("stroke","none");if(O=="on"){N.select(".map").selectAll("path").filter(function(U){return(A.indexOf(U.properties.ISO2)!=-1)}).style("fill",R).style("stroke",T).each(function(){this.parentNode.appendChild(this)})}N.select(".delaunay").selectAll("path").style("stroke",S)}function m(g){d3.select("#"+g+" .projection-preview").selectAll("circle").style("fill","#"+j.style().dotColor)}j.addCountry=function(g){A.push(g);C(g,true)};function C(M,g){var N=d3.select(".map").selectAll("path").filter(function(O){return O.properties.ISO2==M}).classed("current",g).each(function(){this.parentNode.appendChild(this)}).style("fill",g?"white":"#bbb").style("stroke-width",g?"1":"0")}function E(M,P,R){J.scale(1).translate([0,0]);var Q=x.getExtent(),g=[J([Math.max(Q[0].lon,-180),Math.max(Q[0].lat,-90)]),J([Math.min(Q[1].lon,180),Math.min(Q[1].lat,90)])],O=Math.min(6000,(R?R:0.95)/Math.max((g[1][0]-g[0][0])/M,(g[1][1]-g[0][1])/P)),N=[(M-O*(g[1][0]+g[0][0]))/2,(P-O*(g[1][1]+g[0][1]))/2];if(M==600){if(O<100){$("#zoomed-to-fit").hide();$("#hammer").css("display","inline-block")}else{$("#zoomed-to-fit").show();$("#hammer").hide()}J.scale(O).translate(N);d3.select("#meshu-container").select(".map").selectAll("path").attr("d",p)}else{J.scale(O).translate(N);d3.selectAll(".projection-preview").select(".map").selectAll("path").attr("d",p)}}j.on("clickedMap",function(g){meshu.findCountry(g);j.add(g[1],g[0],undefined,false)});j.on("removed",function(){if(G.length<3){$("#finish-button").removeClass("active")}if(G.length==1){$("#meshu-container").addClass("inactive")}});function y(g,P){var N=d3.select("#"+g).select(".delaunay-ui");var O=d3.select("#"+g).select(".delaunay");var S=N.selectAll("circle").data(G);S.attr("cx",function(W){return P(W)[0]}).attr("cy",function(W){return P(W)[1]});var R=[];$.each(G,function(X,W){if(X==G.length-1){return}R.push({points:[G[X],G[X+1]],mode:L[X]})});var V=O.selectAll("path").data(R);var M=d3.scale.linear().domain([0,2600]).range([0.5,0.65]);V.enter().append("svg:path");V.exit().remove();V.attr("d",function(ac){var aa=ac.points.length;var ae=[];for(var ab=0;ab<aa;ab++){var af=P(ac.points[ab]);ae.push(af)}var Z=this;if(ac.mode=="air"){var ad=Math.sqrt(Math.pow(ae[0][0]-ae[1][0],2)+Math.pow(ae[0][1]-ae[1][1],2));return"M"+ae[0]+" A "+ad*M(ad)+" "+ad*M(ad)+" 0 0 0 "+ae[1]}else{if(ac.mode=="road"){var X=null;if(!loadedMeshu){D.forEach(function(ah,ag){if(ah.points[0][0]==ac.points[0][0]&&ah.points[1][1]==ac.points[1][1]){X=U(ah.wayPoints);return}});if(X=="undefined"){return""}else{if(X){return X}}}var Y="http://open.mapquestapi.com/directions/v1/route?generalize=500&outFormat=json&shapeFormat=raw&generalize=200&from=";var W=Y+ac.points[0][1]+","+ac.points[0][0]+"&to="+ac.points[1][1]+","+ac.points[1][0]+"&key="+mapquestapi;$.ajax({url:W,dataType:"jsonp",success:function(ah){var ag=[];if(ah.info.statuscode!=0){$(".route-error").fadeIn().delay(3000).fadeOut("slow");D.push({points:ac.points,wayPoints:ag});d3.select(Z).attr("d","")}else{ag=ah.route.shape.shapePoints;D.push({points:ac.points,wayPoints:ag});d3.select(Z).attr("d",U(ag))}}})}else{return"M"+ae[0]+" L"+ae[1]}}}).attr("class",function(W){return W.mode}).style("stroke","#555").style("stroke-width",function(W){return T(W.mode)}).style("stroke-dasharray",function(W){return Q(W.mode)});function T(X){if(w){var W=parseInt(a);return(W/600)}if(X=="air"){if(g=="meshu-container"){return 2}return 1.5}else{if(g=="meshu-container"){return 3}return 2.5}}function Q(X){if(X!="air"){return}if(w){var W=parseInt(a);return(W/300)+" "+(W/300)}if(g=="meshu-container"){return"4 4"}return"3 3"}function U(Y){var W=[];var ab=Y.length;for(var X=0;X<ab;X+=2){var Z=P([Y[X+1],Y[X]]);W.push(Z)}var aa="M"+W.join("L");return(Y.length==0)?"undefined":aa}}function z(){E(parseInt(a),parseInt(d));var O=F.selectAll("circle").data(G);O.enter().append("svg:circle").attr("id",function(Q,P){return"c-"+P}).attr("r",4).attr("fill","#FF3FB4").on("mousedown",function(P){j.dragging=P;d3.event.stopPropagation()});O.exit().remove();var M=s.selectAll("li.place").data(G);var g=M.enter().append("li").attr("class","place").attr("id",function(Q,P){return"p-"+P});var N=g.append("span").attr("class","mode");N.append("span").attr("class","origin").html("Origin:");N.append("span").attr("class","air selected");N.append("span").attr("class","rail");N.append("span").attr("class","road");N.selectAll("span").on("click",function(S,R){var Q=$(this.parentNode.parentNode).index()-1,P=d3.select(this).attr("class");L[Q]=P;y("meshu-container",J);$(this.parentNode).find("span").removeClass("selected");$(this).addClass("selected")});g.append("span").attr("class","place-text").html(function(Q,P){h.innerHTML=u[P];return h.firstChild.nodeValue});g.append("span").attr("class","place-delete").html("x");M.exit().remove();M.each(function(P){P.edit=false}).attr("id",function(Q,P){return"p-"+P}).select(".place-text").html(function(R,P){var Q=$(this).parent().attr("id").split("-")[1];h.innerHTML=u[Q];return h.firstChild.nodeValue});M.select(".mode").each(function(R,P){if(P==0){return}var Q=d3.select(this).selectAll("span");Q.classed("selected",false);Q.classed("selected",function(T,S){return $(this).attr("class")==L[P-1]})});I();y("meshu-container",J)}function I(){var M=s.selectAll("li.place");M.select(".place-delete").on("click",function(O,N){j.remove(N);x.updateBounds(c,r);z()});var g=0;if(!w){$("#places ul").sortable({axis:"y",cursor:"move",start:function(N,O){g=O.item.index()},stop:function(O,P){var N=P.item.index();if(g==N){return}u.splice(N,0,u.splice(g,1)[0]);G.splice(N,0,G.splice(g,1)[0]);c.splice(N,0,c.splice(g,1)[0]);r.splice(N,0,r.splice(g,1)[0]);A.splice(N,0,A.splice(g,1)[0]);g=0}});$("#places ul").disableSelection()}}j.add=function(R,N,P,g){var O=parseFloat(R);var Q=parseFloat(N);c.push(O);r.push(Q);x.updateBounds(c,r);if(P==undefined){u.push(R.toFixed(3)+", "+N.toFixed(3))}else{u.push(P)}if(G.length){$("#meshu-container").removeClass("inactive");l=[Q,O];L.push("air");if(g){G.push([l[0],l[1]]);z();y("meshu-container",J)}else{var M=G[G.length-1];G.push([l[0],l[1]]);z()}}else{G.push([Q,O]);z()}j.dirty=true;j.added();return j};j.remove=function(g){var M=A[g];G.splice(g,1);c.splice(g,1);r.splice(g,1);u.splice(g,1);A.splice(g,1);if(g==0){L.splice(g,1)}else{L.splice(g-1,1)}if(A.indexOf(M)==-1){C(M,false)}if(G.length<3){$("#finish-button").removeClass("active")}if(G.length==1){$("#meshu-container").addClass("inactive")}};j.lats=function(){return c};j.lons=function(){return r};j.places=function(){return u};j.points=function(g){if(!arguments.length){return G}G=g;return j};j.locations=function(M,g){mesh.applyStyle(loadedMeshu.metadata);A=j.style().countries.split(",");L=j.style().modes.split(",");G=[];c=[];r=[];u=[];$.each(M,function(N,O){G.push([O.longitude,O.latitude]);c.push(O.latitude);r.push(O.longitude);u.push(O.name)});j.locationsSet();if(w){d3.select(".map").attr("height","100%").select(".layer").remove();d3.select("#meshu-container").append("svg").attr("class","projection-preview").style("position","absolute").style("top","0")}return j};j.refresh=function(){z();j.refreshed()};j.updateTitle=function(g){B=g};j.outputTitle=function(){return B||"My Meshu"};j.output=function(){var N=$(".projection-preview").last().clone();N.find(".map").remove();var g=A.join(","),M=L.join(",");j.style({countries:g,modes:M});return new XMLSerializer().serializeToString(d3.select(N).node()[0])};j.getProjection=function(g){return J.invert(g)};return j};