var sb=sb||{};sb.mesh.facet=function(k,D,s,o){var n=sb.mesh.base(k,D,s,o),u=parseInt(Math.random()*10000000000,10);n.name="facet";var z=[],j=[],l=[];var h=document.createElement("div");var f=d3.select(k||"body").append("div").attr("id",u).style("width",s).style("height",o).style("position","absolute").style("z-index","1").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var A=f.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var y=f.append("svg:g").attr("class","hidden");y.append("svg:path");var b=d3.select(k||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",s).style("height",o);var q=b.append("svg:svg").attr("width","100%").attr("height","100%");var p=q.append("svg:g").attr("id","delaunay-ui");var m=d3.select("#places");var C=m.select("#place-title").attr("class","inactive");C.append("span").attr("class","title-text");C.append("span").attr("class","title-edit").html("edit");var B=m.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",n.removeInput)}var x=[],w=[],t=[],G=0,a=null;var v=$("#content");n.hittest=function(g){return d3.event.target!=q.node()};n.on("draggedMap",function(){i()});n.on("draggedPoint",function(H,I){H[0]=I.lon;H[1]=I.lat;var g=x.indexOf(H);z[g]=I.lat;j[g]=I.lon;n.dirty=true;i()});n.on("clickedMap",function(g){n.add(g.lat,g.lon,undefined,false)});n.on("clickedPoint",function(H){var g=x.indexOf(H);n.remove(g);D.updateBounds(z,j);n.updatePixelBounds();n.dirty=false;i()});n.on("removed",function(){if(x.length==1){$("#meshu-container").addClass("inactive")}});n.on("interactiveToggled",function(g){n.updateCircleBehavior(g)});var F=function(g,O){var N=0,H=[];if(O.length<2){return}for(var K=0;K<O.length;K++){var L=g.l2p({lat:O[K][1],lon:O[K][0]});for(var I=K+1;I<O.length;I++){var J=g.l2p({lat:O[I][1],lon:O[I][0]});var Q=L.x-J.x;var P=L.y-J.y;var M=Math.sqrt((Q*Q)+(P*P));if(M>N){N=M;H=[J,L]}}}return H};var d=function(I,H){var J=H.y-I.y,g=H.x-I.x;return Math.atan2(J,g)*(180/Math.PI)};var c=function(I,H){var J=H.y-I.y,g=H.x-I.x;return Math.sqrt((g*g)+(J*J))};var r=function(I,H){var g=H.getTransformToElement(H.ownerSVGElement);return I.matrixTransform(g)};n.getLongestRotation=function(){var J=F(D,x),I=d(J[0],J[1]),H=-I+180,g="rotate("+[H,300,300].join(",")+") ";return g};n.projectPoints=function(J){d3.select("#delaunay-ui").attr("transform",J);var g=[],H=[],I=[];var K=d3.selectAll("#delaunay-ui circle").each(function(P,M){var O=this.ownerSVGElement.createSVGPoint(),L=D.l2p({lat:z[M],lon:j[M]});O.x=L.x;O.y=L.y;var N=r(O,this);H.push(N.x);I.push(N.y);g.push([N.x,N.y])});d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");return{pts:g,xvalues:H,yvalues:I}};n.transformedDelaunay=function(K,I,M,H){var L={top:d3.min(K.yvalues),left:d3.min(K.xvalues),right:d3.max(K.xvalues),bottom:d3.max(K.yvalues)},J=L.right-L.left,N=L.bottom-L.top,g=I/J,P=M/N;var O=A.selectAll("path").data(d3.geom.delaunay(K.pts));O.enter().append("svg:path");O.exit().remove();O.exit().remove();O.attr("stroke-width",25).attr("d",function(V){var R=V.length;var Q=[];for(var U=0;U<R;U++){var T=(V[U][0]-L.left)*g,S=((V[U][1]-L.top)*P)+H;Q.push([T,S])}return"M"+Q.join(" L")+"Z"})};function e(H){var L=p.selectAll("circle");L.attr("cx",function(M){return D.l2p({lat:M[1],lon:M[0]}).x}).attr("cy",function(M){return D.l2p({lat:M[1],lon:M[0]}).y});var g=A.selectAll("path").data(d3.geom.delaunay(x));g.enter().append("svg:path");g.exit().remove();g.attr("d",function(R){var N=R.length;var M=[];for(var O=0;O<N;O++){var Q={lat:parseFloat(R[O][1]),lon:parseFloat(R[O][0])};var P=D.l2p(Q);M.push([P.x,P.y])}return"M"+M.join("L")+"Z"});if(w&&H==true){clearInterval(G);w=null}else{if(w){var K=x[x.length-1]||[];if(Math.abs(K[0]-w[0])>0.0002){K[0]+=(w[0]-K[0])/3}if(Math.abs(K[1]-w[1])>0.0002){K[1]+=(w[1]-K[1])/3}x[x.length-1]=K;var J=Math.abs(K[0]-w[0]);var I=Math.abs(K[1]-w[1]);if(I<0.0002&&J<0.0002){clearInterval(G);w=null}}else{clearInterval(G)}}}n.updatePixelBounds=function(){if(z.length&&j.length){t=[D.l2p({lat:d3.min(z),lon:d3.min(j)}),D.l2p({lat:d3.max(z),lon:d3.min(j)}),D.l2p({lat:d3.max(z),lon:d3.max(j)}),D.l2p({lat:d3.min(z),lon:d3.max(j)})]}else{t=[]}};function i(){var L=p.selectAll("circle").data(x);L.enter().append("svg:circle").attr("id",function(N,M){return"c-"+M}).attr("r",7).on("mousedown",function(M){n.dragging=M;d3.event.stopPropagation()});L.exit().remove();var J=B.selectAll("li.place").data(x);var H=J.enter().append("li").attr("class","place");var K=H.append("span").attr("class","title");K.append("span").attr("class","place-text").html(function(N,M){h.innerHTML=l[M];return h.firstChild.nodeValue});K.append("span").attr("class","place-edit").html("edit");H.append("span").attr("class","place-delete").html("x");J.exit().remove();J.attr("id",function(N,M){return"p-"+M}).select(".title").each(function(M){M.edit=false}).attr("class","title").select(".place-text").html(function(N,M){h.innerHTML=l[M];return h.firstChild.nodeValue});C.data(x).each(function(M){M.edit=false});var g=y.selectAll("circle.rotation").data(t);g.enter().append("svg:circle").attr("class","rotation").attr("r","40").attr("cx",function(N,M){return N.x}).attr("cy",function(N,M){return N.y});g.exit().remove();g.attr("cx",function(N,M){return N.x}).attr("cy",function(N,M){return N.y});var I=y.select("path");I.attr("d",function(){if(t.length==0){return}var M=[];$.each(t,function(N,O){M.push([O.x,O.y])});return"M"+M.join("L")+"Z"}).attr("class","hiddenFrame");n.updateCircleBehavior();E();e()}n.updateCircleBehavior=function(J){var H=v.hasClass("edit");var g=$("#place-hover");var I=p.selectAll("circle");I.on("mouseover",function(Q,M){if(J){return}else{if(H){B.select("#p-"+M).attr("class","place highlight")}else{g.addClass("active").find("span").text(l[M]);var P=D.l2p({lat:Q[1],lon:Q[0]});var K=g.width();var O=(P.y-32)+"px";var N=(P.x-(K/2)-3)+"px";var L=K/2-3+"px";g.css({top:O,left:N}).find("b").css("left",L)}}});I.on("mouseout",function(L,K){if(J){return}else{if(H){B.select("#p-"+K).attr("class","place")}else{g.removeClass("active")}}})};function E(){var g=B.selectAll("li.place");g.select(".place-delete").on("click",function(I,H){n.remove(H);n.updatePixelBounds();D.updateBounds(z,j);i()});g.on("mouseover",function(I,H){p.select("#c-"+H).attr("class","highlight")});g.on("mouseout",function(I,H){p.select("#c-"+H).attr("class","")});g.select(".place-edit").on("click",function(J,H){var I=$(this).parent();if(!J.edit){n.editText(I,H,"place")}else{n.saveText(I,H,"place")}J.edit=!J.edit});g.select(".place-text").on("click",function(I,H){if(I.edit){return}n.editText($(this).parent(),H,"place");I.edit=!I.edit});C.attr("class","").select(".title-text").text(function(H){if(H&&H.title){return H.title}else{return"My Meshu"}});C.select(".title-text").on("click",function(H){if(H.edit){return}n.editText($(this).parent(),0,"title");H.edit=!H.edit});C.select(".title-edit").on("click",function(I){var H=$(this).parent();if(!I.edit){n.editText(H,0,"title")}else{I.title=a=n.saveText(H,0,"title")}I.edit=!I.edit})}n.add=function(M,I,K,g){if(G){clearInterval(G)}var J=parseFloat(M);var L=parseFloat(I);z.push(J);j.push(L);if(K==undefined){l.push(M.toFixed(3)+", "+I.toFixed(3))}else{l.push(K)}if(x.length){$("#meshu-container").removeClass("inactive");w=[L,J];if(g){x.push([w[0],w[1]]);n.updatePixelBounds();i();e(g)}else{var H=x[x.length-1];x.push([H[0],H[1]]);n.updatePixelBounds();i();G=setInterval(e,40)}}else{x.push([L,J]);i()}n.dirty=true;n.added();return n};n.remove=function(g){x.splice(g,1);z.splice(g,1);j.splice(g,1);l.splice(g,1);if(x.length==1){$("#meshu-container").addClass("inactive")}};n.lats=function(){return z};n.lons=function(){return j};n.places=function(){return l};n.points=function(g){if(!arguments.length){return x}x=g;return n};n.bakeStyles=function(){y.style("display","none")};n.unBakeStyles=function(){y.style("display","")};n.locations=function(g){w=null;x=[];z=[];j=[];l=[];$.each(g,function(H,I){x.push([I.longitude,I.latitude]);z.push(I.latitude);j.push(I.longitude);l.push(I.name)});n.locationsSet();return n};n.refresh=function(){i();n.refreshed()};n.updateTitle=function(g){a=g};n.outputTitle=function(){return a||"My Meshu"};n.output=function(){return $("#"+u).html()};return n};