var sb=sb||{};sb.mesh.facet=function(l,E,t,r){var q=sb.mesh.base(l,E,t,r),v=parseInt(Math.random()*10000000000,10);q.name="facet";var A=[],k=[],m=[],b=null,D=null,I={};var i=document.createElement("div");var h=d3.select(l||"body").append("div").attr("id",v).style("width",t).style("height",r).style("position","absolute").style("z-index","1").append("svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var B=h.append("g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var z=h.append("g").attr("class","hidden");z.append("path");var c=d3.select(l||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",t).style("height",r);var p=c.append("svg").attr("width","100%").attr("height","100%");var o=p.append("g").attr("id","delaunay-ui");var n=d3.select("#places");var C=n.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",q.removeInput)}var y=[],x=[],u=[],H=0,a=null;var w=$("#content");q.hittest=function(g){return d3.event.target!=p.node()};q.on("draggedMap",function(){j()});q.on("draggedPoint",function(J,K){J[0]=K.lon;J[1]=K.lat;var g=y.indexOf(J);A[g]=K.lat;k[g]=K.lon;q.dirty=true;b=null;D=null;I={};j()});q.on("clickedMap",function(g){q.add(g.lat,g.lon,undefined,false)});q.on("removed",function(){if(y.length<3){$("#scroll-down").fadeIn()}if(y.length==1){$("#meshu-container").addClass("inactive")}});q.on("interactiveToggled",function(g){q.updateCircleBehavior(g)});var G=function(){var O=0,g=[];if(y.length<2){return}for(var L=0;L<y.length;L++){var M=E.l2p({lat:y[L][1],lon:y[L][0]});for(var J=L+1;J<y.length;J++){var K=E.l2p({lat:y[J][1],lon:y[J][0]});var Q=M.x-K.x;var P=M.y-K.y;var N=Math.sqrt((Q*Q)+(P*P));if(N>O){O=N;if(K.y>M.y){g=[K,M]}else{g=[M,K]}}}}return g};var e=function(K,J){var L=J.y-K.y,g=J.x-K.x;return Math.atan2(L,g)*(180/Math.PI)};var d=function(K,J){var L=J.y-K.y,g=J.x-K.x;return Math.sqrt((g*g)+(L*L))};var s=function(K,J){var g=J.getTransformToElement(J.ownerSVGElement);return K.matrixTransform(g)};q.getRotationAngle=function(K){K=K||0;if(y.length<2){return}if(D){return D+K}var J=G(E,y),g=e(J[0],J[1]);D=-g+180;return D+K};q.getLongestRotation=function(g){angle=q.getRotationAngle();g=g||0;return"rotate("+[angle+g,300,300].join(",")+") "};q.projectPoints=function(L){if(I.transform==L){return I}d3.select("#delaunay-ui").attr("transform",L);var K=[],J=[],N=[];var g=d3.selectAll("#delaunay-ui circle").each(function(V,S){var U=this.ownerSVGElement.createSVGPoint(),R=E.l2p({lat:A[S],lon:k[S]});U.x=R.x;U.y=R.y;var T=s(U,this);J.push(T.x);N.push(T.y);K.push([T.x,T.y])});d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");var M=d3.min(N),Q=d3.min(J),O=d3.max(J),P=d3.max(N);I={pts:K,transform:L,top:M,left:Q,right:O,bottom:P,width:O-Q,height:P-M};return I};q.transformedDelaunay=function(M,L,N,J){J=J||0;var P=M,O=L/P.width,K=N/P.height;var g=B.selectAll("path").data(d3.geom.delaunay(M.pts));g.enter().append("path");g.exit().remove();g.attr("stroke-width",20).attr("fill","none").attr("d",function(V){var R=V.length;var Q=[];for(var U=0;U<R;U++){var T=(V[U][0]-P.left)*O,S=((V[U][1]-P.top)*K)+J;Q.push([T,S])}return"M"+Q.join(" L")+"Z"})};function f(J){var N=o.selectAll("circle");N.attr("cx",function(O){return E.l2p({lat:parseFloat(O[1]),lon:parseFloat(O[0])}).x}).attr("cy",function(O){return E.l2p({lat:O[1],lon:O[0]}).y});var g=B.selectAll("path").data(d3.geom.delaunay(y));g.enter().append("path");g.exit().remove();g.attr("d",function(T){var P=T.length;var O=[];for(var Q=0;Q<P;Q++){var S={lat:parseFloat(T[Q][1]),lon:parseFloat(T[Q][0])};var R=E.l2p(S);O.push([R.x,R.y])}return"M"+O.join("L")+"Z"});if(x&&J==true){clearInterval(H);x=null}else{if(x){var M=y[y.length-1]||[];if(Math.abs(M[0]-x[0])>0.0002){M[0]+=(x[0]-M[0])/3}if(Math.abs(M[1]-x[1])>0.0002){M[1]+=(x[1]-M[1])/3}y[y.length-1]=M;var L=Math.abs(M[0]-x[0]);var K=Math.abs(M[1]-x[1]);if(K<0.0002&&L<0.0002){clearInterval(H);x=null}}else{clearInterval(H)}}}q.updatePixelBounds=function(){if(A.length&&k.length){u=[E.l2p({lat:d3.min(A),lon:d3.min(k)}),E.l2p({lat:d3.max(A),lon:d3.min(k)}),E.l2p({lat:d3.max(A),lon:d3.max(k)}),E.l2p({lat:d3.min(A),lon:d3.max(k)})]}else{u=[]}};function j(){var N=o.selectAll("circle").data(y);N.enter().append("circle").attr("id",function(P,O){return"c-"+O}).attr("r",10).on("mousedown",function(O){q.dragging=O;d3.event.stopPropagation()});N.exit().remove();var L=C.selectAll("li.place").data(y);var J=L.enter().append("li").attr("class","place");var M=J.append("span").attr("class","title");M.append("span").attr("class","place-text").html(function(P,O){i.innerHTML=m[O];return i.firstChild.nodeValue});M.append("span").attr("class","place-edit").html("edit");J.append("span").attr("class","place-delete").html("x");L.exit().remove();L.attr("id",function(P,O){return"p-"+O}).select(".title").each(function(O){O.edit=false}).attr("class","title").select(".place-text").html(function(P,O){i.innerHTML=m[O];return i.firstChild.nodeValue});var g=z.selectAll("circle.rotation").data(u);g.enter().append("circle").attr("class","rotation").attr("r","40").attr("cx",function(P,O){return P.x}).attr("cy",function(P,O){return P.y});g.exit().remove();g.attr("cx",function(P,O){return P.x}).attr("cy",function(P,O){return P.y});var K=z.select("path");K.attr("d",function(){if(u.length==0){return}var O=[];$.each(u,function(P,Q){O.push([Q.x,Q.y])});return"M"+O.join("L")+"Z"}).attr("class","hiddenFrame");q.updateCircleBehavior();F();f()}q.updateCircleBehavior=function(L){var g=w.hasClass("view");var J=$("#place-hover");var K=o.selectAll("circle");K.on("mouseover",function(S,O){if(L){return}else{if(g){J.addClass("active").find("span").text(m[O]);var R=E.l2p({lat:S[1],lon:S[0]});var M=J.width();var Q=(R.y-32)+"px";var P=(R.x-(M/2)-3)+"px";var N=M/2-3+"px";J.css({top:Q,left:P}).find("b").css("left",N)}else{C.select("#p-"+O).attr("class","place highlight")}}});K.on("mouseout",function(N,M){if(L){return}else{if(g){J.removeClass("active")}else{C.select("#p-"+M).attr("class","place")}}})};function F(){var g=C.selectAll("li.place");g.select(".place-delete").on("click",function(K,J){q.remove(J);q.refresh()});g.on("mouseover",function(K,J){o.select("#c-"+J).attr("class","highlight")});g.on("mouseout",function(K,J){o.select("#c-"+J).attr("class","")});g.select(".place-edit").on("click",function(L,J){var K=$(this).parent();if(!L.edit){q.editText(K,J,"place");q.removeInput()}else{q.saveText(K,J,"place")}L.edit=!L.edit});g.select(".place-text").on("click",function(K,J){if(K.edit){return}q.removeInput();q.editText($(this).parent(),J,"place");K.edit=!K.edit})}q.add=function(O,K,M,g){if(H){clearInterval(H)}var L=parseFloat(O);var N=parseFloat(K);A.push(L);k.push(N);if(M==undefined){m.push(O.toFixed(3)+", "+K.toFixed(3))}else{m.push(M)}if(y.length){$("#meshu-container").removeClass("inactive");x=[N,L];if(g){y.push([x[0],x[1]]);q.updatePixelBounds();j();f(g)}else{var J=y[y.length-1];y.push([J[0],J[1]]);q.updatePixelBounds();j();H=setInterval(f,40)}}else{y.push([N,L]);j()}if(y.length>=3){$("#scroll-down").fadeIn()}q.dirty=true;b=null;D=null;I={};q.added();return q};q.remove=function(g){y.splice(g,1);A.splice(g,1);k.splice(g,1);m.splice(g,1);q.dirty=true;b=null;D=null;I={};if(y.length<3){$("#scroll-down").fadeOut()}if(y.length==1){$("#meshu-container").addClass("inactive")}};q.lats=function(){return A};q.lons=function(){return k};q.places=function(){return m};q.points=function(g){if(!arguments.length){return y}y=g;return q};q.bakeStyles=function(){z.style("display","none")};q.unBakeStyles=function(){z.style("display","")};q.locations=function(g){x=null;y=[];A=[];k=[];m=[];$.each(g,function(J,K){y.push([K.longitude,K.latitude]);A.push(K.latitude);k.push(K.longitude);m.push(K.name)});q.locationsSet();return q};q.editText=function(L,J,K){var g=L.find("."+K+"-edit").text("save");var N=L.find("."+K+"-text");var M=((K=="title")?N.text():m[J]);L.addClass("active");N.html('<input value="'+M+'">').find("input").focus()};q.saveText=function(L,J,K){var g=L.find("."+K+"-edit").text("edit");var M=L.find("input").val();L.removeClass("active");L.find("."+K+"-text").text(M);if(K=="place"){m[J]=M}else{return M}};q.removeInput=function(g){var J=d3.select("#places").selectAll("li.place .title");J.each(function(L,K){if(!L.edit){return}L.edit=false;q.saveText($(this),K,"place")});return false};q.refresh=function(){j();q.refreshed()};q.updateTitle=function(g){a=g};q.outputTitle=function(){return a||"My Meshu"};q.output=function(){return $("#"+v).html()};return q};