var sb=sb||{};sb.mesh.facet=function(l,D,t,q){var p=sb.mesh.base(l,D,t,q),v=parseInt(Math.random()*10000000000,10);p.name="facet";var z=[],k=[],m=[],b=null,C=null,H={};var i=document.createElement("div");var h=d3.select(l||"body").append("div").attr("id",v).style("width",t).style("height",q).style("position","absolute").style("z-index","1").append("svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var A=h.append("g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var c=d3.select(l||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",t).style("height",q);var r=c.append("svg").attr("width","100%").attr("height","100%");var o=r.append("g").attr("id","delaunay-ui");var n=d3.select("#places");var B=n.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").on("blur",p.removeInput)}var y=[],x=[],u=[],G=0,a=null;var w=$("#content");p.hittest=function(g){return d3.event.target!=r.node()};p.on("draggedMap",function(){j()});p.on("draggedPoint",function(I,J){I[0]=J.lon;I[1]=J.lat;var g=y.indexOf(I);z[g]=J.lat;k[g]=J.lon;p.dirty=true;b=null;C=null;H={};j()});p.on("clickedMap",function(g){p.add(g.lat,g.lon,undefined,false)});p.on("removed",function(){if(y.length<3){$("#scroll-down").fadeIn()}if(y.length==1){$("#meshu-container").addClass("inactive")}});p.on("interactiveToggled",function(g){p.updateCircleBehavior(g)});var F=function(){var N=0,g=[];if(y.length<2){return}for(var K=0;K<y.length;K++){var L=D.l2p({lat:y[K][1],lon:y[K][0]});for(var I=K+1;I<y.length;I++){var J=D.l2p({lat:y[I][1],lon:y[I][0]});var P=L.x-J.x;var O=L.y-J.y;var M=Math.sqrt((P*P)+(O*O));if(M>N){N=M;if(J.y>L.y){g=[J,L]}else{g=[L,J]}}}}return g};var e=function(J,I){var K=I.y-J.y,g=I.x-J.x;return Math.atan2(K,g)*(180/Math.PI)};var d=function(J,I){var K=I.y-J.y,g=I.x-J.x;return Math.sqrt((g*g)+(K*K))};var s=function(J,I){var g=I.getTransformToElement(I.ownerSVGElement);return J.matrixTransform(g)};p.getRotationAngle=function(J){J=J||0;if(y.length<2){return}if(C){return C+J}var I=F(D,y),g=e(I[0],I[1]);if(Math.abs(g)<30){C=-g}else{C=-g+180}return C+J};p.getLongestRotation=function(g){angle=p.getRotationAngle();g=g||0;return"rotate("+[angle+g,300,300].join(",")+") "};p.projectPoints=function(K){if(H.transform==K){return H}d3.select("#delaunay-ui").attr("transform",K);var J=[],I=[],M=[];var g=d3.selectAll("#delaunay-ui circle").each(function(U,R){var T=this.ownerSVGElement.createSVGPoint(),Q=D.l2p({lat:z[R],lon:k[R]});T.x=Q.x;T.y=Q.y;var S=s(T,this);I.push(S.x);M.push(S.y);J.push([S.x,S.y])});d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");var L=d3.min(M),P=d3.min(I),N=d3.max(I),O=d3.max(M);H={pts:J,transform:K,top:L,left:P,right:N,bottom:O,width:N-P,height:O-L};return H};p.transformedDelaunay=function(L,K,M,I){I=I||0;var O=L,N=K/O.width,J=M/O.height;var g=A.selectAll("path").data(d3.geom.delaunay(L.pts));g.enter().append("path");g.exit().remove();g.attr("stroke-width",20).attr("fill","none").attr("d",function(U){var Q=U.length;var P=[];for(var T=0;T<Q;T++){var S=(U[T][0]-O.left)*N,R=((U[T][1]-O.top)*J)+I;P.push([S,R])}return"M"+P.join(" L")+"Z"})};function f(I){var M=o.selectAll("circle");M.attr("cx",function(N){return D.l2p({lat:parseFloat(N[1]),lon:parseFloat(N[0])}).x}).attr("cy",function(N){return D.l2p({lat:N[1],lon:N[0]}).y});var g=A.selectAll("path").data(d3.geom.delaunay(y));g.enter().append("path");g.exit().remove();g.attr("d",function(S){var O=S.length;var N=[];for(var P=0;P<O;P++){var R={lat:parseFloat(S[P][1]),lon:parseFloat(S[P][0])};var Q=D.l2p(R);N.push([Q.x,Q.y])}return"M"+N.join("L")+"Z"});if(x&&I==true){clearInterval(G);x=null}else{if(x){var L=y[y.length-1]||[];if(Math.abs(L[0]-x[0])>0.0002){L[0]+=(x[0]-L[0])/3}if(Math.abs(L[1]-x[1])>0.0002){L[1]+=(x[1]-L[1])/3}y[y.length-1]=L;var K=Math.abs(L[0]-x[0]);var J=Math.abs(L[1]-x[1]);if(J<0.0002&&K<0.0002){clearInterval(G);x=null}}else{clearInterval(G)}}}p.updatePixelBounds=function(){if(z.length&&k.length){u=[D.l2p({lat:d3.min(z),lon:d3.min(k)}),D.l2p({lat:d3.max(z),lon:d3.min(k)}),D.l2p({lat:d3.max(z),lon:d3.max(k)}),D.l2p({lat:d3.min(z),lon:d3.max(k)})]}else{u=[]}};function j(){var K=o.selectAll("circle").data(y);K.enter().append("circle").attr("id",function(M,L){return"c-"+L}).attr("r",10).on("mousedown",function(L){p.dragging=L;d3.event.stopPropagation()});K.exit().remove();var I=B.selectAll("li.place").data(y);var g=I.enter().append("li").attr("class","place");var J=g.append("span").attr("class","title");J.append("span").attr("class","place-text").html(function(M,L){i.innerHTML=m[L];return i.firstChild.nodeValue});J.append("span").attr("class","place-edit").html("edit");g.append("span").attr("class","place-delete").html("x");I.exit().remove();I.attr("id",function(M,L){return"p-"+L}).select(".title").each(function(L){L.edit=false}).attr("class","title").select(".place-text").html(function(M,L){i.innerHTML=m[L];return i.firstChild.nodeValue});p.updateCircleBehavior();E();f()}p.updateCircleBehavior=function(K){var g=w.hasClass("view");var I=$("#place-hover");var J=o.selectAll("circle");J.on("mouseover",function(R,N){if(K){return}else{if(g){I.addClass("active").find("span").text(m[N]);var Q=D.l2p({lat:R[1],lon:R[0]});var L=I.width();var P=(Q.y-32)+"px";var O=(Q.x-(L/2)-3)+"px";var M=L/2-3+"px";I.css({top:P,left:O}).find("b").css("left",M)}else{B.select("#p-"+N).attr("class","place highlight")}}});J.on("mouseout",function(M,L){if(K){return}else{if(g){I.removeClass("active")}else{B.select("#p-"+L).attr("class","place")}}})};function E(){var g=B.selectAll("li.place");g.select(".place-delete").on("click",function(J,I){p.remove(I);p.refresh()});g.on("mouseover",function(J,I){o.select("#c-"+I).attr("class","highlight")});g.on("mouseout",function(J,I){o.select("#c-"+I).attr("class","")});g.select(".place-edit").on("click",function(K,I){var J=$(this).parent();if(!K.edit){p.editText(J,I,"place");p.removeInput()}else{p.saveText(J,I,"place")}K.edit=!K.edit});g.select(".place-text").on("click",function(J,I){if(J.edit){return}p.removeInput();p.editText($(this).parent(),I,"place");J.edit=!J.edit})}p.add=function(N,J,L,g){if(G){clearInterval(G)}var K=parseFloat(N);var M=parseFloat(J);z.push(K);k.push(M);if(L==undefined){m.push(N.toFixed(3)+", "+J.toFixed(3))}else{m.push(L)}if(y.length){$("#meshu-container").removeClass("inactive");x=[M,K];if(g){y.push([x[0],x[1]]);p.updatePixelBounds();j();f(g)}else{var I=y[y.length-1];y.push([I[0],I[1]]);p.updatePixelBounds();j();G=setInterval(f,40)}}else{y.push([M,K]);j()}if(y.length>=3){$("#scroll-down").fadeIn()}p.dirty=true;b=null;C=null;H={};p.added();return p};p.remove=function(g){y.splice(g,1);z.splice(g,1);k.splice(g,1);m.splice(g,1);p.dirty=true;b=null;C=null;H={};if(y.length<3){$("#scroll-down").fadeOut()}if(y.length==1){$("#meshu-container").addClass("inactive")}};p.lats=function(){return z};p.lons=function(){return k};p.places=function(){return m};p.points=function(g){if(!arguments.length){return y}y=g;return p};p.bakeStyles=function(){};p.unBakeStyles=function(){};p.locations=function(g){x=null;y=[];z=[];k=[];m=[];$.each(g,function(I,J){y.push([J.longitude,J.latitude]);z.push(J.latitude);k.push(J.longitude);m.push(J.name)});p.locationsSet();return p};p.editText=function(K,I,J){var g=K.find("."+J+"-edit").text("save");var M=K.find("."+J+"-text");var L=((J=="title")?M.text():m[I]);K.addClass("active");M.html('<input value="'+L+'">').find("input").focus()};p.saveText=function(K,I,J){var g=K.find("."+J+"-edit").text("edit");var L=K.find("input").val();K.removeClass("active");K.find("."+J+"-text").text(L);if(J=="place"){m[I]=L}else{return L}};p.removeInput=function(g){var I=d3.select("#places").selectAll("li.place .title");I.each(function(K,J){if(!K.edit){return}K.edit=false;p.saveText($(this),J,"place")});return false};p.refresh=function(){j();p.refreshed()};p.updateTitle=function(g){a=g};p.outputTitle=function(){return a||"My Meshu"};p.output=function(){var I=sb.rotator?sb.rotator.getRotation():0;A.attr("transform","rotate("+I+",300,300)");var g=$("#"+v).html();A.attr("transform","rotate(0)");return g};return p};