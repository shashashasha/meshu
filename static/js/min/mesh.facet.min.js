var sb=sb||{};sb.mesh.facet=function(k,C,s,o){var n=sb.mesh.base(k,C,s,o),u=parseInt(Math.random()*10000000000,10);n.name="facet";var z=[],j=[],l=[];var h=document.createElement("div");var f=d3.select(k||"body").append("div").attr("id",u).style("width",s).style("height",o).style("position","absolute").style("z-index","1").append("svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var A=f.append("g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var y=f.append("g").attr("class","hidden");y.append("path");var b=d3.select(k||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",s).style("height",o);var q=b.append("svg").attr("width","100%").attr("height","100%");var p=q.append("g").attr("id","delaunay-ui");var m=d3.select("#places");var B=m.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",n.removeInput)}var x=[],w=[],t=[],F=0,a=null;var v=$("#content");n.hittest=function(g){return d3.event.target!=q.node()};n.on("draggedMap",function(){i()});n.on("draggedPoint",function(G,H){G[0]=H.lon;G[1]=H.lat;var g=x.indexOf(G);z[g]=H.lat;j[g]=H.lon;n.dirty=true;i()});n.on("clickedMap",function(g){n.add(g.lat,g.lon,undefined,false)});n.on("removed",function(){if(x.length<3){$("#scroll-down").fadeIn()}if(x.length==1){$("#meshu-container").addClass("inactive")}});n.on("interactiveToggled",function(g){n.updateCircleBehavior(g)});var E=function(){var L=0,g=[];if(x.length<2){return}for(var I=0;I<x.length;I++){var J=C.l2p({lat:x[I][1],lon:x[I][0]});for(var G=I+1;G<x.length;G++){var H=C.l2p({lat:x[G][1],lon:x[G][0]});var N=J.x-H.x;var M=J.y-H.y;var K=Math.sqrt((N*N)+(M*M));if(K>L){L=K;g=[H,J]}}}return g};var d=function(H,G){var I=G.y-H.y,g=G.x-H.x;return Math.atan2(I,g)*(180/Math.PI)};var c=function(H,G){var I=G.y-H.y,g=G.x-H.x;return Math.sqrt((g*g)+(I*I))};var r=function(H,G){var g=G.getTransformToElement(G.ownerSVGElement);return H.matrixTransform(g)};n.getRotationAngle=function(){if(x.length<2){return}var H=E(C,x),G=d(H[0],H[1]),g=-G+180;return g};n.getLongestRotation=function(){return"rotate("+[n.getRotationAngle(),300,300].join(",")+") "};n.projectPoints=function(I){d3.select("#delaunay-ui").attr("transform",I);var g=[],G=[],H=[];var J=d3.selectAll("#delaunay-ui circle").each(function(O,L){var N=this.ownerSVGElement.createSVGPoint(),K=C.l2p({lat:z[L],lon:j[L]});N.x=K.x;N.y=K.y;var M=r(N,this);G.push(M.x);H.push(M.y);g.push([M.x,M.y])});d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");return{pts:g,xvalues:G,yvalues:H}};n.transformedDelaunay=function(J,H,L,G){var K={top:d3.min(J.yvalues),left:d3.min(J.xvalues),right:d3.max(J.xvalues),bottom:d3.max(J.yvalues)},I=K.right-K.left,M=K.bottom-K.top,g=H/I,O=L/M;var N=A.selectAll("path").data(d3.geom.delaunay(J.pts));N.enter().append("path");N.exit().remove();N.exit().remove();N.attr("stroke-width",20).attr("d",function(U){var Q=U.length;var P=[];for(var T=0;T<Q;T++){var S=(U[T][0]-K.left)*g,R=((U[T][1]-K.top)*O)+G;P.push([S,R])}return"M"+P.join(" L")+"Z"})};function e(G){var K=p.selectAll("circle");K.attr("cx",function(L){return C.l2p({lat:parseFloat(L[1]),lon:parseFloat(L[0])}).x}).attr("cy",function(L){return C.l2p({lat:L[1],lon:L[0]}).y});var g=A.selectAll("path").data(d3.geom.delaunay(x));g.enter().append("path");g.exit().remove();g.attr("d",function(Q){var M=Q.length;var L=[];for(var N=0;N<M;N++){var P={lat:parseFloat(Q[N][1]),lon:parseFloat(Q[N][0])};var O=C.l2p(P);L.push([O.x,O.y])}return"M"+L.join("L")+"Z"});if(w&&G==true){clearInterval(F);w=null}else{if(w){var J=x[x.length-1]||[];if(Math.abs(J[0]-w[0])>0.0002){J[0]+=(w[0]-J[0])/3}if(Math.abs(J[1]-w[1])>0.0002){J[1]+=(w[1]-J[1])/3}x[x.length-1]=J;var I=Math.abs(J[0]-w[0]);var H=Math.abs(J[1]-w[1]);if(H<0.0002&&I<0.0002){clearInterval(F);w=null}}else{clearInterval(F)}}}n.updatePixelBounds=function(){if(z.length&&j.length){t=[C.l2p({lat:d3.min(z),lon:d3.min(j)}),C.l2p({lat:d3.max(z),lon:d3.min(j)}),C.l2p({lat:d3.max(z),lon:d3.max(j)}),C.l2p({lat:d3.min(z),lon:d3.max(j)})]}else{t=[]}};function i(){var K=p.selectAll("circle").data(x);K.enter().append("circle").attr("id",function(M,L){return"c-"+L}).attr("r",10).on("mousedown",function(L){n.dragging=L;d3.event.stopPropagation()});K.exit().remove();var I=B.selectAll("li.place").data(x);var G=I.enter().append("li").attr("class","place");var J=G.append("span").attr("class","title");J.append("span").attr("class","place-text").html(function(M,L){h.innerHTML=l[L];return h.firstChild.nodeValue});J.append("span").attr("class","place-edit").html("edit");G.append("span").attr("class","place-delete").html("x");I.exit().remove();I.attr("id",function(M,L){return"p-"+L}).select(".title").each(function(L){L.edit=false}).attr("class","title").select(".place-text").html(function(M,L){h.innerHTML=l[L];return h.firstChild.nodeValue});var g=y.selectAll("circle.rotation").data(t);g.enter().append("circle").attr("class","rotation").attr("r","40").attr("cx",function(M,L){return M.x}).attr("cy",function(M,L){return M.y});g.exit().remove();g.attr("cx",function(M,L){return M.x}).attr("cy",function(M,L){return M.y});var H=y.select("path");H.attr("d",function(){if(t.length==0){return}var L=[];$.each(t,function(M,N){L.push([N.x,N.y])});return"M"+L.join("L")+"Z"}).attr("class","hiddenFrame");n.updateCircleBehavior();D();e()}n.updateCircleBehavior=function(I){var g=v.hasClass("view");var G=$("#place-hover");var H=p.selectAll("circle");H.on("mouseover",function(P,L){if(I){return}else{if(g){G.addClass("active").find("span").text(l[L]);var O=C.l2p({lat:P[1],lon:P[0]});var J=G.width();var N=(O.y-32)+"px";var M=(O.x-(J/2)-3)+"px";var K=J/2-3+"px";G.css({top:N,left:M}).find("b").css("left",K)}else{B.select("#p-"+L).attr("class","place highlight")}}});H.on("mouseout",function(K,J){if(I){return}else{if(g){G.removeClass("active")}else{B.select("#p-"+J).attr("class","place")}}})};function D(){var g=B.selectAll("li.place");g.select(".place-delete").on("click",function(H,G){n.remove(G);n.refresh()});g.on("mouseover",function(H,G){p.select("#c-"+G).attr("class","highlight")});g.on("mouseout",function(H,G){p.select("#c-"+G).attr("class","")});g.select(".place-edit").on("click",function(I,G){var H=$(this).parent();if(!I.edit){n.editText(H,G,"place");n.removeInput()}else{n.saveText(H,G,"place")}I.edit=!I.edit});g.select(".place-text").on("click",function(H,G){if(H.edit){return}n.removeInput();n.editText($(this).parent(),G,"place");H.edit=!H.edit})}n.add=function(L,H,J,g){if(F){clearInterval(F)}var I=parseFloat(L);var K=parseFloat(H);z.push(I);j.push(K);if(J==undefined){l.push(L.toFixed(3)+", "+H.toFixed(3))}else{l.push(J)}if(x.length){$("#meshu-container").removeClass("inactive");w=[K,I];if(g){x.push([w[0],w[1]]);n.updatePixelBounds();i();e(g)}else{var G=x[x.length-1];x.push([G[0],G[1]]);n.updatePixelBounds();i();F=setInterval(e,40)}}else{x.push([K,I]);i()}if(x.length>=3){$("#scroll-down").fadeIn()}n.dirty=true;n.added();return n};n.remove=function(g){x.splice(g,1);z.splice(g,1);j.splice(g,1);l.splice(g,1);n.dirty=true;if(x.length<3){$("#scroll-down").fadeOut()}if(x.length==1){$("#meshu-container").addClass("inactive")}};n.lats=function(){return z};n.lons=function(){return j};n.places=function(){return l};n.points=function(g){if(!arguments.length){return x}x=g;return n};n.bakeStyles=function(){y.style("display","none")};n.unBakeStyles=function(){y.style("display","")};n.locations=function(g){w=null;x=[];z=[];j=[];l=[];$.each(g,function(G,H){x.push([H.longitude,H.latitude]);z.push(H.latitude);j.push(H.longitude);l.push(H.name)});n.locationsSet();return n};n.editText=function(I,G,H){var g=I.find("."+H+"-edit").text("save");var K=I.find("."+H+"-text");var J=((H=="title")?K.text():l[G]);I.addClass("active");K.html('<input value="'+J+'">').find("input").focus()};n.saveText=function(I,G,H){var g=I.find("."+H+"-edit").text("edit");var J=I.find("input").val();I.removeClass("active");I.find("."+H+"-text").text(J);if(H=="place"){l[G]=J}else{return J}};n.removeInput=function(g){var G=d3.select("#places").selectAll("li.place .title");G.each(function(I,H){if(!I.edit){return}I.edit=false;n.saveText($(this),H,"place")});return false};n.refresh=function(){i();n.refreshed()};n.updateTitle=function(g){a=g};n.outputTitle=function(){return a||"My Meshu"};n.output=function(){return $("#"+u).html()};return n};