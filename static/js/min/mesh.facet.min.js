var sb=sb||{};sb.mesh.facet=function(k,D,s,p){var o=sb.mesh.base(k,D,s,p),u=parseInt(Math.random()*10000000000,10);o.name="facet";var z=[],j=[],l=[],C=null,H={};var h=document.createElement("div");var f=d3.select(k||"body").append("div").attr("id",u).style("width",s).style("height",p).style("position","absolute").style("z-index","1").append("svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var A=f.append("g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var y=f.append("g").attr("class","hidden");y.append("path");var b=d3.select(k||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",s).style("height",p);var q=b.append("svg").attr("width","100%").attr("height","100%");var n=q.append("g").attr("id","delaunay-ui");var m=d3.select("#places");var B=m.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",o.removeInput)}var x=[],w=[],t=[],G=0,a=null;var v=$("#content");o.hittest=function(g){return d3.event.target!=q.node()};o.on("draggedMap",function(){i()});o.on("draggedPoint",function(I,J){I[0]=J.lon;I[1]=J.lat;var g=x.indexOf(I);z[g]=J.lat;j[g]=J.lon;o.dirty=true;C=null;H={};i()});o.on("clickedMap",function(g){o.add(g.lat,g.lon,undefined,false)});o.on("removed",function(){if(x.length<3){$("#scroll-down").fadeIn()}if(x.length==1){$("#meshu-container").addClass("inactive")}});o.on("interactiveToggled",function(g){o.updateCircleBehavior(g)});var F=function(){var N=0,g=[];if(x.length<2){return}for(var K=0;K<x.length;K++){var L=D.l2p({lat:x[K][1],lon:x[K][0]});for(var I=K+1;I<x.length;I++){var J=D.l2p({lat:x[I][1],lon:x[I][0]});var P=L.x-J.x;var O=L.y-J.y;var M=Math.sqrt((P*P)+(O*O));if(M>N){N=M;g=[J,L]}}}return g};var d=function(J,I){var K=I.y-J.y,g=I.x-J.x;return Math.atan2(K,g)*(180/Math.PI)};var c=function(J,I){var K=I.y-J.y,g=I.x-J.x;return Math.sqrt((g*g)+(K*K))};var r=function(J,I){var g=I.getTransformToElement(I.ownerSVGElement);return J.matrixTransform(g)};o.getRotationAngle=function(){if(x.length<2){return}var J=F(D,x),I=d(J[0],J[1]),g=-I+180;return g};o.getLongestRotation=function(){if(C==null){C=o.getRotationAngle()}return"rotate("+[C,300,300].join(",")+") "};o.projectPoints=function(K){if(H.transform==K){return H}console.log("projecting points");d3.select("#delaunay-ui").attr("transform",K);var g=[],I=[],J=[];var L=d3.selectAll("#delaunay-ui circle").each(function(Q,N){var P=this.ownerSVGElement.createSVGPoint(),M=D.l2p({lat:z[N],lon:j[N]});P.x=M.x;P.y=M.y;var O=r(P,this);I.push(O.x);J.push(O.y);g.push([O.x,O.y])});d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");H={pts:g,xvalues:I,yvalues:J,transform:K};return H};o.transformedDelaunay=function(L,J,N,I){var M={top:d3.min(L.yvalues),left:d3.min(L.xvalues),right:d3.max(L.xvalues),bottom:d3.max(L.yvalues)},K=M.right-M.left,O=M.bottom-M.top,g=J/K,Q=N/O;var P=A.selectAll("path").data(d3.geom.delaunay(L.pts));P.enter().append("path");P.exit().remove();P.exit().remove();P.attr("stroke-width",20).attr("d",function(W){var S=W.length;var R=[];for(var V=0;V<S;V++){var U=(W[V][0]-M.left)*g,T=((W[V][1]-M.top)*Q)+I;R.push([U,T])}return"M"+R.join(" L")+"Z"})};function e(I){var M=n.selectAll("circle");M.attr("cx",function(N){return D.l2p({lat:parseFloat(N[1]),lon:parseFloat(N[0])}).x}).attr("cy",function(N){return D.l2p({lat:N[1],lon:N[0]}).y});var g=A.selectAll("path").data(d3.geom.delaunay(x));g.enter().append("path");g.exit().remove();g.attr("d",function(S){var O=S.length;var N=[];for(var P=0;P<O;P++){var R={lat:parseFloat(S[P][1]),lon:parseFloat(S[P][0])};var Q=D.l2p(R);N.push([Q.x,Q.y])}return"M"+N.join("L")+"Z"});if(w&&I==true){clearInterval(G);w=null}else{if(w){var L=x[x.length-1]||[];if(Math.abs(L[0]-w[0])>0.0002){L[0]+=(w[0]-L[0])/3}if(Math.abs(L[1]-w[1])>0.0002){L[1]+=(w[1]-L[1])/3}x[x.length-1]=L;var K=Math.abs(L[0]-w[0]);var J=Math.abs(L[1]-w[1]);if(J<0.0002&&K<0.0002){clearInterval(G);w=null}}else{clearInterval(G)}}}o.updatePixelBounds=function(){if(z.length&&j.length){t=[D.l2p({lat:d3.min(z),lon:d3.min(j)}),D.l2p({lat:d3.max(z),lon:d3.min(j)}),D.l2p({lat:d3.max(z),lon:d3.max(j)}),D.l2p({lat:d3.min(z),lon:d3.max(j)})]}else{t=[]}};function i(){var M=n.selectAll("circle").data(x);M.enter().append("circle").attr("id",function(O,N){return"c-"+N}).attr("r",10).on("mousedown",function(N){o.dragging=N;d3.event.stopPropagation()});M.exit().remove();var K=B.selectAll("li.place").data(x);var I=K.enter().append("li").attr("class","place");var L=I.append("span").attr("class","title");L.append("span").attr("class","place-text").html(function(O,N){h.innerHTML=l[N];return h.firstChild.nodeValue});L.append("span").attr("class","place-edit").html("edit");I.append("span").attr("class","place-delete").html("x");K.exit().remove();K.attr("id",function(O,N){return"p-"+N}).select(".title").each(function(N){N.edit=false}).attr("class","title").select(".place-text").html(function(O,N){h.innerHTML=l[N];return h.firstChild.nodeValue});var g=y.selectAll("circle.rotation").data(t);g.enter().append("circle").attr("class","rotation").attr("r","40").attr("cx",function(O,N){return O.x}).attr("cy",function(O,N){return O.y});g.exit().remove();g.attr("cx",function(O,N){return O.x}).attr("cy",function(O,N){return O.y});var J=y.select("path");J.attr("d",function(){if(t.length==0){return}var N=[];$.each(t,function(O,P){N.push([P.x,P.y])});return"M"+N.join("L")+"Z"}).attr("class","hiddenFrame");o.updateCircleBehavior();E();e()}o.updateCircleBehavior=function(K){var g=v.hasClass("view");var I=$("#place-hover");var J=n.selectAll("circle");J.on("mouseover",function(R,N){if(K){return}else{if(g){I.addClass("active").find("span").text(l[N]);var Q=D.l2p({lat:R[1],lon:R[0]});var L=I.width();var P=(Q.y-32)+"px";var O=(Q.x-(L/2)-3)+"px";var M=L/2-3+"px";I.css({top:P,left:O}).find("b").css("left",M)}else{B.select("#p-"+N).attr("class","place highlight")}}});J.on("mouseout",function(M,L){if(K){return}else{if(g){I.removeClass("active")}else{B.select("#p-"+L).attr("class","place")}}})};function E(){var g=B.selectAll("li.place");g.select(".place-delete").on("click",function(J,I){o.remove(I);o.refresh()});g.on("mouseover",function(J,I){n.select("#c-"+I).attr("class","highlight")});g.on("mouseout",function(J,I){n.select("#c-"+I).attr("class","")});g.select(".place-edit").on("click",function(K,I){var J=$(this).parent();if(!K.edit){o.editText(J,I,"place");o.removeInput()}else{o.saveText(J,I,"place")}K.edit=!K.edit});g.select(".place-text").on("click",function(J,I){if(J.edit){return}o.removeInput();o.editText($(this).parent(),I,"place");J.edit=!J.edit})}o.add=function(N,J,L,g){if(G){clearInterval(G)}var K=parseFloat(N);var M=parseFloat(J);z.push(K);j.push(M);if(L==undefined){l.push(N.toFixed(3)+", "+J.toFixed(3))}else{l.push(L)}if(x.length){$("#meshu-container").removeClass("inactive");w=[M,K];if(g){x.push([w[0],w[1]]);o.updatePixelBounds();i();e(g)}else{var I=x[x.length-1];x.push([I[0],I[1]]);o.updatePixelBounds();i();G=setInterval(e,40)}}else{x.push([M,K]);i()}if(x.length>=3){$("#scroll-down").fadeIn()}o.dirty=true;C=null;H={};o.added();return o};o.remove=function(g){x.splice(g,1);z.splice(g,1);j.splice(g,1);l.splice(g,1);o.dirty=true;C=null;H={};if(x.length<3){$("#scroll-down").fadeOut()}if(x.length==1){$("#meshu-container").addClass("inactive")}};o.lats=function(){return z};o.lons=function(){return j};o.places=function(){return l};o.points=function(g){if(!arguments.length){return x}x=g;return o};o.bakeStyles=function(){y.style("display","none")};o.unBakeStyles=function(){y.style("display","")};o.locations=function(g){w=null;x=[];z=[];j=[];l=[];$.each(g,function(I,J){x.push([J.longitude,J.latitude]);z.push(J.latitude);j.push(J.longitude);l.push(J.name)});o.locationsSet();return o};o.editText=function(K,I,J){var g=K.find("."+J+"-edit").text("save");var M=K.find("."+J+"-text");var L=((J=="title")?M.text():l[I]);K.addClass("active");M.html('<input value="'+L+'">').find("input").focus()};o.saveText=function(K,I,J){var g=K.find("."+J+"-edit").text("edit");var L=K.find("input").val();K.removeClass("active");K.find("."+J+"-text").text(L);if(J=="place"){l[I]=L}else{return L}};o.removeInput=function(g){var I=d3.select("#places").selectAll("li.place .title");I.each(function(K,J){if(!K.edit){return}K.edit=false;o.saveText($(this),J,"place")});return false};o.refresh=function(){i();o.refreshed()};o.updateTitle=function(g){a=g};o.outputTitle=function(){return a||"My Meshu"};o.output=function(){return $("#"+u).html()};return o};