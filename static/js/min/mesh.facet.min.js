var sb=sb||{};sb.mesh.facet=function(i,B,q,m){var l=sb.mesh.base(i,B,q,m),s=parseInt(Math.random()*10000000000,10);l.name="facet";var x=[],h=[],j=[];var e=document.createElement("div");var d=d3.select(i||"body").append("div").attr("id",s).style("width",q).style("height",m).style("position","absolute").style("z-index","1").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var y=d.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var w=d.append("svg:g").attr("class","hidden");w.append("svg:path");var b=d3.select(i||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",q).style("height",m);var o=b.append("svg:svg").attr("width","100%").attr("height","100%");var n=o.append("svg:g").attr("id","delaunay-ui");var k=d3.select("#places");var A=k.select("#place-title").attr("class","inactive");A.append("span").attr("class","title-text");A.append("span").attr("class","title-edit").html("edit");var z=k.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",l.removeInput)}var v=[],u=[],r=[],D=0,a=null;var t=$("#content");l.hittest=function(g){return d3.event.target!=o.node()};l.on("draggedMap",function(){f()});l.on("draggedPoint",function(E,F){E[0]=F.lon;E[1]=F.lat;var g=v.indexOf(E);x[g]=F.lat;h[g]=F.lon;l.dirty=true;f()});l.on("clickedMap",function(g){l.add(g.lat,g.lon,undefined,false)});l.on("clickedPoint",function(E){var g=v.indexOf(E);l.remove(g);B.updateBounds(x,h);l.updatePixelBounds();l.dirty=false;f()});l.on("removed",function(){if(v.length==1){$("#meshu-container").addClass("inactive")}});l.on("interactiveToggled",function(g){l.updateCircleBehavior(g)});var p=function(F,E){var g=E.getTransformToElement(E.ownerSVGElement);return F.matrixTransform(g)};l.projectPoints=function(G){d3.select("#delaunay-ui").attr("transform",G);var g=[],E=[],F=[];var H=d3.selectAll("#delaunay-ui circle").each(function(M,J){var L=this.ownerSVGElement.createSVGPoint(),I=B.l2p({lat:x[J],lon:h[J]});L.x=I.x;L.y=I.y;var K=p(L,this);E.push(K.x);F.push(K.y);g.push([K.x,K.y])});d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");return{pts:g,xvalues:E,yvalues:F}};l.transformedDelaunay=function(H,F,J,E){var I={top:d3.min(H.yvalues),left:d3.min(H.xvalues),right:d3.max(H.xvalues),bottom:d3.max(H.yvalues)},G=I.right-I.left,K=I.bottom-I.top,g=F/G,M=J/K;var L=y.selectAll("path").data(d3.geom.delaunay(H.pts));L.enter().append("svg:path");L.exit().remove();L.exit().remove();L.attr("stroke-width",25).attr("d",function(S){var O=S.length;var N=[];for(var R=0;R<O;R++){var Q=(S[R][0]-I.left)*g,P=((S[R][1]-I.top)*M)+E;N.push([Q,P])}return"M"+N.join(" L")+"Z"})};function c(E){var I=n.selectAll("circle");I.attr("cx",function(J){return B.l2p({lat:J[1],lon:J[0]}).x}).attr("cy",function(J){return B.l2p({lat:J[1],lon:J[0]}).y});var g=y.selectAll("path").data(d3.geom.delaunay(v));g.enter().append("svg:path");g.exit().remove();g.attr("d",function(O){var K=O.length;var J=[];for(var L=0;L<K;L++){var N={lat:parseFloat(O[L][1]),lon:parseFloat(O[L][0])};var M=B.l2p(N);J.push([M.x,M.y])}return"M"+J.join("L")+"Z"});if(u&&E==true){clearInterval(D);u=null}else{if(u){var H=v[v.length-1]||[];if(Math.abs(H[0]-u[0])>0.0002){H[0]+=(u[0]-H[0])/3}if(Math.abs(H[1]-u[1])>0.0002){H[1]+=(u[1]-H[1])/3}v[v.length-1]=H;var G=Math.abs(H[0]-u[0]);var F=Math.abs(H[1]-u[1]);if(F<0.0002&&G<0.0002){clearInterval(D);u=null}}else{clearInterval(D)}}}l.updatePixelBounds=function(){if(x.length&&h.length){r=[B.l2p({lat:d3.min(x),lon:d3.min(h)}),B.l2p({lat:d3.max(x),lon:d3.min(h)}),B.l2p({lat:d3.max(x),lon:d3.max(h)}),B.l2p({lat:d3.min(x),lon:d3.max(h)})]}else{r=[]}};function f(){var I=n.selectAll("circle").data(v);I.enter().append("svg:circle").attr("id",function(K,J){return"c-"+J}).attr("r",7).on("mousedown",function(J){l.dragging=J;d3.event.stopPropagation()});I.exit().remove();var G=z.selectAll("li.place").data(v);var E=G.enter().append("li").attr("class","place");var H=E.append("span").attr("class","title");H.append("span").attr("class","place-text").html(function(K,J){e.innerHTML=j[J];return e.firstChild.nodeValue});H.append("span").attr("class","place-edit").html("edit");E.append("span").attr("class","place-delete").html("x");G.exit().remove();G.attr("id",function(K,J){return"p-"+J}).select(".title").each(function(J){J.edit=false}).attr("class","title").select(".place-text").html(function(K,J){e.innerHTML=j[J];return e.firstChild.nodeValue});A.data(v).each(function(J){J.edit=false});var g=w.selectAll("circle.rotation").data(r);g.enter().append("svg:circle").attr("class","rotation").attr("r","40").attr("cx",function(K,J){return K.x}).attr("cy",function(K,J){return K.y});g.exit().remove();g.attr("cx",function(K,J){return K.x}).attr("cy",function(K,J){return K.y});var F=w.select("path");F.attr("d",function(){if(r.length==0){return}var J=[];$.each(r,function(K,L){J.push([L.x,L.y])});return"M"+J.join("L")+"Z"}).attr("class","hiddenFrame");l.updateCircleBehavior();C();c()}l.updateCircleBehavior=function(G){var E=t.hasClass("edit");var g=$("#place-hover");var F=n.selectAll("circle");F.on("mouseover",function(N,J){if(G){return}else{if(E){z.select("#p-"+J).attr("class","place highlight")}else{g.addClass("active").find("span").text(j[J]);var M=B.l2p({lat:N[1],lon:N[0]});var H=g.width();var L=(M.y-32)+"px";var K=(M.x-(H/2)-3)+"px";var I=H/2-3+"px";g.css({top:L,left:K}).find("b").css("left",I)}}});F.on("mouseout",function(I,H){if(G){return}else{if(E){z.select("#p-"+H).attr("class","place")}else{g.removeClass("active")}}})};function C(){var g=z.selectAll("li.place");g.select(".place-delete").on("click",function(F,E){l.remove(E);l.updatePixelBounds();B.updateBounds(x,h);f()});g.on("mouseover",function(F,E){n.select("#c-"+E).attr("class","highlight")});g.on("mouseout",function(F,E){n.select("#c-"+E).attr("class","")});g.select(".place-edit").on("click",function(G,E){var F=$(this).parent();if(!G.edit){l.editText(F,E,"place")}else{l.saveText(F,E,"place")}G.edit=!G.edit});g.select(".place-text").on("click",function(F,E){if(F.edit){return}l.editText($(this).parent(),E,"place");F.edit=!F.edit});A.attr("class","").select(".title-text").text(function(E){if(E&&E.title){return E.title}else{return"My Meshu"}});A.select(".title-text").on("click",function(E){if(E.edit){return}l.editText($(this).parent(),0,"title");E.edit=!E.edit});A.select(".title-edit").on("click",function(F){var E=$(this).parent();if(!F.edit){l.editText(E,0,"title")}else{F.title=a=l.saveText(E,0,"title")}F.edit=!F.edit})}l.add=function(J,F,H,g){if(D){clearInterval(D)}var G=parseFloat(J);var I=parseFloat(F);x.push(G);h.push(I);if(H==undefined){j.push(J.toFixed(3)+", "+F.toFixed(3))}else{j.push(H)}if(v.length){$("#meshu-container").removeClass("inactive");u=[I,G];if(g){v.push([u[0],u[1]]);l.updatePixelBounds();f();c(g)}else{var E=v[v.length-1];v.push([E[0],E[1]]);l.updatePixelBounds();f();D=setInterval(c,40)}}else{v.push([I,G]);f()}l.dirty=true;l.added();return l};l.remove=function(g){v.splice(g,1);x.splice(g,1);h.splice(g,1);j.splice(g,1);if(v.length==1){$("#meshu-container").addClass("inactive")}};l.lats=function(){return x};l.lons=function(){return h};l.places=function(){return j};l.points=function(g){if(!arguments.length){return v}v=g;return l};l.bakeStyles=function(){w.style("display","none")};l.unBakeStyles=function(){w.style("display","")};l.locations=function(g){u=null;v=[];x=[];h=[];j=[];$.each(g,function(E,F){v.push([F.longitude,F.latitude]);x.push(F.latitude);h.push(F.longitude);j.push(F.name)});l.locationsSet();return l};l.refresh=function(){f();l.refreshed()};l.updateTitle=function(g){a=g};l.outputTitle=function(){return a||"My Meshu"};l.output=function(){return $("#"+s).html()};return l};