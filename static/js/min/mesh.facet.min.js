var sb=sb||{};sb.mesh.facet=function(i,A,p,m){var l=sb.mesh.base(i,A,p,m),r=parseInt(Math.random()*10000000000,10);l.name="facet";var w=[],h=[],j=[];var e=document.createElement("div");var d=d3.select(i||"body").append("div").attr("id",r).style("width",p).style("height",m).style("position","absolute").style("z-index","1").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var x=d.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var v=d.append("svg:g").attr("class","hidden");v.append("svg:path");var b=d3.select(i||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",p).style("height",m);var o=b.append("svg:svg").attr("width","100%").attr("height","100%");var n=o.append("svg:g").attr("id","delaunay-ui");var k=d3.select("#places");var z=k.select("#place-title").attr("class","inactive");z.append("span").attr("class","title-text");z.append("span").attr("class","title-edit").html("edit");var y=k.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",l.removeInput)}var u=[],t=[],q=[],C=0,a=null;var s=$("#content");l.hittest=function(g){return d3.event.target!=o.node()};l.on("draggedMap",function(){f()});l.on("draggedPoint",function(D,E){D[0]=E.lon;D[1]=E.lat;var g=u.indexOf(D);w[g]=E.lat;h[g]=E.lon;l.dirty=true;f()});l.on("clickedMap",function(g){l.add(g.lat,g.lon,undefined,false)});l.on("clickedPoint",function(D){var g=u.indexOf(D);l.remove(g);A.updateBounds(w,h);l.updatePixelBounds();l.dirty=false;f()});l.on("removed",function(){if(u.length<3){$("#finish-button").removeClass("active")}if(u.length==1){$("#meshu-container").addClass("inactive")}});l.on("interactiveToggled",function(g){l.updateCircleBehavior(g)});function c(D){var H=n.selectAll("circle");H.attr("cx",function(I){return A.l2p({lat:I[1],lon:I[0]}).x}).attr("cy",function(I){return A.l2p({lat:I[1],lon:I[0]}).y});var g=x.selectAll("path").data(d3.geom.delaunay(u));g.enter().append("svg:path");g.exit().remove();g.attr("d",function(N){var J=N.length;var I=[];for(var K=0;K<J;K++){var M={lat:parseFloat(N[K][1]),lon:parseFloat(N[K][0])};var L=A.l2p(M);I.push([L.x,L.y])}return"M"+I.join("L")+"Z"});if(t&&D==true){clearInterval(C);t=null}else{if(t){var G=u[u.length-1]||[];if(Math.abs(G[0]-t[0])>0.0002){G[0]+=(t[0]-G[0])/3}if(Math.abs(G[1]-t[1])>0.0002){G[1]+=(t[1]-G[1])/3}u[u.length-1]=G;var F=Math.abs(G[0]-t[0]);var E=Math.abs(G[1]-t[1]);if(E<0.0002&&F<0.0002){clearInterval(C);t=null}}else{clearInterval(C)}}}l.updatePixelBounds=function(){if(w.length&&h.length){q=[A.l2p({lat:d3.min(w),lon:d3.min(h)}),A.l2p({lat:d3.max(w),lon:d3.min(h)}),A.l2p({lat:d3.max(w),lon:d3.max(h)}),A.l2p({lat:d3.min(w),lon:d3.max(h)})]}else{q=[]}};function f(){var H=n.selectAll("circle").data(u);H.enter().append("svg:circle").attr("id",function(J,I){return"c-"+I}).attr("r",7).on("mousedown",function(I){l.dragging=I;d3.event.stopPropagation()});H.exit().remove();var F=y.selectAll("li.place").data(u);var D=F.enter().append("li").attr("class","place");var G=D.append("span").attr("class","title");G.append("span").attr("class","place-text").html(function(J,I){e.innerHTML=j[I];return e.firstChild.nodeValue});G.append("span").attr("class","place-edit").html("edit");D.append("span").attr("class","place-delete").html("x");F.exit().remove();F.attr("id",function(J,I){return"p-"+I}).select(".title").each(function(I){I.edit=false}).attr("class","title").select(".place-text").html(function(J,I){e.innerHTML=j[I];return e.firstChild.nodeValue});z.data(u).each(function(I){I.edit=false});var g=v.selectAll("circle.rotation").data(q);g.enter().append("svg:circle").attr("class","rotation").attr("r","40").attr("cx",function(J,I){return J.x}).attr("cy",function(J,I){return J.y});g.exit().remove();g.attr("cx",function(J,I){return J.x}).attr("cy",function(J,I){return J.y});var E=v.select("path");E.attr("d",function(){if(q.length==0){return}var I=[];$.each(q,function(J,K){I.push([K.x,K.y])});return"M"+I.join("L")+"Z"}).attr("class","hiddenFrame");l.updateCircleBehavior();B();c()}l.updateCircleBehavior=function(F){var D=s.hasClass("edit");var g=$("#place-hover");var E=n.selectAll("circle");E.on("mouseover",function(M,I){if(F){return}else{if(D){y.select("#p-"+I).attr("class","place highlight")}else{g.addClass("active").find("span").text(j[I]);var L=A.l2p({lat:M[1],lon:M[0]});var G=g.width();var K=(L.y-32)+"px";var J=(L.x-(G/2)-3)+"px";var H=G/2-3+"px";g.css({top:K,left:J}).find("b").css("left",H)}}});E.on("mouseout",function(H,G){if(F){return}else{if(D){y.select("#p-"+G).attr("class","place")}else{g.removeClass("active")}}})};function B(){var g=y.selectAll("li.place");g.select(".place-delete").on("click",function(E,D){l.remove(D);l.updatePixelBounds();A.updateBounds(w,h);f()});g.on("mouseover",function(E,D){n.select("#c-"+D).attr("class","highlight")});g.on("mouseout",function(E,D){n.select("#c-"+D).attr("class","")});g.select(".place-edit").on("click",function(F,D){var E=$(this).parent();if(!F.edit){l.editText(E,D,"place")}else{l.saveText(E,D,"place")}F.edit=!F.edit});g.select(".place-text").on("click",function(E,D){if(E.edit){return}l.editText($(this).parent(),D,"place");E.edit=!E.edit});z.attr("class","").select(".title-text").text(function(D){if(D&&D.title){return D.title}else{return"My Meshu"}});z.select(".title-text").on("click",function(D){if(D.edit){return}l.editText($(this).parent(),0,"title");D.edit=!D.edit});z.select(".title-edit").on("click",function(E){var D=$(this).parent();if(!E.edit){editText(D,0,"title")}else{E.title=a=l.saveText(D,0,"title")}E.edit=!E.edit})}l.add=function(I,E,G,g){if(C){clearInterval(C)}var F=parseFloat(I);var H=parseFloat(E);w.push(F);h.push(H);if(G==undefined){j.push(I.toFixed(3)+", "+E.toFixed(3))}else{j.push(G)}if(u.length){$("#meshu-container").removeClass("inactive");t=[H,F];if(g){u.push([t[0],t[1]]);l.updatePixelBounds();f();c(g)}else{var D=u[u.length-1];u.push([D[0],D[1]]);l.updatePixelBounds();f();C=setInterval(c,40)}}else{u.push([H,F]);f()}l.dirty=true;l.added();return l};l.remove=function(g){u.splice(g,1);w.splice(g,1);h.splice(g,1);j.splice(g,1);if(u.length<3){$("#finish-button").removeClass("active")}if(u.length==1){$("#meshu-container").addClass("inactive")}};l.lats=function(){return w};l.lons=function(){return h};l.places=function(){return j};l.points=function(g){if(!arguments.length){return u}u=g;return l};l.bakeStyles=function(){v.style("display","none")};l.unBakeStyles=function(){v.style("display","")};l.locations=function(g){t=null;u=[];w=[];h=[];j=[];$.each(g,function(D,E){u.push([E.longitude,E.latitude]);w.push(E.latitude);h.push(E.longitude);j.push(E.name)});l.locationsSet();return l};l.refresh=function(){f();l.refreshed()};l.updateTitle=function(g){a=g};l.outputTitle=function(){return a||"My Meshu"};l.output=function(){return $("#"+r).html()};return l};