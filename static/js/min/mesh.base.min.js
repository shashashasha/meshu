var sb=sb||{};sb.mesh={};sb.mesh.base=function(e,x,k,h){var g=d3.dispatch("added","refreshed","locationsSet","removed","draggedMap","draggedPoint","clickedMap","clickedPoint","styled","interactiveToggled"),m=parseInt(Math.random()*10000000000,10);g.dirty=true;var s=[],d=[],f=[],t={};var r=[],q=[],l=[],y=0,j=null,c=false,w=null,i=null,u=null,a=null;var p=$("#content"),b=$("#cases");d3.select(".frame").on("mousemove",v).on("mousedown",n);d3.select("body").on("mouseup",o);function n(){if(!p.hasClass("edit")){return}w=true}function v(){if(!p.hasClass("edit")){return}if(!g.dragging&&!w){return}var z=d3.svg.mouse(e);if(g.dragging){var A=x.p2l({x:z[0],y:z[1]});g.draggedPoint(g.dragging,A)}if(c&&w){i=true;if(u){x.map.panBy({x:z[0]-u[0],y:z[1]-u[1]})}g.dirty=true;g.draggedMap()}c=true;u=z}function o(){w=null;u=null;if(!p.hasClass("edit")){return}if(d3.event.target.tagName!="circle"&&g.hittest(d3.event.target)&&d3.event.target.tagName!="image"){return}if(!g.dragging&&!i){var z=d3.svg.mouse(e);var A=x.p2l({x:z[0],y:z[1]});g.clickedMap(A);i=null;return}if(!c&&g.dragging){g.clickedPoint(g.dragging)}else{v()}if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}c=false;g.dragging=null;i=null}g.updatePixelBounds=function(){if(s.length&&d.length){l=[x.l2p({lat:d3.min(s),lon:d3.min(d)}),x.l2p({lat:d3.max(s),lon:d3.min(d)}),x.l2p({lat:d3.max(s),lon:d3.max(d)}),x.l2p({lat:d3.min(s),lon:d3.max(d)})]}else{l=[]}};g.editText=function(C,A,B){var z=C.find("."+B+"-edit").text("save");var E=C.find("."+B+"-text");var D=((B=="title")?E.text():f[A]);C.addClass("active");E.html('<input value="'+D+'">').find("input").focus()};g.saveText=function(C,A,B){var z=C.find("."+B+"-edit").text("edit");var D=C.find("input").val();C.removeClass("active");C.find("."+B+"-text").text(D);if(B=="place"){f[A]=D}else{return D}};g.removeInput=function(z){var A=list.selectAll("li.place .title");A.each(function(C,B){if(!C.edit){return}C.edit=false;g.saveText($(this),B,"place")});return false};g.add=function(E,A,C,z){var B=parseFloat(E);var D=parseFloat(A);s.push(B);d.push(D);if(C==undefined){f.push(E.toFixed(3)+", "+A.toFixed(3))}else{f.push(C)}r.push([D,B]);update();g.added();return g};g.remove=function(z){r.splice(z,1);s.splice(z,1);d.splice(z,1);f.splice(z,1);g.removed()};g.interactive=function(z){g.interactiveToggled(z)};g.lats=function(){return s};g.lons=function(){return d};g.places=function(){return f};g.points=function(z){if(!arguments.length){return r}r=z;return g};g.locations=function(z){q=null;r=[];s=[];d=[];f=[];$.each(z,function(A,B){r.push([B.longitude,B.latitude]);s.push(B.latitude);d.push(B.longitude);f.push(B.name)});g.locationsSet();return g};g.refresh=function(){update();g.refreshed()};g.prerender=function(){};g.applyStyle=function(z){var C=z.split("|");var B={};for(var A=0;A<C.length;A++){var D=C[A].split(":");B[D[0]]=D[1]}g.style(B)};g.style=function(A){if(!arguments.length){return A}for(var z in A){t[z]=A[z]}g.styled(t)};g.outputStyle=function(){var A=[];for(var z in t){A.push(z+":"+t[z])}return A.join("|")};g.updateTitle=function(z){a=z};g.outputTitle=function(){return a||"My Meshu"};g.output=function(){return $("#"+m).html()};g.outputMesh=function(){return".delaunay"};return g};