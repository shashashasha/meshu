var sb=sb||{};sb.catalog=function(f,d){var a={},e={},f=f||"facet";e.facet={earrings:{bamboo:{price:68,colors:["Amber"]},acrylic:{price:75,colors:["Black","White"]},nylon:{price:85,colors:["Black","White"]},silver:{price:145,colors:["Sterling Silver"]}},pendant:{bamboo:{price:68,colors:["Amber"]},acrylic:{price:80,colors:["Black","White"]},nylon:{price:85,colors:["Black","White"]},silver:{price:125,colors:["Sterling Silver"]}},necklace:{bamboo:{price:75,colors:["Amber"]},acrylic:{price:85,colors:["Black","White"]},nylon:{price:90,colors:["Black","White"]},silver:{price:145,colors:["Sterling Silver"]}},cufflinks:{silver:{price:145}}};e.radial={earrings:{bamboo:{price:75,colors:["Amber"]},acrylic:{price:80,colors:["Black","White"]},nylon:{price:90,colors:["Black","White"]}},pendant:{bamboo:{price:75,colors:["Amber"]},acrylic:{price:85,colors:["Black","White"]},nylon:{price:95,colors:["Black","White"]},silver:{price:140,colors:["Sterling Silver"]}}};var c=e[f];var b={};b.marathon={earrings:{bamboo:{price:64,colors:["Amber"],discount:0.85,originalPrice:75}},pendant:{bamboo:{price:64,colors:["Amber"],discount:0.85,originalPrice:75}},necklace:{bamboo:{price:68,colors:["Amber"],discount:0.85,originalPrice:80}}};if(d&&b[d]){c=b[d]}a.check=function(h,g){return c[h]&&c[h][g]};a.get=function(i,h,g){if(!c[i]||!c[i][h]){return"N/A"}return c[i][h][g]};a.getPrice=function(h,g){return a.get(h,g,"price")};a.getColors=function(h,g){return a.get(h,g,"colors")};if(d){a.getProducts=function(){var m=[];for(var k in c){var i=[],h=[],g=[],l=c[k];for(var j in l){i.push(l[j].price);if(l[j].originalPrice){h.push(l[j].originalPrice)}if(l[j].discount){g.push(l[j].discount)}}m.push({type:k,prices:i,originals:h,discount:g.length?g[0]:undefined})}return m}}else{a.getProducts=function(){var k=[];for(var i in c){var g=[],j=c[i];for(var h in j){g.push(j[h].price)}k.push({type:i,prices:g,discount:j.discount})}return k}}a.getMaterials=function(j){var g=[];for(var h in c[j]){g.push(h)}return g};return a};Stripe.setPublishableKey("pk_GtEuTncR1hDqm7tP3oz9RRM9XOLub");var orderer=function(){var k={},i=0,e=0,d=1,h=null,g=null,b=5,c=5,j=17,f=null;function a(l,m){var o=$("#payment-form");var n=m.id;o.append("<input type='hidden' name='stripeToken' value='"+n+"' />");var p=o.attr("action");if(p.search("None")>0){o.attr("action","/order/")}o.get(0).submit()}k.submit=function(){if(i<2000){return}$("#submit-button").attr("disabled","disabled").addClass("inactive");$(".card-info").removeAttr("name");Stripe.createToken({number:$("#card-number").val(),cvc:$("#card-cvc").val(),exp_month:$("#card-expiry-month").val(),exp_year:$("#card-expiry-year").val()},i,a);return false};k.shippingMode=function(m){var l=m=="international"?j:c;k.updateProduct(h,g,l)};k.applyCoupon=function(l,m){$.get("/order/apply_coupon",{code:l},function(n){if(n.success){var o=parseFloat(n.amount);if(o<1&&o>0){d=o}else{if(o>0){e=parseInt(n.amount)}}}if(m){m(n)}},"json")};k.catalog=function(l){if(f){return}f=l;return k};k.updateProduct=function(n,l,o){if(!f.check(n,l)){return}b=o||5;h=n;g=l;i=k.getTotal()*100;return k};k.getPrice=function(){return f.getPrice(h,g)};k.getPriceString=function(){if(!f){return null}return"$"+k.getPrice()+".00"};k.getShipping=function(){return b};k.getTotal=function(){if(!f){return null}return Math.floor(d*(k.getPrice()-e))+b};k.getTotalCents=function(){if(!f){return null}return k.getTotal()*100};k.getTotalString=function(){if(!f){return null}return"$"+k.getTotal()+".00"};k.getColors=function(m,l){if(!f){return null}return f.getColors(m,l)};return k}();var sb=sb||{};sb.map=function(e,d,l){var f=org.polymaps;var m=d3.dispatch("boundsUpdated"),h=0.5;var b="http://{S}.meshu.io/proxy/tiles/{S}/{Z}/{X}/{Y}";var a=d3.select(e).append("div")[0][0];a.style.position="absolute";a.style.width=d;a.style.height=l;d3.select(e).append("div").attr("class","render");var g=f.image().url(f.url(b).hosts(["a","b","c","d"]));m.dispatch=d3.dispatch("show");var j=[{name:"San Francisco",lat:37.775,lon:-122.43,zoom:13},{name:"New York City",lat:40.718,lon:-73.997,zoom:14},{name:"London",lat:51.506325,lon:-0.127144,zoom:13},{name:"Paris",lat:48.85693,lon:2.3412,zoom:14},{name:"Moscow",lat:55.75695,lon:37.614975,zoom:14},{name:"Montreal",lat:45.512303,lon:-73.554431,zoom:13},{name:"Tokyo",lat:35.7,lon:139.774414,zoom:14}];var k=a.appendChild(f.svg("svg"));var i=Math.floor(Math.random()*j.length);m.map=f.map().container(k).zoom(j[i].zoom).center({lat:j[i].lat,lon:j[i].lon});m.map.size({x:$(e).width(),y:$(e).height()});m.map.add(g);d3.select(k).attr("width","100%").attr("height","100%").select("rect").attr("visibility","visible").attr("fill","white");m.frame=function(){return a};m.show=function(){if(!g.map()){m.map.add(g)}};m.hide=function(){if(g.map()){m.map.remove(g)}};m.buffer=function(c){h=c;return m};m.updateBounds=function(p,n,o){if(p.length==0||n.length==0){return}if(p.length==1&&n.length==1){m.map.center({lat:p[0],lon:n[0]});console.log(m.map.center(),m.map.zoom());m.boundsUpdated();return}var c=[{lat:d3.min(p),lon:d3.min(n)},{lat:d3.max(p),lon:d3.max(n)}];m.map.extent(c);o=o||0;m.map.zoom(Math.floor(m.map.zoom())+o);m.boundsUpdated()};m.resizeContainer=function(n,q){var v=[{lat:d3.min(n),lon:d3.min(q)},{lat:d3.max(n),lon:d3.max(q)}];m.map.zoom(10).center({lat:0,lon:0});var o=m.map.locationPoint(v[0]);var r=m.map.locationPoint(v[1]);var c=Math.abs(r.x-o.x);var u=Math.abs(r.y-o.y);var s=430;var p=c>u?s/c:s/u;c*=p;u*=p;a.style.width=(c)+"px";a.style.height=(u)+"px";m.map.extent(v);var t=m.l2p(v[0]).y-m.l2p(m.map.extent()[0]).y;if(t){a.style.top=(150-t)+"px"}};m.getBounds=function(){var n=m.map.extent();var c=m.map.locationPoint(n[0]);var o=m.map.locationPoint(n[1]);return{t:o.y,b:c.y,l:c.x,r:o.x}};m.getMapRadius=function(){var c=m.map.extent();return{lat:Math.abs(c[0].lat-c[1].lat)/3,lon:Math.abs(c[0].lon-c[1].lon)/3}};m.l2p=function(c){return m.map.locationPoint(c)};m.p2l=function(c){return m.map.pointLocation(c)};return m};var sb=sb||{};sb.mesh={};sb.mesh.base=function(e,x,k,h){var g=d3.dispatch("added","refreshed","locationsSet","removed","draggedMap","draggedPoint","clickedMap","clickedPoint","styled","interactiveToggled"),m=parseInt(Math.random()*10000000000,10);g.dirty=true;var s=[],d=[],f=[],t={};var r=[],q=[],l=[],y=0,j=null,c=false,w=null,i=null,u=null,a=null;var p=$("#content"),b=$("#cases");d3.select(".frame").on("mousemove",v).on("mousedown",n);d3.select("body").on("mouseup",o);function n(){if(!p.hasClass("edit")){return}w=true}function v(){if(!p.hasClass("edit")){return}if(!g.dragging&&!w){return}var z=d3.svg.mouse(e);if(g.dragging){var A=x.p2l({x:z[0],y:z[1]});g.draggedPoint(g.dragging,A)}if(c&&w){i=true;if(u){x.map.panBy({x:z[0]-u[0],y:z[1]-u[1]})}g.dirty=true;g.draggedMap()}c=true;u=z}function o(){w=null;u=null;if(!p.hasClass("edit")){return}if(d3.event.target.tagName!="circle"&&g.hittest(d3.event.target)&&d3.event.target.tagName!="image"){return}if(!g.dragging&&!i){var z=d3.svg.mouse(e);var A=x.p2l({x:z[0],y:z[1]});g.clickedMap(A);i=null;return}if(!c&&g.dragging){g.clickedPoint(g.dragging)}else{v()}if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}c=false;g.dragging=null;i=null}g.updatePixelBounds=function(){if(s.length&&d.length){l=[x.l2p({lat:d3.min(s),lon:d3.min(d)}),x.l2p({lat:d3.max(s),lon:d3.min(d)}),x.l2p({lat:d3.max(s),lon:d3.max(d)}),x.l2p({lat:d3.min(s),lon:d3.max(d)})]}else{l=[]}};g.editText=function(C,A,B){var z=C.find("."+B+"-edit").text("save");var E=C.find("."+B+"-text");var D=((B=="title")?E.text():f[A]);C.addClass("active");E.html('<input value="'+D+'">').find("input").focus()};g.saveText=function(C,A,B){var z=C.find("."+B+"-edit").text("edit");var D=C.find("input").val();C.removeClass("active");C.find("."+B+"-text").text(D);if(B=="place"){f[A]=D}else{return D}};g.removeInput=function(z){var A=list.selectAll("li.place .title");A.each(function(C,B){if(!C.edit){return}C.edit=false;g.saveText($(this),B,"place")});return false};g.add=function(E,A,C,z){var B=parseFloat(E);var D=parseFloat(A);s.push(B);d.push(D);if(C==undefined){f.push(E.toFixed(3)+", "+A.toFixed(3))}else{f.push(C)}r.push([D,B]);update();g.added();return g};g.remove=function(z){r.splice(z,1);s.splice(z,1);d.splice(z,1);f.splice(z,1);g.removed()};g.interactive=function(z){g.interactiveToggled(z)};g.lats=function(){return s};g.lons=function(){return d};g.places=function(){return f};g.points=function(z){if(!arguments.length){return r}r=z;return g};g.locations=function(z){q=null;r=[];s=[];d=[];f=[];$.each(z,function(A,B){r.push([B.longitude,B.latitude]);s.push(B.latitude);d.push(B.longitude);f.push(B.name)});g.locationsSet();return g};g.refresh=function(){update();g.refreshed()};g.prerender=function(){};g.applyStyle=function(z){var C=z.split("|");var B={};for(var A=0;A<C.length;A++){var D=C[A].split(":");B[D[0]]=D[1]}g.style(B)};g.style=function(A){if(!arguments.length){return t}for(var z in A){t[z]=A[z]}g.styled(t)};g.outputStyle=function(){var A=[];for(var z in t){A.push(z+":"+t[z])}return A.join("|")};g.updateTitle=function(z){a=z};g.outputTitle=function(){return a||"My Meshu"};g.output=function(){return $("#"+m).html()};g.outputMesh=function(){return".delaunay"};return g};var sb=sb||{};var app_key="dj0yJmk9M1hsekZBSDY1ZjRxJmQ9WVdrOU5uUjZiRzE0TXpRbWNHbzlNVEV5TURZMU1qRTJNZy0tJnM9Y29uc3VtZXJzZWNyZXQmeD00OQ--";sb.meshu=function(i,o,h){var k={},m=$(i).width()+"px",l=$(i).height()+"px",r=h||sb.map(i,m,l),o=o||"facet",b=sb.mesh[o](i,r,m,l),d=$("#cases");$(i).append("<div class='mapui'><div id='zoomin'></div><div id='zoomout'></div></div>");$("#zoomin").mousedown(function(t){r.map.zoom(r.map.zoom()+1);b.refresh("zoomed")});$("#zoomout").mousedown(function(t){r.map.zoom(r.map.zoom()-1);b.refresh("zoomed")});var a=$("#searchbox");a.focus(function(){d.fadeOut()}).keypress(function(t){if(t.which==13){q()}});$("#search-button").click(function(){q()});k.checkAdded=function(){var u=b.points();var t=3;if($("body").hasClass("radial")){t=1}if(u.length>=t){$("#finish-button").addClass("active")}else{$("#finish-button").removeClass("active")}};function q(){var t=a.val();if(t=="add a city, place, or address"){return}var v=t.replace("&","and").replace(/[^\w ]/ig,"").replace(" ","+");var u=$("body").hasClass("ie")?"/proxy/geocoder/?location="+v:"http://where.yahooapis.com/geocode?location="+v+"&flags=J&appid="+app_key;a.val("");$.ajax({url:u,cache:false,dataType:"json",error:function(w,y,x){console.log(x)},success:function(x){var w=x.ResultSet.Results||[x.ResultSet.Result];d.empty().hide();if(typeof w=="undefined"){a.blur();var z="Hrm, we weren't able to find your search. Try again?";d.append($("<p>").text(z)).fadeIn()}else{if(w.length>0){var y=w[0];switch(b.name){case"facet":b.add(y.latitude,y.longitude,t);k.updateBounds();if(b.points().length==1){e(y.radius)}break;case"radial":e(y.radius);b.add(y.latitude,y.longitude,t);break}}}}})}function j(t){if(t>100000){return 4}else{if(t>10000){return 12}else{if(t>1000){return 13}else{if(t>400){return 14}}}}return 12}function e(t){var u=j(t);if(u!=r.map.zoom()){r.map.zoom(u)}}k.locations=function(t,v){for(var u=0;u<t.length;u++){if(v){b.add(t[u].latitude,location[u].longitude,t[u].name)}else{setTimeout(function(w){return function(){b.add(w.latitude,w.longitude,w.name);k.updateBounds()}}(t[u]),u*400)}}if(v){k.updateBounds()}};function c(y){var t=y.split("|");var x=[],v={};for(var w=0;w<t.length;w++){var u=t[w].split("\t");if(u.length<3){continue}var z=u[0]+"-"+u[1];if(v[z]){continue}else{v[z]=true}x.push({latitude:parseFloat(u[0]),longitude:parseFloat(u[1]),name:u[2]})}return x}k.initializeFromData=function(w,v,u){b.prerender(u);var t=c(w);b.locations(t);if(v){b.applyStyle(v)}return k};k.mesh=function(){return b};k.map=function(){return r};var g=0,f=1,p=0,n=0;var s;k.animateTransform=function(y,x,v,t){if(s){clearInterval(s)}var u=0;var w=d3.select(".delaunay");s=setInterval(function(){if(++u<30){g+=(y-g)*0.33;f+=(x-f)*0.5;p+=(v-p)*0.5;n+=(t-n)*0.5;var z="rotate("+g+", 300, 300)";var B="scale("+f+")";var A="translate("+p+","+n+")";w.attr("transform",B+A+z)}else{clearInterval(s)}},40)};k.refreshWithBounds=function(u,t){r.updateBounds(u,t,k.zoomOffset)};k.updateBounds=function(){if(b.dirty){k.refreshWithBounds(b.lats(),b.lons());b.dirty=false}};b.on("added",k.checkAdded);r.on("boundsUpdated",function(){b.updatePixelBounds();b.refresh()});b.on("locationsSet",k.updateBounds);k.getFrame=function(){return i};k.updateTitle=function(u){b.updateTitle(u)};k.outputTitle=function(){return b.outputTitle()};k.outputSVG=function(){return b.output()};k.outputMapSVG=function(){return $(r.map.container()).html()};k.hideMesh=function(){return k};k.showMesh=function(){return k};k.outputLocationData=function(){var t=[];var v=b.places(),w=b.lats(),u=b.lons();$.each(v,function(y){var x=w[y]+"\t"+u[y]+"\t"+v[y];t.push(x)});return t.join("|")};k.xhr=function(){return{xhr:"true",title:k.outputTitle(),svg:k.outputSVG(),location_data:k.outputLocationData(),renderer:b.name,metadata:b.outputStyle(),promo:meshu.promo}};return k};sb.transforms={earrings:{product:{scale:0.09,transform:{x:830,y:710}},preview:{scale:0.125,transform:{x:650,y:540}},render:{scale:0.45,transform:{x:530,y:450}}},pendant:{product:{scale:0.045,transform:{x:1570,y:2200}},preview:{scale:0.075,transform:{x:1030,y:1470}},render:{scale:0.25,transform:{x:900,y:1375}}},necklace:{product:{scale:0.09,transform:{x:650,y:980}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}},cufflinks:{product:{scale:0.075,transform:{x:870,y:1170}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}}};sb.transforms.getTransform=function(c,b){var a=sb.transforms[c][b];return"scale("+a.scale+") translate("+a.transform.x+","+a.transform.y+") "};var sb=sb||{};$(function(){sb.product=function(){var a={};var b=[];a.initialize=function(f,c){b=c.getProducts();var e={};for(var g=0;g<b.length;g++){var h=b[g];a.resetPreviewImage(h.type);if(typeof f=="string"){a.previewFromSelector(h.type,f)}else{a.previewFromElement(h.type,f)}e[h.type]=true;var d=a.describeProductRange(h);$("#range-"+h.type).html(d)}$("#product-preview .wrapper").each(function(j,k){var l=k.id.split("-").pop();if(!e[l]){$(k).hide()}})};a.resetPreviewImage=function(e){var c=d3.select("#preview-"+e),d=sb.transforms.getTransform(e,"product");c.selectAll("*").remove();c.append("svg:image").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").attr("xlink:href",static_url+"images/preview/preview_"+e+".png")};a.previewFromSelector=function(f,e){var c=d3.select("#preview-"+f),d=sb.transforms.getTransform(f,"product");var g=$(e).clone().attr("class","product-delaunay").attr("transform",d);$(c[0]).append(g)};a.previewFromElement=function(f,e){var c=d3.select("#preview-"+f),d=sb.transforms.getTransform(f,"product");c.append("svg:image").attr("x",0).attr("y",0).attr("width","600px").attr("height","600px").attr("transform",d).attr("xlink:href",e.toDataURL())};a.range=function(c){return c.length==1?"$"+c[0]:"$"+c[0]+"-"+c[c.length-1]};a.describeProductRange=function(d){if(d.discount!=undefined){var c="<del>"+a.range(d.originals)+"</del>";c+=" "+a.range(d.prices);c+=d.discount<1?" ("+Math.floor((1-d.discount)*100)+"% off!)":" ($"+d.discount+" off!)";return c}else{return a.range(d.prices)}};a.attachMeshu=function(e,d,c){};a.thumbnail=function(f,e,c){var d=$(f).clone().attr("class","product-delaunay").attr("transform",c);d3.select(e[0]).append("svg:rect").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%");e.append(d)};a.rotation=function(c){d3.selectAll(".product-delaunay").attr("transform",function(g,f){var e=sb.transforms.getTransform(b[f].type,"product");return e+" rotate("+c+", 300, 300)"})};return a}()});var sb=sb||{};$(function(){sb.rotator=function(e,d,b){var c=d3.dispatch("rotated");var f=0,g="scale(.125) translate(380, 670) ";c.update=function(u){$(e).empty();var m=d3.select(e);var l=m.append("svg:image").attr("id","previewImage").attr("x",0).attr("y",0).attr("width",200).attr("height",190).attr("xlink:href",c.getImage(u));var h=m.append("svg:g").attr("id","transform").attr("transform",c.getTransform(u));var k=$(d).clone().attr("id","mini-delaunay");var i=$(b).clone().attr("id","rotate-ui");$(h[0]).append(k).append(i);if(u=="pendant"){m.select("#rotate-ui").attr("class","hidden pendant").selectAll("circle").attr("r","55")}d3.selectAll("circle.rotation").on("mousedown",q);m.on("mouseup",n).on("mousemove",s);var p,o,x,w,j,r,t,v;var r=0;function q(){var y=d3.svg.mouse(m.node());p=y[0]-100,o=y[1]-100;t=true}function s(){if(!t){return}var y=d3.svg.mouse(m.node());x=y[0]-100,w=y[1]-100;v=a(p,o,x,w);var A=Math.sqrt(Math.pow(p,2)+Math.pow(o,2));var z=Math.sqrt(Math.pow(x,2)+Math.pow(w,2));j=Math.acos((p*x+o*w)/(A*z))*180/Math.PI;f=v?(f-j)%360:(f+j)%360;if(isNaN(f)){f=0}p=x,o=w;c.rotated(f);h.attr("transform",c.getTransform(u))}function n(){t=false;if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}}};c.getTransform=function(h){return sb.transforms.getTransform(h,"preview")+" rotate("+f+",300,300)"};c.getImage=function(h){return static_url+"images/preview/preview_"+h+".png"};c.rotation=function(h){if(!arguments.length){return f}f=h;return c};function a(i,k,h,j){if(h>i){if(k>0&&j>0){return true}else{return false}}else{if(h<i){if(k<0&&j<0){return true}else{return false}}else{if(j<k){if(i>0){return true}else{return false}}else{if(i<0){return true}else{return false}}}}}return c}("#rotate",".delaunay",".hidden")});var sb=sb||{};sb.materializer=function(){var c=d3.dispatch("update"),a,f,g,e,d,b;f={earrings:"pair of earrings",pendant:"small pendant necklace",necklace:"large necklace",cufflinks:"pair of cufflinks"};g={earrings:"earrings",pendant:"pendant necklace",necklace:"large necklace",cufflinks:"cufflinks"};c.initialize=function(h){a=h;c.materials=$("#material-list li");c.colors=$("#color-list li");c.materials.click(function(i){c.material(i.target.id)});c.colors.click(function(i){c.color(i.target.innerHTML)});$(".option-list li").live("click",function(){var i=$(this);i.parent().find("li").removeClass("selected");i.addClass("selected")})};c.product=function(m){if(!arguments.length){return e}e=m;var h=a.getMaterials(m);c.materials.hide();d=null;for(var j=0;j<h.length;j++){var l=h[j];if(!d){c.material(l)}$("#"+l).show()}var k=f[e];var n=k.charAt(0).toUpperCase()+k.slice(1);$("#readymade-type").text(n);return c};c.material=function(h){if(!arguments.length){return d}d=h;c.materials.removeClass("selected");$("#"+d).addClass("selected");var i=a.getColors(e,d);if(i){c.colors.find(".color-title").empty();c.colors.find("img").attr("src","");$(".options.right").fadeIn();$.each(i,function(l,m){var k=c.colors.eq(l);var j=static_url+"images/materials/"+d+"_"+m.replace(" ","_").toLowerCase()+".png";k.find(".color-title").text(m);k.find(".color-img img").attr("src",j);k.attr("id","color-"+m.replace(" ","-").toLowerCase())});c.color(i[0])}else{$(".options.right").fadeOut();c.color("")}orderer.updateProduct(e,d);$("#total-cost").text(orderer.getPriceString());return c};c.color=function(h){if(!arguments.length){return b}b=h;c.colors.removeClass("selected");$("#color-"+b.replace(" ","-").toLowerCase()).addClass("selected");c.update();return c};c.productName=function(){return g[e]};c.displayName=function(){return f[e].toLowerCase()};return c}();var saver=function(){var b={};function e(){var f=b.meshu.xhr();f.csrfmiddlewaretoken=$("#csrf input").val();return f}function d(f){if(!f){return}b.meshu.id=f;if($("#meshu-id").length==0){$("#hidden-form-values").append('<input type="hidden" id="meshu-id" name="meshu_id" />')}$("#meshu-id").val(f)}function a(){var f=e();if($("#meshu-id").length){f.id=b.getMeshuID()}$.post("/make/assign/",f,function(g){d(g.meshu_id);if(b.postAssignCallback){b.postAssignCallback(g)}},"json")}function c(){var f=e();if($("#meshu-id").length){f.id=b.getMeshuID()}$.post("/make/create/",f,function(g){d(g.meshu_id);if(b.postCreateCallback){b.postCreateCallback(g)}},"json")}b.initialize=function(f){b.meshu=f;$("#cancel-button").click(function(){window.location.href=loadedMeshu.view_url});$("#save-button").click(function(){if(!loadedMeshu){return}$("#save-button").html("saving");var g=loadedMeshu.edit_url+"save";$.post(g,e(),function(h){d(h.meshu_id);setTimeout(function(){$("#save-button").html("saved!")},200);setTimeout(function(){window.location.href=h.meshu_url},1000)},"json")});$("#update-button").click(function(){if(!loadedMeshu){return}$("#update-button").html("updating");var g=loadedMeshu.edit_url+"update";console.log(e());$.post(g,e(),function(h){d(h.meshu_id);setTimeout(function(){$("#update-button").html("saved!")},200);setTimeout(function(){window.location.href=h.meshu_url},1000)},"json")});return b};b.initializeNewMeshu=function(f){b.meshu=f;return b};b.createOrUpdateMeshu=function(f){console.log("creatingorupdating",e());if(b.meshu.isReadymade&&f){f()}else{if(b.meshu.username&&b.meshu.username=="guest"){a();if(f){b.postAssignCallback=f}}else{c();if(f){b.postCreateCallback=f}}}return b};b.updateMeshuData=function(f){d(f.id);b.meshu.view_url=f.view_url;b.meshu.username=f.username;b.meshu.title=f.title;b.meshu.promo=f.promo;if(f.image_url){b.meshu.image_url=f.image_url}};b.getMeshuID=function(){return $("#meshu-id").val()};return b}();var sb=sb||{};sb.facebook={};$(".facebook-auth").click(function(){var a="/facebook/login";window.location=a});sb.facebook.initialize=function(h){$("#finish-button").click(function(){window.location="/make/#skipintro"});var c="Alabama,AL,Alaska,AK,Arizona,AZ,Arkansas,AR,California,CA,Colorado,CO,Connecticut,CT,Delaware,DE,Florida,FL,Georgia,GA,Hawaii,HI,Idaho,ID,Illinois,IL,Indiana,IN,Iowa,IA,Kansas,KS,Kentucky,KY,Louisiana,LA,Maine,ME,Maryland,MD,Massachusetts,MA,Michigan,MI,Minnesota,MN,Mississippi,MS,Missouri,MO,Montana,MT,Nebraska,NE,Nevada,NV,New Hampshire,NH,New Jersey,NJ,New Mexico,NM,New York,NY,North Carolina,NC,North Dakota,ND,Ohio,OH,Oklahoma,OK,Oregon,OR,Pennsylvania,PA,Rhode Island,RI,South Carolina,SC,South Dakota,SD,Tennessee,TN,Texas,TX,Utah,UT,Vermont,VT,Virginia,VA,Washington,WA,West Virginia,WV,Wisconsin,WI,Wyoming,WY";var u=c.split(",");var o={};for(var q=1;q<u.length;q+=2){o[u[q]]=u[q-1]}var d=function(i,v){return function(){$("#svg-file").val(i.outputSVG());$("#meshu-data").val(i.outputLocationData());$("#meshu-title").val(v);$("#meshu-select-form").submit()}};var s=[];var l={all:{name:"All Cities",locations:[]}};var j=[];var r=[];var m=[];var t=0;var g=function(v,w){if(w.locations.length<3){return}t+=300;setTimeout(function(){return function(){var y=$("<div>").addClass("mini-meshu");var x=$("<div>").addClass("title").html(w.name);y.append(x).fadeIn();$("#maps").append(y);var i=sb.minimeshu(y[0]);setTimeout(function(){i.locations(w.locations)},100);y.click(d(i,w.name))}}(),t)};var e=function(i,v){if(!l[v]){l[v]={name:v,locations:[],seen:{}};i.push(l[v])}};var b=function(v,w,i,x){if(!l[w].seen[x]){l[w].locations.push(i);l[w].seen[x]=i}else{l[w].seen[x].times++}};var f=function(){var i=function(w,v){return v.locations.length-w.locations.length};j.sort(i);r.sort(i);m.sort(i);if(m.length>1){m.unshift(l.all);$.each(m,g)}else{g(0,l.all)}if(r.length>1){$.each(r,g)}if(j.length){$.each(j,g)}else{$(".page-header").html("Oh no! Not enough checkins to make any meshus.");$("#finish-button").html("Make one manually")}};var p=0;var n=function(i){var v=i.data;if(!v||!v.length){f();return}p+=i.data.length;$.each(v,function(y,A){if(!A.place||!A.place.location||!A.place.location.city){return}var C=A.place.location.city;var B=A.place.location.country;var w={latitude:A.place.location.latitude,longitude:A.place.location.longitude,name:A.place.name,times:1};var x={name:C,latitude:w.latitude,longitude:w.longitude};if(!l[C]){l.all.locations.push(x)}e(j,C);e(m,B);b(j,C,w,w.name);b(m,B,x,C);var z=A.place.location.state;if(z&&B=="United States"){if(o[z.toUpperCase()]){z=o[z.toUpperCase()]}e(r,z);b(r,z,x,x.name)}});$.ajax({url:i.paging.next,dataType:"jsonp",success:function(w){if(w.data&&w.data.length){$(".page-header").html("Loaded "+p+" places...");n(w)}else{$(".page-header").html("Each meshu is a different set of places. Choose one to get started!");f()}},error:function(w){console.warn(w)}})};var k=false;function a(){h.api("/me/locations?limit=50",function(i){if(i.error){if(k){$(".page-header").html("We're not sure what happened! Try connecting to Facebook again?")}else{$(".page-header").html("Oops, there was an error connecting to Facebook. Retrying...");setTimeout(a,500);k=true}}else{n(i)}})}a()};$(".foursquare-auth").click(function(){var a="AJXTWLOH1K5RIWG33XSGQZHRISL5CCJ0XG1VUL3NAKDYYPMM";var d="http://meshu.io/make/foursquare/";var c="https://foursquare.com/oauth2/authenticate?client_id={client}&response_type=token&redirect_uri={redirect}";var b=c.replace("{client}",a).replace("{redirect}",d);window.location=b});var sb=sb||{};sb.foursquare={};sb.foursquare.initialize=function(){var a=window.location.hash,h=a.split("=").pop(),m="https://api.foursquare.com/v2/users/self/checkins?oauth_token={token}&v={v}&limit=250&offset={offset}",s=m.replace("{token}",h).replace("{v}","20120102");window.location.hash="#connected";$("#finish-button").click(function(){window.location="/make/#skipintro"});if(!h||!h.length){return}var c="Alabama,AL,Alaska,AK,Arizona,AZ,Arkansas,AR,California,CA,Colorado,CO,Connecticut,CT,Delaware,DE,Florida,FL,Georgia,GA,Hawaii,HI,Idaho,ID,Illinois,IL,Indiana,IN,Iowa,IA,Kansas,KS,Kentucky,KY,Louisiana,LA,Maine,ME,Maryland,MD,Massachusetts,MA,Michigan,MI,Minnesota,MN,Mississippi,MS,Missouri,MO,Montana,MT,Nebraska,NE,Nevada,NV,New Hampshire,NH,New Jersey,NJ,New Mexico,NM,New York,NY,North Carolina,NC,North Dakota,ND,Ohio,OH,Oklahoma,OK,Oregon,OR,Pennsylvania,PA,Rhode Island,RI,South Carolina,SC,South Dakota,SD,Tennessee,TN,Texas,TX,Utah,UT,Vermont,VT,Virginia,VA,Washington,WA,West Virginia,WV,Wisconsin,WI,Wyoming,WY";var v=c.split(",");var o={};for(var q=1;q<v.length;q+=2){o[v[q]]=v[q-1]}var d=function(i,w){return function(){$("#svg-file").val(i.outputSVG());$("#meshu-data").val(i.outputLocationData());$("#meshu-title").val(w);$("#meshu-select-form").submit()}};var t=[];var l={all:{name:"All Cities",locations:[]}};var k=[];var r=[];var n=[];var u=0;var j=function(w,x){if(x.locations.length<3){return}u+=300;setTimeout(function(){return function(){var z=$("<div>").addClass("mini-meshu");var y=$("<div>").addClass("title").html(x.name);z.append(y).fadeIn();$("#maps").append(z);var i=sb.minimeshu(z[0]);setTimeout(function(){i.locations(x.locations)},100);z.click(d(i,x.name))}}(),u)};var e=function(i,w){if(!l[w]){l[w]={name:w,locations:[],seen:{}};i.push(l[w])}};var b=function(w,x,i,y){if(!l[x].seen[y]){l[x].locations.push(i);l[x].seen[y]=i}else{l[x].seen[y].times++}};var g=function(){var i=function(x,w){return w.locations.length-x.locations.length};k.sort(i);r.sort(i);n.sort(i);if(n.length>1){n.unshift(l.all);$.each(n,j)}else{j(0,l.all)}if(r.length>1){$.each(r,j)}if(k.length){$.each(k,j)}else{$(".page-header").html("Oh no! Not enough checkins to make any meshus.");$("#finish-button").html("Make one manually")}};var p=0;var f=function(i){$.ajax({url:i,dataType:"jsonp",success:function(y){if(!y.response.checkins){g();return}var w=y.response.checkins.items;if(!w||!w.length){g();return}p+=y.response.checkins.items.length;$.each(w,function(B,D){if(!D.venue||!D.venue.location||!D.venue.location.city){return}var F=D.venue.location.city;var E=D.venue.location.country;var z={latitude:D.venue.location.lat,longitude:D.venue.location.lng,name:D.venue.name,times:1};var A={name:F,latitude:z.latitude,longitude:z.longitude};if(!l[F]){l.all.locations.push(A)}e(k,F);e(n,E);b(k,F,z,z.name);b(n,E,A,F);var C=D.venue.location.state;if(C&&E=="United States"){if(o[C.toUpperCase()]){C=o[C.toUpperCase()]}e(r,C);b(r,C,A,A.name)}});var x=y.response.checkins.count;if(p<x){$(".page-header").html("Loaded "+p+" of "+x+" checkins...");f(s.replace("{offset}",p))}else{$(".page-header").html("Each meshu is a different set of places. Choose one to get started!");g()}}})};f(s.replace("{offset}",p))};var sb=sb||{};sb.ui=sb.ui||{};sb.ui.socialsharer=function(b){$(".share-facebook").click(function(){if(!sb.rasterizer.generated){sb.rasterizer.rasterize(b,a)}else{a()}});$(".action-button").click(function(){var d=this;if(!sb.rasterizer.generated){sb.rasterizer.rasterize(b,function(e){d.click()});return false}});sb.rasterizer.on("rasterized",function(d){saver.updateMeshuData(d);c();$(".social-media").fadeIn()});var c=function(f){var h="https://twitter.com/intent/tweet?text=";var j="http://pinterest.com/pin/create/button/?url=";var e="http://"+window.location.host;var i=e+b.image_url;var d=encodeURIComponent(e+b.view_url);var g="Check out this meshu I just made of the places I've been";$(".share-pinterest").attr("href",j+d+"&media="+i);$(".share-twitter").attr("href",h+g+"&url="+d)};var a=function(){var d="http://"+window.location.host;FB.ui({method:"feed",link:d+b.view_url,picture:d+b.image_url,name:b.title+" on meshu.io",caption:"",description:""},function(e){if(!e||e.error){}else{}})}};var sb=sb||{};sb.ui=sb.ui||{};sb.ui.orderer=function(c){var b=d3.dispatch("validated","updated");b.on("updated",function(){a();e()});$("#shipping-destination li").click(function(){var h=$(this).attr("id").split("-").pop();var g=$("#shipping-destination");$("#checkout").attr("class",h);g.find("li").removeClass("active");$(this).addClass("active");orderer.shippingMode(h)});$("#postcard-note-form").keyup(function(h){var g=h.target.value;$("#postcard-note").val(g)});$("#coupon-code").submit(function(){var g=$("#coupon-code-value").val();orderer.applyCoupon(g,function(j){if(j.success){var k=parseFloat(j.amount);if(k<1&&k>0){var h=Math.floor(orderer.getPrice()*(1-k));var i=parseInt((1-k)*100);$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>"+i+"% off! -$"+h+".00</span>").insertAfter("#subtotal-price")}else{if(k>1){$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>-$"+k+".00</span>").insertAfter("#subtotal-price")}}$("#coupon-message").fadeIn("fast").html(g+" discount applied!");$(".coupon-form").hide()}else{$("#coupon-message").fadeIn("fast").html("Invalid code.")}b.updated()});return false});$("#payment-form").validate({rules:{card_number:{creditcard:true},card_cvc:{digits:true,minlength:3},card_month:{digits:true,minlength:2},card_year:{digits:true,minlength:4,}},messages:{shipping_state:"Please enter the two-letter state abbreviation.",card_cvc:"Sorry, that is not a valid CVC code",card_month:{minlength:"Please enter the month as a two-digit number."},card_year:{minlength:"Please enter the year as a four-digit number.",},},submitHandler:d});$("#save-and-view").click(function(){var g=function(){saver.createOrUpdateMeshu(function(h){window.location.href=h.meshu_url})};if(!user.loggedIn){f();user.afterLogIn=g}else{g()}});$("#review-button").click(function(){if(!user.loggedIn){f()}});$("#submit-button").click(function(g){if(!user.loggedIn){f();return false}orderer.submit()});function d(){if(!user.loggedIn){f(d);return}b.updated();b.validated();return false}function f(g){user.showModal();user.afterLogIn=function(){if(g){saver.createOrUpdateMeshu(function(){setTimeout(g,200)})}}}function a(){orderer.updateProduct(sb.materializer.product(),sb.materializer.material(),orderer.getShipping());console.log("updating form",sb.materializer.color().toLowerCase());$("#object-type").val(sb.materializer.productName());$("#object-material").val(sb.materializer.material());$("#object-color").val(sb.materializer.color().toLowerCase());$("#object-amount").val(orderer.getTotalCents());console.log($("#object-color").val());$("#svg-theta").val(sb.rotator?sb.rotator.rotation():0);$("#svg-file").val(c.outputSVG());$("#meshu-data").val(c.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:c.outputTitle());$("#meshu-renderer").val(c.mesh().name);$("#meshu-metadata").val(c.mesh().outputStyle());$("#postcard-note").val($("#postcard-note-form").val())}function e(){var h="One "+sb.materializer.displayName();var i=sb.materializer.color().toLowerCase()+" "+sb.materializer.material();$("#review-description").text(h+", made out of "+i);$("#subtotal-price span").text(orderer.getPriceString());$("#shipping-price span").text("$"+orderer.getShipping()+".00");$("#total-price span").text(orderer.getTotalString());$("#review-shipping").empty();$(".ship-row input").each(function(){var k;var j=function(l){return l.replace(/\w\S*/g,function(m){return m.charAt(0).toUpperCase()+m.substr(1).toLowerCase()})};this.value=j(this.value);switch(this.id){case"ship-city":case"ship-zip":k=$("<span>");break;case"ship-state":this.value=this.value.toUpperCase();k=$("<span>");break;default:k=$("<p>");break}k.text($(this).val()).appendTo("#review-shipping")});var g=$("#card-number").val();$("#review-payment").text("XXXX-XXXX-XXXX-"+g.substring(12,16))}return b};var sb=sb||{};sb.viewhandler=function(){var b=d3.dispatch("updated","next","prev");var a=["edit","product","make","account","checkout","review"];var f=$("#content");b.updateViews=function(g){switch(g){case"edit":a=["edit","product","make","account","checkout","review"];break;case"view":a=["view"];break;case"product":a=["product","make","account","checkout","review"];break;default:a=["readymade","account","checkout","review"];break}};b.updateAccountView=function(){if(user.loggedIn){d()}};b.initialize=function(){$(".next").live("click",c);$(".back").click(e)};function c(){if(!$(this).hasClass("active")){return}var j=$(this);var g=b.view();var h=a.indexOf(g);var i=function(){f.attr("class",a[h+1])};if(g=="edit"&&user.loggedIn){saver.createOrUpdateMeshu()}if(g=="make"||g=="readymade"){d();user.afterLogIn=function(){saver.createOrUpdateMeshu(function(){j.click()})}}if(g=="account"&&!user.loggedIn){user.afterLogIn=function(){saver.createOrUpdateMeshu(function(){j.click()})};return}b.next();user.updateLogoutActions(g);i()}function e(){var g=b.view();if(g=="checkout"){d()}if(!user.loggedIn){user.afterLogIn=function(){saver.createOrUpdateMeshu(function(){$($(".next")[0]).click()})}}var h=a.indexOf(g);var i=a[h-1];f.attr("class",i);b.prev()}function d(){var g=a.indexOf("account");if(user.loggedIn){if(g>=0){a.splice(g,1)}$("#account").css("visibility","hidden")}else{if(g==-1){a.splice(-2,0,"account")}$("#account").css("visibility","visible");$("#account li").click(function(){var i=$(this).attr("id").split("-")[1];var h=$("#account");h.attr("class",i);h.find("li").removeClass("active");$(this).addClass("active")})}}b.view=function(g){if(!arguments.length){return f.attr("class")}var h=a.indexOf(g);if(h!=-1){f.attr("class",a[h]);view=g}};return b}();$(function(){var k=$("html").hasClass("svg");var a=loadedMeshu?loadedMeshu.promo:null,f=loadedMeshu&&loadedMeshu.product!="",j=window.location.href.search("postcard")>0?-0.25:0,e=loadedMeshu?loadedMeshu.renderer:$("body").hasClass("radial")?"radial":null;var g=sb.catalog(e,a);orderer.catalog(g);sb.materializer.initialize(g);meshu=sb.meshu($("#meshu-container")[0],e);meshu.zoomOffset=j;meshu.isReadymade=f;var c=sb.ui.orderer(meshu);c.on("validated",function(){sb.viewhandler.view("review");d("review");return false});sb.ui.socialsharer(meshu);sb.viewhandler.initialize();if(loadedMeshu){saver.initialize(meshu);saver.updateMeshuData(loadedMeshu);user.updateLogoutActions(pageType);sb.viewhandler.updateViews(pageType);switch(pageType){case"view":if(k){meshu.map().buffer(0)}break;case"product":var i=$("#product");i.find(".nav").remove();i.find(".make-wrapper").removeClass("make-wrapper");break;default:$("#materials").addClass("ready");var i=loadedMeshu.product.length?loadedMeshu.product:"necklace";sb.materializer.product(i);break}if(k){if(meshu.isReadymade&&readymade){readymade.initialize(meshu)}meshu.initializeFromData(loadedMeshu.location_data,loadedMeshu.metadata,loadedMeshu.svg)}h();$("#finish-button").addClass("active");$("#meshu-container").removeClass("inactive");var l=loadedMeshu.location_data.split("|");$.each(l,function(n,p){var o=p.split("\t");if(o.length==3){var q=document.createElement("div");q.innerHTML=o[2];var m=q.firstChild.nodeValue;$("<li>").html(m).appendTo($("#display-places"))}});d3.select("#places").attr("class","").select("#place-title").attr("class","").select(".title-text").html(function(m){m.title=loadedMeshu.title;meshu.updateTitle(m.title);return m.title})}else{saver.initializeNewMeshu(meshu)}sb.viewhandler.updateAccountView();sb.viewhandler.on("next",d);sb.viewhandler.on("prev",b);if(!user.loggedIn&&!loadedMeshu&&window.location.hash!="#skipintro"){$(".tooltip").each(function(m,n){setTimeout(function(){$(n).fadeIn()},m*1000)});$(document).click(function(){$(".tooltip").fadeOut()})}$("#product-preview svg").live("click",function(){var m=$(this).attr("id").split("-")[1];$(".make-option").hide();$("#make-"+m).show();sb.rotator.update(m);sb.materializer.product(m);sb.rotator.on("rotated",sb.product.rotation)});function h(){if(meshu.mesh().name=="facet"){sb.product.initialize(".delaunay",g);sb.rasterizer.rasterize(meshu)}else{if(meshu.mesh().name=="radial"){sb.rasterizer.thumbnail(meshu,function(m){sb.product.initialize(m,g);sb.rasterizer.rasterize(meshu)})}}}function d(){var m=sb.viewhandler.view();switch(m){case"edit":meshu.updateBounds();meshu.mesh().interactive(true);h();break;case"make":case"readymade":meshu.mesh().interactive(false);var p=sb.materializer.product();var o=sb.transforms[p]["render"];meshu.animateTransform(sb.rotator?sb.rotator.rotation():0,o.scale,o.transform.x,o.transform.y);d3.select(".delaunay").attr("class","delaunay "+p);var q=static_url+"images/render/"+p+"_preview.jpg",n="url("+q+")";$(".render").css("background-image",n);break;case"review":c.updated();break}}function b(){var m=sb.viewhandler.view();switch(m){case"edit":meshu.mesh().interactive(true);break;case"make":case"readymade":meshu.mesh().interactive(true);meshu.animateTransform(0,1,0,0);break}}$(".show-places").click(function(){$("#display-places").slideToggle();$(".show-places").toggle()})});