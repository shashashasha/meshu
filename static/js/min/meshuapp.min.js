var sb=sb||{};sb.catalog=function(f,d){var a={},e={},f=f||"facet";e.facet={earrings:{bamboo:{price:70,colors:["amber"]},acrylic:{price:75,colors:["black","white"]},nylon:{price:85,colors:["black","white"]}},pendant:{bamboo:{price:75,colors:["amber"]},acrylic:{price:80,colors:["black","white"]},nylon:{price:85,colors:["black","white"]},silver:{price:145,colors:["sterling"]}},necklace:{bamboo:{price:80,colors:["amber"]},acrylic:{price:85,colors:["black","white"]},nylon:{price:90,colors:["black","white"]},silver:{price:165,colors:["sterling"]}},cufflinks:{silver:{price:165,colors:["sterling"]}},ring:{nylon:{price:30,colors:["white"]},silver:{price:120,colors:["sterling"]}}};e.radial={earrings:{bamboo:{price:75,colors:["amber"]},acrylic:{price:80,colors:["black","white"]},nylon:{price:90,colors:["black","white"]}},pendant:{bamboo:{price:80,colors:["amber"]},acrylic:{price:85,colors:["black","white"]},nylon:{price:95,colors:["black","white"]},silver:{price:160,colors:["sterling"]}},coasters:{bamboo:{price:40,colors:["amber"]},acrylic:{price:45,colors:["black"]}}};var c=e[f];var b={};b.marathon={earrings:{bamboo:{price:64,colors:["Amber"],discount:0.85,originalPrice:75}},pendant:{bamboo:{price:64,colors:["Amber"],discount:0.85,originalPrice:75}},necklace:{bamboo:{price:68,colors:["Amber"],discount:0.85,originalPrice:80}}};if(d&&b[d]){c=b[d]}a.check=function(h,g){return c[h]&&c[h][g]};a.get=function(i,h,g){if(!c[i]||!c[i][h]){return"N/A"}return c[i][h][g]};a.getPrice=function(h,g){return a.get(h,g,"price")};a.getColors=function(h,g){return a.get(h,g,"colors")};if(d){a.getProducts=function(){var m=[];for(var k in c){var i=[],h=[],g=[],l=c[k];for(var j in l){i.push(l[j].price);if(l[j].originalPrice){h.push(l[j].originalPrice)}if(l[j].discount){g.push(l[j].discount)}}m.push({type:k,prices:i,originals:h,discount:g.length?g[0]:undefined})}return m}}else{a.getProducts=function(){var k=[];for(var i in c){var g=[],j=c[i];for(var h in j){g.push(j[h].price)}k.push({type:i,prices:g,discount:j.discount})}return k}}a.getMaterials=function(j){var g={};for(var h in c[j]){$.each(c[j][h].colors,function(k,i){g[i+"-"+h]=c[j][h].price})}return g};return a};Stripe.setPublishableKey("pk_GtEuTncR1hDqm7tP3oz9RRM9XOLub");var cashier=function(){var d={},c=totalPrice,b=0,a=1,e=5,g=5,f=38;function h(i,j){var l=$("#payment-form");var k=j.id;l.append("<input type='hidden' name='stripe_token' value='"+k+"' />");l.append("<input type='hidden' name='coupon_amount' value='"+d.getDiscountCents()+"' />");l.append("<input type='hidden' name='shipping_amount' value='"+d.getShippingCents()+"' />");l.get(0).submit()}d.submit=function(){if(d.getFinalCents()<2000){return}$("#submit-button").attr("disabled","disabled").addClass("inactive");$(".card-info").removeAttr("name");console.log("preauth for",d.getFinalCents());Stripe.createToken({number:$("#card-number").val(),cvc:$("#card-cvc").val(),exp_month:$("#card-expiry-month").val(),exp_year:$("#card-expiry-year").val()},d.getFinalCents(),h);return false};d.update=function(){$("#shipping-price .num").text(e+".00");$("#total-price .num").text(d.getTotal()+".00")};d.shippingMode=function(i){e=i=="international"?f:g;d.update()};d.applyCoupon=function(i,j){$.get("/order/apply_coupon",{code:i},function(l){if(l.success){var m=parseFloat(l.amount);if(m<1&&m>0){a=m;b=Math.round(d.getPrice()*(1-a));var k=Math.round((1-a)*100);l.message="("+k+"% off!) -$"+b+".00"}else{if(m>0){b=parseInt(l.amount);l.message="-$"+b+".00"}}}else{b=0;a=1}if(j){j(l)}},"json")};d.getPrice=function(){return c};d.getTotal=function(){return Math.floor(d.getPrice()-b)+e};d.getShippingCents=function(){return e*100};d.getDiscountCents=function(){return b*100};d.getFinalCents=function(){return d.getTotal()*100};return d}();var sb=sb||{};sb.map=function(e,d,l){var f=org.polymaps;var m=d3.dispatch("boundsUpdated"),h=0.5;var b="/proxy/tiles/{S}/{Z}/{X}/{Y}";var a=d3.select(e).append("div")[0][0];a.style.position="absolute";a.style.width=d;a.style.height=l;d3.select(e).append("div").attr("class","render");var g=f.image().url(f.url(b).hosts(["a","b","c","d"]));m.dispatch=d3.dispatch("show");var j=[{name:"San Francisco",lat:37.775,lon:-122.43,zoom:13},{name:"New York City",lat:40.718,lon:-73.997,zoom:14},{name:"London",lat:51.506325,lon:-0.127144,zoom:13},{name:"Paris",lat:48.85693,lon:2.3412,zoom:14},{name:"Moscow",lat:55.75,lon:37.614975,zoom:14},{name:"Montreal",lat:45.512303,lon:-73.554431,zoom:13},{name:"Tokyo",lat:35.7,lon:139.774414,zoom:14}];var k=a.appendChild(f.svg("svg"));var i=Math.floor(Math.random()*j.length);m.map=f.map().container(k).zoom(j[i].zoom).center({lat:j[i].lat,lon:j[i].lon});m.map.size({x:$(e).width(),y:$(e).height()});m.map.add(g);d3.select(k).attr("width","100%").attr("height","100%").select("rect").attr("visibility","visible").attr("fill","white");m.frame=function(){return a};m.show=function(){if(!g.map()){m.map.add(g)}};m.hide=function(){if(g.map()){m.map.remove(g)}};m.buffer=function(c){h=c;return m};m.centerOn=function(o,n,p){var c=m.l2p(o);c.x-=n||0;c.y-=p||0;o=m.p2l(c);console.log(o,c);m.map.center(o)};m.updateBounds=function(r,q,n,c,s){console.log("updatebounds",r,q,n,c,s);if(r.length==0||q.length==0){return}if(r.length==1&&q.length==1){m.centerOn({lat:r[0],lon:q[0]},c,s);m.boundsUpdated();return}var o=[{lat:d3.min(r),lon:d3.min(q)},{lat:d3.max(r),lon:d3.max(q)}];console.log("found extent",o);m.map.extent(o);m.centerOn(m.map.center(),c,s);offset=n||0;var p=Math.floor(m.map.zoom())+offset;if(p!=m.map.zoom()){m.map.zoom(p)}m.boundsUpdated()};m.resizeContainer=function(n,q){var v=[{lat:d3.min(n),lon:d3.min(q)},{lat:d3.max(n),lon:d3.max(q)}];m.map.zoom(10).center({lat:0,lon:0});var o=m.map.locationPoint(v[0]);var r=m.map.locationPoint(v[1]);var c=Math.abs(r.x-o.x);var u=Math.abs(r.y-o.y);var s=430;var p=c>u?s/c:s/u;c*=p;u*=p;a.style.width=(c)+"px";a.style.height=(u)+"px";m.map.extent(v);var t=m.l2p(v[0]).y-m.l2p(m.map.extent()[0]).y;if(t){a.style.top=(150-t)+"px"}};m.getBounds=function(){var n=m.map.extent();var c=m.map.locationPoint(n[0]);var o=m.map.locationPoint(n[1]);return{t:o.y,b:c.y,l:c.x,r:o.x}};m.getMapRadius=function(){var c=m.map.extent();return{lat:Math.abs(c[0].lat-c[1].lat)/3,lon:Math.abs(c[0].lon-c[1].lon)/3}};m.l2p=function(c){return m.map.locationPoint(c)};m.p2l=function(c){return m.map.pointLocation(c)};return m};var sb=sb||{};sb.mesh={};sb.mesh.base=function(e,x,k,h){var g=d3.dispatch("added","refreshed","locationsSet","removed","draggedMap","draggedPoint","clickedMap","clickedPoint","styled","interactiveToggled"),m=parseInt(Math.random()*10000000000,10);g.dirty=true;var s=[],d=[],f=[],t={};var r=[],q=[],l=[],y=0,j=null,c=false,w=null,i=null,u=null,a=null;var p=$("#content"),b=$("#cases");d3.select(".frame").on("mousemove",v).on("mousedown",n);d3.select("body").on("mouseup",o);function n(){if(!p.hasClass("edit")){return}w=true}function v(){if(!p.hasClass("edit")){return}if(!g.dragging&&!w){return}var z=d3.svg.mouse(e);if(g.dragging){var A=x.p2l({x:z[0],y:z[1]});g.draggedPoint(g.dragging,A)}if(c&&w){i=true;if(u){x.map.panBy({x:z[0]-u[0],y:z[1]-u[1]})}g.dirty=true;g.draggedMap()}c=true;u=z}function o(){w=null;u=null;if(!p.hasClass("edit")){return}if(d3.event.target.tagName!="circle"&&g.hittest(d3.event.target)&&d3.event.target.tagName!="image"){return}if(!g.dragging&&!i){var z=d3.svg.mouse(e);var A=x.p2l({x:z[0],y:z[1]});g.clickedMap(A);i=null;return}if(!c&&g.dragging){g.clickedPoint(g.dragging)}else{v()}if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}c=false;g.dragging=null;i=null}g.interactive=function(z){g.interactiveToggled(z)};g.refresh=function(){update();g.refreshed()};g.prerender=function(){};g.applyStyle=function(z){var C=z.split("|");var B={};for(var A=0;A<C.length;A++){var D=C[A].split(":");B[D[0]]=D[1]}g.style(B)};g.style=function(A){if(!arguments.length){return t}for(var z in A){t[z]=A[z]}g.styled(t)};g.outputStyle=function(){var A=[];for(var z in t){A.push(z+":"+t[z])}return A.join("|")};g.updateTitle=function(z){a=z};g.outputTitle=function(){return a||"My Meshu"};g.output=function(){return $("#"+m).html()};g.outputMesh=function(){return".delaunay"};return g};var sb=sb||{};sb.mesh.facet=function(k,D,s,o){var n=sb.mesh.base(k,D,s,o),u=parseInt(Math.random()*10000000000,10);n.name="facet";var z=[],j=[],l=[];var h=document.createElement("div");var f=d3.select(k||"body").append("div").attr("id",u).style("width",s).style("height",o).style("position","absolute").style("z-index","1").append("svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var A=f.append("g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var y=f.append("g").attr("class","hidden");y.append("path");var b=d3.select(k||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",s).style("height",o);var q=b.append("svg").attr("width","100%").attr("height","100%");var p=q.append("g").attr("id","delaunay-ui");var m=d3.select("#places");var C=m.select("#place-title").attr("class","inactive");C.append("span").attr("class","title-text");C.append("span").attr("class","title-edit").html("edit");var B=m.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",n.removeInput)}var x=[],w=[],t=[],G=0,a=null;var v=$("#content");n.hittest=function(g){return d3.event.target!=q.node()};n.on("draggedMap",function(){i()});n.on("draggedPoint",function(H,I){H[0]=I.lon;H[1]=I.lat;var g=x.indexOf(H);z[g]=I.lat;j[g]=I.lon;n.dirty=true;i()});n.on("clickedMap",function(g){n.add(g.lat,g.lon,undefined,false)});n.on("clickedPoint",function(H){var g=x.indexOf(H);n.remove(g);D.updateBounds(z,j);n.dirty=false;i()});n.on("removed",function(){if(x.length==1){$("#meshu-container").addClass("inactive")}});n.on("interactiveToggled",function(g){n.updateCircleBehavior(g)});var F=function(){var M=0,g=[];if(x.length<2){return}for(var J=0;J<x.length;J++){var K=D.l2p({lat:x[J][1],lon:x[J][0]});for(var H=J+1;H<x.length;H++){var I=D.l2p({lat:x[H][1],lon:x[H][0]});var O=K.x-I.x;var N=K.y-I.y;var L=Math.sqrt((O*O)+(N*N));if(L>M){M=L;g=[I,K]}}}return g};var d=function(I,H){var J=H.y-I.y,g=H.x-I.x;return Math.atan2(J,g)*(180/Math.PI)};var c=function(I,H){var J=H.y-I.y,g=H.x-I.x;return Math.sqrt((g*g)+(J*J))};var r=function(I,H){var g=H.getTransformToElement(H.ownerSVGElement);return I.matrixTransform(g)};n.getLongestRotation=function(){var J=F(D,x),I=d(J[0],J[1]),H=-I+180,g="rotate("+[H,300,300].join(",")+") ";return g};n.projectPoints=function(J){d3.select("#delaunay-ui").attr("transform",J);var g=[],H=[],I=[];var K=d3.selectAll("#delaunay-ui circle").each(function(P,M){var O=this.ownerSVGElement.createSVGPoint(),L=D.l2p({lat:z[M],lon:j[M]});O.x=L.x;O.y=L.y;var N=r(O,this);H.push(N.x);I.push(N.y);g.push([N.x,N.y])});d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");return{pts:g,xvalues:H,yvalues:I}};n.transformedDelaunay=function(K,I,M,H){var L={top:d3.min(K.yvalues),left:d3.min(K.xvalues),right:d3.max(K.xvalues),bottom:d3.max(K.yvalues)},J=L.right-L.left,N=L.bottom-L.top,g=I/J,P=M/N;var O=A.selectAll("path").data(d3.geom.delaunay(K.pts));O.enter().append("path");O.exit().remove();O.exit().remove();O.attr("stroke-width",20).attr("d",function(V){var R=V.length;var Q=[];for(var U=0;U<R;U++){var T=(V[U][0]-L.left)*g,S=((V[U][1]-L.top)*P)+H;Q.push([T,S])}return"M"+Q.join(" L")+"Z"})};function e(H){var L=p.selectAll("circle");L.attr("cx",function(M){return D.l2p({lat:parseFloat(M[1]),lon:parseFloat(M[0])}).x}).attr("cy",function(M){return D.l2p({lat:M[1],lon:M[0]}).y});var g=A.selectAll("path").data(d3.geom.delaunay(x));g.enter().append("path");g.exit().remove();g.attr("d",function(R){var N=R.length;var M=[];for(var O=0;O<N;O++){var Q={lat:parseFloat(R[O][1]),lon:parseFloat(R[O][0])};var P=D.l2p(Q);M.push([P.x,P.y])}return"M"+M.join("L")+"Z"});if(w&&H==true){clearInterval(G);w=null}else{if(w){var K=x[x.length-1]||[];if(Math.abs(K[0]-w[0])>0.0002){K[0]+=(w[0]-K[0])/3}if(Math.abs(K[1]-w[1])>0.0002){K[1]+=(w[1]-K[1])/3}x[x.length-1]=K;var J=Math.abs(K[0]-w[0]);var I=Math.abs(K[1]-w[1]);if(I<0.0002&&J<0.0002){clearInterval(G);w=null}}else{clearInterval(G)}}}n.updatePixelBounds=function(){console.log("updating pixel bounds, map center: ",D.map.center());if(z.length&&j.length){t=[D.l2p({lat:d3.min(z),lon:d3.min(j)}),D.l2p({lat:d3.max(z),lon:d3.min(j)}),D.l2p({lat:d3.max(z),lon:d3.max(j)}),D.l2p({lat:d3.min(z),lon:d3.max(j)})]}else{t=[]}console.log("updating pixel bounds",z,j,t)};function i(){var L=p.selectAll("circle").data(x);L.enter().append("circle").attr("id",function(N,M){return"c-"+M}).attr("r",10).on("mousedown",function(M){n.dragging=M;d3.event.stopPropagation()});L.exit().remove();var J=B.selectAll("li.place").data(x);var H=J.enter().append("li").attr("class","place");var K=H.append("span").attr("class","title");K.append("span").attr("class","place-text").html(function(N,M){h.innerHTML=l[M];return h.firstChild.nodeValue});K.append("span").attr("class","place-edit").html("edit");H.append("span").attr("class","place-delete").html("x");J.exit().remove();J.attr("id",function(N,M){return"p-"+M}).select(".title").each(function(M){M.edit=false}).attr("class","title").select(".place-text").html(function(N,M){h.innerHTML=l[M];return h.firstChild.nodeValue});C.data(x).each(function(M){M.edit=false});var g=y.selectAll("circle.rotation").data(t);g.enter().append("circle").attr("class","rotation").attr("r","40").attr("cx",function(N,M){return N.x}).attr("cy",function(N,M){return N.y});g.exit().remove();g.attr("cx",function(N,M){return N.x}).attr("cy",function(N,M){return N.y});var I=y.select("path");I.attr("d",function(){if(t.length==0){return}var M=[];$.each(t,function(N,O){M.push([O.x,O.y])});return"M"+M.join("L")+"Z"}).attr("class","hiddenFrame");n.updateCircleBehavior();E();e()}n.updateCircleBehavior=function(J){var H=v.hasClass("edit");var g=$("#place-hover");var I=p.selectAll("circle");I.on("mouseover",function(Q,M){if(J){return}else{if(H){B.select("#p-"+M).attr("class","place highlight")}else{g.addClass("active").find("span").text(l[M]);var P=D.l2p({lat:Q[1],lon:Q[0]});var K=g.width();var O=(P.y-32)+"px";var N=(P.x-(K/2)-3)+"px";var L=K/2-3+"px";g.css({top:O,left:N}).find("b").css("left",L)}}});I.on("mouseout",function(L,K){if(J){return}else{if(H){B.select("#p-"+K).attr("class","place")}else{g.removeClass("active")}}})};function E(){var g=B.selectAll("li.place");g.select(".place-delete").on("click",function(I,H){n.remove(H);n.updatePixelBounds();D.updateBounds(z,j);i()});g.on("mouseover",function(I,H){p.select("#c-"+H).attr("class","highlight")});g.on("mouseout",function(I,H){p.select("#c-"+H).attr("class","")});g.select(".place-edit").on("click",function(J,H){var I=$(this).parent();if(!J.edit){n.editText(I,H,"place")}else{n.saveText(I,H,"place")}J.edit=!J.edit});g.select(".place-text").on("click",function(I,H){if(I.edit){return}n.editText($(this).parent(),H,"place");I.edit=!I.edit});C.attr("class","").select(".title-text").text(function(H){if(H&&H.title){return H.title}else{return"My Meshu"}});C.select(".title-text").on("click",function(H){if(H.edit){return}n.editText($(this).parent(),0,"title");H.edit=!H.edit});C.select(".title-edit").on("click",function(I){var H=$(this).parent();if(!I.edit){n.editText(H,0,"title")}else{I.title=a=n.saveText(H,0,"title")}I.edit=!I.edit})}n.add=function(M,I,K,g){if(G){clearInterval(G)}var J=parseFloat(M);var L=parseFloat(I);z.push(J);j.push(L);if(K==undefined){l.push(M.toFixed(3)+", "+I.toFixed(3))}else{l.push(K)}if(x.length){$("#meshu-container").removeClass("inactive");w=[L,J];if(g){x.push([w[0],w[1]]);n.updatePixelBounds();i();e(g)}else{var H=x[x.length-1];x.push([H[0],H[1]]);n.updatePixelBounds();i();G=setInterval(e,40)}}else{x.push([L,J]);i()}n.dirty=true;n.added();return n};n.remove=function(g){x.splice(g,1);z.splice(g,1);j.splice(g,1);l.splice(g,1);if(x.length==1){$("#meshu-container").addClass("inactive")}};n.lats=function(){return z};n.lons=function(){return j};n.places=function(){return l};n.points=function(g){if(!arguments.length){return x}x=g;return n};n.bakeStyles=function(){y.style("display","none")};n.unBakeStyles=function(){y.style("display","")};n.locations=function(g){w=null;x=[];z=[];j=[];l=[];$.each(g,function(H,I){x.push([I.longitude,I.latitude]);z.push(I.latitude);j.push(I.longitude);l.push(I.name)});n.locationsSet();return n};n.editText=function(J,H,I){var g=J.find("."+I+"-edit").text("save");var L=J.find("."+I+"-text");var K=((I=="title")?L.text():l[H]);J.addClass("active");L.html('<input value="'+K+'">').find("input").focus()};n.saveText=function(J,H,I){var g=J.find("."+I+"-edit").text("edit");var K=J.find("input").val();J.removeClass("active");J.find("."+I+"-text").text(K);if(I=="place"){l[H]=K}else{return K}};n.removeInput=function(g){var H=d3.select("#places").selectAll("li.place .title");H.each(function(J,I){if(!J.edit){return}J.edit=false;n.saveText($(this),I,"place")});return false};n.refresh=function(){i();n.refreshed()};n.updateTitle=function(g){a=g};n.outputTitle=function(){return a||"My Meshu"};n.output=function(){return $("#"+u).html()};return n};var sb=sb||{};sb.mesh.radial=function(o,G,s,q){var p=sb.mesh.base(o,G,s,q),v="m"+parseInt(Math.random()*10000000000,10),C=200,B=0;p.name="radial";var z=[],l=[],b;var D=d3.select(o||"body").append("div").attr("id",v).style("width",s).style("height",q).style("position","absolute");var e=d3.select(o||"body").append("div").attr("id",v+"prerendered").style("width",s).style("height",q).style("position","absolute");var i=d3.select("#"+v).append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var h=i.append("svg:g").attr("class","delaunay");h.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var A=h.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");h.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var n=d3.select(o).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var F=d3.select("#place-title").attr("class","inactive");F.append("span").attr("class","title-text");F.append("span").attr("class","title-edit").html("edit");var y=[],a=[],u=[],t=[],f={},b=null;var x=$("#content");p.hittest=function(g){return d3.event.target!=n.node()};p.on("draggedMap",function(){j()});p.on("clickedMap",function(g){p.add(g.lat,g.lon,undefined,false)});p.on("styled",function(g){if(g.zoom&&g.zoom!=G.map.zoom()){G.map.zoom(g.zoom)}});function m(){var g=h.selectAll("circle");g.attr("cx",function(I){return G.l2p({lat:I[1],lon:I[0]}).x}).attr("cy",function(I){return G.l2p({lat:I[1],lon:I[0]}).y})}function k(){var J=function(P,N){var K=Math.min(16,P.total-4),M=5,O=(1-Math.sqrt(P.d)),L=(K*O)+M;return L+"px"};var I="black";if(p.style()!=undefined&&p.style().drawStyle){I=p.style().drawStyle=="outline"?"black":"white"}var g=A.selectAll("path").data(u);if($("body").hasClass("firefox")){g.enter().append("svg:path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",J)}else{g.enter().append("svg:path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",0).transition().duration(500).style("stroke-width",J)}g.exit().remove();g.attr("d",function(K){return w(K.pts)}).attr("stroke",I)}function w(L){var g=[];var I=L.length;for(var J=0;J<I;J++){var M={lat:L[J][0],lon:L[J][1]};var K=G.l2p(M);g.push([K.x,K.y])}return"M"+g.join("L")}function E(L){a.push(L);var I=L.length;for(var J=0;J<I-2;J+=2){var K=[L[J],L[J+1]];var g=[L[J+2],L[J+3]];u.push({pts:[K,g],total:L.length,d:J/L.length})}k()}function c(L){var g=true,I=0;for(var K=1;K<y.length;K++){if(f[L][K]!="done"){g=false}else{I++}}var J=(I/(y.length-1)*100).toFixed(0)+"%";$("#radial-heading").html("Generating radial... "+J);if(g){$("#radial-heading").html("Your radial is done!");p.added()}}function d(){var M=G.map.zoom(),O=y[0];startCoords=O[1]+","+O[0];f[M]=["done"];var L=$("body").hasClass("ie")||window.location.protocol=="https:"?"https://meshu.io/proxy/router/?from=":"http://open.mapquestapi.com/directions/v1/route?routeType=pedestrian&outFormat=json&shapeFormat=raw&generalize=200&from=";var N=L+"{start}&to={end}";for(var K=1;K<y.length;K++){var I=y[K],g=I[1]+","+I[0],J=N.replace("{start}",startCoords).replace("{end}",g);f[M][K]=$.jsonp({url:J,callbackParameter:"callback",error:function(P){return function(Q){f[M][P]="done";c(M)}}(K),success:function(P){return function(R){if(!R.route.shape){f[M][P]="done";return}else{if(f[M]==undefined||f[M][P]==undefined||f[M]=="inactive"){return}}var Q=R.route.shape.shapePoints;E(Q);f[M][P]="done";c(M)}}(K)})}}function j(){F.data(y).each(function(g){g.edit=false});H();m();k()}function H(){F.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return b}});F.select(".title-text").on("click",function(g){if(g.edit){return}p.editText($(this).parent(),0,"title");g.edit=!g.edit});F.select(".title-edit").on("click",function(I){var g=$(this).parent();if(!I.edit){p.editText(g,0,"title")}else{I.title=b=p.saveText(g,0,"title")}I.edit=!I.edit})}p.editText=function(K,I,J){var g=K.find("."+J+"-edit").text("save");var M=K.find("."+J+"-text");var L=M.text();K.addClass("active");M.html('<input value="'+L+'">').find("input").focus()};p.saveText=function(K,I,J){var g=K.find("."+J+"-edit").text("edit");var L=K.find("input").val();K.removeClass("active");K.find("."+J+"-text").text(L);return L};function r(){i.selectAll("path").remove();u=[];y=[y[0]];z=[z[0]];l=[l[0]];var I,J;for(var L=0;L<24;L++){var K=L*(Math.PI/12);var g=G.p2l({x:C+300+(Math.sin(K)*200),y:B+300+(Math.cos(K)*200)});J=g.lon;I=g.lat;z.push(I);l.push(J);y.push([J,I])}}p.add=function(N,I,K,g){var J=parseFloat(N);var M=parseFloat(I);D.select("#radialClip circle").data([[M,J]]);D.select(".circleFrame").data([[M,J]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",17);z=[J];l=[M];y=[[M,J]];if(K==undefined){b=N.toFixed(3)+", "+I.toFixed(3)}else{b=K[0].toUpperCase()+K.substr(1,K.length-1)}$("#places").removeClass("inactive");var L={lat:J,lon:M};G.map.center(L);p.recalculate();G.centerOn(L,C,B);G.boundsUpdated();return p};p.remove=function(g){y.splice(g,1);z.splice(g,1);l.splice(g,1)};p.lats=function(){return z};p.lons=function(){return l};p.places=function(){return[b]};p.points=function(g){if(!arguments.length){return y}y=g;return p};p.bakeStyles=function(){var J=$(".circleFrame").css("stroke"),I=$(".circleFrame").css("fill"),g=$(".radial path").css("stroke");$(".circleFrame").attr("stroke",J);$(".circleFrame").attr("fill",I);$(".radial path").attr("stroke",g)};p.unBakeStyles=function(){$(".circleFrame").attr("stroke","").attr("fill","");$(".radial path").css("stroke","")};p.locations=function(g){y=[];z=[];l=[];$.each(g,function(I,J){y.push([J.longitude,J.latitude]);z.push(J.latitude);l.push(J.longitude)});p.dirty=true;p.locationsSet();return p};p.prerender=function(I,O){O=O||1;$("#"+v+"prerendered").html(I);var J=$("#"+v+"prerendered").find(".delaunay");$("#"+v).find(".delaunay").replaceWith(J);var L=$(o).width(),g=$(o).height(),K=600*O,N="translate("+(L-K)/2+","+(g-K)/2+") ",M=" scale("+O+","+O+")";$("#"+v+" .delaunay").attr("transform",N+M)};p.recalculate=function(){$("#"+v+"prerendered").remove();$.each(f,function(g,I){$.each(I,function(J,K){if(K==undefined||K=="done"){return}if(K.abort){K.abort()}});f[g]="inactive"});r();d();p.style({zoom:G.map.zoom()});p.dirty=false};p.refresh=function(g){if(g=="zoomed"&&z.length>0&&l.length>0){p.add(z[0],l[0],b)}else{j();p.refreshed()}};p.updateTitle=function(g){b=g};p.outputTitle=function(){return b||"My Meshu"};p.output=function(){return $("#"+v).html()};p.id=function(){return v};return p};var sb=sb||{};var app_key="dj0yJmk9M1hsekZBSDY1ZjRxJmQ9WVdrOU5uUjZiRzE0TXpRbWNHbzlNVEV5TURZMU1qRTJNZy0tJnM9Y29uc3VtZXJzZWNyZXQmeD00OQ--";sb.meshu=function(i,o,h){var k={},m=$(i).width()+"px",l=$(i).height()+"px",t=h||sb.map(i,m,l),o=o||"facet",b=sb.mesh[o](i,t,m,l),d=$("#cases"),s=200,q=0;$(i).append("<div class='mapui'><div id='zoomin'></div><div id='zoomout'></div></div>");$("#zoomin").mousedown(function(v){t.map.zoom(t.map.zoom()+1);b.refresh("zoomed")});$("#zoomout").mousedown(function(v){t.map.zoom(t.map.zoom()-1);b.refresh("zoomed")});var a=$("#searchbox");a.focus(function(){d.fadeOut()}).keypress(function(w){if(w.which==13){var v=a.val();r(v)}});$("#search-button").click(function(){var w=a.val();if(w.split("|").length>2){var v=w.split("|");for(var x=0;x<v.length;x++){setTimeout(function(y){return function(){r(y)}}(v[x]),x*1000)}}else{r(w)}});function r(v){if(v=="add a city, place, or address"){return}var x=v.replace("&","and").replace(/[^\w ]/ig,"").replace(" ","+");var w="/proxy/geocoder/?location="+x;a.val("");$.ajax({url:w,cache:false,dataType:"json",error:function(y,A,z){console.log(z)},success:function(z){var y=z.bossresponse.placefinder.results;d.empty().hide();if(typeof y=="undefined"){a.blur();var B="Hrm, we weren't able to find your search. Try again?";d.append($("<p>").text(B)).fadeIn()}else{if(y.length>0){var A=y[0];switch(b.name){case"facet":case"print":b.add(A.offsetlat,A.offsetlon,v);k.updateBounds();if(b.points().length==1){f(A.radius)}break;case"radial":f(A.radius/10);b.add(A.offsetlat,A.offsetlon,v);break}}}}})}function j(v){if(v>100000){return 4}else{if(v>10000){return 12}else{if(v>1000){return 13}else{if(v>400){return 14}}}}return 12}function f(v){var w=j(v);if(w!=t.map.zoom()){t.map.zoom(w)}}k.locations=function(v,x){for(var w=0;w<v.length;w++){if(x){b.add(v[w].latitude,location[w].longitude,v[w].name)}else{setTimeout(function(y){return function(){b.add(y.latitude,y.longitude,y.name);k.updateBounds()}}(v[w]),w*400)}}if(x){k.updateBounds()}};function c(A){var v=A.split("|");var z=[],x={};for(var y=0;y<v.length;y++){var w=v[y].split("\t");if(w.length<3){continue}var B=w[0]+"-"+w[1];if(x[B]){continue}else{x[B]=true}z.push({latitude:parseFloat(w[0]),longitude:parseFloat(w[1]),name:w[2]})}return z}k.initializeFromData=function(y,x,w){b.prerender(w);var v=c(y);b.locations(v);if(x){b.applyStyle(x)}return k};k.mesh=function(){return b};k.map=function(){return t};var g=0,e=1,p=0,n=0;var u;k.animateTransform=function(A,z,x,v){if(u){clearInterval(u)}var w=0;var y=d3.select(".delaunay");u=setInterval(function(){if(++w<30){g+=(A-g)*0.33;e+=(z-e)*0.5;p+=(x-p)*0.5;n+=(v-n)*0.5;var B="rotate("+g+", 300, 300)";var D="scale("+e+")";var C="translate("+p+","+n+")";y.attr("transform",D+C+B)}else{clearInterval(u)}},40)};k.refreshWithBounds=function(w,v){t.updateBounds(w,v,k.zoomOffset,s,q)};k.updateBounds=function(){if(b.dirty){k.refreshWithBounds(b.lats(),b.lons());b.dirty=false}};t.on("boundsUpdated",function(){if(b.updatePixelBounds){b.updatePixelBounds()}b.refresh()});b.on("locationsSet",k.updateBounds);k.getFrame=function(){return i};k.getRenderer=function(){return o};k.updateTitle=function(v){b.updateTitle(v)};k.outputTitle=function(){return b.outputTitle()};k.outputSVG=function(){return b.output()};k.outputMapSVG=function(){return $(t.map.container()).html()};k.hideMesh=function(){return k};k.showMesh=function(){return k};k.outputLocationData=function(){var v=[];var x=b.places(),y=b.lats(),w=b.lons();$.each(x,function(A){var z=y[A]+"\t"+w[A]+"\t"+x[A];v.push(z)});return v.join("|")};k.xhr=function(){return{xhr:"true",title:k.outputTitle(),svg:k.outputSVG(),location_data:k.outputLocationData(),renderer:b.name,metadata:b.outputStyle(),promo:meshu.promo}};return k};var sb=sb||{};sb.rasterizer=function(){var h=d3.dispatch("rasterized","rasterizedThumbnail"),e=false,g=[];var d=function(k,l){var j=document.createElement("canvas");j.width=400;j.height=400;j.style.position="absolute";j.style.top="0";j.style.left="0";j.className=k;$(j).addClass("hidden");if(!l){g.push(j)}return j};var c=function(j,k){j.fillStyle="rgba(255, 255, 255, "+k+")";j.fillRect(0,0,j.width,j.height);j.fill()};var i=function(j){var k=new XMLSerializer();return k.serializeToString(j)};var b=function(k){var m=k.map().map,l=m.zoom(),j=Math.round(l);if(l!=j){m.zoom(j);k.mesh().refresh()}};var f=function(m,l,j,k,o){var n=d();m.appendChild(n);k.mesh().bakeStyles();canvg(n,k.outputSVG(),{renderCallback:function(){k.mesh().unBakeStyles();j.drawImage(n,0,0,l.width,l.height);var p=new Image();p.onload=function(){j.drawImage(p,l.width-130,l.height-35,117,22);a(m,l,k,o)};p.src="/static/images/logo_io.png"}})};var a=function(m,k,j,n){var l=j.xhr();l.csrfmiddlewaretoken=$("#csrf input").val();l.dataurl=k.toDataURL();if(j.id){l.id=j.id}h.clearCanvases();console.log("rasterizer:","posting meshu to_png",l);$.post("to_png",l,function(p){var o=document.createElement("img");o.src=p.image_url;$(o).addClass("hidden");m.appendChild(o);h.generated=true;h.rasterized(p);if(n){n(p)}},"json")};h.clearCanvases=function(){while(g.length){var j=g.pop();$(j).remove()}};h.rasterize=function(l,o){console.log("rasterizer:",l,o);b(l);var k=d(),n=l.getFrame(),j=k.getContext("2d"),m=i(l.map().map.container());n.appendChild(k);canvg(k,m,{renderCallback:function(){c(j,0.7);f(n,k,j,l,o)}})};h.thumbnail=function(l,o){l.mesh().bakeStyles();var k=d(),n=l.getFrame(),j=k.getContext("2d"),m=l.outputSVG();n.appendChild(k);canvg(k,m,{renderCallback:function(){l.mesh().unBakeStyles();if(o){o(k)}}})};h.ringPreview=function(s,q){s.mesh().bakeStyles();if(s.mesh().points().length<3){return}var l=s.mesh().getLongestRotation(),p=s.mesh().projectPoints(l),n=500,r=110,m=10;s.mesh().transformedDelaunay(p,n,r-m,m/2);var k=d("ring-canvas",true),j=s.getFrame(),t=k.getContext("2d"),o=s.outputSVG();j.appendChild(k);canvg(k,o,{renderCallback:function(){s.mesh().unBakeStyles();s.mesh().refresh();d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");d3.select("#ring-img").style("display","none");d3.selectAll(".ring-canvas").remove();var w=40,v=0;var u=document.getCSSCanvasContext("2d","ring-preview",n,r+v+w);u.clearRect(0,0,n,r+v+w);u.fillStyle="rgba(255, 255, 255, .75)";u.fillRect(0,0,n,r+v+w);u.drawImage(k,0,0,n,r,0,v,n,r);if(q){q(k)}}})};return h}();sb.transforms={earrings:{product:{scale:0.175,transform:{x:143,y:112}},preview:{scale:0.125,transform:{x:650,y:540}},render:{scale:0.45,transform:{x:530,y:450}}},pendant:{product:{scale:0.125,transform:{x:119,y:167}},preview:{scale:0.075,transform:{x:1030,y:1470}},render:{scale:0.25,transform:{x:900,y:1375}}},necklace:{product:{scale:0.2,transform:{x:90,y:150}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}},cufflinks:{product:{scale:0.15,transform:{x:115,y:155}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}},coasters:{product:{scale:0.3,transform:{x:200,y:200}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}},ring:{product:{scale:0.3,transform:{x:200,y:200}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}}};sb.transforms.getTransform=function(c,b){var a=sb.transforms[c][b];return"translate("+a.transform.x+","+a.transform.y+") scale("+a.scale+")"};var sb=sb||{};$(function(){sb.product=function(){var a={};var b=[];a.initialize=function(d,c){b=c.getProducts();for(var e=0;e<b.length;e++){var f=b[e];a.resetPreviewImage(f.type);if(typeof d=="string"){a.previewFromSelector(f.type,d)}else{a.previewFromElement(f.type,d)}}};a.resetPreviewImage=function(d){var c=d3.select("#preview-"+d);c.select(".product-delaunay").remove()};a.previewFromSelector=function(f,e){var c=d3.select("#preview-"+f),d=sb.transforms.getTransform(f,"product");var g=$(e).clone().attr("class","product-delaunay").attr("transform",d);$(c[0]).append(g)};a.previewFromElement=function(f,e){var c=d3.select("#preview-"+f),d=sb.transforms.getTransform(f,"product");c.append("svg:image").attr("x",0).attr("y",0).attr("width","600px").attr("height","600px").attr("class","product-delaunay").attr("transform",d).attr("xlink:href",e.toDataURL())};a.thumbnail=function(f,e,c){var d=$(f).clone().attr("class","product-delaunay").attr("transform",c);d3.select(e[0]).append("svg:rect").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%");e.append(d)};a.rotation=function(c){d3.selectAll(".product-delaunay").attr("transform",function(g,f){var e=sb.transforms.getTransform(b[f].type,"product");return e+" rotate("+c+", 300, 300)"})};return a}()});var sb=sb||{};$(function(){sb.rotator=function(e,d,b){var c=d3.dispatch("rotated","ringSizeUpdated");var f=0,g="scale(.125) translate(380, 670) ";c.update=function(l){$(e).empty();var n=d3.select(e);var q=n.append("svg:image").attr("id","previewImage").attr("x",0).attr("y",0).attr("width",313).attr("height",297).attr("xlink:href",c.getImage(l));var p=n.append("svg:g").attr("id","transform").attr("transform",c.getTransform(l));var m=$(b).clone().attr("class","rotate-ui");var s=$(d).clone().attr("class","mini-delaunay");$(p[0]).append(s).append(m);if(l=="pendant"){n.select(".rotate-ui").attr("class","hidden pendant").selectAll("circle").attr("r","55")}d3.selectAll("circle.rotation").on("mousedown",x);n.on("mouseup",t).on("mousemove",k);var w,v,j,i,o,h,r,y;var h=0;function x(){var z=d3.svg.mouse(n.node());w=z[0]-100,v=z[1]-100;r=true}function k(){if(!r){return}var z=d3.svg.mouse(n.node());j=z[0]-100,i=z[1]-100;y=a(w,v,j,i);var B=Math.sqrt(Math.pow(w,2)+Math.pow(v,2));var A=Math.sqrt(Math.pow(j,2)+Math.pow(i,2));o=Math.acos((w*j+v*i)/(B*A))*180/Math.PI;f=y?(f-o)%360:(f+o)%360;if(isNaN(f)){f=0}w=j,v=i;p.attr("transform",c.getTransform(l))}function t(){r=false;if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}}function u(z){f=(f+z)%360;p.attr("transform",c.getTransform(l))}$("#rotate-cw").click(function(){u(22.5)});$("#rotate-ccw").click(function(){u(-22.5)})};c.updateRing=function(){var h=$("#final-ring .frame");var i=$(".ring-preview-frame").clone();$(h).append(i);c.ringSizeUpdated(7);var j=d3.scale.linear().domain([4,14]).range([0.8,1.2]);$("#ring-range").change(function(m){var k=m.currentTarget.value;$("#ring-number").text(k);c.ringSizeUpdated(k);var l=j(k);i.css({"-moz-transform":"rotateX(20deg) rotateY(0deg) rotateZ(45deg) translate3d(0px,0px,0px) scale("+l+")","-webkit-transform":"rotateX(20deg) rotateY(0deg) rotateZ(45deg) translate3d(0px,0px,0px) scale("+l+")"})})};c.getTransform=function(h){return sb.transforms.getTransform(h,"product")+" rotate("+f+",300,300)"};c.getImage=function(h){return static_url+"images/preview/preview_"+h+".png"};c.rotation=function(h){if(!arguments.length){return f}f=h;return c};function a(i,k,h,j){if(h>i){if(k>0&&j>0){return true}else{return false}}else{if(h<i){if(k<0&&j<0){return true}else{return false}}else{if(j<k){if(i>0){return true}else{return false}}else{if(i<0){return true}else{return false}}}}}return c}("#rotate",".delaunay",".hidden")});var sb=sb||{};sb.materializer=function(){var c=d3.dispatch("update"),a,f,g,e,d,b;f={earrings:"pair of earrings",pendant:"small pendant necklace",necklace:"large necklace",cufflinks:"pair of cufflinks"};g={earrings:"earrings",pendant:"pendant necklace",necklace:"large necklace",cufflinks:"cufflinks"};c.initialize=function(h){a=h;c.materials=$("#material-list");c.materials.find("li").live("click",function(k){var j=k.currentTarget.id.split("-");c.material(j[1]);c.color(j[0]);var i=$(this);i.parent().find("li").removeClass("selected");i.addClass("selected")})};c.product=function(i){if(!arguments.length){return e}e=i;var h=a.getMaterials(i);$.each(c.materials.find("li"),function(k,j){var l=$(this).attr("id");if(h[l]){$(j).removeClass("inactive").find(".price").text("$"+h[l])}else{$(j).addClass("inactive").find(".price").text("")}});return c};c.material=function(h){if(!arguments.length){return d}d=h;return c};c.color=function(h){if(!arguments.length){return b}b=h;c.update();return c};c.productName=function(){return g[e]};c.displayName=function(){return f[e].toLowerCase()};return c}();var saver=function(){var b={},f="#meshu-id";function e(){var g=b.meshu.xhr();g.csrfmiddlewaretoken=$("#csrf input").val();return g}function d(g){if(!g){return}b.meshu.id=g;if($(f).length==0){$("#hidden-form-values").append('<input type="hidden" id="meshu-id" name="meshu_id" />')}$(f).val(g)}function a(){var g=e();if($(f).length){g.id=b.getMeshuID()}$.post("/make/assign/",g,function(h){d(h.meshu_id);if(b.postAssignCallback){b.postAssignCallback(h)}},"json")}function c(){var g=e();if($(f).length){g.id=b.getMeshuID()}$.post("/make/create/",g,function(h){d(h.meshu_id);if(b.postCreateCallback){b.postCreateCallback(h)}},"json")}b.initialize=function(h){b.meshu=h;$("#cancel-button").click(function(){window.location.href=loadedMeshu.view_url});var i="#save-button";$(i).click(function(){if(!loadedMeshu){return}$(i).html("saving");var j=loadedMeshu.edit_url+"save";$.post(j,e(),function(k){d(k.meshu_id);setTimeout(function(){$(i).html("saved!")},200);setTimeout(function(){window.location.href=k.meshu_url},1000)},"json")});var g="#update-button";$(g).click(function(){if(!loadedMeshu){return}$(g).html("updating");var j=loadedMeshu.edit_url+"update";$.post(j,e(),function(k){d(k.meshu_id);setTimeout(function(){$(g).html("saved!")},200);setTimeout(function(){window.location.href=k.meshu_url},1000)},"json")});return b};b.initializeNewMeshu=function(g){b.meshu=g;return b};b.createOrUpdateMeshu=function(g){if(b.meshu.isReadymade&&g){g()}else{if(b.meshu.username&&b.meshu.username=="guest"){a();if(g){b.postAssignCallback=g}}else{c();if(g){b.postCreateCallback=g}}}return b};b.updateMeshuData=function(g){d(g.id);b.meshu.view_url=g.view_url;b.meshu.username=g.username;b.meshu.title=g.title;b.meshu.promo=g.promo;if(g.image_url){b.meshu.image_url=g.image_url}};b.getMeshuID=function(){return $(f).val()};return b}();var sb=sb||{};sb.facebook={};$(".facebook-auth").click(function(){var a="/facebook/login";window.location=a});sb.facebook.initialize=function(h){$("#finish-button").click(function(){window.location="/make/#skipintro"});var c="Alabama,AL,Alaska,AK,Arizona,AZ,Arkansas,AR,California,CA,Colorado,CO,Connecticut,CT,Delaware,DE,Florida,FL,Georgia,GA,Hawaii,HI,Idaho,ID,Illinois,IL,Indiana,IN,Iowa,IA,Kansas,KS,Kentucky,KY,Louisiana,LA,Maine,ME,Maryland,MD,Massachusetts,MA,Michigan,MI,Minnesota,MN,Mississippi,MS,Missouri,MO,Montana,MT,Nebraska,NE,Nevada,NV,New Hampshire,NH,New Jersey,NJ,New Mexico,NM,New York,NY,North Carolina,NC,North Dakota,ND,Ohio,OH,Oklahoma,OK,Oregon,OR,Pennsylvania,PA,Rhode Island,RI,South Carolina,SC,South Dakota,SD,Tennessee,TN,Texas,TX,Utah,UT,Vermont,VT,Virginia,VA,Washington,WA,West Virginia,WV,Wisconsin,WI,Wyoming,WY";var u=c.split(",");var o={};for(var q=1;q<u.length;q+=2){o[u[q]]=u[q-1]}var d=function(i,v){return function(){$("#svg-file").val(i.outputSVG());$("#meshu-data").val(i.outputLocationData());$("#meshu-title").val(v);$("#meshu-select-form").submit()}};var s=[];var l={all:{name:"All Cities",locations:[]}};var j=[];var r=[];var m=[];var t=0;var g=function(v,w){if(w.locations.length<3){return}t+=300;setTimeout(function(){return function(){var y=$("<div>").addClass("mini-meshu");var x=$("<div>").addClass("title").html(w.name);y.append(x).fadeIn();$("#maps").append(y);var i=sb.minimeshu(y[0]);setTimeout(function(){i.locations(w.locations)},100);y.click(d(i,w.name))}}(),t)};var e=function(i,v){if(!l[v]){l[v]={name:v,locations:[],seen:{}};i.push(l[v])}};var b=function(v,w,i,x){if(!l[w].seen[x]){l[w].locations.push(i);l[w].seen[x]=i}else{l[w].seen[x].times++}};var f=function(){var i=function(w,v){return v.locations.length-w.locations.length};j.sort(i);r.sort(i);m.sort(i);if(m.length>1){m.unshift(l.all);$.each(m,g)}else{g(0,l.all)}if(r.length>1){$.each(r,g)}if(j.length){$.each(j,g)}else{$(".page-header").html("Oh no! Not enough checkins to make any meshus.");$("#finish-button").html("Make one manually")}};var p=0;var n=function(i){var v=i.data;if(!v||!v.length){f();return}p+=i.data.length;$.each(v,function(y,A){if(!A.place||!A.place.location||!A.place.location.city){return}var C=A.place.location.city;var B=A.place.location.country;var w={latitude:A.place.location.latitude,longitude:A.place.location.longitude,name:A.place.name,times:1};var x={name:C,latitude:w.latitude,longitude:w.longitude};if(!l[C]){l.all.locations.push(x)}e(j,C);e(m,B);b(j,C,w,w.name);b(m,B,x,C);var z=A.place.location.state;if(z&&B=="United States"){if(o[z.toUpperCase()]){z=o[z.toUpperCase()]}e(r,z);b(r,z,x,x.name)}});$.ajax({url:i.paging.next,dataType:"jsonp",success:function(w){if(w.data&&w.data.length){$(".page-header").html("Loaded "+p+" places...");n(w)}else{$(".page-header").html("Each meshu is a different set of places. Choose one to get started!");f()}},error:function(w){console.warn(w)}})};var k=false;function a(){h.api("/me/locations?limit=50",function(i){if(i.error){if(k){$(".page-header").html("We're not sure what happened! Try connecting to Facebook again?")}else{$(".page-header").html("Oops, there was an error connecting to Facebook. Retrying...");setTimeout(a,500);k=true}}else{n(i)}})}a()};$(".foursquare-auth").click(function(){var a="AJXTWLOH1K5RIWG33XSGQZHRISL5CCJ0XG1VUL3NAKDYYPMM";var d="https://meshu.io/make/foursquare/";var c="https://foursquare.com/oauth2/authenticate?client_id={client}&response_type=token&redirect_uri={redirect}";var b=c.replace("{client}",a).replace("{redirect}",d);window.location=b});var sb=sb||{};sb.foursquare={};sb.foursquare.initialize=function(){var a=window.location.hash,h=a.split("=").pop(),m="https://api.foursquare.com/v2/users/self/checkins?oauth_token={token}&v={v}&limit=250&offset={offset}",s=m.replace("{token}",h).replace("{v}","20120102");window.location.hash="#connected";$("#finish-button").click(function(){window.location="/make/#skipintro"});if(!h||!h.length){return}var c="Alabama,AL,Alaska,AK,Arizona,AZ,Arkansas,AR,California,CA,Colorado,CO,Connecticut,CT,Delaware,DE,Florida,FL,Georgia,GA,Hawaii,HI,Idaho,ID,Illinois,IL,Indiana,IN,Iowa,IA,Kansas,KS,Kentucky,KY,Louisiana,LA,Maine,ME,Maryland,MD,Massachusetts,MA,Michigan,MI,Minnesota,MN,Mississippi,MS,Missouri,MO,Montana,MT,Nebraska,NE,Nevada,NV,New Hampshire,NH,New Jersey,NJ,New Mexico,NM,New York,NY,North Carolina,NC,North Dakota,ND,Ohio,OH,Oklahoma,OK,Oregon,OR,Pennsylvania,PA,Rhode Island,RI,South Carolina,SC,South Dakota,SD,Tennessee,TN,Texas,TX,Utah,UT,Vermont,VT,Virginia,VA,Washington,WA,West Virginia,WV,Wisconsin,WI,Wyoming,WY";var v=c.split(",");var o={};for(var q=1;q<v.length;q+=2){o[v[q]]=v[q-1]}var d=function(i,w){return function(){$("#svg-file").val(i.outputSVG());$("#meshu-data").val(i.outputLocationData());$("#meshu-title").val(w);$("#meshu-select-form").submit()}};var t=[];var l={all:{name:"All Cities",locations:[]}};var k=[];var r=[];var n=[];var u=0;var j=function(w,x){if(x.locations.length<3){return}u+=300;setTimeout(function(){return function(){var z=$("<div>").addClass("mini-meshu");var y=$("<div>").addClass("title").html(x.name);z.append(y).fadeIn();$("#maps").append(z);var i=sb.minimeshu(z[0]);setTimeout(function(){i.locations(x.locations)},100);z.click(d(i,x.name))}}(),u)};var e=function(i,w){if(!l[w]){l[w]={name:w,locations:[],seen:{}};i.push(l[w])}};var b=function(w,x,i,y){if(!l[x].seen[y]){l[x].locations.push(i);l[x].seen[y]=i}else{l[x].seen[y].times++}};var g=function(){var i=function(x,w){return w.locations.length-x.locations.length};k.sort(i);r.sort(i);n.sort(i);if(n.length>1){n.unshift(l.all);$.each(n,j)}else{j(0,l.all)}if(r.length>1){$.each(r,j)}if(k.length){$.each(k,j)}else{$(".page-header").html("Oh no! Not enough checkins to make any meshus.");$("#finish-button").html("Make one manually")}};var p=0;var f=function(i){$.ajax({url:i,dataType:"jsonp",success:function(y){if(!y.response.checkins){g();return}var w=y.response.checkins.items;if(!w||!w.length){g();return}p+=y.response.checkins.items.length;$.each(w,function(B,D){if(!D.venue||!D.venue.location||!D.venue.location.city){return}var F=D.venue.location.city;var E=D.venue.location.country;var z={latitude:D.venue.location.lat,longitude:D.venue.location.lng,name:D.venue.name,times:1};var A={name:F,latitude:z.latitude,longitude:z.longitude};if(!l[F]){l.all.locations.push(A)}e(k,F);e(n,E);b(k,F,z,z.name);b(n,E,A,F);var C=D.venue.location.state;if(C&&E=="United States"){if(o[C.toUpperCase()]){C=o[C.toUpperCase()]}e(r,C);b(r,C,A,A.name)}});var x=y.response.checkins.count;if(p<x){$(".page-header").html("Loaded "+p+" of "+x+" checkins...");f(s.replace("{offset}",p))}else{$(".page-header").html("Each meshu is a different set of places. Choose one to get started!");g()}}})};f(s.replace("{offset}",p))};var sb=sb||{};sb.ui=sb.ui||{};sb.ui.orderer=function(){var d=d3.dispatch("updated"),e=null,b=null,f={};d.on("updated",function(){c();a()});d.initialize=function(i,j){e=i,b=j;$("#postcard-note-form").keyup(function(l){var k=l.target.value;$("#postcard-note").val(k)});$("#save-and-view").click(function(){var k=function(){saver.createOrUpdateMeshu(function(l){window.location.href=l.meshu_url})};if(!user.loggedIn){h();user.afterLogIn=k}else{k()}});$("#add-to-cart").click(function(){d.updated();$("#order-form")[0].submit()})};function g(){if(!user.loggedIn){h(g);return}d.updated();d.validated();return false}function h(i){user.showModal();user.afterLogIn=function(){if(i){saver.createOrUpdateMeshu(function(){setTimeout(i,200)})}}}function c(){var l=sb.materializer.product(),j=sb.materializer.material(),i=sb.materializer.color(),k=b.getPrice(l,j)*100;$("#object-type").val(l);$("#object-material").val(j);$("#object-color").val(i?i.toLowerCase():"");$("#object-amount").val(k);$("#svg-theta").val(sb.rotator?sb.rotator.rotation():0);$("#svg-file").val(e.outputSVG());$("#meshu-data").val(e.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:e.outputTitle());$("#meshu-renderer").val(e.mesh().name);$("#meshu-metadata").val(e.mesh().outputStyle());$("#postcard-note").val($("#postcard-note-form").val());$("#order-metadata").val(d.outputMetadata())}function a(){var k=sb.materializer.product(),i=sb.materializer.material(),j=b.getPrice(k,i);if(k){$(".review-product").removeClass("inactive").text(k)}if(sb.materializer.color()&&i){$(".review-material").removeClass("inactive").text(sb.materializer.color()+" "+i)}if(k&&sb.materializer.color()&&i){$(".review-price").text("$"+j+".00");$("#add-to-cart").removeClass("inactive")}}d.metadata=function(k){if(!arguments.length){return f}for(var j in k){f[j]=k[j]}};d.clearMetadata=function(i){if(f[i]){delete f[i]}};d.outputMetadata=function(){var k=[];for(var j in f){k.push(j+":"+f[j])}return k.join("|")};return d}();var sb=sb||{};sb.ui=sb.ui||{};sb.ui.socialsharer=function(b){console.log("initializing social sharer",b);$(".share-facebook").click(function(){if(!sb.rasterizer.generated){sb.rasterizer.rasterize(b,a)}else{a()}});$(".action-button").click(function(){var d=this;if(!sb.rasterizer.generated){sb.rasterizer.rasterize(b,function(e){d.click()});return false}});sb.rasterizer.on("rasterized",function(d){saver.updateMeshuData(d);c();$(".social-media").fadeIn()});var c=function(f){var h="https://twitter.com/intent/tweet?text=";var j="http://pinterest.com/pin/create/button/?url=";var e="http://"+window.location.host;var i=e+b.image_url;var d=encodeURIComponent(e+b.view_url);var g="Check out this meshu I just made of the places I've been";$(".share-pinterest").attr("href",j+d+"&media="+i);$(".share-twitter").attr("href",h+g+"&url="+d)};var a=function(){var d="http://"+window.location.host;FB.ui({method:"feed",link:d+b.view_url,picture:d+b.image_url,name:b.title+" on meshu.io",caption:"",description:""},function(e){if(!e||e.error){}else{}})}};var sb=sb||{};sb.viewhandler=function(){var b=d3.dispatch("updated","next","prev");var a=["edit","product","make","add-ons","checkout","review"];var e=$("#content");$("#product").waypoint(function(f){if(f=="down"){c();if(meshu.getRenderer()=="facet"){sb.rasterizer.ringPreview(meshu)}}else{d()}},{offset:550});$("#review").waypoint(function(f){if(f=="down"){sb.ui.orderer.updated()}},{offset:700});b.updateAccountView=function(){};function c(){var i=$(this);var f=b.view();var g=a.indexOf(f);var h=function(){e.attr("class",a[g+1])};b.next();h()}function d(){var f=b.view();var g=a.indexOf(f);var h=a[g-1];e.attr("class",h);b.prev()}b.view=function(f){if(!arguments.length){return e.attr("class")}var g=a.indexOf(f);if(g!=-1){e.attr("class",a[g]);view=f}};return b}();$(function(){var h=$("html").hasClass("svg");var a=loadedMeshu?loadedMeshu.promo:null,e=loadedMeshu&&loadedMeshu.product!="",d=loadedMeshu?loadedMeshu.renderer:$("body").hasClass("radial")?"radial":null;if($("body").hasClass("print")){d="print"}var f=sb.catalog(d,a);sb.materializer.initialize(f);meshu=sb.meshu($("#meshu-container")[0],d);meshu.zoomOffset=window.location.href.search("postcard")>0?-0.25:0;meshu.isReadymade=e;sb.ui.orderer.initialize(meshu,f);if(loadedMeshu){saver.initialize(meshu);saver.updateMeshuData(loadedMeshu);user.updateLogoutActions(pageType);console.log("pageType:",pageType);switch(pageType){case"view":sb.ui.socialsharer(meshu);if(h){meshu.map().buffer(0)}break}if(h){if(meshu.isReadymade&&readymade){readymade.initialize(meshu)}meshu.initializeFromData(loadedMeshu.location_data,loadedMeshu.metadata,loadedMeshu.svg)}if(pageType!="postcard"){g()}$("#meshu-container").removeClass("inactive");var i=loadedMeshu.location_data.split("|");$.each(i,function(k,m){var l=m.split("\t");if(l.length==3){var n=document.createElement("div");n.innerHTML=l[2];var j=n.firstChild.nodeValue;$("<li>").html(j).appendTo($("#display-places"))}});d3.select("#places").attr("class","").select("#place-title").attr("class","").select(".title-text").html(function(j){j.title=loadedMeshu.title;meshu.updateTitle(j.title);return j.title})}else{saver.initializeNewMeshu(meshu)}sb.viewhandler.updateAccountView();sb.viewhandler.on("next",c);sb.viewhandler.on("prev",b);if(!user.loggedIn&&!loadedMeshu&&window.location.hash!="#skipintro"){$(".tooltip").each(function(j,k){setTimeout(function(){$(k).fadeIn()},j*1000)});$(document).click(function(){$(".tooltip").fadeOut()})}$("#product-preview .wrapper").live("click",function(){var k=$(this);k.parent().find(".wrapper").removeClass("selected");k.addClass("selected");var j=k.attr("id").split("-")[1];switch(j){case"cufflinks":sb.ui.orderer.clearMetadata("ringSize");break;case"ring":$("#final-rotate").hide();$("#final-ring").show();sb.rotator.on("ringSizeUpdated",function(l){sb.ui.orderer.metadata({ringSize:l})});sb.rotator.updateRing();break;default:$("#final-rotate").show();$("#final-ring").hide();sb.rotator.update(j);sb.ui.orderer.clearMetadata("ringSize");break}sb.materializer.product(j)});function g(){if(meshu.mesh().name=="facet"){sb.product.initialize(".delaunay",f)}else{if(meshu.mesh().name=="radial"){sb.rasterizer.thumbnail(meshu,function(j){sb.product.initialize(j,f)})}}}function c(){var j=sb.viewhandler.view();switch(j){case"edit":meshu.mesh().interactive(true);g();break;case"make":case"readymade":meshu.mesh().interactive(false);var l=static_url+"images/render/"+product+"_preview.jpg",k="url("+l+")";$(".render").css("background-image",k);break}}function b(){var j=sb.viewhandler.view();switch(j){case"edit":meshu.mesh().interactive(true);break;case"make":case"readymade":meshu.mesh().interactive(true);meshu.animateTransform(0,1,0,0);break}}$(".show-places").click(function(){$("#display-places").slideToggle();$(".show-places").toggle()})});