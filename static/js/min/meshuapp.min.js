Stripe.setPublishableKey("pk_GtEuTncR1hDqm7tP3oz9RRM9XOLub");var orderer=function(){var j={},h=0,e=0,d=1,g=null,f=null,b=5,c=5,i=20,k=null;function a(l,m){var o=$("#payment-form");var n=m.id;o.append("<input type='hidden' name='stripeToken' value='"+n+"' />");var p=o.attr("action");if(p.search("None")>0){o.attr("action","/order/")}o.get(0).submit()}j.submit=function(){if(h<2000){return}$("#submit-button").attr("disabled","disabled").addClass("inactive");$(".card-info").removeAttr("name");Stripe.createToken({number:$("#card-number").val(),cvc:$("#card-cvc").val(),exp_month:$("#card-expiry-month").val(),exp_year:$("#card-expiry-year").val()},h,a);return false};j.shippingMode=function(m){var l=m=="international"?i:c;j.updateProduct(g,f,l)};j.applyCoupon=function(l,m){$.get("/order/apply_coupon",{code:l},function(n){if(n.success){var o=parseFloat(n.amount);if(o<1&&o>0){d=o}else{if(o>0){e=parseInt(n.amount)}}}if(m){m(n)}},"json")};j.options=function(l){if(k){return}k=l;return j};j.updateProduct=function(n,l,o){if(!k[n]||!k[n][l]){return}b=o||5;g=n;f=l;h=j.getTotal()*100;return j};j.getPrice=function(){if(!k){return null}return k[g][f].price};j.getPriceString=function(){if(!k){return null}return"$"+k[g][f].price+".00"};j.getShipping=function(){return b};j.getTotal=function(){if(!k){return null}return Math.floor(d*(k[g][f].price-e))+b};j.getTotalCents=function(){if(!k){return null}return j.getTotal()*100};j.getTotalString=function(){if(!k){return null}return"$"+j.getTotal()+".00"};j.getColors=function(m,l){if(!k){return null}return k[m][l].colors};return j}();var sb=sb||{};sb.map=function(d,c,i){var e=org.polymaps;var j=d3.dispatch("boundsUpdated"),g=0.5;var b="/proxy/tiles/{S}/{Z}/{X}/{Y}";var a=d3.select(d).append("div")[0][0];a.style.position="absolute";a.style.width=c;a.style.height=i;d3.select(d).append("div").attr("class","render");var f=e.image().url(e.url(b).hosts(["a","b","c","d"]));j.dispatch=d3.dispatch("show");var h=a.appendChild(e.svg("svg"));j.map=e.map().container(h).zoom(12).center({lat:37.755,lon:-122.445});j.map.size({x:$(d).width(),y:$(d).height()});j.map.add(f);d3.select(h).attr("width","100%").attr("height","100%").select("rect").attr("visibility","visible").attr("fill","white");j.frame=function(){return a};j.show=function(){if(!f.map()){j.map.add(f)}};j.hide=function(){if(f.map()){j.map.remove(f)}};j.buffer=function(k){g=k;return j};j.updateBounds=function(n,l,m){if(n.length==0||l.length==0){return}if(n.length==1&&l.length==1){j.map.center({lat:n[0],lon:l[0]}).zoom(10);return}var k=[{lat:d3.min(n),lon:d3.min(l)},{lat:d3.max(n),lon:d3.max(l)}];j.map.extent(k);console.log(m);j.map.zoom(Math.floor(j.map.zoom())+(m||0));j.boundsUpdated()};j.resizeContainer=function(l,o){var t=[{lat:d3.min(l),lon:d3.min(o)},{lat:d3.max(l),lon:d3.max(o)}];j.map.zoom(10).center({lat:0,lon:0});var m=j.map.locationPoint(t[0]);var p=j.map.locationPoint(t[1]);var k=Math.abs(p.x-m.x);var s=Math.abs(p.y-m.y);var q=430;var n=k>s?q/k:q/s;k*=n;s*=n;a.style.width=(k)+"px";a.style.height=(s)+"px";j.map.extent(t);var r=j.l2p(t[0]).y-j.l2p(j.map.extent()[0]).y;if(r){a.style.top=(150-r)+"px"}};j.getBounds=function(){var l=j.map.extent();var k=j.map.locationPoint(l[0]);var m=j.map.locationPoint(l[1]);return{t:m.y,b:k.y,l:k.x,r:m.x}};j.l2p=function(k){return j.map.locationPoint(k)};j.p2l=function(k){return j.map.pointLocation(k)};return j};var sb=sb||{};sb.mesh=function(b,z,a,d){var m=d3.dispatch("added","refreshed","locationsSet"),t=parseInt(Math.random()*10000000000,10);var c=[],u=[],w=[];var j=document.createElement("div");var h=d3.select(b||"body").append("div").attr("id",t).style("width",a).style("height",d).style("position","absolute").style("z-index","100").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var M=h.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var r=h.append("svg:g").attr("class","hidden").style("display","none");r.append("svg:path");var q=d3.select(b||"body").append("div").attr("style","position:absolute;z-index:1337;").style("width",a).style("height",d);var f=q.append("svg:svg").attr("width","100%").attr("height","100%");var I=f.append("svg:g").attr("id","delaunay-ui");var l=d3.select("#places");var C=l.select("#place-number").attr("class","inactive");C.append("span").attr("class","title-text");C.append("span").attr("class","title-edit").html("edit");var v=l.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",i)}var J=[],n=[],y=[],K=0,A=null,e=false,k=null,H=null,O=null,F=null,E=null;var o=$("#content"),p=$("#cases");d3.select(".frame").on("mousemove",x).on("mousedown",s);d3.select("body").on("mouseup",G);function s(){if(!o.hasClass("edit")){return}H=true}function x(){if(!o.hasClass("edit")){return}if(!k&&!H){return}var g=d3.svg.mouse(h.node());if(k){var Q=z.p2l({x:g[0],y:g[1]});k[0]=Q.lon;k[1]=Q.lat;var R=J.indexOf(k);c[R]=Q.lat;u[R]=Q.lon;D()}if(e&&H){O=true;if(F){z.map.panBy({x:g[0]-F[0],y:g[1]-F[1]})}D()}e=true;F=g}function G(){H=null;F=null;if(!o.hasClass("edit")){return}if(d3.event.target.tagName!="circle"&&d3.event.target!=f.node()&&d3.event.target.tagName!="image"){return}if(!k&&!O){var g=d3.svg.mouse(h.node());var R=z.p2l({x:g[0],y:g[1]});m.add(R.lat,R.lon,undefined,false);O=null;return}if(!e&&k){var Q=J.indexOf(k);m.remove(Q);z.updateBounds(c,u);m.updatePixelBounds();D()}else{x()}if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}e=false;k=null;O=null}m.updatePixelBounds=function(){if(c.length&&u.length){y=[z.l2p({lat:d3.min(c),lon:d3.min(u)}),z.l2p({lat:d3.max(c),lon:d3.min(u)}),z.l2p({lat:d3.max(c),lon:d3.max(u)}),z.l2p({lat:d3.min(c),lon:d3.max(u)})]}else{y=[]}};function B(Q){var U=I.selectAll("circle");U.attr("cx",function(V){return z.l2p({lat:V[1],lon:V[0]}).x}).attr("cy",function(V){return z.l2p({lat:V[1],lon:V[0]}).y});var g=M.selectAll("path").data(d3.geom.delaunay(J));g.enter().append("svg:path");g.exit().remove();g.attr("d",function(aa){var W=aa.length;var V=[];for(var X=0;X<W;X++){var Z={lat:parseFloat(aa[X][1]),lon:parseFloat(aa[X][0])};var Y=z.l2p(Z);V.push([Y.x,Y.y])}return"M"+V.join("L")+"Z"});if(n&&Q==true){clearInterval(K);n=null}else{if(n){var T=J[J.length-1]||[];if(Math.abs(T[0]-n[0])>0.0002){T[0]+=(n[0]-T[0])/3}if(Math.abs(T[1]-n[1])>0.0002){T[1]+=(n[1]-T[1])/3}J[J.length-1]=T;var S=Math.abs(T[0]-n[0]);var R=Math.abs(T[1]-n[1]);if(R<0.0002&&S<0.0002){clearInterval(K);n=null}}else{clearInterval(K)}}}function D(){var U=I.selectAll("circle").data(J);U.enter().append("svg:circle").attr("id",function(W,V){return"c-"+V}).attr("r",7).on("mousedown",function(V){A=k=V;d3.event.stopPropagation()});U.exit().remove();var S=v.selectAll("li.place").data(J);var Q=S.enter().append("li").attr("class","place");var T=Q.append("span").attr("class","title");T.append("span").attr("class","place-text").html(function(W,V){j.innerHTML=w[V];return j.firstChild.nodeValue});T.append("span").attr("class","place-edit").html("edit");Q.append("span").attr("class","place-delete").html("x");S.exit().remove();S.attr("id",function(W,V){return"p-"+V}).select(".title").each(function(V){V.edit=false}).attr("class","title").select(".place-text").html(function(W,V){j.innerHTML=w[V];return j.firstChild.nodeValue});C.data(J).each(function(V){V.edit=false});var g=r.selectAll("circle.rotation").data(y);g.enter().append("svg:circle").attr("class","rotation").attr("r","40").attr("cx",function(W,V){return W.x}).attr("cy",function(W,V){return W.y});g.exit().remove();g.attr("cx",function(W,V){return W.x}).attr("cy",function(W,V){return W.y});var R=r.select("path");R.attr("d",function(){if(y.length==0){return}var V=[];$.each(y,function(W,X){V.push([X.x,X.y])});return"M"+V.join("L")+"Z"}).attr("class","hiddenFrame");m.updateCircleBehavior();L();B()}m.updateCircleBehavior=function(S){var Q=o.hasClass("edit");var g=$("#place-hover");var R=I.selectAll("circle");R.on("mouseover",function(Z,V){if(S){return}else{if(Q){v.select("#p-"+V).attr("class","place highlight")}else{g.addClass("active").find("span").text(w[V]);var Y=z.l2p({lat:Z[1],lon:Z[0]});var T=g.width();var X=(Y.y-32)+"px";var W=(Y.x-(T/2)-3)+"px";var U=T/2-3+"px";g.css({top:X,left:W}).find("b").css("left",U)}}});R.on("mouseout",function(U,T){if(S){return}else{if(Q){v.select("#p-"+T).attr("class","place")}else{g.removeClass("active")}}})};function L(){var g=v.selectAll("li.place");g.select(".place-delete").on("click",function(R,Q){m.remove(Q);m.updatePixelBounds();z.updateBounds(c,u);D()});g.on("mouseover",function(R,Q){I.select("#c-"+Q).attr("class","highlight")});g.on("mouseout",function(R,Q){I.select("#c-"+Q).attr("class","")});g.select(".place-edit").on("click",function(S,Q){var R=$(this).parent();if(!S.edit){P(R,Q,"place")}else{N(R,Q,"place")}S.edit=!S.edit});g.select(".place-text").on("click",function(R,Q){if(R.edit){return}P($(this).parent(),Q,"place");R.edit=!R.edit});C.attr("class","").select(".title-text").text(function(Q){if(Q&&Q.title){return Q.title}else{return"My Meshu"}});C.select(".title-text").on("click",function(Q){if(Q.edit){return}P($(this).parent(),0,"title");Q.edit=!Q.edit});C.select(".title-edit").on("click",function(R){var Q=$(this).parent();if(!R.edit){P(Q,0,"title")}else{R.title=E=N(Q,0,"title")}R.edit=!R.edit})}function P(S,Q,R){var g=S.find("."+R+"-edit").text("save");var U=S.find("."+R+"-text");var T=((R=="title")?U.text():w[Q]);S.addClass("active");U.html('<input value="'+T+'">').find("input").focus()}function N(S,Q,R){var g=S.find("."+R+"-edit").text("edit");var T=S.find("input").val();S.removeClass("active");S.find("."+R+"-text").text(T);if(R=="place"){w[Q]=T}else{return T}}function i(g){var Q=v.selectAll("li.place .title");Q.each(function(S,R){if(!S.edit){return}S.edit=false;N($(this),R,"place")});return false}m.add=function(V,R,T,g){if(K){clearInterval(K)}var S=parseFloat(V);var U=parseFloat(R);c.push(S);u.push(U);if(T==undefined){w.push(V.toFixed(3)+", "+R.toFixed(3))}else{w.push(T)}if(J.length){$("#meshu-container").removeClass("inactive");n=[U,S];if(g){J.push([n[0],n[1]]);m.updatePixelBounds();D();B(g)}else{var Q=J[J.length-1];J.push([Q[0],Q[1]]);m.updatePixelBounds();D();K=setInterval(B,40)}}else{J.push([U,S]);D()}p.fadeOut();m.added();return m};m.remove=function(g){J.splice(g,1);c.splice(g,1);u.splice(g,1);w.splice(g,1);if(J.length<3){$("#finish-button").removeClass("active")}if(J.length==1){$("#meshu-container").addClass("inactive")}};m.lats=function(){return c};m.lons=function(){return u};m.places=function(){return w};m.points=function(g){if(!arguments.length){return J}J=g;return m};m.locations=function(g){n=null;J=[];c=[];u=[];w=[];$.each(g,function(Q,R){J.push([R.longitude,R.latitude]);c.push(R.latitude);u.push(R.longitude);w.push(R.name)});m.locationsSet();return m};m.refresh=function(){D();m.refreshed()};m.updateTitle=function(g){E=g};m.outputTitle=function(){return E||"My Meshu"};m.output=function(){return $("#"+t).html()};return m};var sb=sb||{};var app_key="dj0yJmk9M1hsekZBSDY1ZjRxJmQ9WVdrOU5uUjZiRzE0TXpRbWNHbzlNVEV5TURZMU1qRTJNZy0tJnM9Y29uc3VtZXJzZWNyZXQmeD00OQ--";sb.meshu=function(d,e){var o={},c=$(d).width()+"px",l=$(d).height()+"px",a=e||sb.map(d,c,l),p=sb.mesh(d,a,c,l),n=$("#cases");$(d).append("<div class='mapui'><div id='zoomin'></div><div id='zoomout'></div></div>");$("#zoomin").mousedown(function(q){a.map.zoom(a.map.zoom()+1);p.refresh()});$("#zoomout").mousedown(function(q){a.map.zoom(a.map.zoom()-1);p.refresh()});var j=$("#searchbox");j.focus(function(){n.fadeOut()});j.keypress(function(q){if(q.which==13){f()}});$("#search-button").click(function(){f()});o.checkAdded=function(){var q=p.points();if(q.length>3){$("#finish-button").addClass("active")}else{$("#finish-button").removeClass("active")}};function f(){var q=j.val();if(q=="add a city, place, or address"){return}var s=q.replace("&","and").replace(/[^\w ]/ig,"").replace(" ","+");var r=$("body").hasClass("ie")?"/proxy/geocoder/?location="+s:"http://where.yahooapis.com/geocode?location="+s+"&flags=J&appid="+app_key;j.val("");$.ajax({url:r,cache:false,dataType:"json",error:function(t,v,u){console.log(u)},success:function(w){var u=w.ResultSet.Results||[w.ResultSet.Result];var v=$("#content");n.empty().hide();if(typeof u=="undefined"){j.blur();n.append($("<p>").text("Hrm, we weren't able to find your search. Try again?")).fadeIn()}else{if(u.length==1){b(u[0],q);if(p.points().length==1){var t=u[0].radius;if(t>1000000){a.map.zoom(3)}else{if(t>100000){a.map.zoom(4)}else{if(t>10000){a.map.zoom(12)}else{if(t>400){a.map.zoom(14)}}}}}}else{n.append($("<p>").text("Oops, we're not sure which place you meant. Try a more specific search?")).fadeIn();j.blur()}}}})}function b(q,r){p.add(q.latitude,q.longitude,r);o.updateBounds()}o.locations=function(q,s){for(var r=0;r<q.length;r++){if(s){b(q[r],q[r].name)}else{setTimeout(function(t){return function(){b(t,t.name)}}(q[r]),r*400)}}};o.locationData=function(v){var q=v.split("|");var u=[],s={};for(var t=0;t<q.length;t++){var r=q[t].split("\t");if(r.length<3){continue}var w=r[0]+"-"+r[1];if(s[w]){continue}else{s[w]=true}u.push({latitude:parseFloat(r[0]),longitude:parseFloat(r[1]),name:r[2]})}p.locations(u);return o};o.mesh=function(){return p};o.map=function(){return a};var h=0,g=1,m=0,k=0;var i;o.animateTransform=function(x,w,u,q){if(i){clearInterval(i)}var t=0;var v=d3.select(".delaunay");i=setInterval(function(){if(++t<30){h+=(x-h)*0.33;g+=(w-g)*0.5;m+=(u-m)*0.5;k+=(q-k)*0.5;var r="rotate("+h+", 300, 300)";var y="scale("+g+")";var s="translate("+m+","+k+")";v.attr("transform",y+s+r)}else{clearInterval(i)}},40)};o.refreshWithBounds=function(r,q){a.updateBounds(r,q,o.zoomOffset)};o.updateBounds=function(){o.refreshWithBounds(p.lats(),p.lons())};p.on("added",o.checkAdded);a.on("boundsUpdated",function(){p.updatePixelBounds();p.refresh()});p.on("locationsSet",o.updateBounds);o.getFrame=function(){return d};o.updateTitle=function(q){p.updateTitle(q)};o.outputTitle=function(){return p.outputTitle()};o.outputSVG=function(){return p.output()};o.outputMapSVG=function(){return $(a.map.container()).html()};o.hideMesh=function(){return o};o.showMesh=function(){return o};o.outputLocationData=function(){var q=[];var s=p.places(),t=p.lats(),r=p.lons();$.each(s,function(v){var u=t[v]+"\t"+r[v]+"\t"+s[v];q.push(u)});return q.join("|")};return o};sb.transforms={earrings:{product:{scale:0.09,transform:{x:830,y:710}},preview:{scale:0.125,transform:{x:650,y:540}},render:{scale:0.45,transform:{x:530,y:450}}},pendant:{product:{scale:0.045,transform:{x:1570,y:2200}},preview:{scale:0.075,transform:{x:1030,y:1470}},render:{scale:0.25,transform:{x:900,y:1375}}},necklace:{product:{scale:0.09,transform:{x:650,y:980}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}},cufflinks:{product:{scale:0.075,transform:{x:870,y:1170}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}}};sb.transforms.getTransform=function(c,b){var a=sb.transforms[c][b];return"scale("+a.scale+") translate("+a.transform.x+","+a.transform.y+") "};var sb=sb||{};$(function(){sb.product=function(){var a={};var b=["earrings","pendant","necklace","cufflinks"];a.initialize=function(c){for(var d=0;d<b.length;d++){a.initializeProduct(b[d],c)}};a.initializeProduct=function(e,d){var c=d3.select("#preview-"+e);c.selectAll("*").remove();c.append("svg:image").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").attr("xlink:href",static_url+"images/preview/preview_"+e+".png");a.attachMeshu(d,$(c[0]),sb.transforms.getTransform(e,"product"))};a.attachMeshu=function(f,e,c){var d=$(f).clone().attr("class","product-delaunay").attr("transform",c);e.append(d)};a.thumbnail=function(f,e,c){var d=$(f).clone().attr("class","product-delaunay").attr("transform",c);d3.select(e[0]).append("svg:rect").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%");e.append(d)};a.rotation=function(c){d3.selectAll(".product-delaunay").attr("transform",function(g,f){var e=sb.transforms.getTransform(b[f],"product");return e+" rotate("+c+", 300, 300)"})};return a}()});var sb=sb||{};$(function(){sb.rotator=function(e,d,b){var c=d3.dispatch("rotated");var f=0,g="scale(.125) translate(380, 670) ";c.update=function(u){$(e).empty();var m=d3.select(e);var l=m.append("svg:image").attr("id","previewImage").attr("x",0).attr("y",0).attr("width",200).attr("height",190).attr("xlink:href",c.getImage(u));var h=m.append("svg:g").attr("id","transform").attr("transform",c.getTransform(u));var k=$(d).clone().attr("id","mini-delaunay");var i=$(b).clone().attr("id","rotate-ui");$(h[0]).append(k).append(i);if(u=="pendant"){m.select("#rotate-ui").attr("class","hidden pendant").selectAll("circle").attr("r","55")}d3.selectAll("circle.rotation").on("mousedown",q);m.on("mouseup",n).on("mousemove",s);var p,o,x,w,j,r,t,v;var r=0;function q(){var y=d3.svg.mouse(m.node());p=y[0]-100,o=y[1]-100;t=true}function s(){if(!t){return}var y=d3.svg.mouse(m.node());x=y[0]-100,w=y[1]-100;v=a(p,o,x,w);var A=Math.sqrt(Math.pow(p,2)+Math.pow(o,2));var z=Math.sqrt(Math.pow(x,2)+Math.pow(w,2));j=Math.acos((p*x+o*w)/(A*z))*180/Math.PI;f=v?(f-j)%360:(f+j)%360;if(isNaN(f)){f=0}p=x,o=w;c.rotated(f);h.attr("transform",c.getTransform(u))}function n(){t=false;if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}}};c.getTransform=function(h){return sb.transforms.getTransform(h,"preview")+" rotate("+f+",300,300)"};c.getImage=function(h){return static_url+"images/preview/preview_"+h+".png"};c.rotation=function(h){if(!arguments.length){return f}f=h;return c};function a(i,k,h,j){if(h>i){if(k>0&&j>0){return true}else{return false}}else{if(h<i){if(k<0&&j<0){return true}else{return false}}else{if(j<k){if(i>0){return true}else{return false}}else{if(i<0){return true}else{return false}}}}}return c}("#rotate",".delaunay",".hidden")});var sb=sb||{};sb.materializer=function(){var b=d3.dispatch("update"),c,f,g,e,d,a;b.initialize=function(j,i,h){c=j;f=i;g=h;b.materials=$("#material-list li");b.colors=$("#color-list li");b.materials.click(function(k){b.material(k.target.id)});b.colors.click(function(k){b.color(k.target.innerHTML)});$(".option-list li").live("click",function(){var k=$(this);k.parent().find("li").removeClass("selected");k.addClass("selected")})};b.product=function(l){if(!arguments.length){return e}e=l;var h=c[l];b.materials.hide();d=null;for(var j in h){if(!d){b.material(j)}$("#"+j).show()}var k=f[e];var m=k.charAt(0).toUpperCase()+k.slice(1);$("#readymade-type").text(m);return b};b.material=function(h){if(!arguments.length){return d}d=h;b.materials.removeClass("selected");$("#"+d).addClass("selected");var i=c[e][d].colors;if(i){b.colors.find(".color-title").empty();b.colors.find("img").attr("src","");$(".options.right").fadeIn();$.each(i,function(l,m){var k=b.colors.eq(l);var j=static_url+"images/materials/"+d+"_"+m.replace(" ","_").toLowerCase()+".png";k.find(".color-title").text(m);k.find(".color-img img").attr("src",j);k.attr("id","color-"+m.replace(" ","-").toLowerCase())});b.color(i[0])}else{$(".options.right").fadeOut();b.color("")}orderer.updateProduct(e,d);$("#total-cost").text(orderer.getPriceString());return b};b.color=function(h){if(!arguments.length){return a}a=h;b.colors.removeClass("selected");$("#color-"+a.replace(" ","-").toLowerCase()).addClass("selected");b.update();return b};b.productName=function(){return g[e]};b.displayName=function(){return f[e].toLowerCase()};return b}();var saver=function(){var b={};function e(){return{xhr:"true",title:b.meshu.outputTitle(),svg:b.meshu.outputSVG(),location_data:b.meshu.outputLocationData()}}function d(f){if(!f){return}b.meshu.id=f;if($("#meshu-id").length==0){$("#hidden-form-values").append('<input type="hidden" id="meshu-id" name="meshu_id" />')}$("#meshu-id").val(f)}function a(){var f=e();f.csrfmiddlewaretoken=$("#csrf input").val();if($("#meshu-id").length){f.id=b.getMeshuID()}$.post("/make/assign/",f,function(g){d(g.meshu_id);if(b.postAssignCallback){b.postAssignCallback(g)}},"json")}function c(){var f=e();f.csrfmiddlewaretoken=$("#csrf input").val();if($("#meshu-id").length){f.id=b.getMeshuID()}$.post("/make/create/",f,function(g){d(g.meshu_id);if(b.postCreateCallback){b.postCreateCallback(g)}},"json")}b.initialize=function(f){b.meshu=f;$("#cancel-button").click(function(){window.location.href=loadedMeshu.view_url});$("#save-button").click(function(){if(!loadedMeshu){return}$("#save-button").html("saving");var g=loadedMeshu.edit_url+"save";$.get(g,e(),function(h){d(h.meshu_id);setTimeout(function(){$("#save-button").html("saved!")},200);setTimeout(function(){window.location.href=h.meshu_url},1000)},"json")});$("#update-button").click(function(){if(!loadedMeshu){return}$("#update-button").html("updating");var g=loadedMeshu.edit_url+"update";$.get(g,e(),function(h){d(h.meshu_id);setTimeout(function(){$("#update-button").html("saved!")},200);setTimeout(function(){window.location.href=h.meshu_url},1000)},"json")});return b};b.initializeNewMeshu=function(f){b.meshu=f;return b};b.createOrUpdateMeshu=function(f){console.log("createOrUpdateMeshu",b.meshu.username,b.meshu);if(b.meshu.isReadymade&&f){f()}else{if(b.meshu.username&&b.meshu.username=="guest"){a();if(f){b.postAssignCallback=f}}else{c();if(f){b.postCreateCallback=f}}}return b};b.updateMeshuData=function(f){d(f.id);b.meshu.view_url=f.view_url;b.meshu.username=f.username;if(f.image_url){b.meshu.image_url=f.image_url}};b.getMeshuID=function(){return $("#meshu-id").val()};return b}();var sb=sb||{};sb.facebook={};$(".facebook-auth").click(function(){var a="/facebook/login";window.location=a});sb.facebook.initialize=function(h){$("#finish-button").click(function(){window.location="/make/#skipintro"});var c="Alabama,AL,Alaska,AK,Arizona,AZ,Arkansas,AR,California,CA,Colorado,CO,Connecticut,CT,Delaware,DE,Florida,FL,Georgia,GA,Hawaii,HI,Idaho,ID,Illinois,IL,Indiana,IN,Iowa,IA,Kansas,KS,Kentucky,KY,Louisiana,LA,Maine,ME,Maryland,MD,Massachusetts,MA,Michigan,MI,Minnesota,MN,Mississippi,MS,Missouri,MO,Montana,MT,Nebraska,NE,Nevada,NV,New Hampshire,NH,New Jersey,NJ,New Mexico,NM,New York,NY,North Carolina,NC,North Dakota,ND,Ohio,OH,Oklahoma,OK,Oregon,OR,Pennsylvania,PA,Rhode Island,RI,South Carolina,SC,South Dakota,SD,Tennessee,TN,Texas,TX,Utah,UT,Vermont,VT,Virginia,VA,Washington,WA,West Virginia,WV,Wisconsin,WI,Wyoming,WY";var u=c.split(",");var o={};for(var q=1;q<u.length;q+=2){o[u[q]]=u[q-1]}var d=function(i,v){return function(){$("#svg-file").val(i.outputSVG());$("#meshu-data").val(i.outputLocationData());$("#meshu-title").val(v);$("#meshu-select-form").submit()}};var s=[];var l={all:{name:"All Cities",locations:[]}};var j=[];var r=[];var m=[];var t=0;var g=function(v,w){if(w.locations.length<3){return}t+=300;setTimeout(function(){return function(){var y=$("<div>").addClass("mini-meshu");var x=$("<div>").addClass("title").html(w.name);y.append(x).fadeIn();$("#maps").append(y);var i=sb.minimeshu(y[0]);setTimeout(function(){i.locations(w.locations)},100);y.click(d(i,w.name))}}(),t)};var e=function(i,v){if(!l[v]){l[v]={name:v,locations:[],seen:{}};i.push(l[v])}};var b=function(v,w,i,x){if(!l[w].seen[x]){l[w].locations.push(i);l[w].seen[x]=i}else{l[w].seen[x].times++}};var f=function(){var i=function(w,v){return v.locations.length-w.locations.length};j.sort(i);r.sort(i);m.sort(i);if(m.length>1){m.unshift(l.all);$.each(m,g)}else{g(0,l.all)}if(r.length>1){$.each(r,g)}if(j.length){$.each(j,g)}else{$(".page-header").html("Oh no! Not enough checkins to make any meshus.");$("#finish-button").html("Make one manually")}};var p=0;var n=function(i){var v=i.data;if(!v||!v.length){f();return}p+=i.data.length;$.each(v,function(y,A){if(!A.place||!A.place.location||!A.place.location.city){return}var C=A.place.location.city;var B=A.place.location.country;var w={latitude:A.place.location.latitude,longitude:A.place.location.longitude,name:A.place.name,times:1};var x={name:C,latitude:w.latitude,longitude:w.longitude};if(!l[C]){l.all.locations.push(x)}e(j,C);e(m,B);b(j,C,w,w.name);b(m,B,x,C);var z=A.place.location.state;if(z&&B=="United States"){if(o[z.toUpperCase()]){z=o[z.toUpperCase()]}e(r,z);b(r,z,x,x.name)}});$.ajax({url:i.paging.next,dataType:"jsonp",success:function(w){if(w.data&&w.data.length){$(".page-header").html("Loaded "+p+" places...");n(w)}else{$(".page-header").html("Each meshu is a different set of places. Choose one to get started!");f()}},error:function(w){console.warn(w)}})};var k=false;function a(){h.api("/me/locations?limit=50",function(i){if(i.error){if(k){$(".page-header").html("We're not sure what happened! Try connecting to Facebook again?")}else{$(".page-header").html("Oops, there was an error connecting to Facebook. Retrying...");setTimeout(a,500);k=true}}else{n(i)}})}a()};$(".foursquare-auth").click(function(){var a="AJXTWLOH1K5RIWG33XSGQZHRISL5CCJ0XG1VUL3NAKDYYPMM";var d="http://meshu.io/make/foursquare/";var c="https://foursquare.com/oauth2/authenticate?client_id={client}&response_type=token&redirect_uri={redirect}";var b=c.replace("{client}",a).replace("{redirect}",d);window.location=b});var sb=sb||{};sb.foursquare={};sb.foursquare.initialize=function(){var a=window.location.hash,h=a.split("=").pop(),m="https://api.foursquare.com/v2/users/self/checkins?oauth_token={token}&v={v}&limit=250&offset={offset}",s=m.replace("{token}",h).replace("{v}","20120102");window.location.hash="#connected";$("#finish-button").click(function(){window.location="/make/#skipintro"});if(!h||!h.length){return}var c="Alabama,AL,Alaska,AK,Arizona,AZ,Arkansas,AR,California,CA,Colorado,CO,Connecticut,CT,Delaware,DE,Florida,FL,Georgia,GA,Hawaii,HI,Idaho,ID,Illinois,IL,Indiana,IN,Iowa,IA,Kansas,KS,Kentucky,KY,Louisiana,LA,Maine,ME,Maryland,MD,Massachusetts,MA,Michigan,MI,Minnesota,MN,Mississippi,MS,Missouri,MO,Montana,MT,Nebraska,NE,Nevada,NV,New Hampshire,NH,New Jersey,NJ,New Mexico,NM,New York,NY,North Carolina,NC,North Dakota,ND,Ohio,OH,Oklahoma,OK,Oregon,OR,Pennsylvania,PA,Rhode Island,RI,South Carolina,SC,South Dakota,SD,Tennessee,TN,Texas,TX,Utah,UT,Vermont,VT,Virginia,VA,Washington,WA,West Virginia,WV,Wisconsin,WI,Wyoming,WY";var v=c.split(",");var o={};for(var q=1;q<v.length;q+=2){o[v[q]]=v[q-1]}var d=function(i,w){return function(){$("#svg-file").val(i.outputSVG());$("#meshu-data").val(i.outputLocationData());$("#meshu-title").val(w);$("#meshu-select-form").submit()}};var t=[];var l={all:{name:"All Cities",locations:[]}};var k=[];var r=[];var n=[];var u=0;var j=function(w,x){if(x.locations.length<3){return}u+=300;setTimeout(function(){return function(){var z=$("<div>").addClass("mini-meshu");var y=$("<div>").addClass("title").html(x.name);z.append(y).fadeIn();$("#maps").append(z);var i=sb.minimeshu(z[0]);setTimeout(function(){i.locations(x.locations)},100);z.click(d(i,x.name))}}(),u)};var e=function(i,w){if(!l[w]){l[w]={name:w,locations:[],seen:{}};i.push(l[w])}};var b=function(w,x,i,y){if(!l[x].seen[y]){l[x].locations.push(i);l[x].seen[y]=i}else{l[x].seen[y].times++}};var g=function(){var i=function(x,w){return w.locations.length-x.locations.length};k.sort(i);r.sort(i);n.sort(i);if(n.length>1){n.unshift(l.all);$.each(n,j)}else{j(0,l.all)}if(r.length>1){$.each(r,j)}if(k.length){$.each(k,j)}else{$(".page-header").html("Oh no! Not enough checkins to make any meshus.");$("#finish-button").html("Make one manually")}};var p=0;var f=function(i){$.ajax({url:i,dataType:"jsonp",success:function(y){if(!y.response.checkins){g();return}var w=y.response.checkins.items;if(!w||!w.length){g();return}p+=y.response.checkins.items.length;$.each(w,function(B,D){if(!D.venue||!D.venue.location||!D.venue.location.city){return}var F=D.venue.location.city;var E=D.venue.location.country;var z={latitude:D.venue.location.lat,longitude:D.venue.location.lng,name:D.venue.name,times:1};var A={name:F,latitude:z.latitude,longitude:z.longitude};if(!l[F]){l.all.locations.push(A)}e(k,F);e(n,E);b(k,F,z,z.name);b(n,E,A,F);var C=D.venue.location.state;if(C&&E=="United States"){if(o[C.toUpperCase()]){C=o[C.toUpperCase()]}e(r,C);b(r,C,A,A.name)}});var x=y.response.checkins.count;if(p<x){$(".page-header").html("Loaded "+p+" of "+x+" checkins...");f(s.replace("{offset}",p))}else{$(".page-header").html("Each meshu is a different set of places. Choose one to get started!");g()}}})};f(s.replace("{offset}",p))};$(function(){var p={earrings:{wood:{price:75,colors:["Amber"]},acrylic:{price:80,colors:["Black","White"]},nylon:{price:90,colors:["Black","White"]},silver:{price:150,colors:["Sterling Silver"]}},pendant:{wood:{price:75,colors:["Amber"]},acrylic:{price:85,colors:["Black","White"]},nylon:{price:90,colors:["Black","White"]},silver:{price:130,colors:["Sterling Silver"]}},necklace:{wood:{price:80,colors:["Amber"]},acrylic:{price:90,colors:["Black","White"]},nylon:{price:95,colors:["Black","White"]},silver:{price:150,colors:["Sterling Silver"]}},cufflinks:{stainless:{price:85},silver:{price:160}}};var e={earrings:"pair of earrings",pendant:"small pendant necklace",necklace:"large necklace",cufflinks:"pair of cufflinks"};var m={earrings:"earrings",pendant:"pendant necklace",necklace:"large necklace",cufflinks:"cufflinks"};var l=["edit","product","make","account","checkout","review"];var h=$("#content");orderer.options(p);sb.materializer.initialize(p,e,m);var k=sb.meshu($("#meshu-container")[0]);k.isReadymade=loadedMeshu&&loadedMeshu.product!="";if(loadedMeshu){saver.initialize(k);saver.updateMeshuData(loadedMeshu);if($("html").hasClass("svg")){if(k.isReadymade){readymade.initialize(k)}if(pageType=="view"){k.map().buffer(0)}k.locationData(loadedMeshu.location_data)}user.updateLogoutActions(pageType);sb.product.initialize(".delaunay");switch(pageType){case"edit":l=["edit","product","make","account","checkout","review"];break;case"view":l=["view"];break;case"product":var j=$("#product");j.find(".nav").remove();j.find(".make-wrapper").removeClass("make-wrapper");l=["product","make","account","checkout","review"];break;default:l=["readymade","account","checkout","review"];$("#materials").addClass("ready");var j=loadedMeshu.product.length?loadedMeshu.product:"necklace";sb.materializer.product(j);break}$("#finish-button").addClass("active");$("#meshu-container").removeClass("inactive");var o=loadedMeshu.location_data.split("|");$.each(o,function(r,t){var s=t.split("\t");if(s.length==3){var u=document.createElement("div");u.innerHTML=s[2];var q=u.firstChild.nodeValue;$("<li>").html(q).appendTo($("#display-places"))}});d3.select("#place-number").attr("class","").select(".title-text").html(function(q){q.title=loadedMeshu.title;k.updateTitle(q.title);return q.title})}else{saver.initializeNewMeshu(k)}if(user.loggedIn){n()}if(!user.loggedIn&&!loadedMeshu&&window.location.hash!="#skipintro"){$("#edit-help").fadeIn();$("#modal-bg").fadeIn();$("#close-help").click(function(){$("#edit-help").fadeOut();$("#modal-bg").fadeOut()})}else{if(window.location.hash=="#skipintro"){window.location.hash=""}}$(".next").live("click",function(){if(!$(this).hasClass("active")){return}var t=$(this);var q=h.attr("class");var r=l.indexOf(q);var s=function(){h.attr("class",l[r+1])};if(q=="edit"&&user.loggedIn){saver.createOrUpdateMeshu()}if(q=="make"||q=="readymade"){n()}if(q=="account"&&!user.loggedIn){user.afterLogIn=function(){saver.createOrUpdateMeshu(function(){t.click()})};return}d(q);user.updateLogoutActions(q);s()});$(".back").click(function(){var q=h.attr("class");if(q=="checkout"){n()}var r=l.indexOf(q);var s=l[r-1];h.attr("class",s);a(s)});$("#save-and-view").click(function(){var q=function(){saver.createOrUpdateMeshu(function(r){window.location.href=r.meshu_url})};if(!user.loggedIn){f();user.afterLogIn=q}else{q()}});$("#product-preview svg").live("click",function(){var q=$(this).attr("id").split("-")[1];$(".make-option").hide();$("#make-"+q).show();sb.rotator.update(q);sb.materializer.product(q);sb.rotator.on("rotated",sb.product.rotation)});function d(q){switch(q){case"edit":k.updateBounds();k.mesh().updateCircleBehavior();sb.product.initialize(".delaunay");sb.rasterizer.rasterize(k);break;case"make":case"readymade":k.mesh().updateCircleBehavior(true);var s=sb.materializer.product();var r=sb.transforms[s]["render"];k.animateTransform(sb.rotator?sb.rotator.rotation():0,r.scale,r.transform.x,r.transform.y);var u=static_url+"images/render/"+s+"_preview.jpg";$(".render").css("background-image","url("+u+")");break;case"review":i();break}}function a(q){switch(q){case"edit":k.mesh().updateCircleBehavior();break;case"make":case"readymade":k.mesh().updateCircleBehavior();k.animateTransform(0,1,0,0);break}}function n(){var q=l.indexOf("account");if(user.loggedIn){if(q>=0){l.splice(q,1)}$("#account").css("visibility","hidden")}else{if(q==-1){l.splice(-2,0,"account")}$("#account").css("visibility","visible");$("#account li").click(function(){var s=$(this).attr("id").split("-")[1];console.log("click",s);var r=$("#account");r.attr("class",s);r.find("li").removeClass("active");$(this).addClass("active");self.mode=s})}}$(".show-places").click(function(){$("#display-places").slideToggle();$(".show-places").toggle()});$(".share-facebook").click(function(){if(!sb.rasterizer.generated){sb.rasterizer.rasterize(k,b)}else{b()}});sb.rasterizer.on("rasterized",function(q){console.log("rasterizing",q);saver.updateMeshuData(q);$(".share-buttons").show()});var b=function(){FB.ui({method:"feed",link:"http://meshu.io"+k.view_url,picture:"http://dev.meshu.io:8000"+k.image_url,name:k.outputTitle(),caption:"Come see the jewelry I'm making out of places I've been",description:""},function(q){if(!q||q.error){console.log(q)}else{console.log("Post ID: "+q.id)}})};$("#shipping-destination li").click(function(){var r=$(this).attr("id").split("-").pop();var q=$("#shipping-destination");$("#checkout").attr("class",r);q.find("li").removeClass("active");$(this).addClass("active");orderer.shippingMode(r)});$("#payment-form").validate({rules:{card_number:{creditcard:true},card_cvc:{digits:true,minlength:3},card_month:{digits:true,minlength:2},card_year:{digits:true,minlength:4,}},messages:{shipping_state:"Please enter the two-letter state abbreviation.",card_cvc:"Sorry, that is not a valid CVC code",card_month:{minlength:"Please enter the month as a two-digit number."},card_year:{minlength:"Please enter the year as a four-digit number.",},},submitHandler:g});$("#postcard-note-form").keyup(function(r){var q=r.target.value;$("#postcard-note").val(q)});$("#coupon-code").submit(function(){var q=$("#coupon-code-value").val();orderer.applyCoupon(q,function(t){if(t.success){var u=parseFloat(t.amount);if(u<1&&u>0){var r=Math.floor(orderer.getPrice()*(1-u));var s=parseInt((1-u)*100);$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>"+s+"% off! -$"+r+".00</span>").insertAfter("#subtotal-price")}else{if(u>1){$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>-$"+u+".00</span>").insertAfter("#subtotal-price")}}$("#coupon-message").fadeIn("fast").html(q+" discount applied!");$(".coupon-form").hide()}else{$("#coupon-message").fadeIn("fast").html("Invalid code.")}i()});return false});$("#review-button").click(function(){if(!user.loggedIn){f()}});$("#submit-button").click(function(q){if(!user.loggedIn){f();return false}orderer.submit()});function g(){if(!user.loggedIn){f(g);return}h.attr("class","review");d("review")}function f(q){user.showModal();user.afterLogIn=function(){if(q){saver.createOrUpdateMeshu(function(){setTimeout(q,200)})}}}function i(){orderer.updateProduct(sb.materializer.product(),sb.materializer.material(),orderer.getShipping());$("#object-type").val(sb.materializer.productName());$("#object-material").val(sb.materializer.material());$("#object-color").val(sb.materializer.color().toLowerCase());$("#object-amount").val(orderer.getTotalCents());$("#svg-theta").val(sb.rotator?sb.rotator.rotation():0);$("#svg-file").val(k.outputSVG());$("#meshu-data").val(k.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:k.outputTitle());$("#postcard-note").val($("#postcard-note-form").val());c();$("#review-shipping").empty();$(".ship-row input").each(function(){var s;var r=function(t){return t.replace(/\w\S*/g,function(u){return u.charAt(0).toUpperCase()+u.substr(1).toLowerCase()})};this.value=r(this.value);switch(this.id){case"ship-city":case"ship-zip":s=$("<span>");break;case"ship-state":this.value=this.value.toUpperCase();s=$("<span>");break;default:s=$("<p>");break}s.text($(this).val()).appendTo("#review-shipping")});var q=$("#card-number").val();$("#review-payment").text("XXXX-XXXX-XXXX-"+q.substring(12,16))}function c(){var q="One "+sb.materializer.displayName();var r=sb.materializer.color().toLowerCase()+" "+sb.materializer.material();$("#review-description").text(q+", made out of "+r);$("#subtotal-price span").text(orderer.getPriceString());$("#shipping-price span").text("$"+orderer.getShipping()+".00");$("#total-price span").text(orderer.getTotalString())}});