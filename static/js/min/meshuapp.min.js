var sb=sb||{};sb.catalog=function(f,d){var a={},e={},f=f||"facet";e.facet={earrings:{bamboo:{price:70,colors:["amber"]},acrylic:{price:75,colors:["black","white"]},nylon:{price:85,colors:["black","white"]}},pendant:{bamboo:{price:75,colors:["amber"]},acrylic:{price:80,colors:["black","white"]},nylon:{price:85,colors:["black","white"]},silver:{price:145,colors:["sterling"]}},necklace:{bamboo:{price:80,colors:["amber"]},acrylic:{price:85,colors:["black","white"]},nylon:{price:90,colors:["black","white"]},silver:{price:165,colors:["sterling"]}},cufflinks:{silver:{price:165,colors:["sterling"]}}};e.radial={earrings:{bamboo:{price:75,colors:["amber"]},acrylic:{price:80,colors:["black","white"]},nylon:{price:90,colors:["black","white"]}},pendant:{bamboo:{price:80,colors:["amber"]},acrylic:{price:85,colors:["black","white"]},nylon:{price:95,colors:["black","white"]},silver:{price:160,colors:["sterling"]}},coasters:{bamboo:{price:40,colors:["amber"]},acrylic:{price:45,colors:["black","white"]}}};var c=e[f];var b={};b.marathon={earrings:{bamboo:{price:64,colors:["Amber"],discount:0.85,originalPrice:75}},pendant:{bamboo:{price:64,colors:["Amber"],discount:0.85,originalPrice:75}},necklace:{bamboo:{price:68,colors:["Amber"],discount:0.85,originalPrice:80}}};if(d&&b[d]){c=b[d]}a.check=function(h,g){return c[h]&&c[h][g]};a.get=function(i,h,g){if(!c[i]||!c[i][h]){return"N/A"}return c[i][h][g]};a.getPrice=function(h,g){return a.get(h,g,"price")};a.getColors=function(h,g){return a.get(h,g,"colors")};if(d){a.getProducts=function(){var m=[];for(var k in c){var i=[],h=[],g=[],l=c[k];for(var j in l){i.push(l[j].price);if(l[j].originalPrice){h.push(l[j].originalPrice)}if(l[j].discount){g.push(l[j].discount)}}m.push({type:k,prices:i,originals:h,discount:g.length?g[0]:undefined})}return m}}else{a.getProducts=function(){var k=[];for(var i in c){var g=[],j=c[i];for(var h in j){g.push(j[h].price)}k.push({type:i,prices:g,discount:j.discount})}return k}}a.getMaterials=function(j){var g={};for(var h in c[j]){$.each(c[j][h].colors,function(k,i){g[i+"-"+h]=c[j][h].price})}return g};return a};Stripe.setPublishableKey("pk_GtEuTncR1hDqm7tP3oz9RRM9XOLub");var cashier=function(){var k={},i=0,e=0,d=1,h=null,g=null,b=5,c=5,j=38,f=null;function a(l,m){var o=$("#payment-form");var n=m.id;o.append("<input type='hidden' name='stripeToken' value='"+n+"' />");o.get(0).submit()}k.submit=function(){if(i<2000){return}$("#submit-button").attr("disabled","disabled").addClass("inactive");$(".card-info").removeAttr("name");Stripe.createToken({number:$("#card-number").val(),cvc:$("#card-cvc").val(),exp_month:$("#card-expiry-month").val(),exp_year:$("#card-expiry-year").val()},i,a);return false};k.shippingMode=function(m){var l=m=="international"?j:c;k.updateProduct(h,g,l);$("#shipping-price span").text(getPriceString(l))};k.applyCoupon=function(l,m){$.get("/order/apply_coupon",{code:l},function(n){if(n.success){var o=parseFloat(n.amount);if(o<1&&o>0){d=o}else{if(o>0){e=parseInt(n.amount)}}}if(m){m(n)}},"json")};k.catalog=function(l){if(f){return}f=l;return k};k.updateProduct=function(n,l,o){if(!f.check(n,l)){return}b=o||5;h=n;g=l;i=k.getTotal()*100;return k};k.getPrice=function(){return f.getPrice(h,g)};k.getPriceString=function(){if(!f){return null}return"$"+k.getPrice()+".00"};k.getShipping=function(){return b};k.getTotal=function(){if(!f){return null}return Math.floor(d*(k.getPrice()-e))+b};k.getTotalCents=function(){if(!f){return null}return k.getTotal()*100};k.getTotalString=function(){if(!f){return null}return"$"+k.getTotal()+".00"};k.getColors=function(m,l){if(!f){return null}return f.getColors(m,l)};return k}();var sb=sb||{};sb.map=function(e,d,l){var f=org.polymaps;var m=d3.dispatch("boundsUpdated"),h=0.5;var b="/proxy/tiles/{S}/{Z}/{X}/{Y}";var a=d3.select(e).append("div")[0][0];a.style.position="absolute";a.style.width=d;a.style.height=l;d3.select(e).append("div").attr("class","render");var g=f.image().url(f.url(b).hosts(["a","b","c","d"]));m.dispatch=d3.dispatch("show");var j=[{name:"San Francisco",lat:37.775,lon:-122.43,zoom:13},{name:"New York City",lat:40.718,lon:-73.997,zoom:14},{name:"London",lat:51.506325,lon:-0.127144,zoom:13},{name:"Paris",lat:48.85693,lon:2.3412,zoom:14},{name:"Moscow",lat:55.75,lon:37.614975,zoom:14},{name:"Montreal",lat:45.512303,lon:-73.554431,zoom:13},{name:"Tokyo",lat:35.7,lon:139.774414,zoom:14}];var k=a.appendChild(f.svg("svg"));var i=Math.floor(Math.random()*j.length);m.map=f.map().container(k).zoom(j[i].zoom).center({lat:j[i].lat,lon:j[i].lon});m.map.size({x:$(e).width(),y:$(e).height()});m.map.add(g);d3.select(k).attr("width","100%").attr("height","100%").select("rect").attr("visibility","visible").attr("fill","white");m.frame=function(){return a};m.show=function(){if(!g.map()){m.map.add(g)}};m.hide=function(){if(g.map()){m.map.remove(g)}};m.buffer=function(c){h=c;return m};m.updateBounds=function(q,o,p){if(q.length==0||o.length==0){return}if(q.length==1&&o.length==1){m.map.center({lat:q[0],lon:o[0]});m.boundsUpdated();return}var c=[{lat:d3.min(q),lon:d3.min(o)},{lat:d3.max(q),lon:d3.max(o)}];m.map.extent(c);p=p||0;var n=Math.floor(m.map.zoom())+p;if(n!=m.map.zoom()){m.map.zoom(n)}m.boundsUpdated()};m.resizeContainer=function(n,q){var v=[{lat:d3.min(n),lon:d3.min(q)},{lat:d3.max(n),lon:d3.max(q)}];m.map.zoom(10).center({lat:0,lon:0});var o=m.map.locationPoint(v[0]);var r=m.map.locationPoint(v[1]);var c=Math.abs(r.x-o.x);var u=Math.abs(r.y-o.y);var s=430;var p=c>u?s/c:s/u;c*=p;u*=p;a.style.width=(c)+"px";a.style.height=(u)+"px";m.map.extent(v);var t=m.l2p(v[0]).y-m.l2p(m.map.extent()[0]).y;if(t){a.style.top=(150-t)+"px"}};m.getBounds=function(){var n=m.map.extent();var c=m.map.locationPoint(n[0]);var o=m.map.locationPoint(n[1]);return{t:o.y,b:c.y,l:c.x,r:o.x}};m.getMapRadius=function(){var c=m.map.extent();return{lat:Math.abs(c[0].lat-c[1].lat)/3,lon:Math.abs(c[0].lon-c[1].lon)/3}};m.l2p=function(c){return m.map.locationPoint(c)};m.p2l=function(c){return m.map.pointLocation(c)};return m};var sb=sb||{};sb.mesh={};sb.mesh.base=function(e,x,k,h){var g=d3.dispatch("added","refreshed","locationsSet","removed","draggedMap","draggedPoint","clickedMap","clickedPoint","styled","interactiveToggled"),m=parseInt(Math.random()*10000000000,10);g.dirty=true;var s=[],d=[],f=[],t={};var r=[],q=[],l=[],y=0,j=null,c=false,w=null,i=null,u=null,a=null;var p=$("#content"),b=$("#cases");d3.select(".frame").on("mousemove",v).on("mousedown",n);d3.select("body").on("mouseup",o);function n(){if(!p.hasClass("edit")){return}w=true}function v(){if(!p.hasClass("edit")){return}if(!g.dragging&&!w){return}var z=d3.svg.mouse(e);if(g.dragging){var A=x.p2l({x:z[0],y:z[1]});g.draggedPoint(g.dragging,A)}if(c&&w){i=true;if(u){x.map.panBy({x:z[0]-u[0],y:z[1]-u[1]})}g.dirty=true;g.draggedMap()}c=true;u=z}function o(){w=null;u=null;if(!p.hasClass("edit")){return}if(d3.event.target.tagName!="circle"&&g.hittest(d3.event.target)&&d3.event.target.tagName!="image"){return}if(!g.dragging&&!i){var z=d3.svg.mouse(e);var A=x.p2l({x:z[0],y:z[1]});g.clickedMap(A);i=null;return}if(!c&&g.dragging){g.clickedPoint(g.dragging)}else{v()}if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}c=false;g.dragging=null;i=null}g.editText=function(C,A,B){var z=C.find("."+B+"-edit").text("save");var E=C.find("."+B+"-text");var D=((B=="title")?E.text():f[A]);C.addClass("active");E.html('<input value="'+D+'">').find("input").focus()};g.saveText=function(C,A,B){var z=C.find("."+B+"-edit").text("edit");var D=C.find("input").val();C.removeClass("active");C.find("."+B+"-text").text(D);if(B=="place"){f[A]=D}else{return D}};g.removeInput=function(z){var A=list.selectAll("li.place .title");A.each(function(C,B){if(!C.edit){return}C.edit=false;g.saveText($(this),B,"place")});return false};g.add=function(E,A,C,z){var B=parseFloat(E);var D=parseFloat(A);s.push(B);d.push(D);if(C==undefined){f.push(E.toFixed(3)+", "+A.toFixed(3))}else{f.push(C)}r.push([D,B]);update();g.added();return g};g.remove=function(z){r.splice(z,1);s.splice(z,1);d.splice(z,1);f.splice(z,1);g.removed()};g.interactive=function(z){g.interactiveToggled(z)};g.lats=function(){return s};g.lons=function(){return d};g.places=function(){return f};g.points=function(z){if(!arguments.length){return r}r=z;return g};g.locations=function(z){q=null;r=[];s=[];d=[];f=[];$.each(z,function(A,B){r.push([B.longitude,B.latitude]);s.push(B.latitude);d.push(B.longitude);f.push(B.name)});g.locationsSet();return g};g.refresh=function(){update();g.refreshed()};g.prerender=function(){};g.applyStyle=function(z){var C=z.split("|");var B={};for(var A=0;A<C.length;A++){var D=C[A].split(":");B[D[0]]=D[1]}g.style(B)};g.style=function(A){if(!arguments.length){return t}for(var z in A){t[z]=A[z]}g.styled(t)};g.outputStyle=function(){var A=[];for(var z in t){A.push(z+":"+t[z])}return A.join("|")};g.updateTitle=function(z){a=z};g.outputTitle=function(){return a||"My Meshu"};g.output=function(){return $("#"+m).html()};g.outputMesh=function(){return".delaunay"};return g};var sb=sb||{};sb.mesh.facet=function(i,A,p,m){var l=sb.mesh.base(i,A,p,m),r=parseInt(Math.random()*10000000000,10);l.name="facet";var w=[],h=[],j=[];var e=document.createElement("div");var d=d3.select(i||"body").append("div").attr("id",r).style("width",p).style("height",m).style("position","absolute").style("z-index","1").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var x=d.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var v=d.append("svg:g").attr("class","hidden");v.append("svg:path");var b=d3.select(i||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",p).style("height",m);var o=b.append("svg:svg").attr("width","100%").attr("height","100%");var n=o.append("svg:g").attr("id","delaunay-ui");var k=d3.select("#places");var z=k.select("#place-title").attr("class","inactive");z.append("span").attr("class","title-text");z.append("span").attr("class","title-edit").html("edit");var y=k.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",l.removeInput)}var u=[],t=[],q=[],C=0,a=null;var s=$("#content");l.hittest=function(g){return d3.event.target!=o.node()};l.on("draggedMap",function(){f()});l.on("draggedPoint",function(D,E){D[0]=E.lon;D[1]=E.lat;var g=u.indexOf(D);w[g]=E.lat;h[g]=E.lon;l.dirty=true;f()});l.on("clickedMap",function(g){l.add(g.lat,g.lon,undefined,false)});l.on("clickedPoint",function(D){var g=u.indexOf(D);l.remove(g);A.updateBounds(w,h);l.updatePixelBounds();l.dirty=false;f()});l.on("removed",function(){if(u.length==1){$("#meshu-container").addClass("inactive")}});l.on("interactiveToggled",function(g){l.updateCircleBehavior(g)});function c(D){var H=n.selectAll("circle");H.attr("cx",function(I){return A.l2p({lat:I[1],lon:I[0]}).x}).attr("cy",function(I){return A.l2p({lat:I[1],lon:I[0]}).y});var g=x.selectAll("path").data(d3.geom.delaunay(u));g.enter().append("svg:path");g.exit().remove();g.attr("d",function(N){var J=N.length;var I=[];for(var K=0;K<J;K++){var M={lat:parseFloat(N[K][1]),lon:parseFloat(N[K][0])};var L=A.l2p(M);I.push([L.x,L.y])}return"M"+I.join("L")+"Z"});if(t&&D==true){clearInterval(C);t=null}else{if(t){var G=u[u.length-1]||[];if(Math.abs(G[0]-t[0])>0.0002){G[0]+=(t[0]-G[0])/3}if(Math.abs(G[1]-t[1])>0.0002){G[1]+=(t[1]-G[1])/3}u[u.length-1]=G;var F=Math.abs(G[0]-t[0]);var E=Math.abs(G[1]-t[1]);if(E<0.0002&&F<0.0002){clearInterval(C);t=null}}else{clearInterval(C)}}}l.updatePixelBounds=function(){if(w.length&&h.length){q=[A.l2p({lat:d3.min(w),lon:d3.min(h)}),A.l2p({lat:d3.max(w),lon:d3.min(h)}),A.l2p({lat:d3.max(w),lon:d3.max(h)}),A.l2p({lat:d3.min(w),lon:d3.max(h)})]}else{q=[]}};function f(){var H=n.selectAll("circle").data(u);H.enter().append("svg:circle").attr("id",function(J,I){return"c-"+I}).attr("r",7).on("mousedown",function(I){l.dragging=I;d3.event.stopPropagation()});H.exit().remove();var F=y.selectAll("li.place").data(u);var D=F.enter().append("li").attr("class","place");var G=D.append("span").attr("class","title");G.append("span").attr("class","place-text").html(function(J,I){e.innerHTML=j[I];return e.firstChild.nodeValue});G.append("span").attr("class","place-edit").html("edit");D.append("span").attr("class","place-delete").html("x");F.exit().remove();F.attr("id",function(J,I){return"p-"+I}).select(".title").each(function(I){I.edit=false}).attr("class","title").select(".place-text").html(function(J,I){e.innerHTML=j[I];return e.firstChild.nodeValue});z.data(u).each(function(I){I.edit=false});var g=v.selectAll("circle.rotation").data(q);g.enter().append("svg:circle").attr("class","rotation").attr("r","40").attr("cx",function(J,I){return J.x}).attr("cy",function(J,I){return J.y});g.exit().remove();g.attr("cx",function(J,I){return J.x}).attr("cy",function(J,I){return J.y});var E=v.select("path");E.attr("d",function(){if(q.length==0){return}var I=[];$.each(q,function(J,K){I.push([K.x,K.y])});return"M"+I.join("L")+"Z"}).attr("class","hiddenFrame");l.updateCircleBehavior();B();c()}l.updateCircleBehavior=function(F){var D=s.hasClass("edit");var g=$("#place-hover");var E=n.selectAll("circle");E.on("mouseover",function(M,I){if(F){return}else{if(D){y.select("#p-"+I).attr("class","place highlight")}else{g.addClass("active").find("span").text(j[I]);var L=A.l2p({lat:M[1],lon:M[0]});var G=g.width();var K=(L.y-32)+"px";var J=(L.x-(G/2)-3)+"px";var H=G/2-3+"px";g.css({top:K,left:J}).find("b").css("left",H)}}});E.on("mouseout",function(H,G){if(F){return}else{if(D){y.select("#p-"+G).attr("class","place")}else{g.removeClass("active")}}})};function B(){var g=y.selectAll("li.place");g.select(".place-delete").on("click",function(E,D){l.remove(D);l.updatePixelBounds();A.updateBounds(w,h);f()});g.on("mouseover",function(E,D){n.select("#c-"+D).attr("class","highlight")});g.on("mouseout",function(E,D){n.select("#c-"+D).attr("class","")});g.select(".place-edit").on("click",function(F,D){var E=$(this).parent();if(!F.edit){l.editText(E,D,"place")}else{l.saveText(E,D,"place")}F.edit=!F.edit});g.select(".place-text").on("click",function(E,D){if(E.edit){return}l.editText($(this).parent(),D,"place");E.edit=!E.edit});z.attr("class","").select(".title-text").text(function(D){if(D&&D.title){return D.title}else{return"My Meshu"}});z.select(".title-text").on("click",function(D){if(D.edit){return}l.editText($(this).parent(),0,"title");D.edit=!D.edit});z.select(".title-edit").on("click",function(E){var D=$(this).parent();if(!E.edit){l.editText(D,0,"title")}else{E.title=a=l.saveText(D,0,"title")}E.edit=!E.edit})}l.add=function(I,E,G,g){if(C){clearInterval(C)}var F=parseFloat(I);var H=parseFloat(E);w.push(F);h.push(H);if(G==undefined){j.push(I.toFixed(3)+", "+E.toFixed(3))}else{j.push(G)}if(u.length){$("#meshu-container").removeClass("inactive");t=[H,F];if(g){u.push([t[0],t[1]]);l.updatePixelBounds();f();c(g)}else{var D=u[u.length-1];u.push([D[0],D[1]]);l.updatePixelBounds();f();C=setInterval(c,40)}}else{u.push([H,F]);f()}l.dirty=true;l.added();return l};l.remove=function(g){u.splice(g,1);w.splice(g,1);h.splice(g,1);j.splice(g,1);if(u.length==1){$("#meshu-container").addClass("inactive")}};l.lats=function(){return w};l.lons=function(){return h};l.places=function(){return j};l.points=function(g){if(!arguments.length){return u}u=g;return l};l.bakeStyles=function(){v.style("display","none")};l.unBakeStyles=function(){v.style("display","")};l.locations=function(g){t=null;u=[];w=[];h=[];j=[];$.each(g,function(D,E){u.push([E.longitude,E.latitude]);w.push(E.latitude);h.push(E.longitude);j.push(E.name)});l.locationsSet();return l};l.refresh=function(){f();l.refreshed()};l.updateTitle=function(g){a=g};l.outputTitle=function(){return a||"My Meshu"};l.output=function(){return $("#"+r).html()};return l};var sb=sb||{};sb.mesh.radial=function(o,E,s,q){var p=sb.mesh.base(o,E,s,q),v="m"+parseInt(Math.random()*10000000000,10);p.name="radial";var z=[],l=[],b;var B=d3.select(o||"body").append("div").attr("id",v).style("width",s).style("height",q).style("position","absolute");var e=d3.select(o||"body").append("div").attr("id",v+"prerendered").style("width",s).style("height",q).style("position","absolute");var i=d3.select("#"+v).append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var h=i.append("svg:g").attr("class","delaunay");h.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var A=h.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");h.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var n=d3.select(o).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var D=d3.select("#place-title").attr("class","inactive");D.append("span").attr("class","title-text");D.append("span").attr("class","title-edit").html("edit");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",p.removeInput)}var y=[],a=[],u=[],t=[],f={},b=null;var x=$("#content");p.hittest=function(g){return d3.event.target!=n.node()};p.on("draggedMap",function(){j()});p.on("clickedMap",function(g){p.add(g.lat,g.lon,undefined,false)});p.on("styled",function(g){if(g.zoom&&g.zoom!=E.map.zoom()){E.map.zoom(g.zoom)}});function m(){var g=h.selectAll("circle");g.attr("cx",function(G){return E.l2p({lat:G[1],lon:G[0]}).x}).attr("cy",function(G){return E.l2p({lat:G[1],lon:G[0]}).y})}function k(){var H=function(N,L){var I=Math.min(16,N.total-4),K=5,M=(1-Math.sqrt(N.d)),J=(I*M)+K;return J+"px"};var G="black";if(p.style()!=undefined&&p.style().drawStyle){G=p.style().drawStyle=="outline"?"black":"white"}var g=A.selectAll("path").data(u);if($("body").hasClass("firefox")){g.enter().append("svg:path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",H)}else{g.enter().append("svg:path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",0).transition().duration(500).style("stroke-width",H)}g.exit().remove();g.attr("d",function(I){return w(I.pts)}).attr("stroke",G)}function w(J){var g=[];var G=J.length;for(var H=0;H<G;H++){var K={lat:J[H][0],lon:J[H][1]};var I=E.l2p(K);g.push([I.x,I.y])}return"M"+g.join("L")}function C(J){a.push(J);var G=J.length;for(var H=0;H<G-2;H+=2){var I=[J[H],J[H+1]];var g=[J[H+2],J[H+3]];u.push({pts:[I,g],total:J.length,d:H/J.length})}k()}function c(J){var g=true,G=0;for(var I=1;I<y.length;I++){if(f[J][I]!="done"){g=false}else{G++}}var H=(G/(y.length-1)*100).toFixed(0)+"%";$("#radial-heading").html("Generating radial... "+H);if(g){$("#radial-heading").html("Your radial is done!");p.added()}}function d(){var K=E.map.zoom(),M=y[0];startCoords=M[1]+","+M[0];f[K]=["done"];var J=$("body").hasClass("ie")||window.location.protocol=="https:"?"https://meshu.io/proxy/router/?from=":"http://open.mapquestapi.com/directions/v1/route?routeType=pedestrian&outFormat=json&shapeFormat=raw&generalize=200&from=";var L=J+"{start}&to={end}";for(var I=1;I<y.length;I++){var G=y[I],g=G[1]+","+G[0],H=L.replace("{start}",startCoords).replace("{end}",g);f[K][I]=$.jsonp({url:H,callbackParameter:"callback",error:function(N){return function(O){f[K][N]="done";c(K)}}(I),success:function(N){return function(P){if(!P.route.shape){f[K][N]="done";return}else{if(f[K]==undefined||f[K][N]==undefined||f[K]=="inactive"){return}}var O=P.route.shape.shapePoints;C(O);f[K][N]="done";c(K)}}(I)})}}function j(){D.data(y).each(function(g){g.edit=false});F();m();k()}function F(){D.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return b}});D.select(".title-text").on("click",function(g){if(g.edit){return}p.editText($(this).parent(),0,"title");g.edit=!g.edit});D.select(".title-edit").on("click",function(G){var g=$(this).parent();if(!G.edit){p.editText(g,0,"title")}else{G.title=b=p.saveText(g,0,"title")}G.edit=!G.edit})}function r(){i.selectAll("path").remove();u=[];y=[y[0]];z=[z[0]];l=[l[0]];var G,H;for(var J=0;J<24;J++){var I=J*(Math.PI/12);var g=E.p2l({x:300+Math.sin(I)*200,y:300+Math.cos(I)*200});H=g.lon;G=g.lat;z.push(G);l.push(H);y.push([H,G])}}p.add=function(L,H,J,g){var I=parseFloat(L);var K=parseFloat(H);B.select("#radialClip circle").data([[K,I]]);B.select(".circleFrame").data([[K,I]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",17);z=[I];l=[K];y=[[K,I]];if(J==undefined){b=L.toFixed(3)+", "+H.toFixed(3)}else{b=J[0].toUpperCase()+J.substr(1,J.length-1)}$("#places").removeClass("inactive");var G=E.getMapRadius();E.map.center({lat:I,lon:K});E.boundsUpdated();p.recalculate();return p};p.remove=function(g){y.splice(g,1);z.splice(g,1);l.splice(g,1)};p.lats=function(){return z};p.lons=function(){return l};p.places=function(){return[b]};p.points=function(g){if(!arguments.length){return y}y=g;return p};p.bakeStyles=function(){var H=$(".circleFrame").css("stroke"),G=$(".circleFrame").css("fill"),g=$(".radial path").css("stroke");$(".circleFrame").attr("stroke",H);$(".circleFrame").attr("fill",G);$(".radial path").attr("stroke",g)};p.unBakeStyles=function(){$(".circleFrame").attr("stroke","").attr("fill","");$(".radial path").css("stroke","")};p.locations=function(g){y=[];z=[];l=[];$.each(g,function(G,H){y.push([H.longitude,H.latitude]);z.push(H.latitude);l.push(H.longitude)});p.dirty=true;p.locationsSet();return p};p.prerender=function(G,M){M=M||1;$("#"+v+"prerendered").html(G);var H=$("#"+v+"prerendered").find(".delaunay");$("#"+v).find(".delaunay").replaceWith(H);var J=$(o).width(),g=$(o).height(),I=600*M,L="translate("+(J-I)/2+","+(g-I)/2+") ",K=" scale("+M+","+M+")";$("#"+v+" .delaunay").attr("transform",L+K)};p.recalculate=function(){$("#"+v+"prerendered").remove();$.each(f,function(g,G){$.each(G,function(H,I){if(I==undefined||I=="done"){return}if(I.abort){I.abort()}});f[g]="inactive"});r();d();p.style({zoom:E.map.zoom()});p.dirty=false};p.refresh=function(g){if(g=="zoomed"&&z.length>0&&l.length>0){p.add(z[0],l[0],b)}else{j();p.refreshed()}};p.updateTitle=function(g){b=g};p.outputTitle=function(){return b||"My Meshu"};p.output=function(){return $("#"+v).html()};p.id=function(){return v};return p};var sb=sb||{};var app_key="dj0yJmk9M1hsekZBSDY1ZjRxJmQ9WVdrOU5uUjZiRzE0TXpRbWNHbzlNVEV5TURZMU1qRTJNZy0tJnM9Y29uc3VtZXJzZWNyZXQmeD00OQ--";sb.meshu=function(i,o,h){var k={},m=$(i).width()+"px",l=$(i).height()+"px",r=h||sb.map(i,m,l),o=o||"facet",b=sb.mesh[o](i,r,m,l),d=$("#cases");$(i).append("<div class='mapui'><div id='zoomin'></div><div id='zoomout'></div></div>");$("#zoomin").mousedown(function(t){r.map.zoom(r.map.zoom()+1);b.refresh("zoomed")});$("#zoomout").mousedown(function(t){r.map.zoom(r.map.zoom()-1);b.refresh("zoomed")});var a=$("#searchbox");a.focus(function(){d.fadeOut()}).keypress(function(u){if(u.which==13){var t=a.val();q(t)}});$("#search-button").click(function(){var u=a.val();if(u.split("|").length>2){var t=u.split("|");for(var v=0;v<t.length;v++){setTimeout(function(w){return function(){q(w)}}(t[v]),v*1000)}}else{q(u)}});function q(t){if(t=="add a city, place, or address"){return}var v=t.replace("&","and").replace(/[^\w ]/ig,"").replace(" ","+");var u="/proxy/geocoder/?location="+v;a.val("");$.ajax({url:u,cache:false,dataType:"json",error:function(w,y,x){console.log(x)},success:function(x){var w=x.bossresponse.placefinder.results;d.empty().hide();if(typeof w=="undefined"){a.blur();var z="Hrm, we weren't able to find your search. Try again?";d.append($("<p>").text(z)).fadeIn()}else{if(w.length>0){var y=w[0];switch(b.name){case"facet":case"print":b.add(y.offsetlat,y.offsetlon,t);k.updateBounds();if(b.points().length==1){e(y.radius)}break;case"radial":e(y.radius/10);b.add(y.offsetlat,y.offsetlon,t);break}}}}})}function j(t){if(t>100000){return 4}else{if(t>10000){return 12}else{if(t>1000){return 13}else{if(t>400){return 14}}}}return 12}function e(t){var u=j(t);if(u!=r.map.zoom()){r.map.zoom(u)}}k.locations=function(t,v){for(var u=0;u<t.length;u++){if(v){b.add(t[u].latitude,location[u].longitude,t[u].name)}else{setTimeout(function(w){return function(){b.add(w.latitude,w.longitude,w.name);k.updateBounds()}}(t[u]),u*400)}}if(v){k.updateBounds()}};function c(y){var t=y.split("|");var x=[],v={};for(var w=0;w<t.length;w++){var u=t[w].split("\t");if(u.length<3){continue}var z=u[0]+"-"+u[1];if(v[z]){continue}else{v[z]=true}x.push({latitude:parseFloat(u[0]),longitude:parseFloat(u[1]),name:u[2]})}return x}k.initializeFromData=function(w,v,u){b.prerender(u);var t=c(w);b.locations(t);if(v){b.applyStyle(v)}return k};k.mesh=function(){return b};k.map=function(){return r};var g=0,f=1,p=0,n=0;var s;k.animateTransform=function(y,x,v,t){if(s){clearInterval(s)}var u=0;var w=d3.select(".delaunay");s=setInterval(function(){if(++u<30){g+=(y-g)*0.33;f+=(x-f)*0.5;p+=(v-p)*0.5;n+=(t-n)*0.5;var z="rotate("+g+", 300, 300)";var B="scale("+f+")";var A="translate("+p+","+n+")";w.attr("transform",B+A+z)}else{clearInterval(s)}},40)};k.refreshWithBounds=function(u,t){r.updateBounds(u,t,k.zoomOffset)};k.updateBounds=function(){if(b.dirty){k.refreshWithBounds(b.lats(),b.lons());b.dirty=false}};r.on("boundsUpdated",function(){if(b.updatePixelBounds){b.updatePixelBounds()}b.refresh()});b.on("locationsSet",k.updateBounds);k.getFrame=function(){return i};k.updateTitle=function(u){b.updateTitle(u)};k.outputTitle=function(){return b.outputTitle()};k.outputSVG=function(){return b.output()};k.outputMapSVG=function(){return $(r.map.container()).html()};k.hideMesh=function(){return k};k.showMesh=function(){return k};k.outputLocationData=function(){var t=[];var v=b.places(),w=b.lats(),u=b.lons();$.each(v,function(y){var x=w[y]+"\t"+u[y]+"\t"+v[y];t.push(x)});return t.join("|")};k.xhr=function(){return{xhr:"true",title:k.outputTitle(),svg:k.outputSVG(),location_data:k.outputLocationData(),renderer:b.name,metadata:b.outputStyle(),promo:meshu.promo}};return k};var sb=sb||{};sb.rasterizer=function(){var h=d3.dispatch("rasterized","rasterizedThumbnail"),e=false,g=[];var d=function(){var j=document.createElement("canvas");j.width=400;j.height=400;j.style.position="absolute";j.style.top="0";j.style.left="0";$(j).addClass("hidden");g.push(j);return j};var c=function(j,k){j.fillStyle="rgba(255, 255, 255, "+k+")";j.fillRect(0,0,j.width,j.height);j.fill()};var i=function(j){var k=new XMLSerializer();return k.serializeToString(j)};var b=function(k){var m=k.map().map,l=m.zoom(),j=Math.round(l);if(l!=j){m.zoom(j);k.mesh().refresh()}};var f=function(m,l,j,k,o){var n=d();m.appendChild(n);k.mesh().bakeStyles();canvg(n,k.outputSVG(),{renderCallback:function(){k.mesh().unBakeStyles();j.drawImage(n,0,0,l.width,l.height);var p=new Image();p.onload=function(){j.drawImage(p,l.width-130,l.height-35,117,22);a(m,l,k,o)};p.src="/static/images/logo_io.png"}})};var a=function(m,k,j,n){var l=j.xhr();l.csrfmiddlewaretoken=$("#csrf input").val();l.dataurl=k.toDataURL();if(j.id){l.id=j.id}h.clearCanvases();$.post("to_png",l,function(p){var o=document.createElement("img");o.src=p.image_url;$(o).addClass("hidden");m.appendChild(o);h.generated=true;h.rasterized(p);if(n){n(p)}},"json")};h.clearCanvases=function(){while(g.length){var j=g.pop();$(j).remove()}};h.rasterize=function(l,o){b(l);var k=d(),n=l.getFrame(),j=k.getContext("2d"),m=i(l.map().map.container());n.appendChild(k);canvg(k,m,{renderCallback:function(){c(j,0.7);f(n,k,j,l,o)}})};h.thumbnail=function(l,o){l.mesh().bakeStyles();var k=d(),n=l.getFrame(),j=k.getContext("2d"),m=l.outputSVG();n.appendChild(k);canvg(k,m,{renderCallback:function(){l.mesh().unBakeStyles();if(o){o(k)}}})};return h}();sb.transforms={earrings:{product:{scale:0.15,transform:{x:900,y:750}},preview:{scale:0.125,transform:{x:650,y:540}},render:{scale:0.45,transform:{x:530,y:450}}},pendant:{product:{scale:0.1,transform:{x:1200,y:1700}},preview:{scale:0.075,transform:{x:1030,y:1470}},render:{scale:0.25,transform:{x:900,y:1375}}},necklace:{product:{scale:0.175,transform:{x:550,y:850}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}},cufflinks:{product:{scale:0.075,transform:{x:870,y:1170}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}},coasters:{product:{scale:0.3,transform:{x:200,y:200}},preview:{scale:0.125,transform:{x:510,y:760}},render:{scale:0.4,transform:{x:450,y:750}}}};sb.transforms.getTransform=function(c,b){var a=sb.transforms[c][b];return"scale("+a.scale+") translate("+a.transform.x+","+a.transform.y+") "};var sb=sb||{};$(function(){sb.product=function(){var a={};var b=[];a.initialize=function(d,c){b=c.getProducts();for(var e=0;e<b.length;e++){var f=b[e];if(typeof d=="string"){a.previewFromSelector(f.type,d)}else{a.previewFromElement(f.type,d)}}};a.previewFromSelector=function(f,e){var c=d3.select("#preview-"+f),d=sb.transforms.getTransform(f,"product");var g=$(e).clone().attr("class","product-delaunay").attr("transform",d);$(c[0]).append(g)};a.previewFromElement=function(f,e){var c=d3.select("#preview-"+f),d=sb.transforms.getTransform(f,"product");c.append("svg:image").attr("x",0).attr("y",0).attr("width","600px").attr("height","600px").attr("transform",d).attr("xlink:href",e.toDataURL())};return a}()});var sb=sb||{};$(function(){sb.rotator=function(e,d,b){var c=d3.dispatch("rotated");var f=0,g="scale(.125) translate(380, 670) ";c.update=function(l){$(e).empty();var n=d3.select(e);var q=n.append("svg:image").attr("id","previewImage").attr("x",0).attr("y",0).attr("width",313).attr("height",297).attr("xlink:href",c.getImage(l));var p=n.append("svg:g").attr("id","transform").attr("transform",c.getTransform(l));var m=$(b).clone().attr("class","rotate-ui");var s=$(d).clone().attr("class","mini-delaunay");$(p[0]).append(s).append(m);if(l=="pendant"){n.select(".rotate-ui").attr("class","hidden pendant").selectAll("circle").attr("r","55")}d3.selectAll("circle.rotation").on("mousedown",x);n.on("mouseup",t).on("mousemove",k);var w,v,j,i,o,h,r,y;var h=0;function x(){var z=d3.svg.mouse(n.node());w=z[0]-100,v=z[1]-100;r=true}function k(){if(!r){return}var z=d3.svg.mouse(n.node());j=z[0]-100,i=z[1]-100;y=a(w,v,j,i);var B=Math.sqrt(Math.pow(w,2)+Math.pow(v,2));var A=Math.sqrt(Math.pow(j,2)+Math.pow(i,2));o=Math.acos((w*j+v*i)/(B*A))*180/Math.PI;f=y?(f-o)%360:(f+o)%360;if(isNaN(f)){f=0}w=j,v=i;p.attr("transform",c.getTransform(l))}function t(){r=false;if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}}function u(z){f=(f+z)%360;p.attr("transform",c.getTransform(l))}$("#rotate-cw").click(function(){u(22.5)});$("#rotate-ccw").click(function(){u(-22.5)})};c.getTransform=function(h){return sb.transforms.getTransform(h,"product")+" rotate("+f+",300,300)"};c.getImage=function(h){return static_url+"images/preview/preview_"+h+".png"};c.rotation=function(h){if(!arguments.length){return f}f=h;return c};function a(i,k,h,j){if(h>i){if(k>0&&j>0){return true}else{return false}}else{if(h<i){if(k<0&&j<0){return true}else{return false}}else{if(j<k){if(i>0){return true}else{return false}}else{if(i<0){return true}else{return false}}}}}return c}("#rotate",".delaunay",".hidden")});var sb=sb||{};sb.materializer=function(){var c=d3.dispatch("update"),a,f,g,e,d,b;f={earrings:"pair of earrings",pendant:"small pendant necklace",necklace:"large necklace",cufflinks:"pair of cufflinks"};g={earrings:"earrings",pendant:"pendant necklace",necklace:"large necklace",cufflinks:"cufflinks"};c.initialize=function(h){a=h;c.materials=$("#material-list");c.materials.find("li").live("click",function(k){var j=k.currentTarget.id.split("-");c.material(j[1]);c.color(j[0]);var i=$(this);i.parent().find("li").removeClass("selected");i.addClass("selected")})};c.product=function(i){if(!arguments.length){return e}e=i;var h=a.getMaterials(i);$.each(c.materials.find("li"),function(k,j){var l=$(this).attr("id");if(h[l]){$(j).removeClass("inactive").find(".price").text("$"+h[l])}else{$(j).addClass("inactive").find(".price").text("")}});return c};c.material=function(h){if(!arguments.length){return d}d=h;cashier.updateProduct(e,d);return c};c.color=function(h){if(!arguments.length){return b}b=h;c.update();return c};c.productName=function(){return g[e]};c.displayName=function(){return f[e].toLowerCase()};return c}();var saver=function(){var b={},f="#meshu-id";function e(){var g=b.meshu.xhr();g.csrfmiddlewaretoken=$("#csrf input").val();return g}function d(g){if(!g){return}b.meshu.id=g;if($(f).length==0){$("#hidden-form-values").append('<input type="hidden" id="meshu-id" name="meshu_id" />')}$(f).val(g)}function a(){var g=e();if($(f).length){g.id=b.getMeshuID()}$.post("/make/assign/",g,function(h){d(h.meshu_id);if(b.postAssignCallback){b.postAssignCallback(h)}},"json")}function c(){var g=e();if($(f).length){g.id=b.getMeshuID()}$.post("/make/create/",g,function(h){d(h.meshu_id);if(b.postCreateCallback){b.postCreateCallback(h)}},"json")}b.initialize=function(h){b.meshu=h;$("#cancel-button").click(function(){window.location.href=loadedMeshu.view_url});var i="#save-button";$(i).click(function(){if(!loadedMeshu){return}$(i).html("saving");var j=loadedMeshu.edit_url+"save";$.post(j,e(),function(k){d(k.meshu_id);setTimeout(function(){$(i).html("saved!")},200);setTimeout(function(){window.location.href=k.meshu_url},1000)},"json")});var g="#update-button";$(g).click(function(){if(!loadedMeshu){return}$(g).html("updating");var j=loadedMeshu.edit_url+"update";$.post(j,e(),function(k){d(k.meshu_id);setTimeout(function(){$(g).html("saved!")},200);setTimeout(function(){window.location.href=k.meshu_url},1000)},"json")});return b};b.initializeNewMeshu=function(g){b.meshu=g;return b};b.createOrUpdateMeshu=function(g){if(b.meshu.isReadymade&&g){g()}else{if(b.meshu.username&&b.meshu.username=="guest"){a();if(g){b.postAssignCallback=g}}else{c();if(g){b.postCreateCallback=g}}}return b};b.updateMeshuData=function(g){d(g.id);b.meshu.view_url=g.view_url;b.meshu.username=g.username;b.meshu.title=g.title;b.meshu.promo=g.promo;if(g.image_url){b.meshu.image_url=g.image_url}};b.getMeshuID=function(){return $(f).val()};return b}();var sb=sb||{};sb.facebook={};$(".facebook-auth").click(function(){var a="/facebook/login";window.location=a});sb.facebook.initialize=function(h){$("#finish-button").click(function(){window.location="/make/#skipintro"});var c="Alabama,AL,Alaska,AK,Arizona,AZ,Arkansas,AR,California,CA,Colorado,CO,Connecticut,CT,Delaware,DE,Florida,FL,Georgia,GA,Hawaii,HI,Idaho,ID,Illinois,IL,Indiana,IN,Iowa,IA,Kansas,KS,Kentucky,KY,Louisiana,LA,Maine,ME,Maryland,MD,Massachusetts,MA,Michigan,MI,Minnesota,MN,Mississippi,MS,Missouri,MO,Montana,MT,Nebraska,NE,Nevada,NV,New Hampshire,NH,New Jersey,NJ,New Mexico,NM,New York,NY,North Carolina,NC,North Dakota,ND,Ohio,OH,Oklahoma,OK,Oregon,OR,Pennsylvania,PA,Rhode Island,RI,South Carolina,SC,South Dakota,SD,Tennessee,TN,Texas,TX,Utah,UT,Vermont,VT,Virginia,VA,Washington,WA,West Virginia,WV,Wisconsin,WI,Wyoming,WY";var u=c.split(",");var o={};for(var q=1;q<u.length;q+=2){o[u[q]]=u[q-1]}var d=function(i,v){return function(){$("#svg-file").val(i.outputSVG());$("#meshu-data").val(i.outputLocationData());$("#meshu-title").val(v);$("#meshu-select-form").submit()}};var s=[];var l={all:{name:"All Cities",locations:[]}};var j=[];var r=[];var m=[];var t=0;var g=function(v,w){if(w.locations.length<3){return}t+=300;setTimeout(function(){return function(){var y=$("<div>").addClass("mini-meshu");var x=$("<div>").addClass("title").html(w.name);y.append(x).fadeIn();$("#maps").append(y);var i=sb.minimeshu(y[0]);setTimeout(function(){i.locations(w.locations)},100);y.click(d(i,w.name))}}(),t)};var e=function(i,v){if(!l[v]){l[v]={name:v,locations:[],seen:{}};i.push(l[v])}};var b=function(v,w,i,x){if(!l[w].seen[x]){l[w].locations.push(i);l[w].seen[x]=i}else{l[w].seen[x].times++}};var f=function(){var i=function(w,v){return v.locations.length-w.locations.length};j.sort(i);r.sort(i);m.sort(i);if(m.length>1){m.unshift(l.all);$.each(m,g)}else{g(0,l.all)}if(r.length>1){$.each(r,g)}if(j.length){$.each(j,g)}else{$(".page-header").html("Oh no! Not enough checkins to make any meshus.");$("#finish-button").html("Make one manually")}};var p=0;var n=function(i){var v=i.data;if(!v||!v.length){f();return}p+=i.data.length;$.each(v,function(y,A){if(!A.place||!A.place.location||!A.place.location.city){return}var C=A.place.location.city;var B=A.place.location.country;var w={latitude:A.place.location.latitude,longitude:A.place.location.longitude,name:A.place.name,times:1};var x={name:C,latitude:w.latitude,longitude:w.longitude};if(!l[C]){l.all.locations.push(x)}e(j,C);e(m,B);b(j,C,w,w.name);b(m,B,x,C);var z=A.place.location.state;if(z&&B=="United States"){if(o[z.toUpperCase()]){z=o[z.toUpperCase()]}e(r,z);b(r,z,x,x.name)}});$.ajax({url:i.paging.next,dataType:"jsonp",success:function(w){if(w.data&&w.data.length){$(".page-header").html("Loaded "+p+" places...");n(w)}else{$(".page-header").html("Each meshu is a different set of places. Choose one to get started!");f()}},error:function(w){console.warn(w)}})};var k=false;function a(){h.api("/me/locations?limit=50",function(i){if(i.error){if(k){$(".page-header").html("We're not sure what happened! Try connecting to Facebook again?")}else{$(".page-header").html("Oops, there was an error connecting to Facebook. Retrying...");setTimeout(a,500);k=true}}else{n(i)}})}a()};$(".foursquare-auth").click(function(){var a="AJXTWLOH1K5RIWG33XSGQZHRISL5CCJ0XG1VUL3NAKDYYPMM";var d="https://meshu.io/make/foursquare/";var c="https://foursquare.com/oauth2/authenticate?client_id={client}&response_type=token&redirect_uri={redirect}";var b=c.replace("{client}",a).replace("{redirect}",d);window.location=b});var sb=sb||{};sb.foursquare={};sb.foursquare.initialize=function(){var a=window.location.hash,h=a.split("=").pop(),m="https://api.foursquare.com/v2/users/self/checkins?oauth_token={token}&v={v}&limit=250&offset={offset}",s=m.replace("{token}",h).replace("{v}","20120102");window.location.hash="#connected";$("#finish-button").click(function(){window.location="/make/#skipintro"});if(!h||!h.length){return}var c="Alabama,AL,Alaska,AK,Arizona,AZ,Arkansas,AR,California,CA,Colorado,CO,Connecticut,CT,Delaware,DE,Florida,FL,Georgia,GA,Hawaii,HI,Idaho,ID,Illinois,IL,Indiana,IN,Iowa,IA,Kansas,KS,Kentucky,KY,Louisiana,LA,Maine,ME,Maryland,MD,Massachusetts,MA,Michigan,MI,Minnesota,MN,Mississippi,MS,Missouri,MO,Montana,MT,Nebraska,NE,Nevada,NV,New Hampshire,NH,New Jersey,NJ,New Mexico,NM,New York,NY,North Carolina,NC,North Dakota,ND,Ohio,OH,Oklahoma,OK,Oregon,OR,Pennsylvania,PA,Rhode Island,RI,South Carolina,SC,South Dakota,SD,Tennessee,TN,Texas,TX,Utah,UT,Vermont,VT,Virginia,VA,Washington,WA,West Virginia,WV,Wisconsin,WI,Wyoming,WY";var v=c.split(",");var o={};for(var q=1;q<v.length;q+=2){o[v[q]]=v[q-1]}var d=function(i,w){return function(){$("#svg-file").val(i.outputSVG());$("#meshu-data").val(i.outputLocationData());$("#meshu-title").val(w);$("#meshu-select-form").submit()}};var t=[];var l={all:{name:"All Cities",locations:[]}};var k=[];var r=[];var n=[];var u=0;var j=function(w,x){if(x.locations.length<3){return}u+=300;setTimeout(function(){return function(){var z=$("<div>").addClass("mini-meshu");var y=$("<div>").addClass("title").html(x.name);z.append(y).fadeIn();$("#maps").append(z);var i=sb.minimeshu(z[0]);setTimeout(function(){i.locations(x.locations)},100);z.click(d(i,x.name))}}(),u)};var e=function(i,w){if(!l[w]){l[w]={name:w,locations:[],seen:{}};i.push(l[w])}};var b=function(w,x,i,y){if(!l[x].seen[y]){l[x].locations.push(i);l[x].seen[y]=i}else{l[x].seen[y].times++}};var g=function(){var i=function(x,w){return w.locations.length-x.locations.length};k.sort(i);r.sort(i);n.sort(i);if(n.length>1){n.unshift(l.all);$.each(n,j)}else{j(0,l.all)}if(r.length>1){$.each(r,j)}if(k.length){$.each(k,j)}else{$(".page-header").html("Oh no! Not enough checkins to make any meshus.");$("#finish-button").html("Make one manually")}};var p=0;var f=function(i){$.ajax({url:i,dataType:"jsonp",success:function(y){if(!y.response.checkins){g();return}var w=y.response.checkins.items;if(!w||!w.length){g();return}p+=y.response.checkins.items.length;$.each(w,function(B,D){if(!D.venue||!D.venue.location||!D.venue.location.city){return}var F=D.venue.location.city;var E=D.venue.location.country;var z={latitude:D.venue.location.lat,longitude:D.venue.location.lng,name:D.venue.name,times:1};var A={name:F,latitude:z.latitude,longitude:z.longitude};if(!l[F]){l.all.locations.push(A)}e(k,F);e(n,E);b(k,F,z,z.name);b(n,E,A,F);var C=D.venue.location.state;if(C&&E=="United States"){if(o[C.toUpperCase()]){C=o[C.toUpperCase()]}e(r,C);b(r,C,A,A.name)}});var x=y.response.checkins.count;if(p<x){$(".page-header").html("Loaded "+p+" of "+x+" checkins...");f(s.replace("{offset}",p))}else{$(".page-header").html("Each meshu is a different set of places. Choose one to get started!");g()}}})};f(s.replace("{offset}",p))};var sb=sb||{};sb.ui=sb.ui||{};sb.ui.orderer=function(c){var b=d3.dispatch("validated","updated");b.on("updated",function(){a()});$("#shipping-destination li").click(function(){var i=$(this).attr("id").split("-").pop();var h=$("#shipping-destination");$("#shipping-form").attr("class",i);h.find("li").removeClass("active");$(this).addClass("active");cashier.shippingMode(i)});$("#postcard-note-form").keyup(function(i){var h=i.target.value;$("#postcard-note").val(h)});$("#coupon-code").submit(function(){var h=$("#coupon-code-value").val();cashier.applyCoupon(h,function(k){if(k.success){var l=parseFloat(k.amount);if(l<1&&l>0){var i=Math.round(cashier.getPrice()*(1-l));var j=Math.round((1-l)*100);$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>"+j+"% off! -$"+i+".00</span>").insertAfter("#subtotal-price")}else{if(l>1){$("<h2>").attr("id","subtotal-coupon").addClass("review-header").html("Coupon:<span>-$"+l+".00</span>").insertAfter("#subtotal-price")}}$("#coupon-message").fadeIn("fast").html(h+" discount applied!");$(".coupon-form").hide();$("#coupon").val(h)}else{$("#coupon-message").fadeIn("fast").html("Invalid code.")}b.updated()});return false});var e=$("#payment-form").validate({rules:{card_number:{creditcard:true},card_cvc:{digits:true,minlength:3},card_month:{digits:true,minlength:2},card_year:{digits:true,minlength:4,}},messages:{shipping_state:"Please enter the two-letter state abbreviation.",card_cvc:"Sorry, that is not a valid CVC code",card_month:{minlength:"Please enter the month as a two-digit number."},card_year:{minlength:"Please enter the year as a four-digit number.",},},submitHandler:d});$("#save-and-view").click(function(){var h=function(){saver.createOrUpdateMeshu(function(i){window.location.href=i.meshu_url})};if(!user.loggedIn){g();user.afterLogIn=h}else{h()}});$("#review-button").click(function(){if(!user.loggedIn){g();return false}saver.createOrUpdateMeshu()});$("#submit-button").click(function(h){if(!user.loggedIn){g();return false}console.log("submitting");cashier.submit()});$("#add-to-cart").click(function(){b.updated();cashier.submit()});function d(){if(!user.loggedIn){g(d);return}b.updated();b.validated();return false}function g(h){user.showModal();user.afterLogIn=function(){if(h){saver.createOrUpdateMeshu(function(){setTimeout(h,200)})}}}function a(){var i=sb.materializer.product(),h=sb.materializer.material();cashier.updateProduct(i,h,cashier.getShipping());$("#object-type").val(i);$("#object-material").val(h);$("#object-color").val(sb.materializer.color().toLowerCase());$("#object-amount").val(cashier.getTotalCents());$("#svg-theta").val(sb.rotator?sb.rotator.rotation():0);$("#svg-file").val(c.outputSVG());$("#meshu-data").val(c.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:c.outputTitle());$("#meshu-renderer").val(c.mesh().name);$("#meshu-metadata").val(c.mesh().outputStyle());$("#postcard-note").val($("#postcard-note-form").val())}function f(){var i="One "+sb.materializer.displayName();var j=sb.materializer.color().toLowerCase()+" "+sb.materializer.material();$("#review-description").text(i+", made out of "+j);$("#subtotal-price span").text(cashier.getPriceString());$("#shipping-price span").text("$"+cashier.getShipping()+".00");$("#total-price span").text(cashier.getTotalString());$("#review-shipping").empty();$(".ship-row input").each(function(){if(this.value.length==0){return}var k=function(m){return m.replace(/\w\S*/g,function(n){return n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()})};this.value=k(this.value);var l;switch(this.id){case"ship-city":case"ship-zip":l=$("<span>");break;case"ship-state":this.value=this.value.toUpperCase();l=$("<span>");break;default:l=$("<p>");break}l.text($(this).val()).appendTo("#review-shipping")});var h=$("#card-number").val();$("#review-payment").text("XXXX-XXXX-XXXX-"+h.substring(12,16))}return b};var sb=sb||{};sb.ui=sb.ui||{};sb.ui.socialsharer=function(b){$(".share-facebook").click(function(){if(!sb.rasterizer.generated){sb.rasterizer.rasterize(b,a)}else{a()}});$(".action-button").click(function(){var d=this;if(!sb.rasterizer.generated){sb.rasterizer.rasterize(b,function(e){d.click()});return false}});sb.rasterizer.on("rasterized",function(d){saver.updateMeshuData(d);c();$(".social-media").fadeIn()});var c=function(f){var h="https://twitter.com/intent/tweet?text=";var j="http://pinterest.com/pin/create/button/?url=";var e="http://"+window.location.host;var i=e+b.image_url;var d=encodeURIComponent(e+b.view_url);var g="Check out this meshu I just made of the places I've been";$(".share-pinterest").attr("href",j+d+"&media="+i);$(".share-twitter").attr("href",h+g+"&url="+d)};var a=function(){var d="http://"+window.location.host;FB.ui({method:"feed",link:d+b.view_url,picture:d+b.image_url,name:b.title+" on meshu.io",caption:"",description:""},function(e){if(!e||e.error){}else{}})}};var sb=sb||{};sb.viewhandler=function(){var c=d3.dispatch("updated","next","prev");var b=["edit","product","make","add-ons","checkout","review"];var f=$("#content");$("#product").waypoint(function(g){if(g=="down"){d()}else{e()}},{offset:500});$("#materials").waypoint(function(g){if(g=="down"){if(sb.materializer.product()){sb.rotator.update(sb.materializer.product())}}},{offset:550});$("#review").waypoint(function(g){if(g=="down"){a()}},{offset:700});function a(){if(sb.materializer.product()){$(".review-product").removeClass("inactive").text(sb.materializer.product())}if(sb.materializer.color()&&sb.materializer.material()){$(".review-material").removeClass("inactive").text(sb.materializer.color()+" "+sb.materializer.material())}if(sb.materializer.product()&&sb.materializer.color()&&sb.materializer.material()){$(".review-price").text(cashier.getPriceString());$("#add-to-cart").removeClass("inactive")}}c.updateAccountView=function(){};function d(){var j=$(this);var g=c.view();var h=b.indexOf(g);var i=function(){f.attr("class",b[h+1])};c.next();i()}function e(){var g=c.view();var h=b.indexOf(g);var i=b[h-1];f.attr("class",i);c.prev()}c.view=function(g){if(!arguments.length){return f.attr("class")}var h=b.indexOf(g);if(h!=-1){f.attr("class",b[h]);view=g}};return c}();$(function(){var j=$("html").hasClass("svg");var a=loadedMeshu?loadedMeshu.promo:null,f=loadedMeshu&&loadedMeshu.product!="",i=window.location.href.search("postcard")>0?-0.25:0,e=loadedMeshu?loadedMeshu.renderer:$("body").hasClass("radial")?"radial":null;if($("body").hasClass("print")){e="print"}var g=sb.catalog(e,a);cashier.catalog(g);sb.materializer.initialize(g);meshu=sb.meshu($("#meshu-container")[0],e);meshu.zoomOffset=i;meshu.isReadymade=f;var c=sb.ui.orderer(meshu);c.on("validated",function(){sb.viewhandler.view("review");d("review");return false});sb.ui.socialsharer(meshu);if(loadedMeshu){saver.initialize(meshu);saver.updateMeshuData(loadedMeshu);user.updateLogoutActions(pageType);switch(pageType){case"view":if(j){meshu.map().buffer(0)}break}if(j){if(meshu.isReadymade&&readymade){readymade.initialize(meshu)}meshu.initializeFromData(loadedMeshu.location_data,loadedMeshu.metadata,loadedMeshu.svg)}if(pageType!="postcard"){h()}$("#meshu-container").removeClass("inactive");var k=loadedMeshu.location_data.split("|");$.each(k,function(m,o){var n=o.split("\t");if(n.length==3){var p=document.createElement("div");p.innerHTML=n[2];var l=p.firstChild.nodeValue;$("<li>").html(l).appendTo($("#display-places"))}});d3.select("#places").attr("class","").select("#place-title").attr("class","").select(".title-text").html(function(l){l.title=loadedMeshu.title;meshu.updateTitle(l.title);return l.title})}else{saver.initializeNewMeshu(meshu)}sb.viewhandler.updateAccountView();sb.viewhandler.on("next",d);sb.viewhandler.on("prev",b);if(!user.loggedIn&&!loadedMeshu&&window.location.hash!="#skipintro"){$(".tooltip").each(function(l,m){setTimeout(function(){$(m).fadeIn()},l*1000)});$(document).click(function(){$(".tooltip").fadeOut()})}$("#product-preview .wrapper").live("click",function(){var m=$(this);m.parent().find(".wrapper").removeClass("selected");m.addClass("selected");var l=m.attr("id").split("-")[1];sb.rotator.update(l);sb.materializer.product(l)});function h(){if(meshu.mesh().name=="facet"){sb.product.initialize(".delaunay",g);sb.rasterizer.rasterize(meshu)}else{if(meshu.mesh().name=="radial"){sb.rasterizer.thumbnail(meshu,function(l){sb.product.initialize(l,g);sb.rasterizer.rasterize(meshu)})}}}function d(){var l=sb.viewhandler.view();switch(l){case"edit":meshu.updateBounds();meshu.mesh().interactive(true);break;case"make":case"readymade":meshu.mesh().interactive(false);var n=static_url+"images/render/"+product+"_preview.jpg",m="url("+n+")";$(".render").css("background-image",m);break}}function b(){var l=sb.viewhandler.view();switch(l){case"edit":meshu.mesh().interactive(true);break;case"make":case"readymade":meshu.mesh().interactive(true);meshu.animateTransform(0,1,0,0);break}}$(".show-places").click(function(){$("#display-places").slideToggle();$(".show-places").toggle()})});