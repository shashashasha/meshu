var sb=sb||{};sb.catalog=function(d){var a={},c={},d=d||"facet";c.facet={earrings:{bamboo:{price:75,colors:["amber"]},acrylic:{price:80,colors:["black","white"]},nylon:{price:85,colors:["white"]}},pendant:{bamboo:{price:80,colors:["amber"]},acrylic:{price:85,colors:["black","white"]},nylon:{price:90,colors:["white"]},silver:{price:135,colors:["sterling"]},brass:{price:125,colors:["polished"]}},necklace:{bamboo:{price:85,colors:["amber"]},acrylic:{price:90,colors:["black","white"]},silver:{price:145,colors:["sterling"]},brass:{price:135,colors:["polished"]}},cufflinks:{silver:{price:155,colors:["sterling"]},brass:{price:145,colors:["polished"]}},ring:{silver:{price:105,colors:["sterling"]},brass:{price:95,colors:["polished"]}},small_poster:{unframed:{price:35,colors:["null"]}},medium_poster:{unframed:{price:45,colors:["null"]}}};c.radial=c.streets={earrings:{bamboo:{price:75,colors:["amber"]},acrylic:{price:80,colors:["black","white"]},nylon:{price:85,colors:["white"]}},pendant:{bamboo:{price:80,colors:["amber"]},acrylic:{price:85,colors:["black","white"]},nylon:{price:95,colors:["black","white"]},silver:{price:155,colors:["sterling"]},brass:{price:145,colors:["polished"]}},dense_pendant:{bamboo:{price:80,colors:["amber"]},acrylic:{price:85,colors:["black","white"]},nylon:{price:95,colors:["black","white"]},silver:{price:180,colors:["sterling"]},brass:{price:170,colors:["polished"]}},coasters:{bamboo:{price:45,colors:["amber"]},acrylic:{price:90,colors:["black"]}}};c.orbit={earrings:{bamboo:{price:75,colors:["amber"]},acrylic:{price:80,colors:["black","white"]},nylon:{price:85,colors:["black"]}},pendant:{bamboo:{price:80,colors:["amber"]},acrylic:{price:85,colors:["black","white"]},nylon:{price:90,colors:["white"]},silver:{price:145,colors:["sterling"]},brass:{price:135,colors:["polished"]}},necklace:{bamboo:{price:85,colors:["amber"]},acrylic:{price:90,colors:["black","white"]},silver:{price:155,colors:["sterling"]},brass:{price:145,colors:["polished"]}},small_poster:{unframed:{price:35,colors:["null"]}},medium_poster:{unframed:{price:45,colors:["null"]}},large_poster:{unframed:{price:55,colors:["null"]}}};c.print={postcard:{unframed:{price:5,colors:[]}},small_poster:{unframed:{price:35,colors:[]},framed:{price:55,colors:[]}},medium_poster:{unframed:{price:45,colors:[]}},large_poster:{unframed:{price:55,colors:[]},framed:{price:115,colors:[]}},};makeTimes={bamboo:"2-3 Weeks",acrylic:"2-3 Weeks",nylon:"2-3 Weeks",silver:"3-4 Weeks",brass:"3-4 Weeks",unframed:"1-2 Weeks",framed:"2-3 Weeks",};var b=c[d];a.check=function(f,e){return b[f]&&b[f][e]};a.get=function(g,f,e){if(!b[g]||!b[g][f]){return"N/A"}return b[g][f][e]};a.getPrice=function(f,e){return a.get(f,e,"price")};a.getColors=function(f,e){return a.get(f,e,"colors")};a.getMakeTime=function(e){return makeTimes[e]};a.getProducts=function(){var i=[];for(var g in b){var e=[],h=b[g];for(var f in h){e.push(h[f].price)}i.push({type:g,prices:e,discount:h.discount})}return i};a.getMaterials=function(g){var e={};for(var f in b[g]){$.each(b[g][f].colors,function(i,h){e[h+"-"+f]=b[g][f].price})}return e};return a};var sb=sb||{};sb.map=function(f,e,n){var g=org.polymaps;var o=d3.dispatch("boundsUpdated"),i=0.5;var d="http://tile.stamen.com/toner/{Z}/{X}/{Y}.png";var b=d3.select(f)[0][0];d3.select(f).append("div").attr("class","render");var h=g.image().url(g.url(d).hosts(["a","b","c","d"]));o.dispatch=d3.dispatch("show");var l=[{name:"San Francisco",lat:37.775,lon:-122.43,zoom:13},{name:"New York City",lat:40.718,lon:-73.997,zoom:14},{name:"Portland",lat:45.5207056,lon:-122.6768744,zoom:14},{name:"London",lat:51.506325,lon:-0.127144,zoom:14},{name:"Paris",lat:48.85693,lon:2.3412,zoom:14},{name:"Shanghai",lat:31.2367118,lon:121.481832,zoom:13}];var m=b.appendChild(g.svg("svg"));var k=Math.floor(Math.random()*l.length);o.map=g.map().container(m).zoom(l[k].zoom).center({lat:l[k].lat,lon:l[k].lon});o.map.size({x:$(f).width(),y:$(f).height()});var a=$("body").hasClass("print");if(a){o.map.zoom(1.9).center({lat:40,lon:-35})}else{o.map.add(h)}var j=$("body").hasClass("postcard");d3.select(m).attr("width",e).attr("height",j?"100%":"600px").select("rect").attr("visibility","visible").attr("fill",a?"#e7e7e7":"white");o.getStart=function(){return l[k]};o.frame=function(){return b};o.show=function(){if(!h.map()){o.map.add(h)}};o.hide=function(){if(h.map()){o.map.remove(h)}};o.buffer=function(c){i=c;return o};o.centerOn=function(q,p){var c=o.l2p(q);c.x-=p||0;q=o.p2l(c);o.map.center(q)};o.updateBounds=function(v,u,q,p){if(v.length==0||u.length==0){return}if(v.length==1&&u.length==1){o.centerOn({lat:v[0],lon:u[0]},p);o.boundsUpdated();return}var r=[{lat:d3.min(v),lon:d3.min(u)},{lat:d3.max(v),lon:d3.max(u)}];o.map.extent(r);if(p){var c=$(f).width()-p;var t=o.l2p(r[1]).x-o.l2p(r[0]).x;if(t>c){o.map.zoom(o.map.zoom()-0.5)}o.centerOn(o.map.center(),p)}offset=q||0;var s=Math.floor(o.map.zoom())+offset;if(s!=o.map.zoom()){o.map.zoom(s)}o.boundsUpdated()};o.getBounds=function(){var p=o.map.extent();var c=o.map.locationPoint(p[0]);var q=o.map.locationPoint(p[1]);return{t:q.y,b:c.y,l:c.x,r:q.x}};o.getExtent=function(){return o.map.extent()};o.getMapRadius=function(){var c=o.map.extent();return{lat:Math.abs(c[0].lat-c[1].lat)/3,lon:Math.abs(c[0].lon-c[1].lon)/3}};o.l2p=function(c){return o.map.locationPoint(c)};o.p2l=function(c){return o.map.pointLocation(c)};return o};var sb=sb||{};SVGElement.prototype.getTransformToElement=SVGElement.prototype.getTransformToElement||function(a){return a.getScreenCTM().inverse().multiply(this.getScreenCTM())};sb.mesh={};sb.mesh.base=function(e,x,k,h){var g=d3.dispatch("added","refreshed","locationsSet","removed","draggedMap","draggedPoint","clickedMap","clickedPoint","styled","interactiveToggled"),m=parseInt(Math.random()*10000000000,10);g.dirty=true;var s=[],d=[],f=[],t={};var r=[],q=[],l=[],y=0,j=null,c=false,w=null,i=null,u=null,a=null,b=$("body").hasClass("print")||$("body").hasClass("streets");var p=$("#content");if(!$("body").hasClass("streets")){d3.select(".frame").on("mousemove",v).on("mousedown",n)}d3.select("body").on("mouseup",o);function n(){if(!p.hasClass("edit")){return}w=true}function v(){if(!p.hasClass("edit")){return}if(!g.dragging&&!w){return}var z=b?d3.mouse(e):d3.svg.mouse(e);if(g.dragging){if(b){var A=g.getProjection(z)}else{var A=x.p2l({x:z[0],y:z[1]})}g.draggedPoint(g.dragging,A)}if(c&&w){i=true;if(u){x.map.panBy({x:z[0]-u[0],y:z[1]-u[1]})}g.dirty=true;g.draggedMap()}c=true;u=z}function o(){w=null;u=null;if(!p.hasClass("edit")){return}if(d3.event.target.tagName!="circle"&&g.hittest(d3.event.target)&&d3.event.target.tagName!="image"){return}if(!g.dragging&&!i){if(b){var z=d3.mouse(e);var A=g.getProjection(z)}else{var z=d3.svg.mouse(e);var A=x.p2l({x:z[0],y:z[1]})}g.clickedMap(A);i=null;return}if(!c&&g.dragging){g.clickedPoint(g.dragging)}else{v()}if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}c=false;g.dragging=null;i=null}g.interactive=function(z){g.interactiveToggled(z)};g.refresh=function(){update();g.refreshed()};g.prerender=function(){};g.applyStyle=function(z){var C=z.split("|");var B={};for(var A=0;A<C.length;A++){var D=C[A].split(":");B[D[0]]=D[1]}g.style(B)};g.style=function(A){if(!arguments.length){return t}for(var z in A){t[z]=A[z]}g.styled(t)};g.outputStyle=function(){var A=[];for(var z in t){A.push(z+":"+t[z])}return A.join("|")};g.updateTitle=function(z){a=z};g.outputTitle=function(){return a||"My Meshu"};g.output=function(){return $("#"+m).html()};g.outputMesh=function(){return".delaunay"};return g};var sb=sb||{};sb.mesh.facet=function(l,D,t,q){var p=sb.mesh.base(l,D,t,q),v=parseInt(Math.random()*10000000000,10);p.name="facet";var z=[],k=[],m=[],b=null,C=null,H={};var i=document.createElement("div");var h=d3.select(l||"body").append("div").attr("id",v).style("width",t).style("height",q).style("position","absolute").style("z-index","1").append("svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var A=h.append("g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var c=d3.select(l||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",t).style("height",q);var r=c.append("svg").attr("width","100%").attr("height","100%");var o=r.append("g").attr("id","delaunay-ui");var n=d3.select("#places");var B=n.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",p.removeInput)}var y=[],x=[],u=[],G=0,a=null;var w=$("#content");p.hittest=function(g){return d3.event.target!=r.node()};p.on("draggedMap",function(){j()});p.on("draggedPoint",function(I,J){I[0]=J.lon;I[1]=J.lat;var g=y.indexOf(I);z[g]=J.lat;k[g]=J.lon;p.dirty=true;b=null;C=null;H={};j()});p.on("clickedMap",function(g){p.add(g.lat,g.lon,undefined,false)});p.on("removed",function(){if(y.length<3){$("#scroll-down").fadeIn()}if(y.length==1){$("#meshu-container").addClass("inactive")}});p.on("interactiveToggled",function(g){p.updateCircleBehavior(g)});var F=function(){var N=0,g=[];if(y.length<2){return}for(var K=0;K<y.length;K++){var L=D.l2p({lat:y[K][1],lon:y[K][0]});for(var I=K+1;I<y.length;I++){var J=D.l2p({lat:y[I][1],lon:y[I][0]});var P=L.x-J.x;var O=L.y-J.y;var M=Math.sqrt((P*P)+(O*O));if(M>N){N=M;if(J.y>L.y){g=[J,L]}else{g=[L,J]}}}}return g};var e=function(J,I){var K=I.y-J.y,g=I.x-J.x;return Math.atan2(K,g)*(180/Math.PI)};var d=function(J,I){var K=I.y-J.y,g=I.x-J.x;return Math.sqrt((g*g)+(K*K))};var s=function(J,I){var g=I.getTransformToElement(I.ownerSVGElement);return J.matrixTransform(g)};p.getRotationAngle=function(J){J=J||0;if(y.length<2){return}if(C){return C+J}var I=F(D,y),g=e(I[0],I[1]);if(Math.abs(g)<30){C=-g}else{C=-g+180}return C+J};p.getLongestRotation=function(g){angle=p.getRotationAngle();g=g||0;return"rotate("+[angle+g,300,300].join(",")+") "};p.projectPoints=function(K){if(H.transform==K){return H}d3.select("#delaunay-ui").attr("transform",K);var J=[],I=[],M=[];var g=d3.selectAll("#delaunay-ui circle").each(function(U,R){var T=this.ownerSVGElement.createSVGPoint(),Q=D.l2p({lat:z[R],lon:k[R]});T.x=Q.x;T.y=Q.y;var S=s(T,this);I.push(S.x);M.push(S.y);J.push([S.x,S.y])});d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");var L=d3.min(M),P=d3.min(I),N=d3.max(I),O=d3.max(M);H={pts:J,transform:K,top:L,left:P,right:N,bottom:O,width:N-P,height:O-L};return H};p.transformedDelaunay=function(L,K,M,I){I=I||0;var O=L,N=K/O.width,J=M/O.height;var g=A.selectAll("path").data(d3.geom.delaunay(L.pts));g.enter().append("path");g.exit().remove();g.attr("stroke-width",20).attr("fill","none").attr("d",function(U){var Q=U.length;var P=[];for(var T=0;T<Q;T++){var S=(U[T][0]-O.left)*N,R=((U[T][1]-O.top)*J)+I;P.push([S,R])}return"M"+P.join(" L")+"Z"})};function f(I){var M=o.selectAll("circle");M.attr("cx",function(N){return D.l2p({lat:parseFloat(N[1]),lon:parseFloat(N[0])}).x}).attr("cy",function(N){return D.l2p({lat:N[1],lon:N[0]}).y});var g=A.selectAll("path").data(d3.geom.delaunay(y));g.enter().append("path");g.exit().remove();g.attr("d",function(S){var O=S.length;var N=[];for(var P=0;P<O;P++){var R={lat:parseFloat(S[P][1]),lon:parseFloat(S[P][0])};var Q=D.l2p(R);N.push([Q.x,Q.y])}return"M"+N.join("L")+"Z"});if(x&&I==true){clearInterval(G);x=null}else{if(x){var L=y[y.length-1]||[];if(Math.abs(L[0]-x[0])>0.0002){L[0]+=(x[0]-L[0])/3}if(Math.abs(L[1]-x[1])>0.0002){L[1]+=(x[1]-L[1])/3}y[y.length-1]=L;var K=Math.abs(L[0]-x[0]);var J=Math.abs(L[1]-x[1]);if(J<0.0002&&K<0.0002){clearInterval(G);x=null}}else{clearInterval(G)}}}p.updatePixelBounds=function(){if(z.length&&k.length){u=[D.l2p({lat:d3.min(z),lon:d3.min(k)}),D.l2p({lat:d3.max(z),lon:d3.min(k)}),D.l2p({lat:d3.max(z),lon:d3.max(k)}),D.l2p({lat:d3.min(z),lon:d3.max(k)})]}else{u=[]}};function j(){var K=o.selectAll("circle").data(y);K.enter().append("circle").attr("id",function(M,L){return"c-"+L}).attr("r",10).on("mousedown",function(L){p.dragging=L;d3.event.stopPropagation()});K.exit().remove();var I=B.selectAll("li.place").data(y);var g=I.enter().append("li").attr("class","place");var J=g.append("span").attr("class","title");J.append("span").attr("class","place-text").html(function(M,L){i.innerHTML=m[L];return i.firstChild.nodeValue});J.append("span").attr("class","place-edit").html("edit");g.append("span").attr("class","place-delete").html("x");I.exit().remove();I.attr("id",function(M,L){return"p-"+L}).select(".title").each(function(L){L.edit=false}).attr("class","title").select(".place-text").html(function(M,L){i.innerHTML=m[L];return i.firstChild.nodeValue});p.updateCircleBehavior();E();f()}p.updateCircleBehavior=function(K){var g=w.hasClass("view");var I=$("#place-hover");var J=o.selectAll("circle");J.on("mouseover",function(R,N){if(K){return}else{if(g){I.addClass("active").find("span").text(m[N]);var Q=D.l2p({lat:R[1],lon:R[0]});var L=I.width();var P=(Q.y-32)+"px";var O=(Q.x-(L/2)-3)+"px";var M=L/2-3+"px";I.css({top:P,left:O}).find("b").css("left",M)}else{B.select("#p-"+N).attr("class","place highlight")}}});J.on("mouseout",function(M,L){if(K){return}else{if(g){I.removeClass("active")}else{B.select("#p-"+L).attr("class","place")}}})};function E(){var g=B.selectAll("li.place");g.select(".place-delete").on("click",function(J,I){p.remove(I);p.refresh()});g.on("mouseover",function(J,I){o.select("#c-"+I).attr("class","highlight")});g.on("mouseout",function(J,I){o.select("#c-"+I).attr("class","")});g.select(".place-edit").on("click",function(K,I){var J=$(this).parent();if(!K.edit){p.editText(J,I,"place");p.removeInput()}else{p.saveText(J,I,"place")}K.edit=!K.edit});g.select(".place-text").on("click",function(J,I){if(J.edit){return}p.removeInput();p.editText($(this).parent(),I,"place");J.edit=!J.edit})}p.add=function(N,J,L,g){if(G){clearInterval(G)}var K=parseFloat(N);var M=parseFloat(J);z.push(K);k.push(M);if(L==undefined){m.push(N.toFixed(3)+", "+J.toFixed(3))}else{m.push(L)}if(y.length){$("#meshu-container").removeClass("inactive");x=[M,K];if(g){y.push([x[0],x[1]]);p.updatePixelBounds();j();f(g)}else{var I=y[y.length-1];y.push([I[0],I[1]]);p.updatePixelBounds();j();G=setInterval(f,40)}}else{y.push([M,K]);j()}if(y.length>=3){$("#scroll-down").fadeIn()}p.dirty=true;b=null;C=null;H={};p.added();return p};p.remove=function(g){y.splice(g,1);z.splice(g,1);k.splice(g,1);m.splice(g,1);p.dirty=true;b=null;C=null;H={};if(y.length<3){$("#scroll-down").fadeOut()}if(y.length==1){$("#meshu-container").addClass("inactive")}};p.lats=function(){return z};p.lons=function(){return k};p.places=function(){return m};p.points=function(g){if(!arguments.length){return y}y=g;return p};p.bakeStyles=function(){};p.unBakeStyles=function(){};p.locations=function(g){x=null;y=[];z=[];k=[];m=[];$.each(g,function(I,J){y.push([J.longitude,J.latitude]);z.push(J.latitude);k.push(J.longitude);m.push(J.name)});p.locationsSet();return p};p.editText=function(K,I,J){var g=K.find("."+J+"-edit").text("save");var M=K.find("."+J+"-text");var L=((J=="title")?M.text():m[I]);K.addClass("active");M.html('<input value="'+L+'">').find("input").focus()};p.saveText=function(K,I,J){var g=K.find("."+J+"-edit").text("edit");var L=K.find("input").val();K.removeClass("active");K.find("."+J+"-text").text(L);if(J=="place"){m[I]=L}else{return L}};p.removeInput=function(g){var I=d3.select("#places").selectAll("li.place .title");I.each(function(K,J){if(!K.edit){return}K.edit=false;p.saveText($(this),J,"place")});return false};p.refresh=function(){j();p.refreshed()};p.updateTitle=function(g){a=g};p.outputTitle=function(){return a||"My Meshu"};p.output=function(){var I=sb.rotator?sb.rotator.getRotation():0;A.attr("transform","rotate("+I+",300,300)");var g=$("#"+v).html();A.attr("transform","rotate(0)");return g};return p};var sb=sb||{};sb.mesh.radial=function(o,G,s,q){var p=sb.mesh.base(o,G,s,q),v="m"+parseInt(Math.random()*10000000000,10),C=0,B=0;p.name="radial";var z=[],l=[],b;var D=d3.select(o||"body").append("div").attr("id",v).style("width",s).style("height",q).style("position","absolute");var e=d3.select(o||"body").append("div").attr("id",v+"prerendered").style("width",s).style("height",q).style("position","absolute");var i=d3.select("#"+v).append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var h=i.append("svg:g").attr("class","delaunay");h.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var A=h.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");h.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var n=d3.select(o).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var F=d3.select("#place-title").attr("class","inactive");F.append("span").attr("class","title-text");F.append("span").attr("class","title-edit").html("edit");var y=[],a=[],u=[],t=[],f={},b=null;var x=$("#content");p.hittest=function(g){return d3.event.target!=n.node()};p.on("draggedMap",function(){j()});p.on("clickedMap",function(g){p.add(g.lat,g.lon,undefined,false)});p.on("removed",function(){if(y.length==0){$("#scroll-down").fadeOut()}});p.on("styled",function(g){if(g.zoom&&g.zoom!=G.map.zoom()){G.map.zoom(g.zoom)}});function m(){var g=h.selectAll("circle");g.attr("cx",function(I){return G.l2p({lat:I[1],lon:I[0]}).x}).attr("cy",function(I){return G.l2p({lat:I[1],lon:I[0]}).y})}function k(){var J=function(P,N){var K=Math.min(16,P.total-4),M=5,O=(1-Math.sqrt(P.d)),L=(K*O)+M;return L+"px"};var I="black";if(p.style()!=undefined&&p.style().drawStyle){I=p.style().drawStyle=="outline"?"black":"white"}var g=A.selectAll("path").data(u);if($("body").hasClass("firefox")){g.enter().append("path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",J)}else{g.enter().append("path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",0).transition().duration(500).style("stroke-width",J)}g.exit().remove();g.attr("d",function(K){return w(K.pts)}).attr("stroke",I)}function w(L){var g=[];var I=L.length;for(var J=0;J<I;J++){var M={lat:L[J][0],lon:L[J][1]};var K=G.l2p(M);g.push([K.x,K.y])}return"M"+g.join("L")}function E(L){a.push(L);var I=L.length;for(var J=0;J<I-2;J+=2){var K=[L[J],L[J+1]];var g=[L[J+2],L[J+3]];u.push({pts:[K,g],total:L.length,d:J/L.length})}k()}function c(L){var g=true,I=0;for(var K=1;K<y.length;K++){if(f[L][K]!="done"){g=false}else{I++}}var J=(I/(y.length-1)*100).toFixed(0)+"%";$("#radial-heading").html("Generating radial... "+J);if(g){$("#radial-heading").html("Your radial is done!");p.added()}}function d(){var M=G.map.zoom(),O=y[0];startCoords=O[1]+","+O[0];f[M]=["done"];var L=$("body").hasClass("ie")||window.location.protocol=="https:"?"https://meshu.io/proxy/router/?from=":"http://open.mapquestapi.com/directions/v1/route?routeType=pedestrian&outFormat=json&shapeFormat=raw&generalize=200&from=";var N=L+"{start}&to={end}&key={key}";for(var K=1;K<y.length;K++){var I=y[K],g=I[1]+","+I[0],J=N.replace("{start}",startCoords).replace("{end}",g).replace("{key}",mapquestapi);f[M][K]=$.jsonp({url:J,callbackParameter:"callback",error:function(P){return function(Q){f[M][P]="done";c(M)}}(K),success:function(P){return function(R){if(!R.route.shape){f[M][P]="done";return}else{if(f[M]==undefined||f[M][P]==undefined||f[M]=="inactive"){return}}var Q=R.route.shape.shapePoints;E(Q);f[M][P]="done";c(M)}}(K)})}}function j(){F.data(y).each(function(g){g.edit=false});H();m();k()}function H(){F.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return b}});F.select(".title-text").on("click",function(g){if(g.edit){return}p.editText($(this).parent(),0,"title");g.edit=!g.edit});F.select(".title-edit").on("click",function(I){var g=$(this).parent();if(!I.edit){p.editText(g,0,"title")}else{I.title=b=p.saveText(g,0,"title")}I.edit=!I.edit})}p.editText=function(K,I,J){var g=K.find("."+J+"-edit").text("save");var M=K.find("."+J+"-text");var L=M.text();K.addClass("active");M.html('<input value="'+L+'">').find("input").focus()};p.saveText=function(K,I,J){var g=K.find("."+J+"-edit").text("edit");var L=K.find("input").val();K.removeClass("active");K.find("."+J+"-text").text(L);return L};function r(){i.selectAll("path").remove();u=[];y=[y[0]];z=[z[0]];l=[l[0]];var I,J;for(var L=0;L<24;L++){var K=L*(Math.PI/12);var g=G.p2l({x:C+300+(Math.sin(K)*200),y:B+300+(Math.cos(K)*200)});J=g.lon;I=g.lat;z.push(I);l.push(J);y.push([J,I])}}p.add=function(N,I,K,g){var J=parseFloat(N);var M=parseFloat(I);D.select("#radialClip circle").data([[M,J]]);D.select(".circleFrame").data([[M,J]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",17);z=[J];l=[M];y=[[M,J]];if(K==undefined){b=N.toFixed(3)+", "+I.toFixed(3)}else{b=K[0].toUpperCase()+K.substr(1,K.length-1)}$("#places").removeClass("inactive");$("#scroll-down").fadeIn();var L={lat:J,lon:M};G.map.center(L);p.recalculate();G.centerOn(L,C,B);G.boundsUpdated();return p};p.remove=function(g){y.splice(g,1);z.splice(g,1);l.splice(g,1);if(y.length==0){$("#scroll-down").fadeOut()}};p.lats=function(){return z};p.lons=function(){return l};p.places=function(){return[b]};p.points=function(g){if(!arguments.length){return y}y=g;return p};p.bakeStyles=function(){var J=$(".circleFrame").css("stroke"),I=$(".circleFrame").css("fill"),g=$(".radial path").css("stroke");$(".circleFrame").attr("stroke",J);$(".circleFrame").attr("fill",I);$(".radial path").attr("stroke",g)};p.unBakeStyles=function(){$(".circleFrame").attr("stroke","").attr("fill","");$(".radial path").css("stroke","")};p.locations=function(g){y=[];z=[];l=[];$.each(g,function(I,J){y.push([J.longitude,J.latitude]);z.push(J.latitude);l.push(J.longitude)});p.dirty=true;p.locationsSet();return p};p.prerender=function(I,O){O=O||1;$("#"+v+"prerendered").html(I);var J=$("#"+v+"prerendered").find(".delaunay");$("#"+v).find(".delaunay").replaceWith(J);var L=$(o).width(),g=$(o).height(),K=600*O,N="translate("+(L-K)/2+","+(g-K)/2+") ",M=" scale("+O+","+O+")";$("#"+v+" .delaunay").attr("transform",N+M)};p.recalculate=function(){$("#"+v+"prerendered").remove();$.each(f,function(g,I){$.each(I,function(J,K){if(K==undefined||K=="done"){return}if(K.abort){K.abort()}});f[g]="inactive"});r();d();p.style({zoom:G.map.zoom()});p.dirty=false};p.refresh=function(g){if(g=="zoomed"&&z.length>0&&l.length>0){p.add(z[0],l[0],b)}else{j();p.refreshed()}};p.updateTitle=function(g){b=g};p.outputTitle=function(){return b||"My Meshu"};p.output=function(){return $("#"+v).html()};p.id=function(){return v};return p};var sb=sb||{};var processing_page=$("body").hasClass("processing")||$("body").hasClass("postcard")||$("body").hasClass("gallery");sb.mesh.orbit=function(l,D,t,q){var p=sb.mesh.base(l,D,t,q),v=parseInt(Math.random()*10000000000,10);p.name="orbit";var z=[],k=[],m=[],b=null,C=null,H={};var i=document.createElement("div");var h=d3.select(l||"body").append("div").attr("id",v).style("width",t).style("height",q).style("position","absolute").style("z-index","1").append("svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var A=h.append("g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var c=d3.select(l||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",t).style("height",q);var r=c.append("svg").attr("width","100%").attr("height","100%");var o=r.append("g").attr("id","delaunay-ui");var n=d3.select("#places");var B=n.append("ul");var y=[],x=[],u=[],G=0,a=null;var w=$("#content");p.hittest=function(g){return d3.event.target!=r.node()};p.on("draggedMap",function(){j()});p.on("draggedPoint",function(I,J){I[0]=J.lon;I[1]=J.lat;var g=y.indexOf(I);z[g]=J.lat;k[g]=J.lon;p.dirty=true;b=null;C=null;H={};j()});p.on("clickedMap",function(g){p.add(g.lat,g.lon,undefined,false)});p.on("removed",function(){if(y.length<3){$("#scroll-down").fadeIn()}if(y.length==1){$("#meshu-container").addClass("inactive")}});p.on("interactiveToggled",function(g){p.updateCircleBehavior(g)});var F=function(){var N=0,g=[];if(y.length<2){return}for(var K=0;K<y.length;K++){var L=D.l2p({lat:y[K][1],lon:y[K][0]});for(var I=K+1;I<y.length;I++){var J=D.l2p({lat:y[I][1],lon:y[I][0]});var P=L.x-J.x;var O=L.y-J.y;var M=Math.sqrt((P*P)+(O*O));if(M>N){N=M;if(J.y>L.y){g=[J,L]}else{g=[L,J]}}}}return g};var e=function(J,I){var K=I.y-J.y,g=I.x-J.x;return Math.atan2(K,g)*(180/Math.PI)};var d=function(J,I){var K=I.y-J.y,g=I.x-J.x;return Math.sqrt((g*g)+(K*K))};var s=function(J,I){var g=I.getTransformToElement(I.ownerSVGElement);return J.matrixTransform(g)};p.getRotationAngle=function(J){J=J||0;if(y.length<2){return}if(C){return C+J}var I=F(D,y),g=e(I[0],I[1]);if(Math.abs(g)<30){C=-g}else{C=-g+180}return C+J};p.getLongestRotation=function(g){angle=p.getRotationAngle();g=g||0;return"rotate("+[angle+g,300,300].join(",")+") "};p.projectPoints=function(K){if(H.transform==K){return H}d3.select("#delaunay-ui").attr("transform",K);var J=[],I=[],M=[];var g=d3.selectAll("#delaunay-ui circle").each(function(U,R){var T=this.ownerSVGElement.createSVGPoint(),Q=D.l2p({lat:z[R],lon:k[R]});T.x=Q.x;T.y=Q.y;var S=s(T,this);I.push(S.x);M.push(S.y);J.push([S.x,S.y])});d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");var L=d3.min(M),P=d3.min(I),N=d3.max(I),O=d3.max(M);H={pts:J,transform:K,top:L,left:P,right:N,bottom:O,width:N-P,height:O-L};return H};p.transformedDelaunay=function(M,L,O,J){J=J||0;var N=M,g=L/N.width,P=O/N.height;var Q=A.selectAll("path").data(M.pts);var K=M.pts[0];var I=d3.svg.arc().innerRadius(function(R){return R[2]}).outerRadius(function(R){return R[2]+4}).startAngle(0).endAngle(Math.PI*2);Q.enter().append("path");Q.exit().remove();Q.attr("stroke-width",20).attr("fill","none").attr("transform",function(T){var R=[(K[0]-N.left)*g,((K[1]-N.top)*P)+J],S=[(T[0]-N.left)*g,((T[1]-N.top)*P)+J];T[2]=Math.sqrt(Math.pow(S[0]-R[0],2)+Math.pow(S[1]-R[1],2))/2;return"translate("+(S[0]+(R[0]-S[0])/2)+","+(S[1]+(R[1]-S[1])/2)+")"}).attr("d",I)};function f(I){var O=o.selectAll("circle");O.attr("cx",function(P){return D.l2p({lat:parseFloat(P[1]),lon:parseFloat(P[0])}).x}).attr("cy",function(P){return D.l2p({lat:P[1],lon:P[0]}).y});var J=y[0];var g=A.selectAll("path").data(y);var K=d3.svg.arc().innerRadius(function(P){return P[2]-2}).outerRadius(function(P){return P[2]+2}).startAngle(0).endAngle(Math.PI*2);g.enter().append("path");g.exit().remove();g.attr("transform",function(R){var P=D.l2p({lat:R[1],lon:R[0]}),Q=D.l2p({lat:J[1],lon:J[0]});R[2]=Math.sqrt(Math.pow(Q.x-P.x,2)+Math.pow(Q.y-P.y,2))/2;return"translate("+(Q.x+(P.x-Q.x)/2)+","+(Q.y+(P.y-Q.y)/2)+")"}).attr("d",K);if(x&&I==true){clearInterval(G);x=null}else{if(x){var N=y[y.length-1]||[];if(Math.abs(N[0]-x[0])>0.0002){N[0]+=(x[0]-N[0])/3}if(Math.abs(N[1]-x[1])>0.0002){N[1]+=(x[1]-N[1])/3}y[y.length-1]=N;var M=Math.abs(N[0]-x[0]);var L=Math.abs(N[1]-x[1]);if(L<0.0002&&M<0.0002){clearInterval(G);x=null}}else{clearInterval(G)}}}p.updatePixelBounds=function(){if(z.length&&k.length){u=[D.l2p({lat:d3.min(z),lon:d3.min(k)}),D.l2p({lat:d3.max(z),lon:d3.min(k)}),D.l2p({lat:d3.max(z),lon:d3.max(k)}),D.l2p({lat:d3.min(z),lon:d3.max(k)})]}else{u=[]}};function j(){var J=o.selectAll("circle").data(y);J.enter().append("circle").attr("id",function(L,K){return"c-"+K}).attr("r",10).on("mousedown",function(K){p.dragging=K;d3.event.stopPropagation()});J.exit().remove();var I=B.selectAll("li.place").data(y);var g=I.enter().append("li").attr("class","place");g.append("span").attr("class","origin").text("Origin");g.append("span").attr("class","place-text").html(function(L,K){i.innerHTML=m[K];return i.firstChild.nodeValue});g.append("span").attr("class","place-delete").html("x");I.exit().remove();I.attr("id",function(L,K){return"p-"+K}).select(".place-text").text(function(L,K){i.innerHTML=m[K];return i.firstChild.nodeValue});p.updateCircleBehavior();E();f()}p.updateCircleBehavior=function(K){var g=w.hasClass("view");var I=$("#place-hover");var J=o.selectAll("circle");J.on("mouseover",function(R,N){if(K){return}else{if(g){I.addClass("active").find("span").text(m[N]);var Q=D.l2p({lat:R[1],lon:R[0]});var L=I.width();var P=(Q.y-32)+"px";var O=(Q.x-(L/2)-3)+"px";var M=L/2-3+"px";I.css({top:P,left:O}).find("b").css("left",M)}else{B.select("#p-"+N).attr("class","place highlight")}}});J.on("mouseout",function(M,L){if(K){return}else{if(g){I.removeClass("active")}else{B.select("#p-"+L).attr("class","place")}}})};function E(){var I=B.selectAll("li.place");I.select(".place-delete").on("click",function(K,J){p.remove(J);p.refresh()});I.on("mouseover",function(K,J){o.select("#c-"+J).attr("class","highlight")});I.on("mouseout",function(K,J){o.select("#c-"+J).attr("class","")});var g=0;if(!processing_page){$("#places ul").sortable({axis:"y",cursor:"move",start:function(J,K){g=K.item.index()},stop:function(K,L){var J=L.item.index();if(g==J){return}m.splice(J,0,m.splice(g,1)[0]);y.splice(J,0,y.splice(g,1)[0]);z.splice(J,0,z.splice(g,1)[0]);k.splice(J,0,k.splice(g,1)[0]);g=0;j()}});$("#places ul").disableSelection()}}p.add=function(N,J,L,g){if(G){clearInterval(G)}var K=parseFloat(N);var M=parseFloat(J);z.push(K);k.push(M);if(L==undefined){m.push(N.toFixed(3)+", "+J.toFixed(3))}else{m.push(L)}if(y.length){$("#meshu-container").removeClass("inactive");x=[M,K];if(g){y.push([x[0],x[1]]);p.updatePixelBounds();j();f(g)}else{var I=y[0];y.push([I[0],I[1]]);p.updatePixelBounds();j();G=setInterval(f,40)}}else{y.push([M,K]);j()}if(y.length>=3){$("#scroll-down").fadeIn()}p.dirty=true;b=null;C=null;H={};p.added();return p};p.remove=function(g){y.splice(g,1);z.splice(g,1);k.splice(g,1);m.splice(g,1);p.dirty=true;b=null;C=null;H={};if(y.length<3){$("#scroll-down").fadeOut()}if(y.length==1){$("#meshu-container").addClass("inactive")}};p.lats=function(){return z};p.lons=function(){return k};p.places=function(){return m};p.points=function(g){if(!arguments.length){return y}y=g;return p};p.bakeStyles=function(){};p.unBakeStyles=function(){};p.locations=function(g){x=null;y=[];z=[];k=[];m=[];$.each(g,function(I,J){y.push([J.longitude,J.latitude]);z.push(J.latitude);k.push(J.longitude);m.push(J.name)});p.locationsSet();return p};p.refresh=function(){j();p.refreshed()};p.updateTitle=function(g){a=g};p.outputTitle=function(){return a||"My Meshu"};p.output=function(){var I=sb.rotator?sb.rotator.getRotation():0;A.attr("transform","rotate("+I+",300,300)");var g=$("#"+v).html();A.attr("transform","rotate(0)");return g};return p};var sb=sb||{};sb.mesh.streets=function(b,v,a,e){var k=sb.mesh.base(b,v,a,e),n="m"+parseInt(Math.random()*10000000000,10),C=0,B=0;var D=[{layer:"roads",display:true,types:[]},];var a=$("#meshu-container").width(),e=$("#meshu-container").height();var h=d3.geo.tile().size([a,e]);var t=v.getStart();v.hide();var F=[t.lon,t.lat,t.zoom];var H=d3.geo.mercator().scale((1<<(8+F[2]))/2/Math.PI).translate([-a/2,-e/2]);var E=d3.geo.mercator();var g=d3.geo.path().projection(E);var G=d3.behavior.zoom().scale(H.scale()*2*Math.PI).scaleExtent([1<<12,1<<25]).translate(H([F[0],F[1]]).map(function(L){return -L}));if(!$("body").hasClass("display")&&!$("body").hasClass("postcard")){G.on("zoom",u).on("zoomend",p)}var A=d3.select("#meshu-container").append("div").attr("id","map-now").style({position:"absolute",top:"0"}).style("width",a+"px").style("height",e+"px").call(G).on("mousewheel.zoom",null).on("DOMMouseScroll.zoom",null);A.append("div").attr("class","layer");var q=A.select(".layer").append("svg").attr("id","raster-tiles").attr("width",a).attr("height",e).append("g");var c=A.select(".layer").append("div").attr("id","map-boundary").append("svg").attr("width",a).attr("height",e);c.append("defs").append("clipPath").attr("id","circle-clip").append("circle").attr("cx",a/2).attr("cy",e/2).attr("r",280);c.append("circle").attr("cx",a/2).attr("cy",e/2).attr("r",280);var f=c.append("g").attr("clip-path","url(#circle-clip)").append("g").attr("id","vector-tiles");var I=d3.select("#attribution").html('<a href="http://bl.ocks.org/mbostock/5593150" target="_top">Mike Bostock</a> | © <a href="https://www.openstreetmap.org/copyright" target="_top">OpenStreetMap contributors</a> | <a href="https://mapzen.com/projects/vector-tiles" title="Tiles courtesy of Mapzen" target="_top">Mapzen</a>');$(".review-svg").replaceWith(function(){return $("<div>",{"class":"review-svg"})});u();function p(){k.style({scale:G.scale(),translate:G.translate().join(",")})}function u(){if(event&&event.type=="wheel"){G.scale(H.scale()*2*Math.PI);return}var M=h.scale(G.scale()).translate(G.translate())();H.scale(G.scale()/2/Math.PI).translate(G.translate());var O=M[0][2];d3.select("#map-now .layer").attr("class",function(){return"layer z"+O});var N=f.attr("transform",J(M.scale,M.translate)).selectAll(".tile").data(M,function(P){return P});N.exit().each(function(P){this._xhr.abort()}).remove();N.enter().append("g").attr("class","tile").attr("transform",function(P){return"translate("+P[0]*256+","+P[1]*256+")"});N.each(K);var L=q.attr("transform",J(M.scale,M.translate)).selectAll(".tile").data(M,function(P){return P});L.exit().remove();L.enter().append("g").attr("class","tile").attr("transform",function(P){return"translate("+P[0]*256+","+P[1]*256+")"}).append("image");L.select("image").attr("xlink:href",function(P){return"http://tile.stamen.com/toner/"+P[2]+"/"+P[0]+"/"+P[1]+".png"}).attr("opacity",0.2).attr("width",256).attr("height",256)}function j(M){var N=f.selectAll("path").data();var L=d3.nest().key(function(O){return O.layer_name}).key(function(P){var O=P.properties.kind;if(M&&P.properties.boundary=="yes"){O+="_boundary"}return O}).entries(N);if(L[0]&&L[0].values){L[0].values=L[0].values.filter(function(O){return d3.select("."+O.key.replace("_","-")).style("display")!="none"})}return L}var r=d3.select("body").append("div").attr("id","svg-download").style("display","none").append("svg").attr("width","100%").attr("height","100%");clipGroup=r.append("g").attr("clip-path","url(#dl-clip)").attr("class","delaunay");group=clipGroup.append("g").attr("class","tile");r.append("defs").append("clipPath").attr("id","dl-clip").append("circle").attr("cx",300).attr("cy",300).attr("r",280);clipGroup.append("circle").attr("cx",300).attr("cy",300).attr("r",280).attr("fill","none");function l(){var L=j();var U=h.scale(G.scale()).translate(G.translate())(),S=U[0],Q=Math.pow(2,S[2])*256;g.projection().translate([Q/2-S[0]*256,Q/2-S[1]*256]).scale(Q/2/Math.PI).precision(0);var R=["svg","tile"];var N=r.selectAll(".tile").data(L);var O=N.selectAll(".feature-type").data(function(Z){return Z.values});O.enter().append("g").attr("class","feature-type");O.attr("id",function(Z){R.push(Z.key.replace("_","-"));return Z.key});O.exit().remove();var Y=O.selectAll("path").data(function(Z){return Z.values});Y.enter().append("path");Y.exit().remove();Y.attr("class",function(aa){var Z=aa.properties.kind||"",Z=Z.replace("_","-");if(aa.properties.boundary=="yes"){Z+="_boundary"}return aa.layer_name+"-layer "+Z}).attr("d",g).attr("fill","none").attr("stroke-width",7);var M=H.invert([a/2,e/2]),T=H.invert([0,0]);var W=H.translate(),X=H.scale();H.translate([Q/2-S[0]*256,Q/2-S[1]*256]).scale(Q/2/Math.PI);var P=H(M),V=H(T);r.select(".tile").attr("transform","translate(-"+V[0]+",-"+V[1]+")");H.translate(W).scale(X)}function J(O,N){var L=O/256,M=O%1?Number:Math.round;return"translate("+M(N[0]*O)+","+M(N[1]*O)+") scale("+L+")"}function i(N,M){var L=this;return d3.transition().duration(350).tween("zoom",function(){var P=d3.interpolate(G.translate(),N),O=d3.interpolate(G.scale(),M);return function(Q){G.scale(O(Q)).translate(P(Q));u()}})}function s(Q){var O=Math.PI,N=2*O;var R=H([Q[0],Q[1]]),P=H([Q[2],Q[3]]);function M(S){return Math.pow(2,Math.floor(Math.log(S*N)/Math.LN2))/N}var L=M(0.95/Math.max((P[0]-R[0])/a,(P[1]-R[1])/e))*G.scale();return L}k.zoomTo=function(O,Q){var N=H(O).map(function(R){return -R}),L=[a/2+N[0],e/2+N[1]],P=G.translate(),M={x:P[0],y:P[1],k:G.scale()};M.x+=L[0];M.y+=L[1];G.translate([M.x,M.y]).scale(M.k);u();setTimeout(p,100)};function w(O){var R=1,L=[a/2,e/2],Q=G.scaleExtent(),S=G.translate(),P=[],N=[],M={x:S[0],y:S[1],k:G.scale()};d3.event.preventDefault();direction=(O==="zoomin")?2:0.5;R=G.scale()*direction;if(R<Q[0]||R>Q[1]){return false}P=[(L[0]-M.x)/M.k,(L[1]-M.y)/M.k];M.k=R;N=[P[0]*M.k+M.x,P[1]*M.k+M.y];M.x+=L[0]-N[0];M.y+=L[1]-N[1];i([M.x,M.y],M.k);setTimeout(p,350)}function K(P){var M=D.filter(function(Q){return Q.display}).map(function(Q){return Q.layer}),O="all";var L=d3.select(this);var N=P[2];this._xhr=d3.json("https://vector.mapzen.com/osm/"+O+"/"+N+"/"+P[0]+"/"+P[1]+".topojson?api_key=vector-tiles-9rqLeje",function(R,T){var Q=Math.pow(2,P[2])*256;g.projection().translate([Q/2-P[0]*256,Q/2-P[1]*256]).scale(Q/2/Math.PI).precision(0);var V={};for(var S in T.objects){V[S]=topojson.feature(T,T.objects[S])}var U=[];D.forEach(function(X){if(!X.display){return}var ab=X.layer;if(V[ab]){if(N<=13&&ab=="buildings"){return}var Y=d3.nest().key(function(ae){return ae.properties.kind}).entries(V[ab].features);for(var aa in Y){var ad=true;if(X.types.length){X.types.forEach(function(ae){if(ae.type==Y[aa].key){ad=ae.display}})}var ac=Y[aa].key;for(var Z in Y[aa].values){if(Y[aa].values[Z].properties.label_placement=="yes"){continue}if(Y[aa].values[Z].properties.kind=="path"||Y[aa].values[Z].properties.kind=="ferry"){continue}if(N<=14&&ab=="buildings"&&Y[aa].values[Z].properties.area<2000){continue}Y[aa].values[Z].layer_name=ab;Y[aa].values[Z].display=ad;U.push(Y[aa].values[Z])}}}});var W=L.selectAll("path").data(U.sort(function(Y,X){return Y.properties.sort_key?Y.properties.sort_key-X.properties.sort_key:0}));W.enter().append("path");W.exit().remove();W.attr("class",function(Y){var X=Y.properties.kind||"",X=X.replace("_","-");if(Y.properties.boundary=="yes"){X+="_boundary"}return Y.layer_name+"-layer "+X}).attr("d",g)})}setTimeout(function(){d3.selectAll(".mapui div").on("click",function(){w(d3.select(this).attr("id"))})},1000);k.name="streets";var d=[],o=[],y;var z=[],y=null;var m=$("#content");k.on("removed",function(){if(z.length==0){$("#scroll-down").fadeOut()}});function x(){}k.refresh=function(L){};k.add=function(Q,M,O,L){var N=parseFloat(Q);var P=parseFloat(M);d=[N];o=[P];z=[[P,N]];if(O==undefined){y=Q.toFixed(3)+", "+M.toFixed(3)}else{y=O[0].toUpperCase()+O.substr(1,O.length-1)}$("#place-title").text(y);$("#places").removeClass("inactive");$("#scroll-down").fadeIn();return k};k.remove=function(L){z.splice(L,1);d.splice(L,1);o.splice(L,1);if(z.length==0){$("#scroll-down").fadeOut()}};k.lats=function(){return d};k.lons=function(){return o};k.places=function(){return[y]};k.points=function(L){if(!arguments.length){return z}z=L;return k};k.locations=function(N){z=[];d=[];o=[];$.each(N,function(O,P){z.push([P.longitude,P.latitude]);d.push(P.latitude);o.push(P.longitude)});k.dirty=true;k.locationsSet();mesh.applyStyle(loadedMeshu.metadata);if(k.style()!=undefined){var L=k.style().translate.split(",").map(function(O){return parseFloat(O)}),M=parseFloat(k.style().scale);if($("body").hasClass("display")){L[0]+=200}else{if($("body").hasClass("postcard")){L[0]+=540;L[1]+=337.5}}G.scale(M).translate(L);u()}return k};k.hittest=function(L){return d3.event.target!=f.node()};k.updateTitle=function(L){y=L};k.outputTitle=function(){return y||"My Meshu"};k.bakeStyles=function(){var L=$(".streets path").css("stroke-width");d3.selectAll(".streets path").attr("stroke-width",L).attr("fill","none")};k.unBakeStyles=function(){d3.selectAll(".streets path").attr("stroke-width","")};k.outputG=function(){l();return $("#svg-download svg").html()};k.output=function(){l();return $("#svg-download").html()};k.id=function(){return n};return k};var sb=sb||{};sb.mesh.print=function(b,x,a,d){var j=sb.mesh.base(b,x,a,d),q=parseInt(Math.random()*10000000000,10);j.name="print";var w=$("body").hasClass("processing")||$("body").hasClass("display");var c=[],r=[],u=[],A=[],D=[],L=[];var h=document.createElement("div");var f=d3.select(b||"body").append("div").attr("id",q).style("width",a).style("height",d).style("position","absolute").style("z-index","1").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var K=f.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var o=d3.select(b||"body").append("div").attr("style","position:absolute;z-index:2;").style("width",a).style("height",d);var e=o.append("svg:svg").attr("width","100%").attr("height","100%");var F=e.append("svg:g").attr("class","delaunay-ui");var i=d3.select("#places");var s=i.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",j.removeInput)}$(b).append($("<div>").attr("class","route-error").text("Sorry, no route found! Try another mode?"));var G=[],l=[],v=[],B=null;var n=$("#content");j.hittest=function(g){return d3.event.target!=e.node()};j.on("draggedMap",function(){z()});j.on("draggedPoint",function(M,N){M[0]=N[0];M[1]=N[1];var g=G.indexOf(M);r[g]=N[0];c[g]=N[1];j.dirty=true;z()});var J=d3.geo.mercator().scale(1).translate([0,0]);var p=d3.geo.path().projection(J);var k;$.getJSON("/static/lib/world_borders.json",function(M){E(parseInt(a),parseInt(d));k=M.features;var g=d3.select(".map").selectAll("path").data(M.features);g.enter().append("path").attr("d",p).attr("class",function(N){return N.properties.ISO2}).style("fill","#bbb").style("stroke","#aaa").style("stroke-width","0");if(loadedMeshu){A.forEach(function(O,N){C(O,true)});$("#"+j.style().projection).click();$(".map-style").find("li[data-color="+j.style().mapStyle+"]").click();$(".dot-style").find("li[data-color="+j.style().dotColor+"]").click();$(".country-style").find("li[data-color="+j.style().countryStyle+"]").click()}else{j.style({mapStyle:"light",dotColor:"FF3FB4",countryStyle:"on"})}if(w){j.copyMap();mesh.applyStyle(loadedMeshu.metadata);H(j.style().projection,j.style().zoom,j.style().translate);t("meshu-container");m("meshu-container")}});j.copyMap=function(){var O=$(".projection-preview").empty();var R=$(".map").clone();var T=$(".delaunay").clone();var Q=$(".delaunay-ui").clone();if(w){$(".delaunay").remove();$(".delaunay-ui").remove()}R.find("rect").remove();var S=d3.select(R).node()[0];var P=d3.selectAll(".projection-preview");var N=P.append("defs");N.append("path").datum({type:"Sphere"}).attr("id","sphere-"+q);N.append("clipPath").attr("id","clip").append("use").attr("xlink:href","#sphere-"+q);P.append("g").attr("class","projection-clip").append("use").attr("class","fill").attr("xlink:href","#sphere-"+q);var M=d3.selectAll(".projection-preview").append("g").attr("class","map");O.find(".map").html(S);O.append(T);O.append(Q);P.selectAll("circle").attr("r",2);var g="zoomed-to-fit";$(".proj").each(function(){if($(this).hasClass("selected")){g=$(this).attr("id")}});H(g)};function H(O,N,g){var P,M=w?parseInt(a):575,U=w?parseInt(d):425;switch(O){case"mercator":P=d3.geo.mercator().scale(M/6.25).translate([M/2,U/2]);break;case"hammer":P=d3.geo.hammer().scale(M/6).translate([M/2,U/2]);break;case"august":P=d3.geo.august().scale(M/11.5).translate([M/2,U/2]);break;case"lagrange":P=d3.geo.lagrange().scale(M/5.57).translate([M/2,U/2]);break;case"eckert1":P=d3.geo.eckert1().scale(M/6).translate([M/2,U/2]);break;case"butterfly":P=d3.geo.polyhedron.butterfly().scale(M/8.45).translate([M/2,5*U/7]);break;case"zoomed-to-fit":E(M,U,0.85);P=J;break}var Q=d3.selectAll(".projection-preview").attr("class","projection-preview meshu-svg").classed(O,true);Q.style("background-color",(O=="zoomed-to-fit")?"#e7e7e7":"#bbb");var S=w?parseInt(a)/450:((O=="zoomed-to-fit")?3:2.5);Q.selectAll("circle").attr("r",S);var T=w?parseInt(a)/2500:1;var R=d3.geo.path().projection(P);var V=Q.select(".map").selectAll("path").data(k).attr("clip-path","url(#clip)").attr("d",R).attr("class",function(X){var W=d3.select("#meshu-container").select("."+X.properties.ISO2).classed("current");d3.select(this).style("fill",W?"white":"#bbb").style("stroke-width",W?T:"0");return W?(X.properties.ISO2+" current"):X.properties.ISO2});d3.selectAll(".projection-preview #sphere-"+q).attr("d",R);y("projection",P);y("design",P);if(w){J=P;y("meshu-container",J)}j.style({projection:O,scale:P.scale(),translate:P.translate()});t("design");m("design")}$(".proj").click(function(){$(".proj").removeClass("selected");$(this).addClass("selected");var g=$(this).attr("id");H(g)});$(".map-style li").click(function(){var g=$(this).attr("data-color");j.style({mapStyle:g});$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");t("design")});$(".dot-style li").click(function(){var g=$(this).attr("data-color");$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");j.style({dotColor:g});m("design")});$(".country-style li").click(function(){var g=$(this).attr("data-color");j.style({countryStyle:g});$(this).parent().find("li").removeClass("selected");$(this).addClass("selected");t("design")});$(".frame-wrapper").click(function(){if($(this).attr("id").split("-")[1]!=sb.materializer.product()){return}if($(this).hasClass("selected")){sb.materializer.material("unframed");sb.ui.orderer.updated();$(this).removeClass("selected")}else{sb.materializer.material("framed");$(".frame-wrapper").removeClass("selected");$(this).addClass("selected");sb.ui.orderer.updated()}});function t(M){var N=d3.select("#"+M+" .projection-preview");var P,Q,R,T,S;var g=j.style().mapStyle,O=j.style().countryStyle;switch(g){case"light":P="#e7e7e7";Q="#bbb";R="#fff";T="#aaa";S="#555";break;case"dark":P="#222";Q="#000";R="#333";T="#666";S="#aaa";break;case"no":P="#fff";Q="#fff";R="#e7e7e7";T="#e7e7e7";S="#000";break}if(j.style().projection=="zoomed-to-fit"){N.style("background-color",P)}else{N.style("background-color",Q)}N.select(".fill").attr("fill",P);N.select(".map").selectAll("path").style("fill",Q).style("stroke","none");if(O=="on"){N.select(".map").selectAll("path").filter(function(U){return(A.indexOf(U.properties.ISO2)!=-1||A.indexOf(U.properties.ISO3)!=-1)}).style("fill",R).style("stroke",T).each(function(){this.parentNode.appendChild(this)})}N.select(".delaunay").selectAll("path").style("stroke",S)}function m(g){d3.select("#"+g+" .projection-preview").selectAll("circle").style("fill","#"+j.style().dotColor)}j.addCountry=function(g){A.push(g);C(g,true)};function C(M,g){var N=d3.select(".map").selectAll("path").filter(function(O){return O.properties.ISO2==M||O.properties.ISO3==M}).classed("current",g).each(function(){this.parentNode.appendChild(this)}).style("fill",g?"white":"#bbb").style("stroke-width",g?"1":"0")}function E(M,P,R){J.scale(1).translate([0,0]);var Q=x.getExtent(),g=[J([Math.max(Q[0].lon,-180),Math.max(Q[0].lat,-90)]),J([Math.min(Q[1].lon,180),Math.min(Q[1].lat,90)])],O=Math.min(6000,(R?R:0.95)/Math.max((g[1][0]-g[0][0])/M,(g[1][1]-g[0][1])/P)),N=[(M-O*(g[1][0]+g[0][0]))/2,(P-O*(g[1][1]+g[0][1]))/2];if(M==600){if(O<100){$("#zoomed-to-fit").hide();$("#hammer").css("display","inline-block")}else{$("#zoomed-to-fit").show();$("#hammer").hide()}J.scale(O).translate(N);d3.select("#meshu-container").select(".map").selectAll("path").attr("d",p)}else{J.scale(O).translate(N);d3.selectAll(".projection-preview").select(".map").selectAll("path").attr("d",p)}}j.on("clickedMap",function(g){meshu.findCountry(g);j.add(g[1],g[0],undefined,false)});j.on("removed",function(){if(G.length<3){$("#finish-button").removeClass("active")}if(G.length==1){$("#meshu-container").addClass("inactive")}});function y(g,P){var N=d3.select("#"+g).select(".delaunay-ui");var O=d3.select("#"+g).select(".delaunay");var S=N.selectAll("circle").data(G);S.attr("cx",function(W){return P(W)[0]}).attr("cy",function(W){return P(W)[1]});var R=[];$.each(G,function(X,W){if(X==G.length-1){return}R.push({points:[G[X],G[X+1]],mode:L[X]})});var V=O.selectAll("path").data(R);var M=d3.scale.linear().domain([0,2600]).range([0.5,0.65]);V.enter().append("svg:path");V.exit().remove();V.attr("d",function(ac){var aa=ac.points.length;var ae=[];for(var ab=0;ab<aa;ab++){var af=P(ac.points[ab]);ae.push(af)}var Z=this;if(ac.mode=="air"){var ad=Math.sqrt(Math.pow(ae[0][0]-ae[1][0],2)+Math.pow(ae[0][1]-ae[1][1],2));return"M"+ae[0]+" A "+ad*M(ad)+" "+ad*M(ad)+" 0 0 0 "+ae[1]}else{if(ac.mode=="road"){var X=null;if(!loadedMeshu){D.forEach(function(ah,ag){if(ah.points[0][0]==ac.points[0][0]&&ah.points[1][1]==ac.points[1][1]){X=U(ah.wayPoints);return}});if(X=="undefined"){return""}else{if(X){return X}}}var Y="http://open.mapquestapi.com/directions/v1/route?generalize=500&outFormat=json&shapeFormat=raw&generalize=200&from=";var W=Y+ac.points[0][1]+","+ac.points[0][0]+"&to="+ac.points[1][1]+","+ac.points[1][0]+"&key="+mapquestapi;$.ajax({url:W,dataType:"jsonp",success:function(ah){var ag=[];if(ah.info.statuscode!=0){$(".route-error").fadeIn().delay(3000).fadeOut("slow");D.push({points:ac.points,wayPoints:ag});d3.select(Z).attr("d","")}else{ag=ah.route.shape.shapePoints;D.push({points:ac.points,wayPoints:ag});d3.select(Z).attr("d",U(ag))}}})}else{return"M"+ae[0]+" L"+ae[1]}}}).attr("class",function(W){return W.mode}).style("stroke","#555").style("stroke-width",function(W){return T(W.mode)}).style("stroke-dasharray",function(W){return Q(W.mode)});function T(X){if(w){var W=parseInt(a);return(W/600)}if(X=="air"){if(g=="meshu-container"){return 2}return 1.5}else{if(g=="meshu-container"){return 3}return 2.5}}function Q(X){if(X!="air"){return}if(w){var W=parseInt(a);return(W/300)+" "+(W/300)}if(g=="meshu-container"){return"4 4"}return"3 3"}function U(Y){var W=[];var ab=Y.length;for(var X=0;X<ab;X+=2){var Z=P([Y[X+1],Y[X]]);W.push(Z)}var aa="M"+W.join("L");return(Y.length==0)?"undefined":aa}}function z(){E(parseInt(a),parseInt(d));var O=F.selectAll("circle").data(G);O.enter().append("svg:circle").attr("id",function(Q,P){return"c-"+P}).attr("r",4).attr("fill","#FF3FB4").on("mousedown",function(P){j.dragging=P;d3.event.stopPropagation()});O.exit().remove();var M=s.selectAll("li.place").data(G);var g=M.enter().append("li").attr("class","place").attr("id",function(Q,P){return"p-"+P});var N=g.append("span").attr("class","mode");N.append("span").attr("class","origin").html("Origin:");N.append("span").attr("class","air selected");N.append("span").attr("class","rail");N.append("span").attr("class","road");N.selectAll("span").on("click",function(S,R){var Q=$(this.parentNode.parentNode).index()-1,P=d3.select(this).attr("class");L[Q]=P;y("meshu-container",J);$(this.parentNode).find("span").removeClass("selected");$(this).addClass("selected")});g.append("span").attr("class","place-text").html(function(Q,P){h.innerHTML=u[P];return h.firstChild.nodeValue});g.append("span").attr("class","place-delete").html("x");M.exit().remove();M.each(function(P){P.edit=false}).attr("id",function(Q,P){return"p-"+P}).select(".place-text").html(function(R,P){var Q=$(this).parent().attr("id").split("-")[1];h.innerHTML=u[Q];return h.firstChild.nodeValue});M.select(".mode").each(function(R,P){if(P==0){return}var Q=d3.select(this).selectAll("span");Q.classed("selected",false);Q.classed("selected",function(T,S){return $(this).attr("class")==L[P-1]})});I();y("meshu-container",J)}function I(){var M=s.selectAll("li.place");M.select(".place-delete").on("click",function(O,N){j.remove(N);x.updateBounds(c,r);z()});var g=0;if(!w){$("#places ul").sortable({axis:"y",cursor:"move",start:function(N,O){g=O.item.index()},stop:function(O,P){var N=P.item.index();if(g==N){return}u.splice(N,0,u.splice(g,1)[0]);G.splice(N,0,G.splice(g,1)[0]);c.splice(N,0,c.splice(g,1)[0]);r.splice(N,0,r.splice(g,1)[0]);A.splice(N,0,A.splice(g,1)[0]);g=0}});$("#places ul").disableSelection()}}j.add=function(R,N,P,g){var O=parseFloat(R);var Q=parseFloat(N);c.push(O);r.push(Q);x.updateBounds(c,r);if(P==undefined){u.push(R.toFixed(3)+", "+N.toFixed(3))}else{u.push(P)}if(G.length){$("#meshu-container").removeClass("inactive");l=[Q,O];L.push("air");if(g){G.push([l[0],l[1]]);z();y("meshu-container",J)}else{var M=G[G.length-1];G.push([l[0],l[1]]);z()}}else{G.push([Q,O]);z()}j.dirty=true;j.added();return j};j.remove=function(g){var M=A[g];G.splice(g,1);c.splice(g,1);r.splice(g,1);u.splice(g,1);A.splice(g,1);if(g==0){L.splice(g,1)}else{L.splice(g-1,1)}if(A.indexOf(M)==-1){C(M,false)}if(G.length<3){$("#finish-button").removeClass("active")}if(G.length==1){$("#meshu-container").addClass("inactive")}};j.lats=function(){return c};j.lons=function(){return r};j.places=function(){return u};j.points=function(g){if(!arguments.length){return G}G=g;return j};j.locations=function(M,g){mesh.applyStyle(loadedMeshu.metadata);A=j.style().countries.split(",");L=j.style().modes.split(",");G=[];c=[];r=[];u=[];$.each(M,function(N,O){G.push([O.longitude,O.latitude]);c.push(O.latitude);r.push(O.longitude);u.push(O.name)});j.locationsSet();if(w){d3.select(".map").attr("height","100%").select(".layer").remove();d3.select("#meshu-container").append("svg").attr("class","projection-preview").style("position","absolute").style("top","0")}return j};j.refresh=function(){z();j.refreshed()};j.updateTitle=function(g){B=g};j.outputTitle=function(){return B||"My Meshu"};j.output=function(){var N=$(".projection-preview").last().clone();N.find(".map").remove();var g=A.join(","),M=L.join(",");j.style({countries:g,modes:M});return new XMLSerializer().serializeToString(d3.select(N).node()[0])};j.getProjection=function(g){return J.invert(g)};return j};var sb=sb||{};var mapzenapi="search-HWoiFxs";var routingapi="valhalla-Gap3BYU";var mapquestapi="Fmjtd|luub2002n0,bx=o5-9urx5r";sb.meshu=function(n,w,j){var o={},u=$(n).width()+"px",p=$(n).height()+"px",z=j||sb.map(n,u,p),w=w||"facet";mesh=sb.mesh[w](n,z,u,p),searchError=$("#search-error"),loadingGif=$(".loading");o.offsetX=0;$(n).append("<div class='mapui'><div id='zoomin'></div><div id='zoomout'></div></div>");var s=(w=="print")?0.5:1;$("#zoomin").mousedown(function(B){z.map.zoom(z.map.zoom()+s);mesh.refresh("zoomed")});$("#zoomout").mousedown(function(B){z.map.zoom(z.map.zoom()-s);mesh.refresh("zoomed")});var a=$("#searchbox"),k=-1,l;a.keyup(function(C){searchError.fadeOut();var B=a.val();if(C.keyCode==8){l=null}if(!B.length){m()}else{if(C.keyCode==40){k=Math.min(k+1,$(".hit").length-1);d3.selectAll(".hit").classed("selected",function(F,D){if(D==k){var E=F.bbox?F.bbox:null;l=[F.geometry.coordinates,F.properties.label,E,F.properties.country_a]}return D==k});a.val($(".hit:eq("+k+")").text())}else{if(C.keyCode==38){k=Math.max(k-1,0);d3.selectAll(".hit").classed("selected",function(F,D){if(D==k){var E=F.bbox?F.bbox:null;l=[F.geometry.coordinates,F.properties.label,E,F.properties.country_a]}return D==k});a.val($(".hit:eq("+k+")").text())}else{if(C.keyCode==13){if(l){r(l[0],l[1],l[2],l[3]);m()}else{q(B)}}else{e(B)}}}}});$("#search-button").click(function(){var B=a.val();q(B)});function q(C){if(C.split("|").length>2){var B=C.split("|");for(var D=0;D<B.length;D++){setTimeout(function(E){return function(){y(E)}}(B[D]),D*1000)}}else{y(C)}}var d,t=false;function e(B){var C="https://search.mapzen.com/v1/autocomplete?text="+B+"&api_key="+mapzenapi;if(d){d.abort()}if(!t){d=d3.json(C,function(D){c(D.features)});t=true;setTimeout(function(){t=false},50)}}function c(C){if($("#searchbox").val()==""){C=[]}var D=d3.select("#autocomplete"),B=D.selectAll(".hit").data(C);B.enter().append("div").attr("class","hit");B.exit().remove();B.text(function(E){return E.properties.label}).on("click",function(F){var E=F.bbox?F.bbox:null;r(F.geometry.coordinates,F.properties.label,E,F.properties.country_a);m()})}function m(){k=-1;l=null;if(d){d.abort()}a.val("");c([])}o.findCountry=function(C){var B="http://open.mapquestapi.com/geocoding/v1/reverse?key="+mapquestapi+"&location="+C[1]+","+C[0];$.ajax({url:B,cache:false,crossDomain:false,dataType:"json",error:function(D,F,E){console.log(E)},success:function(E){var D=E.results;if(typeof D=="undefined"||D[0].locations.length==0){return}else{if(D.length){var F=D[0].locations[0];mesh.addCountry(F.adminArea1)}}}})};function y(B){if(B=="add a city, place, or address"){return}if(B.split(",").length==2&&Number(B.split(",")[0])&&Number(B.split(",")[1])){mesh.add(B.split(",")[0],B.split(",")[1],B);o.updateBounds();return}var D=B;var C="https://search.mapzen.com/v1/search?text="+D+"&api_key="+mapzenapi;m();$.ajax({url:C,cache:false,crossDomain:false,dataType:"json",beforeSend:function(){loadingGif.show()},error:function(E,G,F){console.log(F)},success:function(F){var E=F.features;loadingGif.hide();if(typeof E=="undefined"||E[0].geometry.length==0){searchError.fadeIn();a.focus();return}else{if(E.length){var G=E[0].bbox?E[0].bbox:null;r(E[0].geometry.coordinates,B,G,E[0].properties.country_a)}}}})}function r(E,B,D,C){switch(mesh.name){case"facet":case"orbit":mesh.add(E[1],E[0],B);o.updateBounds();if(mesh.points().length==1){f(E.geocodeQuality)}break;case"print":mesh.add(E[1],E[0],B);o.updateBounds();mesh.addCountry(C);if(mesh.points().length==1){f(12)}break;case"streets":mesh.zoomTo(E,D);mesh.add(E[1],E[0],B);z.map.center({lat:E[1],lon:E[0]});break;case"radial":f(12,12);mesh.add(E[1],E[0],B);break}}function i(B){switch(B){case"POINT":case"ADDRESS":case"INTERSECTION":case"STREET":return 14;case"ZIP":case"ZIP_EXTENDED":return 13;case"CITY":return 12;case"COUNTY":return 10;case"STATE":case"REGION":return 6;case"COUNTRY":return 4;default:return 12}}function f(D,B){var C=Math.max(B||4,i(D));if(C!=z.map.zoom()){z.map.zoom(C)}}o.locations=function(B,D){for(var C=0;C<B.length;C++){if(D){mesh.add(B[C].latitude,location[C].longitude,B[C].name)}else{setTimeout(function(E){return function(){mesh.add(E.latitude,E.longitude,E.name);o.updateBounds()}}(B[C]),C*400)}}if(D){o.updateBounds()}};function b(G,I){var B=G.split("|");var F=[],D={};for(var E=0;E<B.length;E++){var C=B[E].split("\t");if(C.length<3){continue}if(I){var H=C[0]+"-"+C[1];if(D[H]){continue}else{D[H]=true}}F.push({latitude:parseFloat(C[0]),longitude:parseFloat(C[1]),name:C[2]})}return F}o.initializeFromData=function(E,D,C){mesh.prerender(C);var B=b(E,(D.length<20));mesh.locations(B,E);if(D){mesh.applyStyle(D)}return o};o.mesh=function(){return mesh};o.map=function(){return z};var h=0,g=1,x=0,v=0;var A;o.animateTransform=function(G,F,D,B){if(A){clearInterval(A)}var C=0;var E=d3.select(".delaunay");A=setInterval(function(){if(++C<30){h+=(G-h)*0.33;g+=(F-g)*0.5;x+=(D-x)*0.5;v+=(B-v)*0.5;var H="rotate("+h+", 300, 300)";var J="scale("+g+")";var I="translate("+x+","+v+")";E.attr("transform",J+I+H)}else{clearInterval(A)}},40)};o.refreshWithBounds=function(C,B){z.updateBounds(C,B,o.zoomOffset,o.offsetX)};o.updateBounds=function(){if(mesh.dirty){o.refreshWithBounds(mesh.lats(),mesh.lons());mesh.dirty=false}};z.on("boundsUpdated",function(){if(mesh.updatePixelBounds){mesh.updatePixelBounds()}mesh.refresh()});mesh.on("locationsSet",o.updateBounds);o.getFrame=function(){return n};o.getRenderer=function(){return w};o.updateTitle=function(B){mesh.updateTitle(B)};o.outputTitle=function(){return mesh.outputTitle()};o.outputG=function(){return mesh.outputG()};o.outputSVG=function(){return mesh.output()};o.outputMapSVG=function(){return $(z.map.container()).html()};o.hideMesh=function(){return o};o.showMesh=function(){return o};o.outputLocationData=function(){var B=[];var D=mesh.places(),E=mesh.lats(),C=mesh.lons();$.each(D,function(G){var F=E[G]+"\t"+C[G]+"\t"+D[G];B.push(F)});return B.join("|")};o.xhr=function(){return{xhr:"true",title:o.outputTitle(),svg:o.outputSVG(),location_data:o.outputLocationData(),renderer:mesh.name,metadata:mesh.outputStyle()}};return o};var sb=sb||{};sb.rasterizer=function(){var h=d3.dispatch("rasterized","rasterizedThumbnail"),e=false,g=[];var d=function(k,l){var j=document.createElement("canvas");j.width=600;j.height=600;j.style.position="absolute";j.style.top="0";j.style.left="0";$(j).addClass("hidden");if(!l){g.push(j)}return j};var c=function(j,k){j.fillStyle="rgba(255, 255, 255, "+k+")";j.fillRect(0,0,j.width,j.height);j.fill()};var i=function(j){var k=new XMLSerializer();return k.serializeToString(j)};var b=function(k){var m=k.map().map,l=m.zoom(),j=Math.round(l);if(l!=j){m.zoom(j);k.mesh().refresh()}};var f=function(m,l,j,k,o){var n=d();m.appendChild(n);k.mesh().bakeStyles();canvg(n,k.outputSVG(),{renderCallback:function(){k.mesh().unBakeStyles();j.drawImage(n,0,0,l.width,l.height);var p=new Image();p.onload=function(){j.drawImage(p,l.width-130,l.height-35,117,22);a(m,l,k,o)};p.src="/static/images/logo_io.png"}})};var a=function(m,k,j,n){var l=j.xhr();l.csrfmiddlewaretoken=$("#csrf input").val();l.dataurl=k.toDataURL();if(j.id){l.id=j.id}h.clearCanvases();$.post("to_png",l,function(p){var o=document.createElement("img");o.src=p.image_url;$(o).addClass("hidden");m.appendChild(o);h.generated=true;h.rasterized(p);if(n){n(p)}},"json")};h.clearCanvases=function(){while(g.length){var j=g.pop();$(j).remove()}};h.rasterize=function(l,o){b(l);var k=d(),n=l.getFrame(),j=k.getContext("2d"),m=i(l.map().map.container());n.appendChild(k);canvg(k,m,{renderCallback:function(){c(j,0.7);f(n,k,j,l,o);h.clearCanvases()}})};h.thumbnail=function(l,o){l.mesh().bakeStyles();var k=d(),n=l.getFrame(),j=k.getContext("2d"),m=l.mesh().name=="streets"?l.outputG():l.outputSVG();n.appendChild(k);canvg(k,m,{renderCallback:function(){l.mesh().unBakeStyles();if(o){o(k)}}})};h.ringPreview=function(s,q){s.mesh().bakeStyles();if(s.mesh().points().length<3){return}var l=s.mesh().getLongestRotation(),p=s.mesh().projectPoints(l),n=500,r=110,m=10;s.mesh().transformedDelaunay(p,n,r-m,m/2);var k=d("ring-canvas",true),j=s.getFrame(),t=k.getContext("2d"),o=s.outputSVG();j.appendChild(k);canvg(k,o,{renderCallback:function(){s.mesh().unBakeStyles();s.mesh().refresh();d3.select("#delaunay-ui").attr("transform","translate(0,0) scale(1) rotate(0,300,300)");d3.select("#ring-img").style("display","none");d3.selectAll(".ring-canvas").remove();var y=40,x=0,w;if(typeof document.getCSSCanvasContext!="function"){w=d3.select("#ring-preview-canvas").node().getContext("2d");$(".strip div").css("background-image","-moz-element(#ring-preview-canvas)")}else{w=document.getCSSCanvasContext("2d","ring-preview",n,r+x+y)}var u=$("body").hasClass("chrome");w.clearRect(0,0,n,r+x+y);w.fillStyle="rgba(255, 255, 255, "+(u?1:0.8)+")";w.fillRect(0,0,n,r+x+y);w.drawImage(k,0,0,n,r,0,x,n,r);if(u){var v=d3.select("#ring-preview-canvas").node().toDataURL("image/jpeg");$(".strip div").css("background-image","url("+v+")")}if(q){q(k)}}})};return h}();sb.transforms={earrings:{product:{scale:0.17,transform:{x:195,y:165}},render:{scale:0.45,transform:{x:530,y:450}}},pendant:{product:{scale:0.125,transform:{x:155,y:205}},render:{scale:0.25,transform:{x:900,y:1375}}},dense_pendant:{product:{scale:0.125,transform:{x:155,y:205}},render:{scale:0.25,transform:{x:900,y:1375}}},necklace:{product:{scale:0.22,transform:{x:150,y:210}},render:{scale:0.4,transform:{x:450,y:750}}},cufflinks:{product:{scale:0.14,transform:{x:160,y:210}},render:{scale:0.4,transform:{x:450,y:750}}},coasters:{product:{scale:0.4,transform:{x:150,y:150}},render:{scale:0.4,transform:{x:450,y:750}}},ring:{product:{scale:0.5,transform:{x:150,y:150}},render:{scale:0.4,transform:{x:450,y:750}}},small_poster:{product:{scale:0.1,transform:{x:150,y:150}}},medium_poster:{product:{scale:0.25,transform:{x:150,y:150}}},large_poster:{product:{scale:0.35,transform:{x:150,y:150}}}};sb.transforms.getTransform=function(e,d,c){var b=sb.transforms[e][d];var a="translate("+b.transform.x+","+b.transform.y+") scale("+b.scale+")";if(c!=undefined){a=a+"rotate("+c+")"}return a};sb.transforms.getOrientation=function(c){var a={},e=meshu.mesh(),b=e.projectPoints(e.getLongestRotation()),d=b.width/b.height;a.width=450;a.rotation=-e.getRotationAngle();switch(c){case"small_poster":case"medium_poster":case"large_poster":a.height=450/d;break;case"cufflinks":a.height=400;break;case"necklace":a.height=450/d;if(d>2){a.height=(450/d)*1.5;a.rotation=0}break;case"ring":a.height=150;a.rotation=0;break;case"earrings":case"pendant":default:a.height=450/d;if(d>2){a.height=(450/d)*2;a.rotation=90}break}return a};sb.transforms.getDefaultRotation=function(c){var e=meshu.mesh(),b=-e.getRotationAngle();switch(c){case"cufflinks":return b;case"earrings":case"pendant":var a=e.projectPoints(e.getLongestRotation()),d=a.width/a.height;return d>2?b+90:b;case"necklace":var a=e.projectPoints(e.getLongestRotation()),d=a.width/a.height;return d>2?0:b;default:return b}};var sb=sb||{};$(function(){sb.product=function(){var a={};var b=[];a.initialize=function(d,c){b=c.getProducts();for(var e=0;e<b.length;e++){var f=b[e];a.resetPreviewImage(f.type);if(typeof d=="string"){a.previewFromSelector(f.type,d,"#preview-"+f.type)}else{a.previewFromElement(f.type,d)}}};a.resetPreviewImage=function(d){var c=d3.select("#preview-"+d);c.select(".product-transformer").remove()};a.previewFromSelector=function(h,g,c){var i=d3.select(c).append("g").attr("class","product-transformer"),j=meshu.mesh(),f=j.projectPoints(j.getLongestRotation()),d=sb.transforms.getOrientation(h),e=sb.transforms.getTransform(h,"product");j.transformedDelaunay(f,d.width,d.height);a.cloneSVG(i[0],g,d.width,d.height);i.attr("transform",e+" rotate("+d.rotation+")");j.refresh();return i};a.cloneSVG=function(f,d,c,e){var g=$(d).clone().attr("class","product-delaunay").attr("transform","translate(-"+c/2+", -"+e/2+")");$(f).append(g)};a.previewFromElement=function(l,e){var h=d3.select("#preview-"+l),c=sb.transforms.getTransform(l,"product");if($("body").hasClass("streets")){var n=e.getContext("2d");var m=0;var d=n.getImageData(0,0,n.canvas.width,n.canvas.height).data;for(var f=3;f<d.length;f+=4){if(d[f]>0){m++}}var k=m/(n.canvas.width*n.canvas.height);d3.select("#product-preview").classed("dense",k>0.33);if($(".wrapper.selected")){$(".wrapper.selected").click()}d3.select("#wrapper-"+l).select(".product-transformer").attr("src",e.toDataURL())}else{var j=h.append("g").attr("class","product-transformer").attr("transform",c);j.append("svg:image").attr("x",0).attr("y",0).attr("width","600px").attr("height","600px").attr("class","product-delaunay").attr("transform","translate(-300, -300)").attr("xlink:href",e.toDataURL())}};return a}()});var sb=sb||{};$(function(){sb.rotator=function(c,h,f){var k=d3.dispatch("rotated","ringSizeUpdated");var j=0,b=0,g="scale(.125) translate(380, 670) ",d,a;k.update=function(n){$(c).empty();a=n;if(meshu.getRenderer()=="facet"){b=meshu.mesh().getRotationAngle();j=b+sb.transforms.getDefaultRotation(a)}var m=d3.select(c);var o=m.append("svg:image").attr("id","previewImage").attr("x",0).attr("y",0).attr("width",313).attr("height",297).attr("xlink:href",k.getImage(a));d=sb.product.previewFromSelector(a,h,c)};var e=0,i;function l(n){if(i){clearInterval(i)}e=j;j=(j+n);var m=0;i=setInterval(function(){if(++m<30){e+=(j-e)*0.15;var o=sb.transforms.getTransform(a,"product",e-b);d.attr("transform",o)}else{clearInterval(i)}},40)}$("#rotate-cw").click(function(){l(22.5);k.rotated()});$("#rotate-ccw").click(function(){l(-22.5);k.rotated()});k.updateRing=function(){var m=$("#final-ring .frame").empty();var n=$(".ring-preview-frame").clone();$(m).append(n);var o=d3.scale.linear().domain([4,14]).range([0.8,1.2]);$("#ring-range").change(function(r){var p=r.currentTarget.value;$("#ring-number").text(p);k.ringSizeUpdated(p);sb.ui.orderer.updated();var q=o(p);n.css({"-moz-transform":"rotateX(15deg) rotateY(0deg) rotateZ(45deg) translate3d(0px,0px,0px) scale("+q+")","-webkit-transform":"rotateX(15deg) rotateY(0deg) rotateZ(45deg) translate3d(0px,0px,0px) scale("+q+")"})})};k.getTransform=function(m){return sb.transforms.getTransform(m,"product",j)};k.getImage=function(m){return static_url+"images/preview/preview_"+m+".png"};k.getRotation=function(){if(!j||j==NaN){j=0}return(j)%360};k.getBaseRotation=function(){return b};return k}("#rotate",".delaunay",".hidden")});var sb=sb||{};sb.materializer=function(){var c=d3.dispatch("update"),a,e,d,b;c.initialize=function(f){a=f;c.materials=$("#material-list");c.materials.find("li").live("click",function(i){var h=i.currentTarget.id.split("-");c.material(h[1]);c.color(h[0]);var g=$(this);g.parent().find("li").removeClass("selected");g.addClass("selected");sb.ui.orderer.updated()})};c.product=function(g){if(!arguments.length){return e}e=g;var f=a.getMaterials(g);$.each(c.materials.find("li"),function(j,h){var k=$(this).attr("id");if(f[k]){$(h).removeClass("inactive").find(".price").text("$"+f[k]);$(h).find(".img-wrapper").attr("class","img-wrapper "+g)}else{$(h).addClass("inactive").removeClass("selected").find(".price").text("");$(h).find(".img-wrapper").attr("class","img-wrapper")}});return c};c.material=function(f){if(!arguments.length){return d}if(f=="reset"){d=null}else{d=f}return c};c.color=function(f){if(!arguments.length){return b}b=f;c.update();return c};return c}();var saver=function(){var b={},f="#meshu-id";function e(){var g=b.meshu.xhr();g.csrfmiddlewaretoken=$("#csrf input").val();return g}function d(g){if(!g){return}b.meshu.id=g;if($(f).length==0){$("#hidden-form-values").append('<input type="hidden" id="meshu-id" name="meshu_id" />')}$(f).val(g)}function a(){var g=e();if($(f).length){g.id=b.getMeshuID()}$.post("/make/assign/",g,function(h){d(h.meshu_id);if(b.postAssignCallback){b.postAssignCallback(h)}},"json")}function c(){var g=e();if($(f).length){g.id=b.getMeshuID()}console.log(g,"creating new meshu");$.post("/make/create/",g,function(h){d(h.meshu_id);if(b.postCreateCallback){b.postCreateCallback(h)}},"json")}b.initialize=function(h){b.meshu=h;$("#cancel-button").click(function(){window.location.href=loadedMeshu.view_url});var i="#save-button";$(i).click(function(){if(!loadedMeshu){return}$(i).html("saving");var j=loadedMeshu.edit_url+"save";$.post(j,e(),function(k){d(k.meshu_id);setTimeout(function(){$(i).html("saved!")},200);setTimeout(function(){window.location.href=k.meshu_url},1000)},"json")});var g="#update-button";$(g).click(function(){if(!loadedMeshu){return}$(g).html("updating");var j=loadedMeshu.edit_url+"update";$.post(j,e(),function(k){d(k.meshu_id);setTimeout(function(){$(g).html("saved!")},200);setTimeout(function(){window.location.href=k.meshu_url},1000)},"json")});return b};b.initializeNewMeshu=function(g){b.meshu=g;return b};b.createOrUpdateMeshu=function(g){if(b.meshu.username&&b.meshu.username=="guest"){a();if(g){b.postAssignCallback=g}}else{c();if(g){b.postCreateCallback=g}}return b};b.updateMeshuData=function(g){d(g.id);b.meshu.view_url=g.view_url;b.meshu.username=g.username;b.meshu.title=g.title;if(g.image_url){b.meshu.image_url=g.image_url}};b.getMeshuID=function(){return $(f).val()};return b}();var sb=sb||{};sb.ui=sb.ui||{};sb.ui.orderer=function(){var d=d3.dispatch("updated"),e=null,b=null,f={};d.on("updated",function(){c();a()});d.initialize=function(i,j){e=i,b=j;$("#postcard-note-form").keyup(function(l){var k=l.target.value;$("#postcard-note").val(k)});$("#save-and-view").click(function(){var k=function(){saver.createOrUpdateMeshu(function(l){window.location.href=l.meshu_url})};if(!user.loggedIn){h();user.afterLogIn=k}else{k()}});$("#add-to-cart").click(function(){d.updated();$("#order-form")[0].submit()})};function g(){if(!user.loggedIn){h(g);return}d.updated();d.validated();return false}function h(i){user.showModal();user.afterLogIn=function(){if(i){saver.createOrUpdateMeshu(function(){setTimeout(i,200)})}}}function c(){var l=sb.materializer.product(),j=sb.materializer.material(),i=sb.materializer.color(),k=b.getPrice(l,j)*100;$("#object-type").val(l);$("#object-material").val(j);$("#object-color").val(i?i.toLowerCase():"");$("#object-amount").val(k);$("#svg-theta").val(sb.rotator?sb.rotator.getRotation():0);$("#svg-file").val(e.outputSVG());$("#meshu-data").val(e.outputLocationData());$("#meshu-title").val(loadedMeshu?loadedMeshu.title:e.outputTitle());$("#meshu-renderer").val(e.mesh().name);$("#meshu-metadata").val(e.mesh().outputStyle());$("#postcard-note").val($("#postcard-note-form").val());$("#order-metadata").val(d.outputMetadata())}function a(){var p=sb.materializer.product(),n=sb.materializer.material(),k=sb.materializer.color(),m=b.getPrice(p,n),o=e.mesh().name,q=$("#review");var r=sb.rotator?sb.rotator.getRotation()-sb.rotator.getBaseRotation():0;if(o!="print"&&p&&p.split("_")[1]=="poster"){r=sb.transforms.getOrientation(p,"product").rotation}var i="translate(75, 75) scale(.25) rotate("+r+")";var j=$("#product-preview .selected .product-transformer").clone().attr("class","review-delaunay").attr("transform",i);q.find(".review-svg").empty().append(j);if(p){if(p=="ring"){var s=sb.ui.orderer.metadata().ringSize?sb.ui.orderer.metadata().ringSize:"<span class='inactive'>not chosen</span>";q.find(".review-product").removeClass("inactive").html(p+" — size "+s)}else{var l=p.replace("_"," ");if(l.indexOf("Dense")!=-1){l=l.split(" ")[1]}q.find(".review-product").removeClass("inactive").text(l)}}if(k&&n){q.find(".review-material").removeClass("inactive").text(sb.materializer.color()+" "+n)}else{q.find(".review-material").addClass("inactive").text("not chosen")}if((p&&k&&n)||(o=="print"&&p)){q.find(".review-price").html("<span class='dollar'>$</span>"+m+".00");q.find(".review-make-time").text(b.getMakeTime(n));if(o=="facet"&&j.children().length||o=="radial"&&$(".meshu-svg .radial").children().length||o=="print"||o=="orbit"||o=="streets"){if(p=="ring"&&!sb.ui.orderer.metadata().ringSize){return}q.find("#add-to-cart").removeClass("inactive")}}else{q.find(".review-price").text("");q.find(".review-make-time").text("");q.find("#add-to-cart").addClass("inactive")}}d.metadata=function(k){if(!arguments.length){return f}for(var j in k){f[j]=k[j]}};d.clearMetadata=function(i){if(f[i]){delete f[i]}};d.outputMetadata=function(){var k=[];for(var j in f){k.push(j+":"+f[j])}return k.join("|")};return d}();var sb=sb||{};sb.ui=sb.ui||{};sb.ui.socialsharer=function(b){$(".share-facebook").click(function(){if(!sb.rasterizer.generated){sb.rasterizer.rasterize(b,a)}else{a()}});$(".action-button").click(function(){var d=this;if(!sb.rasterizer.generated){sb.rasterizer.rasterize(b,function(e){d.click()});return false}});sb.rasterizer.on("rasterized",function(d){saver.updateMeshuData(d);c();$(".social-media").fadeIn()});var c=function(f){var h="https://twitter.com/intent/tweet?text=";var j="http://pinterest.com/pin/create/button/?url=";var e="http://"+window.location.host;var i=e+b.image_url;var d=encodeURIComponent(e+b.view_url);var g;switch(b.getRenderer()){case"radial":g="Take a look at this radial I just made of a place I've been";break;case"facet":default:g="Take a look at this meshu I just made of the places I've been";break}$(".share-pinterest").attr("href",j+d+"&media="+i);$(".share-twitter").attr("href",h+g+"&url="+d)};var a=function(){var d="http://"+window.location.host;FB.ui({method:"feed",link:d+b.view_url,picture:d+b.image_url,name:b.title+" on meshu.io",caption:"",description:""},function(e){if(!e||e.error){}else{}})}};var sb=sb||{};sb.viewhandler=function(){var b=d3.dispatch("updated","next","prev");var a=["edit","product","make","add-ons","checkout","review"];var e=$("#content");$("#content").waypoint(function(){$("body").addClass("scrolled")},{offset:10});$("#edit").waypoint(function(f){if(f=="down"){c()}else{d()}},{offset:function(){return -70}});$("#add-ons").waypoint(function(f){if(f=="down"){sb.ui.orderer.updated()}},{offset:"bottom-in-view"});function c(){var f=b.view();var g=a.indexOf(f);var h=function(){e.attr("class",a[g+1])};b.next();h()}function d(){var f=b.view();var g=a.indexOf(f);var h=a[g-1];e.attr("class",h);b.prev()}b.view=function(f){if(!arguments.length){return e.attr("class")}var g=a.indexOf(f);if(g!=-1){e.attr("class",a[g]);view=f}};return b}();$(function(){var h=$("html").hasClass("svg");var d=loadedMeshu?loadedMeshu.renderer:"facet";$("body").hasClass("radial")?"radial":"facet";if($("body").hasClass("radial")){d="radial"}else{if($("body").hasClass("print")){d="print"}else{if($("body").hasClass("orbit")){d="orbit"}else{if($("body").hasClass("streets")){d="streets"}}}}var a=sb.catalog(d);sb.materializer.initialize(a);meshu=sb.meshu($("#meshu-container")[0],d);meshu.zoomOffset=window.location.href.search("postcard")>0?-0.25:0;sb.ui.orderer.initialize(meshu,a);if(loadedMeshu){saver.initialize(meshu);saver.updateMeshuData(loadedMeshu);user.updateLogoutActions(pageType);switch(pageType){case"view":sb.ui.socialsharer(meshu);if(h){meshu.map().buffer(0)}break}if(h){meshu.initializeFromData(loadedMeshu.location_data,loadedMeshu.metadata,loadedMeshu.svg)}if(pageType!="postcard"&&pageType!="print"){b()}$("#meshu-container").removeClass("inactive");var g=loadedMeshu.location_data.split("|");$.each(g,function(k,m){var l=m.split("\t");if(l.length==3){var n=document.createElement("div");n.innerHTML=l[2];var j=n.firstChild.nodeValue;$("<li>").html(j).appendTo($("#display-places"))}});d3.select("#places").attr("class","").select("#place-title").attr("class","").select(".title-text").html(function(i){i.title=loadedMeshu.title;meshu.updateTitle(i.title);return i.title})}else{saver.initializeNewMeshu(meshu)}sb.viewhandler.on("next",e);sb.viewhandler.on("prev",f);var c=false;if(!user.loggedIn&&!loadedMeshu&&window.location.hash!="#skipintro"){$(".tooltip").each(function(j,k){setTimeout(function(){if(!c){$(k).fadeIn()}},j*1000)});$(document).click(function(){c=true;$(".tooltip").fadeOut()})}$("#product-preview .wrapper").live("click",function(){var l=$(this);l.parent().find(".wrapper").removeClass("selected");l.addClass("selected");var k=l.attr("id").split("-")[1];var j=sb.materializer.material(),i=sb.materializer.color();if(!(i+"-"+j in a.getMaterials(k))){sb.materializer.material("reset")}if(d=="print"){if(k!=sb.materializer.product()){$(".frame-wrapper").removeClass("selected").removeClass("possible")}$("#frame-"+k).addClass("possible");sb.materializer.material("unframed")}else{if(k.split("_")[1]=="poster"){$("#materials").fadeOut();$("#add-ons").fadeOut();$(".print-hide").fadeOut();sb.materializer.material("unframed");sb.materializer.color("null")}else{$("#materials").fadeIn();$("#add-ons").fadeIn();$(".print-hide").fadeIn()}}switch(k){case"small_poster":case"medium_poster":case"large_poster":case"cufflinks":$("#final-rotate").hide();$("#final-ring").hide();sb.ui.orderer.clearMetadata("ringSize");break;case"ring":$("#final-rotate").hide();$("#final-ring").show();sb.rotator.on("ringSizeUpdated",function(m){sb.ui.orderer.metadata({ringSize:m})});sb.rotator.updateRing();break;default:$("#final-rotate").show();$("#final-ring").hide();if(d=="facet"||d=="orbit"){sb.rotator.update(k);sb.rotator.on("rotated",function(){sb.ui.orderer.updated()})}sb.ui.orderer.clearMetadata("ringSize");break}if($("#product-preview").hasClass("dense")&&k=="pendant"){k="dense_pendant"}sb.materializer.product(k);sb.ui.orderer.updated()});function b(){if(meshu.mesh().name=="facet"){sb.product.initialize(".delaunay",a);var i=$("body").hasClass("ie9")||$("body").hasClass("ie10");if(!i){sb.rasterizer.ringPreview(meshu)}}else{if(meshu.mesh().name=="radial"||meshu.mesh().name=="streets"){sb.rasterizer.thumbnail(meshu,function(j){sb.product.initialize(j,a)})}else{if(meshu.mesh().name=="orbit"){sb.product.initialize(".delaunay",a)}}}}function e(){var i=sb.viewhandler.view();switch(i){case"edit":meshu.updateBounds();meshu.mesh().interactive(true);if(d=="print"){meshu.mesh().copyMap()}b();break;case"make":meshu.mesh().interactive(false);break}}function f(){var i=sb.viewhandler.view();switch(i){case"edit":meshu.mesh().interactive(true);break}}$(".show-places").click(function(){$("#display-places").slideToggle();$(".show-places").toggle()})});