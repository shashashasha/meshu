var sb=sb||{};$(function(){sb.product=function(){var a={};var b=[];a.initialize=function(d,c){b=c.getProducts();for(var e=0;e<b.length;e++){var f=b[e];a.resetPreviewImage(f.type);if(typeof d=="string"){a.previewFromSelector(f.type,d,"#preview-"+f.type)}else{a.previewFromElement(f.type,d)}}};a.resetPreviewImage=function(d){var c=d3.select("#preview-"+d);c.select(".product-transformer").remove()};a.previewFromSelector=function(h,g,c){var i=d3.select(c).append("g").attr("class","product-transformer"),j=meshu.mesh(),f=j.projectPoints(j.getLongestRotation()),d=sb.transforms.getOrientation(h),e=sb.transforms.getTransform(h,"product");j.transformedDelaunay(f,d.width,d.height);a.cloneSVG(i[0],g,d.width,d.height);i.attr("transform",e+" rotate("+d.rotation+")");j.refresh();return i};a.cloneSVG=function(f,d,c,e){var g=$(d).clone().attr("class","product-delaunay").attr("transform","translate(-"+c/2+", -"+e/2+")");$(f).append(g)};a.previewFromElement=function(l,e){var h=d3.select("#preview-"+l),c=sb.transforms.getTransform(l,"product");if($("body").hasClass("streets")){var n=e.getContext("2d");var m=0;var d=n.getImageData(0,0,n.canvas.width,n.canvas.height).data;for(var f=3;f<d.length;f+=4){if(d[f]>0){m++}}var k=m/(n.canvas.width*n.canvas.height);d3.select("#product-preview").classed("dense",k>0.33);if($(".wrapper.selected")){$(".wrapper.selected").click()}d3.select("#wrapper-"+l).select(".product-transformer").attr("src",e.toDataURL())}else{var j=h.append("g").attr("class","product-transformer").attr("transform",c);j.append("svg:image").attr("x",0).attr("y",0).attr("width","600px").attr("height","600px").attr("class","product-delaunay").attr("transform","translate(-300, -300)").attr("xlink:href",e.toDataURL())}};return a}()});