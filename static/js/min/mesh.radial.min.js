var sb=sb||{};sb.mesh.radial=function(o,H,s,q){var p=sb.mesh.base(o,H,s,q),v=parseInt(Math.random()*10000000000,10),j=["a","b","c","d"];p.name="radial";var C=[],m=[],b;var i=document.createElement("div");var h=d3.select(o||"body").append("div").attr("id",v).style("width",s).style("height",q).style("position","absolute").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var f=h.append("svg:g").attr("class","delaunay");f.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var D=f.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");f.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var B=h.append("svg:g").attr("class","hidden");B.append("svg:path");var n=d3.select(o).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var G=d3.select("#place-title").attr("class","inactive");G.append("span").attr("class","title-text");G.append("span").attr("class","title-edit").html("edit");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",p.removeInput)}$("#radial-knockout").click(function(){p.style({drawStyle:"knockout"})});$("#radial-frame").click(function(){p.style({drawStyle:"outline"})});var A=[],a=[],u=[],y=[],t=[],d={},b=null;var x=$("#content");d3.select(n.node()).on("mouseover",J).on("mouseout",F);var c;function J(){c=setTimeout(function(){$(".map-hint").fadeIn()},500)}function F(){clearTimeout(c);$(".map-hint").fadeOut()}p.hittest=function(g){return d3.event.target!=n.node()};p.on("draggedMap",function(){k()});p.on("clickedMap",function(g){p.add(g.lat,g.lon,undefined,false)});p.on("removed",function(){if(A.length==0){$("#finish-button").removeClass("active")}});p.on("styled",function(g){if(g.drawStyle){switch(g.drawStyle){case"knockout":$("body").addClass("knockout");$(this).addClass("active");$("#radial-frame").removeClass("active");break;case"outline":default:$("body").removeClass("knockout");$(this).addClass("active");$("#radial-knockout").removeClass("active");break}}if(g.zoom){if(g.zoom!=H.map.zoom()){H.map.zoom(g.zoom)}}});function e(g){var K=f.selectAll("circle");K.attr("cx",function(L){return H.l2p({lat:L[1],lon:L[0]}).x}).attr("cy",function(L){return H.l2p({lat:L[1],lon:L[0]}).y})}function l(){var g=D.selectAll("path").data(u);g.enter().append("svg:path");g.exit().remove();g.attr("d",function(K){return w(K.pts)});g.attr("stroke","black").attr("fill","none").attr("stroke-linecap","round");g.attr("stroke-width",function(L,K){return 20*((1-Math.pow(L.d,0.5))+0.1)+"px"});g.style("stroke-width",function(L,K){return 20*((1-Math.pow(L.d,0.5))+0.1)+"px"})}function w(N){var g=[];var K=N.length;for(var L=0;L<K;L++){var O={lat:N[L][0],lon:N[L][1]};var M=H.l2p(O);g.push([M.x,M.y])}return"M"+g.join("L")}function E(N){a.push(N);var K=N.length;for(var L=0;L<K-2;L+=2){var M=[N[L],N[L+1]];var g=[N[L+2],N[L+3]];u.push({pts:[M,g],d:L/N.length})}l()}function z(){var L=H.map.zoom();d[L]=[];var K=j.pop();j.unshift(K);for(var g=1;g<A.length;g++){d[L][g]=$.ajax({url:"/proxy/router/?from="+A[0][1]+","+A[0][0]+"&to="+A[g][1]+","+A[g][0],dataType:"json",success:function(){var M=g;return function(O){if(!O.route.shape||d[L]==undefined||d[L][M]==undefined){return}var N=O.route.shape.shapePoints;E(N);d[L][M]="done"}}()})}}function k(){console.log("updating");G.data(A).each(function(L){L.edit=false});var g=B.selectAll("circle.rotation").data(t);g.enter().append("svg:circle").attr("class","rotation").attr("r","40").attr("cx",function(M,L){return M.x}).attr("cy",function(M,L){return M.y});g.exit().remove();g.attr("cx",function(M,L){return M.x}).attr("cy",function(M,L){return M.y});var K=B.select("path");K.attr("d",function(){if(t.length==0){return}var L=[];$.each(t,function(M,N){L.push([N.x,N.y])});return"M"+L.join("L")+"Z"}).attr("class","hiddenFrame");I();e();l()}function I(){G.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return b}});G.select(".title-text").on("click",function(g){if(g.edit){return}p.editText($(this).parent(),0,"title");g.edit=!g.edit});G.select(".title-edit").on("click",function(K){var g=$(this).parent();if(!K.edit){p.editText(g,0,"title")}else{K.title=b=p.saveText(g,0,"title")}K.edit=!K.edit})}function r(){h.selectAll("path").remove();u=[];A=[A[0]];C=[C[0]];m=[m[0]];var K,L;for(var N=0;N<24;N++){var M=N*(Math.PI/12);var g=H.p2l({x:300+Math.sin(M)*200,y:300+Math.cos(M)*200});L=g.lon;K=g.lat;C.push(K);m.push(L);A.push([L,K])}}p.add=function(P,L,N,g){var M=parseFloat(P);var O=parseFloat(L);h.select("#radialClip circle").data([[O,M]]);h.select(".circleFrame").data([[O,M]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",20);C=[M];m=[O];A=[[O,M]];if(N==undefined){b=P.toFixed(3)+", "+L.toFixed(3)}else{b=N}$("#places").removeClass("inactive");var K=H.getMapRadius();H.updateBounds([M-K.lat,M+K.lat],[O-K.lon,O+K.lon]);p.recalculate();k();p.added();return p};p.remove=function(g){A.splice(g,1);C.splice(g,1);m.splice(g,1);if(A.length==0){$("#finish-button").removeClass("active")}};p.lats=function(){return C};p.lons=function(){return m};p.places=function(){return[b]};p.points=function(g){if(!arguments.length){return A}A=g;return p};p.hideRotator=function(){B.style("display","none")};p.showRotator=function(){B.style("display","")};p.locations=function(g){y=null;A=[];C=[];m=[];$.each(g,function(K,L){A.push([L.longitude,L.latitude]);C.push(L.latitude);m.push(L.longitude)});p.locationsSet();return p};p.prerender=function(g){$("#"+v).html(g);$(".delaunay").attr("transform","translate("+($(o).width()-600)/2+",0)")};p.recalculate=function(){$.each(d,function(g,K){$.each(K,function(L,M){if(M==undefined||M=="done"){return}});delete d[g]});r();z();p.style({zoom:H.map.zoom()})};p.refresh=function(){k();p.refreshed()};p.updateTitle=function(g){b=g};p.outputTitle=function(){return b||"My Meshu"};p.output=function(){return $("#"+v).html()};p.id=function(){return v};return p};