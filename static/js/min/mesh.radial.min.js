var sb=sb||{};sb.mesh.radial=function(b,t,a,e){var j=sb.mesh.base(b,t,a,e),n="m"+parseInt(Math.random()*10000000000,10),D=["a","b","c","d"];j.name="radial";var d=[],o=[],z,c;var h=document.createElement("div");var A=d3.select(b||"body").append("div").attr("id",n).style("width",a).style("height",e).style("position","absolute");var q=d3.select(b||"body").append("div").attr("id",n+"prerendered").style("width",a).style("height",e).style("position","absolute");var f=d3.select("#"+n).append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var p=f.append("svg:g").attr("class","delaunay");p.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var L=p.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");p.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var m=f.append("svg:g").attr("class","hidden");m.append("svg:path");var J=d3.select(b).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var w=d3.select("#place-title").attr("class","inactive");w.append("span").attr("class","title-text");w.append("span").attr("class","title-edit").html("edit");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",j.removeInput)}$("#radial-knockout").click(function(){j.style({drawStyle:"knockout"})});$("#radial-frame").click(function(){j.style({drawStyle:"outline"})});var C=[],I=[],v=[],s=[],u={},z=null;var k=$("#content");d3.select(J.node()).on("mouseover",H).on("mouseout",K);var F;function H(){F=setTimeout(function(){$(".map-hint").fadeIn()},500)}function K(){clearTimeout(F);$(".map-hint").fadeOut()}j.hittest=function(g){return d3.event.target!=J.node()};j.on("draggedMap",function(){x()});j.on("clickedMap",function(g){j.add(g.lat,g.lon,undefined,false)});j.on("removed",function(){if(C.length==0){$("#finish-button").removeClass("active")}});j.on("styled",function(g){if(g.drawStyle){switch(g.drawStyle){case"knockout":$("body").addClass("knockout");$(this).addClass("active");$("#radial-frame").removeClass("active");break;case"outline":default:$("body").removeClass("knockout");$(this).addClass("active");$("#radial-knockout").removeClass("active");break}}if(g.zoom){if(g.zoom!=t.map.zoom()){t.map.zoom(g.zoom)}}});function B(){var g=p.selectAll("circle");g.attr("cx",function(M){return t.l2p({lat:M[1],lon:M[0]}).x}).attr("cy",function(M){return t.l2p({lat:M[1],lon:M[0]}).y})}function E(){var g=L.selectAll("path").data(v);g.enter().append("svg:path");g.exit().remove();g.attr("d",function(M){return l(M.pts)});g.attr("stroke","black").attr("fill","none").attr("stroke-linecap","round");g.attr("stroke-width",function(N,M){return 20*((1-Math.pow(N.d,0.5))+0.1)+"px"});g.style("stroke-width",function(N,M){return 20*((1-Math.pow(N.d,0.5))+0.1)+"px"})}function l(P){var g=[];var M=P.length;for(var N=0;N<M;N++){var Q={lat:P[N][0],lon:P[N][1]};var O=t.l2p(Q);g.push([O.x,O.y])}return"M"+g.join("L")}function i(P){I.push(P);var M=P.length;for(var N=0;N<M-2;N+=2){var O=[P[N],P[N+1]];var g=[P[N+2],P[N+3]];v.push({pts:[O,g],d:N/P.length})}E()}function y(){var O=t.map.zoom(),P=C[0];c=O;u[O]=[];var N=D.pop();D.unshift(N);for(var M=1;M<C.length;M++){var g=C[M];u[O][M]=$.ajax({url:"/proxy/router/?from="+P[1]+","+P[0]+"&to="+g[1]+","+g[0],dataType:"json",success:function(){var Q=M;return function(S){console.log();if(!S.route.shape||u[O]==undefined||u[O][Q]==undefined||u[O]=="inactive"){return}var R=S.route.shape.shapePoints;i(R);u[O][Q]="done"}}()})}}function x(){w.data(C).each(function(N){N.edit=false});var g=m.selectAll("circle.rotation").data(s);g.enter().append("svg:circle").attr("class","rotation").attr("r","40").attr("cx",function(O,N){return O.x}).attr("cy",function(O,N){return O.y});g.exit().remove();g.attr("cx",function(O,N){return O.x}).attr("cy",function(O,N){return O.y});var M=m.select("path");M.attr("d",function(){if(s.length==0){return}var N=[];$.each(s,function(O,P){N.push([P.x,P.y])});return"M"+N.join("L")+"Z"}).attr("class","hiddenFrame");G();B();E()}function G(){w.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return z}});w.select(".title-text").on("click",function(g){if(g.edit){return}j.editText($(this).parent(),0,"title");g.edit=!g.edit});w.select(".title-edit").on("click",function(M){var g=$(this).parent();if(!M.edit){j.editText(g,0,"title")}else{M.title=z=j.saveText(g,0,"title")}M.edit=!M.edit})}function r(){f.selectAll("path").remove();v=[];C=[C[0]];d=[d[0]];o=[o[0]];var M,N;for(var P=0;P<24;P++){var O=P*(Math.PI/12);var g=t.p2l({x:300+Math.sin(O)*200,y:300+Math.cos(O)*200});N=g.lon;M=g.lat;d.push(M);o.push(N);C.push([N,M])}}j.add=function(R,N,P,g){var O=parseFloat(R);var Q=parseFloat(N);A.select("#radialClip circle").data([[Q,O]]);A.select(".circleFrame").data([[Q,O]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",20);d=[O];o=[Q];C=[[Q,O]];if(P==undefined){z=R.toFixed(3)+", "+N.toFixed(3)}else{z=P}$("#places").removeClass("inactive");var M=t.getMapRadius();t.updateBounds([O-M.lat,O+M.lat],[Q-M.lon,Q+M.lon]);j.recalculate();x();j.added();return j};j.remove=function(g){C.splice(g,1);d.splice(g,1);o.splice(g,1);if(C.length==0){$("#finish-button").removeClass("active")}};j.lats=function(){return d};j.lons=function(){return o};j.places=function(){return[z]};j.points=function(g){if(!arguments.length){return C}C=g;return j};j.hideRotator=function(){m.style("display","none")};j.showRotator=function(){m.style("display","")};j.locations=function(g){C=[];d=[];o=[];$.each(g,function(M,N){C.push([N.longitude,N.latitude]);d.push(N.latitude);o.push(N.longitude)});j.locationsSet();return j};j.prerender=function(g){$("#"+n+"prerendered").html(g);$("#"+n+"prerendered .delaunay").attr("transform","translate("+($(b).width()-600)/2+",0)")};j.recalculate=function(){$("#"+n+"prerendered").empty();$.each(u,function(g,M){$.each(M,function(N,O){if(O==undefined||O=="done"){return}});u[g]="inactive"});r();y();j.style({zoom:t.map.zoom()})};j.refresh=function(g){if(g){console.log(d,o);j.add(d[0],o[0],z)}else{x();j.refreshed()}};j.updateTitle=function(g){z=g};j.outputTitle=function(){return z||"My Meshu"};j.output=function(){return $("#"+n).html()};j.id=function(){return n};return j};