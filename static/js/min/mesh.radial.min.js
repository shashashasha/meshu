var sb=sb||{};sb.mesh.radial=function(o,E,s,q){var p=sb.mesh.base(o,E,s,q),v="m"+parseInt(Math.random()*10000000000,10);p.name="radial";var z=[],l=[],b;var B=d3.select(o||"body").append("div").attr("id",v).style("width",s).style("height",q).style("position","absolute");var e=d3.select(o||"body").append("div").attr("id",v+"prerendered").style("width",s).style("height",q).style("position","absolute");var i=d3.select("#"+v).append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var h=i.append("svg:g").attr("class","delaunay");h.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var A=h.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");h.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var n=d3.select(o).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var D=d3.select("#place-title").attr("class","inactive");D.append("span").attr("class","title-text");D.append("span").attr("class","title-edit").html("edit");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",p.removeInput)}$("#radial-knockout").click(function(){p.style({drawStyle:"knockout"})});$("#radial-frame").click(function(){p.style({drawStyle:"outline"})});var y=[],a=[],u=[],t=[],f={},b=null;var x=$("#content");p.hittest=function(g){return d3.event.target!=n.node()};p.on("draggedMap",function(){j()});p.on("clickedMap",function(g){p.add(g.lat,g.lon,undefined,false)});p.on("removed",function(){if(y.length==0){$("#finish-button").removeClass("active")}});p.on("styled",function(g){if(g.drawStyle){switch(g.drawStyle){case"knockout":$("body").addClass("knockout");$(this).addClass("active");$("#radial-frame").removeClass("active");k();break;case"outline":default:$("body").removeClass("knockout");$(this).addClass("active");$("#radial-knockout").removeClass("active");k();break}}if(g.zoom&&g.zoom!=E.map.zoom()){E.map.zoom(g.zoom)}});function m(){var g=h.selectAll("circle");g.attr("cx",function(G){return E.l2p({lat:G[1],lon:G[0]}).x}).attr("cy",function(G){return E.l2p({lat:G[1],lon:G[0]}).y})}function k(){var H=function(N,L){var I=Math.min(16,N.total-4),K=5,M=(1-Math.sqrt(N.d)),J=(I*M)+K;return J+"px"};var G="black";if(p.style()!=undefined&&p.style().drawStyle){G=p.style().drawStyle=="outline"?"black":"white"}var g=A.selectAll("path").data(u);if($("body").hasClass("firefox")){g.enter().append("svg:path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",H)}else{g.enter().append("svg:path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",0).transition().duration(500).style("stroke-width",H)}g.exit().remove();g.attr("d",function(I){return w(I.pts)}).attr("stroke",G)}function w(J){var g=[];var G=J.length;for(var H=0;H<G;H++){var K={lat:J[H][0],lon:J[H][1]};var I=E.l2p(K);g.push([I.x,I.y])}return"M"+g.join("L")}function C(J){a.push(J);var G=J.length;for(var H=0;H<G-2;H+=2){var I=[J[H],J[H+1]];var g=[J[H+2],J[H+3]];u.push({pts:[I,g],total:J.length,d:H/J.length})}k()}function c(J){var g=true,G=0;for(var I=1;I<y.length;I++){if(f[J][I]!="done"){g=false}else{G++}}var H=(G/(y.length-1)*100).toFixed(0)+"%";$("#radial-heading").html("Generating radial... "+H);if(g){$("#radial-heading").html("Your radial is done!");p.added()}}function d(){var K=E.map.zoom(),M=y[0];startCoords=M[1]+","+M[0];f[K]=["done"];var J=$("body").hasClass("ie")||window.location.protocol=="https:"?"http://open.mapquestapi.com/directions/v1/route?routeType=pedestrian&outFormat=json&shapeFormat=raw&generalize=200&from=":"https://meshu.io/proxy/router/?from=";var L=J+"{start}&to={end}";for(var I=1;I<y.length;I++){var G=y[I],g=G[1]+","+G[0],H=L.replace("{start}",startCoords).replace("{end}",g);f[K][I]=$.jsonp({url:H,callbackParameter:"callback",error:function(N){return function(O){f[K][N]="done";c(K)}}(I),success:function(N){return function(P){if(!P.route.shape){f[K][N]="done";return}else{if(f[K]==undefined||f[K][N]==undefined||f[K]=="inactive"){return}}var O=P.route.shape.shapePoints;C(O);f[K][N]="done";c(K)}}(I)})}}function j(){D.data(y).each(function(g){g.edit=false});F();m();k()}function F(){D.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return b}});D.select(".title-text").on("click",function(g){if(g.edit){return}p.editText($(this).parent(),0,"title");g.edit=!g.edit});D.select(".title-edit").on("click",function(G){var g=$(this).parent();if(!G.edit){p.editText(g,0,"title")}else{G.title=b=p.saveText(g,0,"title")}G.edit=!G.edit})}function r(){i.selectAll("path").remove();u=[];y=[y[0]];z=[z[0]];l=[l[0]];var G,H;for(var J=0;J<24;J++){var I=J*(Math.PI/12);var g=E.p2l({x:300+Math.sin(I)*200,y:300+Math.cos(I)*200});H=g.lon;G=g.lat;z.push(G);l.push(H);y.push([H,G])}}p.add=function(L,H,J,g){var I=parseFloat(L);var K=parseFloat(H);B.select("#radialClip circle").data([[K,I]]);B.select(".circleFrame").data([[K,I]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",17);z=[I];l=[K];y=[[K,I]];if(J==undefined){b=L.toFixed(3)+", "+H.toFixed(3)}else{b=J[0].toUpperCase()+J.substr(1,J.length-1)}$("#places").removeClass("inactive");var G=E.getMapRadius();E.map.center({lat:I,lon:K});E.boundsUpdated();p.recalculate();return p};p.remove=function(g){y.splice(g,1);z.splice(g,1);l.splice(g,1);if(y.length==0){$("#finish-button").removeClass("active")}};p.lats=function(){return z};p.lons=function(){return l};p.places=function(){return[b]};p.points=function(g){if(!arguments.length){return y}y=g;return p};p.bakeStyles=function(){var H=$(".circleFrame").css("stroke"),G=$(".circleFrame").css("fill"),g=$(".radial path").css("stroke");$(".circleFrame").attr("stroke",H);$(".circleFrame").attr("fill",G);$(".radial path").attr("stroke",g)};p.unBakeStyles=function(){$(".circleFrame").attr("stroke","").attr("fill","");$(".radial path").css("stroke","")};p.locations=function(g){y=[];z=[];l=[];$.each(g,function(G,H){y.push([H.longitude,H.latitude]);z.push(H.latitude);l.push(H.longitude)});p.dirty=true;p.locationsSet();return p};p.prerender=function(G){$("#"+v+"prerendered").html(G);var H=$("#"+v+"prerendered").find(".delaunay");$("#"+v+"prerendered").remove();$("#"+v).find(".delaunay").replaceWith(H);var J=$(o).width(),g=$(o).height(),I=600;$("#"+v+" .delaunay").attr("transform","translate("+(J-I)/2+","+(g-I)/2+")")};p.recalculate=function(){$("#"+v+"prerendered").remove();$.each(f,function(g,G){$.each(G,function(H,I){if(I==undefined||I=="done"){return}if(I.abort){I.abort()}});f[g]="inactive"});r();d();p.style({zoom:E.map.zoom()});p.dirty=false};p.refresh=function(g){if(g=="zoomed"&&z.length>0&&l.length>0){p.add(z[0],l[0],b)}else{j();p.refreshed()}};p.updateTitle=function(g){b=g};p.outputTitle=function(){return b||"My Meshu"};p.output=function(){return $("#"+v).html()};p.id=function(){return v};return p};