var sb=sb||{};sb.mesh.radial=function(q,H,v,s){var r=sb.mesh.base(q,H,v,s),y="m"+parseInt(Math.random()*10000000000,10),k=["a","b","c","d"];r.name="radial";var C=[],n=[],b,u;var j=document.createElement("div");var E=d3.select(q||"body").append("div").attr("id",y).style("width",v).style("height",s).style("position","absolute");var e=d3.select(q||"body").append("div").attr("id",y+"prerendered").style("width",v).style("height",s).style("position","absolute");var i=d3.select("#"+y).append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var h=i.append("svg:g").attr("class","delaunay");h.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var D=h.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");h.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var p=d3.select(q).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var G=d3.select("#place-title").attr("class","inactive");G.append("span").attr("class","title-text");G.append("span").attr("class","title-edit").html("edit");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",r.removeInput)}$("#radial-knockout").click(function(){r.style({drawStyle:"knockout"})});$("#radial-frame").click(function(){r.style({drawStyle:"outline"})});var B=[],a=[],x=[],w=[],f={},b=null;var A=$("#content");r.hittest=function(g){return d3.event.target!=p.node()};r.on("draggedMap",function(){l()});r.on("clickedMap",function(g){r.add(g.lat,g.lon,undefined,false)});r.on("removed",function(){if(B.length==0){$("#finish-button").removeClass("active")}});r.on("styled",function(g){if(g.drawStyle){switch(g.drawStyle){case"knockout":$("body").addClass("knockout");$(this).addClass("active");$("#radial-frame").removeClass("active");m();break;case"outline":default:$("body").removeClass("knockout");$(this).addClass("active");$("#radial-knockout").removeClass("active");m();break}}if(g.zoom&&g.zoom!=H.map.zoom()){H.map.zoom(g.zoom)}});function o(){var g=h.selectAll("circle");g.attr("cx",function(J){return H.l2p({lat:J[1],lon:J[0]}).x}).attr("cy",function(J){return H.l2p({lat:J[1],lon:J[0]}).y})}function m(){var K=function(Q,O){var L=Math.min(16,Q.total-4),N=5,P=(1-Math.sqrt(Q.d)),M=(L*P)+N;console.log(M);return M+"px"};var J="black";if(r.style()!=undefined&&r.style().drawStyle){J=r.style().drawStyle=="outline"?"black":"white"}var g=D.selectAll("path").data(x);g.enter().append("svg:path").style("stroke-width",0);g.exit().remove();g.attr("d",function(L){return z(L.pts)}).attr("stroke",J).attr("fill","none").attr("stroke-linecap","round");g.transition().duration(500).style("stroke-width",K)}function z(M){var g=[];var J=M.length;for(var K=0;K<J;K++){var N={lat:M[K][0],lon:M[K][1]};var L=H.l2p(N);g.push([L.x,L.y])}return"M"+g.join("L")}function F(M){a.push(M);var J=M.length;for(var K=0;K<J-2;K+=2){var L=[M[K],M[K+1]];var g=[M[K+2],M[K+3]];x.push({pts:[L,g],total:M.length,d:K/M.length})}m()}function c(M){var g=true,J=0;for(var L=1;L<B.length;L++){if(f[M][L]!="done"){g=false}else{J++}}var K=(J/(B.length-1)*100).toFixed(0)+"%";$("#radial-heading").html("Generating radial... "+K);if(g){$("#radial-heading").html("Your radial is done!");r.added()}}function d(){var L=H.map.zoom(),M=B[0];u=L;f[L]=["done"];var K=k.pop();k.unshift(K);for(var J=1;J<B.length;J++){var g=B[J];f[L][J]=$.ajax({url:"/proxy/router/?from="+M[1]+","+M[0]+"&to="+g[1]+","+g[0],dataType:"json",success:function(){var N=J;return function(P){if(!P.route.shape){f[L][N]="done";return}else{if(f[L]==undefined||f[L][N]==undefined||f[L]=="inactive"){return}}var O=P.route.shape.shapePoints;F(O);f[L][N]="done";c(L)}}()})}}function l(){console.log("updating");G.data(B).each(function(g){g.edit=false});I();o();m()}function I(){G.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return b}});G.select(".title-text").on("click",function(g){if(g.edit){return}r.editText($(this).parent(),0,"title");g.edit=!g.edit});G.select(".title-edit").on("click",function(J){var g=$(this).parent();if(!J.edit){r.editText(g,0,"title")}else{J.title=b=r.saveText(g,0,"title")}J.edit=!J.edit})}function t(){i.selectAll("path").remove();x=[];B=[B[0]];C=[C[0]];n=[n[0]];var J,K;for(var M=0;M<24;M++){var L=M*(Math.PI/12);var g=H.p2l({x:300+Math.sin(L)*200,y:300+Math.cos(L)*200});K=g.lon;J=g.lat;C.push(J);n.push(K);B.push([K,J])}}r.add=function(O,K,M,g){var L=parseFloat(O);var N=parseFloat(K);E.select("#radialClip circle").data([[N,L]]);E.select(".circleFrame").data([[N,L]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",20);C=[L];n=[N];B=[[N,L]];if(M==undefined){b=O.toFixed(3)+", "+K.toFixed(3)}else{b=M[0].toUpperCase()+M.substr(1,M.length-1)}$("#places").removeClass("inactive");var J=H.getMapRadius();H.updateBounds([L-J.lat,L+J.lat],[N-J.lon,N+J.lon]);r.recalculate();return r};r.remove=function(g){B.splice(g,1);C.splice(g,1);n.splice(g,1);if(B.length==0){$("#finish-button").removeClass("active")}};r.lats=function(){return C};r.lons=function(){return n};r.places=function(){return[b]};r.points=function(g){if(!arguments.length){return B}B=g;return r};r.bakeStyles=function(){var K=$(".circleFrame").css("stroke"),J=$(".circleFrame").css("fill"),g=$(".radial path").css("stroke");$(".circleFrame").attr("stroke",K);$(".circleFrame").attr("fill",J);$(".radial path").attr("stroke",g)};r.unBakeStyles=function(){$(".circleFrame").attr("stroke","").attr("fill","");$(".radial path").css("stroke","")};r.locations=function(g){B=[];C=[];n=[];$.each(g,function(J,K){B.push([K.longitude,K.latitude]);C.push(K.latitude);n.push(K.longitude)});r.dirty=true;r.locationsSet();return r};r.prerender=function(J){$("#"+y+"prerendered").html(J);var K=$("#"+y+"prerendered").find(".delaunay");$("#"+y+"prerendered").remove();$("#"+y).find(".delaunay").replaceWith(K);var L=$(q).width(),g=$(q).height();if(L>g){$("#"+y+" .delaunay").attr("transform","translate("+(L-g)/2+",0)")}};r.recalculate=function(){$("#"+y+"prerendered").remove();$.each(f,function(g,J){$.each(J,function(K,L){if(L==undefined||L=="done"){return}});f[g]="inactive"});t();d();r.style({zoom:H.map.zoom()});r.dirty=false};r.refresh=function(g){if(g=="zoomed"&&C.length>0&&n.length>0){r.add(C[0],n[0],b)}else{l();r.refreshed()}};r.updateTitle=function(g){b=g};r.outputTitle=function(){return b||"My Meshu"};r.output=function(){return $("#"+y).html()};r.id=function(){return y};return r};