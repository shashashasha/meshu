var sb=sb||{};sb.mesh.radial=function(b,s,a,e){var j=sb.mesh.base(b,s,a,e),m="m"+parseInt(Math.random()*10000000000,10),D=["a","b","c","d"];j.name="radial";var d=[],n=[],y,c;var h=document.createElement("div");var z=d3.select(b||"body").append("div").attr("id",m).style("width",a).style("height",e).style("position","absolute");var p=d3.select(b||"body").append("div").attr("id",m+"prerendered").style("width",a).style("height",e).style("position","absolute");var f=d3.select("#"+m).append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var o=f.append("svg:g").attr("class","delaunay");o.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var L=o.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");o.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var J=d3.select(b).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var v=d3.select("#place-title").attr("class","inactive");v.append("span").attr("class","title-text");v.append("span").attr("class","title-edit").html("edit");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",j.removeInput)}$("#radial-knockout").click(function(){j.style({drawStyle:"knockout"})});$("#radial-frame").click(function(){j.style({drawStyle:"outline"})});var C=[],I=[],u=[],r=[],t={},y=null;var k=$("#content");d3.select(J.node()).on("mouseover",H).on("mouseout",K);var F;function H(){F=setTimeout(function(){$(".map-hint").fadeIn()},500)}function K(){clearTimeout(F);$(".map-hint").fadeOut()}j.hittest=function(g){return d3.event.target!=J.node()};j.on("draggedMap",function(){w()});j.on("clickedMap",function(g){j.add(g.lat,g.lon,undefined,false)});j.on("removed",function(){if(C.length==0){$("#finish-button").removeClass("active")}});j.on("styled",function(g){if(g.drawStyle){switch(g.drawStyle){case"knockout":$("body").addClass("knockout");$(this).addClass("active");$("#radial-frame").removeClass("active");break;case"outline":default:$("body").removeClass("knockout");$(this).addClass("active");$("#radial-knockout").removeClass("active");break}}if(g.zoom&&g.zoom!=s.map.zoom()){s.map.zoom(g.zoom)}});function A(){var g=o.selectAll("circle");g.attr("cx",function(M){return s.l2p({lat:M[1],lon:M[0]}).x}).attr("cy",function(M){return s.l2p({lat:M[1],lon:M[0]}).y})}function E(){var g=L.selectAll("path").data(u);g.enter().append("svg:path");g.exit().remove();g.attr("d",function(N){return l(N.pts)});g.attr("stroke","black").attr("fill","none").attr("stroke-linecap","round");var M=function(O,N){return Math.min(20,O.total)*((1-Math.pow(O.d,0.5))+0.1)+"px"};g.attr("stroke-width",M);g.style("stroke-width",M)}function l(P){var g=[];var M=P.length;for(var N=0;N<M;N++){var Q={lat:P[N][0],lon:P[N][1]};var O=s.l2p(Q);g.push([O.x,O.y])}return"M"+g.join("L")}function i(P){I.push(P);var M=P.length;for(var N=0;N<M-2;N+=2){var O=[P[N],P[N+1]];var g=[P[N+2],P[N+3]];u.push({pts:[O,g],total:P.length,d:N/P.length})}E()}function B(P){console.log(P,t);var g=true,M=0;for(var O=1;O<C.length;O++){if(t[P][O]!="done"){g=false}else{M++}}var N=M+"/"+(C.length-1);$("#radial-heading").html("Generating radial... "+N);if(g){$("#radial-heading").html("Your radial is done!");j.added()}}function x(){var O=s.map.zoom(),P=C[0];c=O;t[O]=["done"];var N=D.pop();D.unshift(N);for(var M=1;M<C.length;M++){var g=C[M];t[O][M]=$.ajax({url:"/proxy/router/?from="+P[1]+","+P[0]+"&to="+g[1]+","+g[0],dataType:"json",success:function(){var Q=M;return function(S){if(!S.route.shape){t[O][Q]="done";return}else{if(t[O]==undefined||t[O][Q]==undefined||t[O]=="inactive"){return}}var R=S.route.shape.shapePoints;i(R);t[O][Q]="done";B(O)}}()})}}function w(){console.log("updating");v.data(C).each(function(g){g.edit=false});G();A();E()}function G(){v.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return y}});v.select(".title-text").on("click",function(g){if(g.edit){return}j.editText($(this).parent(),0,"title");g.edit=!g.edit});v.select(".title-edit").on("click",function(M){var g=$(this).parent();if(!M.edit){j.editText(g,0,"title")}else{M.title=y=j.saveText(g,0,"title")}M.edit=!M.edit})}function q(){f.selectAll("path").remove();u=[];C=[C[0]];d=[d[0]];n=[n[0]];var M,N;for(var P=0;P<4;P++){var O=P*(Math.PI/2);var g=s.p2l({x:300+Math.sin(O)*200,y:300+Math.cos(O)*200});N=g.lon;M=g.lat;d.push(M);n.push(N);C.push([N,M])}}j.add=function(R,N,P,g){var O=parseFloat(R);var Q=parseFloat(N);z.select("#radialClip circle").data([[Q,O]]);z.select(".circleFrame").data([[Q,O]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",20).attr("stroke","black").attr("fill","none");d=[O];n=[Q];C=[[Q,O]];if(P==undefined){y=R.toFixed(3)+", "+N.toFixed(3)}else{y=P[0].toUpperCase()+P.substr(1,P.length-1)}$("#places").removeClass("inactive");var M=s.getMapRadius();s.updateBounds([O-M.lat,O+M.lat],[Q-M.lon,Q+M.lon]);j.recalculate();return j};j.remove=function(g){C.splice(g,1);d.splice(g,1);n.splice(g,1);if(C.length==0){$("#finish-button").removeClass("active")}};j.lats=function(){return d};j.lons=function(){return n};j.places=function(){return[y]};j.points=function(g){if(!arguments.length){return C}C=g;return j};j.hideRotator=function(){};j.showRotator=function(){};j.locations=function(g){C=[];d=[];n=[];$.each(g,function(M,N){C.push([N.longitude,N.latitude]);d.push(N.latitude);n.push(N.longitude)});j.dirty=true;j.locationsSet();return j};j.prerender=function(M){$("#"+m+"prerendered").html(M);var N=$("#"+m+"prerendered").find(".delaunay");$("#"+m+"prerendered").remove();$("#"+m).find(".delaunay").replaceWith(N);var O=$(b).width(),g=$(b).height();if(O>g){$("#"+m+" .delaunay").attr("transform","translate("+(O-g)/2+",0)")}};j.recalculate=function(){$("#"+m+"prerendered").remove();$.each(t,function(g,M){$.each(M,function(N,O){if(O==undefined||O=="done"){return}});t[g]="inactive"});q();x();j.style({zoom:s.map.zoom()});j.dirty=false};j.refresh=function(g){if(g=="zoomed"){j.add(d[0],n[0],y)}else{w();j.refreshed()}};j.updateTitle=function(g){y=g};j.outputTitle=function(){return y||"My Meshu"};j.output=function(){return $("#"+m).html()};j.id=function(){return m};return j};