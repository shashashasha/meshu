var sb=sb||{};sb.mesh.radial=function(o,G,s,q){var p=sb.mesh.base(o,G,s,q),v="m"+parseInt(Math.random()*10000000000,10),C=200,B=0;p.name="radial";var z=[],l=[],b;var D=d3.select(o||"body").append("div").attr("id",v).style("width",s).style("height",q).style("position","absolute");var e=d3.select(o||"body").append("div").attr("id",v+"prerendered").style("width",s).style("height",q).style("position","absolute");var i=d3.select("#"+v).append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var h=i.append("svg:g").attr("class","delaunay");h.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var A=h.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");h.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var n=d3.select(o).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var F=d3.select("#place-title").attr("class","inactive");F.append("span").attr("class","title-text");F.append("span").attr("class","title-edit").html("edit");var y=[],a=[],u=[],t=[],f={},b=null;var x=$("#content");p.hittest=function(g){return d3.event.target!=n.node()};p.on("draggedMap",function(){j()});p.on("clickedMap",function(g){p.add(g.lat,g.lon,undefined,false)});p.on("styled",function(g){if(g.zoom&&g.zoom!=G.map.zoom()){G.map.zoom(g.zoom)}});function m(){var g=h.selectAll("circle");g.attr("cx",function(I){return G.l2p({lat:I[1],lon:I[0]}).x}).attr("cy",function(I){return G.l2p({lat:I[1],lon:I[0]}).y})}function k(){var J=function(P,N){var K=Math.min(16,P.total-4),M=5,O=(1-Math.sqrt(P.d)),L=(K*O)+M;return L+"px"};var I="black";if(p.style()!=undefined&&p.style().drawStyle){I=p.style().drawStyle=="outline"?"black":"white"}var g=A.selectAll("path").data(u);if($("body").hasClass("firefox")){g.enter().append("svg:path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",J)}else{g.enter().append("svg:path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",0).transition().duration(500).style("stroke-width",J)}g.exit().remove();g.attr("d",function(K){return w(K.pts)}).attr("stroke",I)}function w(L){var g=[];var I=L.length;for(var J=0;J<I;J++){var M={lat:L[J][0],lon:L[J][1]};var K=G.l2p(M);g.push([K.x,K.y])}return"M"+g.join("L")}function E(L){a.push(L);var I=L.length;for(var J=0;J<I-2;J+=2){var K=[L[J],L[J+1]];var g=[L[J+2],L[J+3]];u.push({pts:[K,g],total:L.length,d:J/L.length})}k()}function c(L){var g=true,I=0;for(var K=1;K<y.length;K++){if(f[L][K]!="done"){g=false}else{I++}}var J=(I/(y.length-1)*100).toFixed(0)+"%";$("#radial-heading").html("Generating radial... "+J);if(g){$("#radial-heading").html("Your radial is done!");p.added()}}function d(){var M=G.map.zoom(),O=y[0];startCoords=O[1]+","+O[0];f[M]=["done"];var L=$("body").hasClass("ie")||window.location.protocol=="https:"?"https://meshu.io/proxy/router/?from=":"http://open.mapquestapi.com/directions/v1/route?routeType=pedestrian&outFormat=json&shapeFormat=raw&generalize=200&from=";var N=L+"{start}&to={end}";for(var K=1;K<y.length;K++){var I=y[K],g=I[1]+","+I[0],J=N.replace("{start}",startCoords).replace("{end}",g);f[M][K]=$.jsonp({url:J,callbackParameter:"callback",error:function(P){return function(Q){f[M][P]="done";c(M)}}(K),success:function(P){return function(R){if(!R.route.shape){f[M][P]="done";return}else{if(f[M]==undefined||f[M][P]==undefined||f[M]=="inactive"){return}}var Q=R.route.shape.shapePoints;E(Q);f[M][P]="done";c(M)}}(K)})}}function j(){F.data(y).each(function(g){g.edit=false});H();m();k()}function H(){F.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return b}});F.select(".title-text").on("click",function(g){if(g.edit){return}p.editText($(this).parent(),0,"title");g.edit=!g.edit});F.select(".title-edit").on("click",function(I){var g=$(this).parent();if(!I.edit){p.editText(g,0,"title")}else{I.title=b=p.saveText(g,0,"title")}I.edit=!I.edit})}p.editText=function(K,I,J){var g=K.find("."+J+"-edit").text("save");var M=K.find("."+J+"-text");var L=M.text();K.addClass("active");M.html('<input value="'+L+'">').find("input").focus()};p.saveText=function(K,I,J){var g=K.find("."+J+"-edit").text("edit");var L=K.find("input").val();K.removeClass("active");K.find("."+J+"-text").text(L);return L};function r(){i.selectAll("path").remove();u=[];y=[y[0]];z=[z[0]];l=[l[0]];var I,J;for(var L=0;L<24;L++){var K=L*(Math.PI/12);var g=G.p2l({x:C+300+(Math.sin(K)*200),y:B+300+(Math.cos(K)*200)});J=g.lon;I=g.lat;z.push(I);l.push(J);y.push([J,I])}}p.add=function(N,I,K,g){var J=parseFloat(N);var M=parseFloat(I);D.select("#radialClip circle").data([[M,J]]);D.select(".circleFrame").data([[M,J]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",17);z=[J];l=[M];y=[[M,J]];if(K==undefined){b=N.toFixed(3)+", "+I.toFixed(3)}else{b=K[0].toUpperCase()+K.substr(1,K.length-1)}$("#places").removeClass("inactive");var L={lat:J,lon:M};G.map.center(L);p.recalculate();G.centerOn(L,C,B);G.boundsUpdated();return p};p.remove=function(g){y.splice(g,1);z.splice(g,1);l.splice(g,1)};p.lats=function(){return z};p.lons=function(){return l};p.places=function(){return[b]};p.points=function(g){if(!arguments.length){return y}y=g;return p};p.bakeStyles=function(){var J=$(".circleFrame").css("stroke"),I=$(".circleFrame").css("fill"),g=$(".radial path").css("stroke");$(".circleFrame").attr("stroke",J);$(".circleFrame").attr("fill",I);$(".radial path").attr("stroke",g)};p.unBakeStyles=function(){$(".circleFrame").attr("stroke","").attr("fill","");$(".radial path").css("stroke","")};p.locations=function(g){y=[];z=[];l=[];$.each(g,function(I,J){y.push([J.longitude,J.latitude]);z.push(J.latitude);l.push(J.longitude)});p.dirty=true;p.locationsSet();return p};p.prerender=function(I,O){O=O||1;$("#"+v+"prerendered").html(I);var J=$("#"+v+"prerendered").find(".delaunay");$("#"+v).find(".delaunay").replaceWith(J);var L=$(o).width(),g=$(o).height(),K=600*O,N="translate("+(L-K)/2+","+(g-K)/2+") ",M=" scale("+O+","+O+")";$("#"+v+" .delaunay").attr("transform",N+M)};p.recalculate=function(){$("#"+v+"prerendered").remove();$.each(f,function(g,I){$.each(I,function(J,K){if(K==undefined||K=="done"){return}if(K.abort){K.abort()}});f[g]="inactive"});r();d();p.style({zoom:G.map.zoom()});p.dirty=false};p.refresh=function(g){if(g=="zoomed"&&z.length>0&&l.length>0){p.add(z[0],l[0],b)}else{j();p.refreshed()}};p.updateTitle=function(g){b=g};p.outputTitle=function(){return b||"My Meshu"};p.output=function(){return $("#"+v).html()};p.id=function(){return v};return p};