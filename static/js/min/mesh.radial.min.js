var sb=sb||{};sb.mesh.radial=function(b,s,a,e){var j=sb.mesh.base(b,s,a,e),m="m"+parseInt(Math.random()*10000000000,10),C=["a","b","c","d"];j.name="radial";var d=[],n=[],y,c;var h=document.createElement("div");var z=d3.select(b||"body").append("div").attr("id",m).style("width",a).style("height",e).style("position","absolute");var p=d3.select(b||"body").append("div").attr("id",m+"prerendered").style("width",a).style("height",e).style("position","absolute");var f=d3.select("#"+m).append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var o=f.append("svg:g").attr("class","delaunay");o.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var K=o.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");o.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var I=d3.select(b).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var v=d3.select("#place-title").attr("class","inactive");v.append("span").attr("class","title-text");v.append("span").attr("class","title-edit").html("edit");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",j.removeInput)}$("#radial-knockout").click(function(){j.style({drawStyle:"knockout"})});$("#radial-frame").click(function(){j.style({drawStyle:"outline"})});var B=[],H=[],u=[],r=[],t={},y=null;var k=$("#content");d3.select(I.node()).on("mouseover",G).on("mouseout",J);var E;function G(){E=setTimeout(function(){$(".map-hint").fadeIn()},500)}function J(){clearTimeout(E);$(".map-hint").fadeOut()}j.hittest=function(g){return d3.event.target!=I.node()};j.on("draggedMap",function(){w()});j.on("clickedMap",function(g){j.add(g.lat,g.lon,undefined,false)});j.on("removed",function(){if(B.length==0){$("#finish-button").removeClass("active")}});j.on("styled",function(g){if(g.drawStyle){switch(g.drawStyle){case"knockout":$("body").addClass("knockout");$(this).addClass("active");$("#radial-frame").removeClass("active");break;case"outline":default:$("body").removeClass("knockout");$(this).addClass("active");$("#radial-knockout").removeClass("active");break}}if(g.zoom&&g.zoom!=s.map.zoom()){s.map.zoom(g.zoom)}});function A(){var g=o.selectAll("circle");g.attr("cx",function(L){return s.l2p({lat:L[1],lon:L[0]}).x}).attr("cy",function(L){return s.l2p({lat:L[1],lon:L[0]}).y})}function D(){var g=K.selectAll("path").data(u);g.enter().append("svg:path");g.exit().remove();g.attr("d",function(L){return l(L.pts)});g.attr("stroke","black").attr("fill","none").attr("stroke-linecap","round");g.attr("stroke-width",function(M,L){return 20*((1-Math.pow(M.d,0.5))+0.1)+"px"});g.style("stroke-width",function(M,L){return 20*((1-Math.pow(M.d,0.5))+0.1)+"px"})}function l(O){var g=[];var L=O.length;for(var M=0;M<L;M++){var P={lat:O[M][0],lon:O[M][1]};var N=s.l2p(P);g.push([N.x,N.y])}return"M"+g.join("L")}function i(O){H.push(O);var L=O.length;for(var M=0;M<L-2;M+=2){var N=[O[M],O[M+1]];var g=[O[M+2],O[M+3]];u.push({pts:[N,g],d:M/O.length})}D()}function x(){var N=s.map.zoom(),O=B[0];c=N;t[N]=[];var M=C.pop();C.unshift(M);for(var L=1;L<B.length;L++){var g=B[L];t[N][L]=$.ajax({url:"/proxy/router/?from="+O[1]+","+O[0]+"&to="+g[1]+","+g[0],dataType:"json",success:function(){var P=L;return function(R){if(!R.route.shape||t[N]==undefined||t[N][P]==undefined||t[N]=="inactive"){return}var Q=R.route.shape.shapePoints;i(Q);t[N][P]="done"}}()})}}function w(){console.log("updating");v.data(B).each(function(g){g.edit=false});F();A();D()}function F(){v.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return y}});v.select(".title-text").on("click",function(g){if(g.edit){return}j.editText($(this).parent(),0,"title");g.edit=!g.edit});v.select(".title-edit").on("click",function(L){var g=$(this).parent();if(!L.edit){j.editText(g,0,"title")}else{L.title=y=j.saveText(g,0,"title")}L.edit=!L.edit})}function q(){f.selectAll("path").remove();u=[];B=[B[0]];d=[d[0]];n=[n[0]];var L,M;for(var O=0;O<24;O++){var N=O*(Math.PI/12);var g=s.p2l({x:300+Math.sin(N)*200,y:300+Math.cos(N)*200});M=g.lon;L=g.lat;d.push(L);n.push(M);B.push([M,L])}}j.add=function(Q,M,O,g){var N=parseFloat(Q);var P=parseFloat(M);z.select("#radialClip circle").data([[P,N]]);z.select(".circleFrame").data([[P,N]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",20);d=[N];n=[P];B=[[P,N]];if(O==undefined){y=Q.toFixed(3)+", "+M.toFixed(3)}else{y=O[0].toUpperCase()+O.substr(1,O.length-1)}$("#places").removeClass("inactive");var L=s.getMapRadius();s.updateBounds([N-L.lat,N+L.lat],[P-L.lon,P+L.lon]);j.recalculate();j.added();return j};j.remove=function(g){B.splice(g,1);d.splice(g,1);n.splice(g,1);if(B.length==0){$("#finish-button").removeClass("active")}};j.lats=function(){return d};j.lons=function(){return n};j.places=function(){return[y]};j.points=function(g){if(!arguments.length){return B}B=g;return j};j.hideRotator=function(){};j.showRotator=function(){};j.locations=function(g){B=[];d=[];n=[];$.each(g,function(L,M){B.push([M.longitude,M.latitude]);d.push(M.latitude);n.push(M.longitude)});j.locationsSet();return j};j.prerender=function(L){$("#"+m+"prerendered").html(L);var M=$("#"+m+"prerendered").find(".delaunay");$("#"+m+"prerendered").remove();$("#"+m).find(".delaunay").replaceWith(M);var N=$(b).width(),g=$(b).height();if(N>g){$("#"+m+" .delaunay").attr("transform","translate("+(N-g)/2+",0)")}};j.recalculate=function(){$("#"+m+"prerendered").remove();$.each(t,function(g,L){$.each(L,function(M,N){if(N==undefined||N=="done"){return}});t[g]="inactive"});q();x();j.style({zoom:s.map.zoom()});j.dirty=false};j.refresh=function(g){if(g=="zoomed"){j.add(d[0],n[0],y)}else{w();j.refreshed()}};j.updateTitle=function(g){y=g};j.outputTitle=function(){return y||"My Meshu"};j.output=function(){return $("#"+m).html()};j.id=function(){return m};return j};