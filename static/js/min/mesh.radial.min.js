var sb=sb||{};sb.mesh.radial=function(p,G,u,r){var q=sb.mesh.base(p,G,u,r),x="m"+parseInt(Math.random()*10000000000,10);q.name="radial";var B=[],m=[],b,t;var j=document.createElement("div");var D=d3.select(p||"body").append("div").attr("id",x).style("width",u).style("height",r).style("position","absolute");var e=d3.select(p||"body").append("div").attr("id",x+"prerendered").style("width",u).style("height",r).style("position","absolute");var i=d3.select("#"+x).append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var h=i.append("svg:g").attr("class","delaunay");h.append("svg:circle").data([[-122.445,37.755]]).attr("class","circleFrame").attr("cx",300).attr("cy",300).attr("r",0).attr("stroke-width",0);var C=h.append("svg:g").attr("class","radial").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-linejoin","round").attr("clip-path","url(#radialClip)");h.append("svg:clipPath").attr("id","radialClip").append("svg:circle").data([[-122.445,37.755]]).attr("cx",300).attr("cy",300).attr("r",200);var o=d3.select(p).append("div").attr("id","ui-shield").style("width","100%").style("height","100%").style("position","absolute");var F=d3.select("#place-title").attr("class","inactive");F.append("span").attr("class","title-text");F.append("span").attr("class","title-edit").html("edit");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",q.removeInput)}$("#radial-knockout").click(function(){q.style({drawStyle:"knockout"})});$("#radial-frame").click(function(){q.style({drawStyle:"outline"})});var A=[],a=[],w=[],v=[],f={},b=null;var z=$("#content");q.hittest=function(g){return d3.event.target!=o.node()};q.on("draggedMap",function(){k()});q.on("clickedMap",function(g){q.add(g.lat,g.lon,undefined,false)});q.on("removed",function(){if(A.length==0){$("#finish-button").removeClass("active")}});q.on("styled",function(g){if(g.drawStyle){switch(g.drawStyle){case"knockout":$("body").addClass("knockout");$(this).addClass("active");$("#radial-frame").removeClass("active");l();break;case"outline":default:$("body").removeClass("knockout");$(this).addClass("active");$("#radial-knockout").removeClass("active");l();break}}if(g.zoom&&g.zoom!=G.map.zoom()){G.map.zoom(g.zoom)}});function n(){var g=h.selectAll("circle");g.attr("cx",function(I){return G.l2p({lat:I[1],lon:I[0]}).x}).attr("cy",function(I){return G.l2p({lat:I[1],lon:I[0]}).y})}function l(){var J=function(P,N){var K=Math.min(16,P.total-4),M=5,O=(1-Math.sqrt(P.d)),L=(K*O)+M;return L+"px"};var I="black";if(q.style()!=undefined&&q.style().drawStyle){I=q.style().drawStyle=="outline"?"black":"white"}var g=C.selectAll("path").data(w);if($("body").hasClass("firefox")){g.enter().append("svg:path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",J)}else{g.enter().append("svg:path").attr("fill","none").attr("stroke-linecap","round").style("stroke-width",0).transition().duration(500).style("stroke-width",J)}g.exit().remove();g.attr("d",function(K){return y(K.pts)}).attr("stroke",I)}function y(L){var g=[];var I=L.length;for(var J=0;J<I;J++){var M={lat:L[J][0],lon:L[J][1]};var K=G.l2p(M);g.push([K.x,K.y])}return"M"+g.join("L")}function E(L){a.push(L);var I=L.length;for(var J=0;J<I-2;J+=2){var K=[L[J],L[J+1]];var g=[L[J+2],L[J+3]];w.push({pts:[K,g],total:L.length,d:J/L.length})}l()}function c(L){var g=true,I=0;for(var K=1;K<A.length;K++){if(f[L][K]!="done"){g=false}else{I++}}var J=(I/(A.length-1)*100).toFixed(0)+"%";$("#radial-heading").html("Generating radial... "+J);if(g){$("#radial-heading").html("Your radial is done!");q.added()}}function d(){var M=G.map.zoom(),O=A[0];startCoords=O[1]+","+O[0];t=M;f[M]=["done"];var L="http://open.mapquestapi.com/directions/v1/route?routeType=pedestrian&outFormat=json&shapeFormat=raw&generalize=200&from=";var N=L+"{start}&to={end}";for(var K=1;K<A.length;K++){var I=A[K],g=I[1]+","+I[0],J=N.replace("{start}",startCoords).replace("{end}",g);f[M][K]=$.jsonp({url:J,callbackParameter:"callback",success:function(P){return function(R){if(!R.route.shape){f[M][P]="done";return}else{if(f[M]==undefined||f[M][P]==undefined||f[M]=="inactive"){return}}var Q=R.route.shape.shapePoints;E(Q);f[M][P]="done";c(M)}}(K)})}}function k(){F.data(A).each(function(g){g.edit=false});H();n();l()}function H(){F.attr("class","").select(".title-text").text(function(g){if(g&&g.title){return g.title}else{return b}});F.select(".title-text").on("click",function(g){if(g.edit){return}q.editText($(this).parent(),0,"title");g.edit=!g.edit});F.select(".title-edit").on("click",function(I){var g=$(this).parent();if(!I.edit){q.editText(g,0,"title")}else{I.title=b=q.saveText(g,0,"title")}I.edit=!I.edit})}function s(){i.selectAll("path").remove();w=[];A=[A[0]];B=[B[0]];m=[m[0]];var I,J;for(var L=0;L<24;L++){var K=L*(Math.PI/12);var g=G.p2l({x:300+Math.sin(K)*200,y:300+Math.cos(K)*200});J=g.lon;I=g.lat;B.push(I);m.push(J);A.push([J,I])}}q.add=function(N,J,L,g){var K=parseFloat(N);var M=parseFloat(J);D.select("#radialClip circle").data([[M,K]]);D.select(".circleFrame").data([[M,K]]).attr("r",0).attr("stroke-width",0).transition().delay(250).duration(500).attr("r",204).attr("stroke-width",17);B=[K];m=[M];A=[[M,K]];if(L==undefined){b=N.toFixed(3)+", "+J.toFixed(3)}else{b=L[0].toUpperCase()+L.substr(1,L.length-1)}$("#places").removeClass("inactive");var I=G.getMapRadius();G.map.center({lat:K,lon:M});G.boundsUpdated();q.recalculate();return q};q.remove=function(g){A.splice(g,1);B.splice(g,1);m.splice(g,1);if(A.length==0){$("#finish-button").removeClass("active")}};q.lats=function(){return B};q.lons=function(){return m};q.places=function(){return[b]};q.points=function(g){if(!arguments.length){return A}A=g;return q};q.bakeStyles=function(){var J=$(".circleFrame").css("stroke"),I=$(".circleFrame").css("fill"),g=$(".radial path").css("stroke");$(".circleFrame").attr("stroke",J);$(".circleFrame").attr("fill",I);$(".radial path").attr("stroke",g)};q.unBakeStyles=function(){$(".circleFrame").attr("stroke","").attr("fill","");$(".radial path").css("stroke","")};q.locations=function(g){A=[];B=[];m=[];$.each(g,function(I,J){A.push([J.longitude,J.latitude]);B.push(J.latitude);m.push(J.longitude)});q.dirty=true;q.locationsSet();return q};q.prerender=function(I){$("#"+x+"prerendered").html(I);var J=$("#"+x+"prerendered").find(".delaunay");$("#"+x+"prerendered").remove();$("#"+x).find(".delaunay").replaceWith(J);var K=$(p).width(),g=$(p).height();if(K>g){$("#"+x+" .delaunay").attr("transform","translate("+(K-g)/2+",0)")}};q.recalculate=function(){$("#"+x+"prerendered").remove();$.each(f,function(g,I){$.each(I,function(J,K){if(K==undefined||K=="done"){return}if(K.abort){K.abort()}});f[g]="inactive"});s();d();q.style({zoom:G.map.zoom()});q.dirty=false};q.refresh=function(g){if(g=="zoomed"&&B.length>0&&m.length>0){q.add(B[0],m[0],b)}else{k();q.refreshed()}};q.updateTitle=function(g){b=g};q.outputTitle=function(){return b||"My Meshu"};q.output=function(){return $("#"+x).html()};q.id=function(){return x};return q};