var sb=sb||{};sb.mesh=function(b,z,a,d){var m=d3.dispatch("added","refreshed","locationsSet"),t=parseInt(Math.random()*10000000000,10);var c=[],u=[],w=[];var j=document.createElement("div");var h=d3.select(b||"body").append("div").attr("id",t).style("width",a).style("height",d).style("position","absolute").style("z-index","100").append("svg:svg").attr("class","meshu-svg").attr("width","100%").attr("height","100%");var M=h.append("svg:g").attr("class","delaunay").attr("transform","translate(0,0) scale(1) rotate(0,300,300)").attr("fill","none").attr("stroke-width","5").attr("stroke","black").attr("stroke-linejoin","round");var r=h.append("svg:g").attr("class","hidden").style("display","none");r.append("svg:path");var q=d3.select(b||"body").append("div").attr("style","position:absolute;z-index:1337;").style("width",a).style("height",d);var f=q.append("svg:svg").attr("width","100%").attr("height","100%");var I=f.append("svg:g").attr("id","delaunay-ui");var l=d3.select("#places");var C=l.select("#place-number").attr("class","inactive");C.append("span").attr("class","title-text");C.append("span").attr("class","title-edit").html("edit");var v=l.append("ul");if(!$("body").hasClass("firefox")){$(".place-text input").live("blur",i)}var J=[],n=[],y=[],K=0,A=null,e=false,k=null,H=null,O=null,F=null,E=null;var o=$("#content"),p=$("#cases");d3.select(".frame").on("mousemove",x).on("mousedown",s);d3.select("body").on("mouseup",G);function s(){if(!o.hasClass("edit")){return}H=true}function x(){if(!o.hasClass("edit")){return}if(!k&&!H){return}var g=d3.svg.mouse(h.node());if(k){var Q=z.p2l({x:g[0],y:g[1]});k[0]=Q.lon;k[1]=Q.lat;var R=J.indexOf(k);c[R]=Q.lat;u[R]=Q.lon;D()}if(e&&H){O=true;if(F){z.map.panBy({x:g[0]-F[0],y:g[1]-F[1]})}D()}e=true;F=g}function G(){H=null;F=null;if(!o.hasClass("edit")){return}if(d3.event.target.tagName!="circle"&&d3.event.target!=f.node()&&d3.event.target.tagName!="image"){return}if(!k&&!O){var g=d3.svg.mouse(h.node());var R=z.p2l({x:g[0],y:g[1]});m.add(R.lat,R.lon,undefined,false);O=null;return}if(!e&&k){var Q=J.indexOf(k);m.remove(Q);z.updateBounds(c,u);m.updatePixelBounds();D()}else{x()}if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}e=false;k=null;O=null}m.updatePixelBounds=function(){if(c.length&&u.length){y=[z.l2p({lat:d3.min(c),lon:d3.min(u)}),z.l2p({lat:d3.max(c),lon:d3.min(u)}),z.l2p({lat:d3.max(c),lon:d3.max(u)}),z.l2p({lat:d3.min(c),lon:d3.max(u)})]}else{y=[]}};function B(Q){var U=I.selectAll("circle");U.attr("cx",function(V){return z.l2p({lat:V[1],lon:V[0]}).x}).attr("cy",function(V){return z.l2p({lat:V[1],lon:V[0]}).y});var g=M.selectAll("path").data(d3.geom.delaunay(J));g.enter().append("svg:path");g.exit().remove();g.attr("d",function(aa){var W=aa.length;var V=[];for(var X=0;X<W;X++){var Z={lat:parseFloat(aa[X][1]),lon:parseFloat(aa[X][0])};var Y=z.l2p(Z);V.push([Y.x,Y.y])}return"M"+V.join("L")+"Z"});if(n&&Q==true){clearInterval(K);n=null}else{if(n){var T=J[J.length-1]||[];if(Math.abs(T[0]-n[0])>0.0002){T[0]+=(n[0]-T[0])/3}if(Math.abs(T[1]-n[1])>0.0002){T[1]+=(n[1]-T[1])/3}J[J.length-1]=T;var S=Math.abs(T[0]-n[0]);var R=Math.abs(T[1]-n[1]);if(R<0.0002&&S<0.0002){clearInterval(K);n=null}}else{clearInterval(K)}}}function D(){var U=I.selectAll("circle").data(J);U.enter().append("svg:circle").attr("id",function(W,V){return"c-"+V}).attr("r",7).on("mousedown",function(V){A=k=V;d3.event.stopPropagation()});U.exit().remove();var S=v.selectAll("li.place").data(J);var Q=S.enter().append("li").attr("class","place");var T=Q.append("span").attr("class","title");T.append("span").attr("class","place-text").html(function(W,V){j.innerHTML=w[V];return j.firstChild.nodeValue});T.append("span").attr("class","place-edit").html("edit");Q.append("span").attr("class","place-delete").html("x");S.exit().remove();S.attr("id",function(W,V){return"p-"+V}).select(".title").each(function(V){V.edit=false}).attr("class","title").select(".place-text").html(function(W,V){j.innerHTML=w[V];return j.firstChild.nodeValue});C.data(J).each(function(V){V.edit=false});var g=r.selectAll("circle.rotation").data(y);g.enter().append("svg:circle").attr("class","rotation").attr("r","40").attr("cx",function(W,V){return W.x}).attr("cy",function(W,V){return W.y});g.exit().remove();g.attr("cx",function(W,V){return W.x}).attr("cy",function(W,V){return W.y});var R=r.select("path");R.attr("d",function(){if(y.length==0){return}var V=[];$.each(y,function(W,X){V.push([X.x,X.y])});return"M"+V.join("L")+"Z"}).attr("class","hiddenFrame");m.updateCircleBehavior();L();B()}m.updateCircleBehavior=function(S){var Q=o.hasClass("edit");var g=$("#place-hover");var R=I.selectAll("circle");R.on("mouseover",function(Z,V){if(S){return}else{if(Q){v.select("#p-"+V).attr("class","place highlight")}else{g.addClass("active").find("span").text(w[V]);var Y=z.l2p({lat:Z[1],lon:Z[0]});var T=g.width();var X=(Y.y-32)+"px";var W=(Y.x-(T/2)-3)+"px";var U=T/2-3+"px";g.css({top:X,left:W}).find("b").css("left",U)}}});R.on("mouseout",function(U,T){if(S){return}else{if(Q){v.select("#p-"+T).attr("class","place")}else{g.removeClass("active")}}})};function L(){var g=v.selectAll("li.place");g.select(".place-delete").on("click",function(R,Q){m.remove(Q);m.updatePixelBounds();z.updateBounds(c,u);D()});g.on("mouseover",function(R,Q){I.select("#c-"+Q).attr("class","highlight")});g.on("mouseout",function(R,Q){I.select("#c-"+Q).attr("class","")});g.select(".place-edit").on("click",function(S,Q){var R=$(this).parent();if(!S.edit){P(R,Q,"place")}else{N(R,Q,"place")}S.edit=!S.edit});g.select(".place-text").on("click",function(R,Q){if(R.edit){return}P($(this).parent(),Q,"place");R.edit=!R.edit});C.attr("class","").select(".title-text").text(function(Q){if(Q&&Q.title){return Q.title}else{return"My Meshu"}});C.select(".title-text").on("click",function(Q){if(Q.edit){return}P($(this).parent(),0,"title");Q.edit=!Q.edit});C.select(".title-edit").on("click",function(R){var Q=$(this).parent();if(!R.edit){P(Q,0,"title")}else{R.title=E=N(Q,0,"title")}R.edit=!R.edit})}function P(S,Q,R){var g=S.find("."+R+"-edit").text("save");var U=S.find("."+R+"-text");var T=((R=="title")?U.text():w[Q]);S.addClass("active");U.html('<input value="'+T+'">').find("input").focus()}function N(S,Q,R){var g=S.find("."+R+"-edit").text("edit");var T=S.find("input").val();S.removeClass("active");S.find("."+R+"-text").text(T);if(R=="place"){w[Q]=T}else{return T}}function i(g){var Q=v.selectAll("li.place .title");Q.each(function(S,R){if(!S.edit){return}S.edit=false;N($(this),R,"place")});return false}m.add=function(V,R,T,g){if(K){clearInterval(K)}var S=parseFloat(V);var U=parseFloat(R);c.push(S);u.push(U);if(T==undefined){w.push(V.toFixed(3)+", "+R.toFixed(3))}else{w.push(T)}if(J.length){$("#meshu-container").removeClass("inactive");n=[U,S];if(g){J.push([n[0],n[1]]);m.updatePixelBounds();D();B(g)}else{var Q=J[J.length-1];J.push([Q[0],Q[1]]);m.updatePixelBounds();D();K=setInterval(B,40)}}else{J.push([U,S]);D()}p.fadeOut();m.added();return m};m.remove=function(g){J.splice(g,1);c.splice(g,1);u.splice(g,1);w.splice(g,1);if(J.length<3){$("#finish-button").removeClass("active")}if(J.length==1){$("#meshu-container").addClass("inactive")}};m.lats=function(){return c};m.lons=function(){return u};m.places=function(){return w};m.points=function(g){if(!arguments.length){return J}J=g;return m};m.locations=function(g){n=null;J=[];c=[];u=[];w=[];$.each(g,function(Q,R){J.push([R.longitude,R.latitude]);c.push(R.latitude);u.push(R.longitude);w.push(R.name)});m.locationsSet();return m};m.refresh=function(){D();m.refreshed()};m.updateTitle=function(g){E=g};m.outputTitle=function(){return E||"My Meshu"};m.output=function(){return $("#"+t).html()};return m};