{% extends "meshu/gallery/gallery.html" %}

{% block title %}Meshu - Use Foursquare Data{% endblock %}

{% block content %}
    <h2 class="page-header">
        Each meshu is a different city. Choose one to get started!
    </h2>
    <div id="maps">
    </div>
    <div id="finish-button" class="nav active">Or, just start making one manually</div>
{% endblock %}

{% block script %}
<script type="text/javascript" src="{{ STATIC_URL }}lib/polymaps.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}lib/d3.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}lib/d3.geom.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/map.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/mesh.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/minimeshu.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/saver.js"></script>
<script type="text/javascript">

    // load foursquare data
    $(function() {

        var hash = window.location.hash,
            token = hash.split('=').pop(),
            api = "https://api.foursquare.com/v2/users/self/checkins?oauth_token={token}&v={v}&limit=250",
            url = api.replace('{token}', token).replace('{v}', '20120102');

        // no token
        if (!token || !token.length) {
            return;
        }

        $("#finish-button").click(function() {
            window.location = "/make/#skipintro";
        });

        $.ajax({
            url: url,
            dataType: 'json',
            success: function(data) {
                var checkins = data.response.checkins.items;
                var locations = [];

                var cities = {
                    all: {
                        name: 'All Cities',
                        locations: []
                    }
                };

                var citiesArray = [];

                // go through all checkins
                $.each(checkins, function(i, e) {
                    if (!e.venue.location.city) return;

                    var location = {
                        latitude: e.venue.location.lat,
                        longitude: e.venue.location.lng,
                        name: e.venue.name
                    };

                    var city = e.venue.location.city;

                    // make new city object
                    if (!cities[city]) {
                        cities[city] = {
                            name: city,
                            locations: [],
                            seen: {}
                        };    

                        cities['all'].locations.push({
                            name: city,
                            latitude: location.latitude,
                            longitude: location.longitude
                        });

                        citiesArray.push(cities[city]);
                    }

                    // add location if we haven't seen it before
                    if (!cities[city].seen[location.name]) {
                        cities[city].locations.push(location);
                        cities[city].seen[location.name] = true;    
                    }
                });
    
                // sort by number of locations
                citiesArray.sort(function(a, b) {
                    return b.locations.length - a.locations.length;
                });


                citiesArray.unshift(cities.all);

                var delay = 0;

                $.each(citiesArray, function(i, e) {
                    if (e.locations.length < 3) {
                        // console.log("ignoring", e.name, "too few checkins!");
                        return;
                    }

                    delay += e.locations.length > 10 ? 500 : 3000;

                    setTimeout(function() {
                        return function() {
                            var frame = $("<div>").addClass("mini-meshu");
                            var title = $("<div>").addClass("title").html("Loading " + e.name);
                            
                            frame.append(title);
                            $("#maps").append(frame);

                            var meshu = sb.minimeshu(frame[0]);
                            meshu.locations(e.locations);     
                        };
                    }(), delay);
                    
                });
            }
        });
    });
</script>
{% endblock %}