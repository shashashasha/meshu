{% extends "meshu/base.html" %}

{% block title %}Current Orders{% endblock %}

{% block content %}
    <h2 class="page-header">{{ orders|length }} orders that haven't been shipped yet. Get to it!</h2>
    <div class="inner-content">
    <ul class="gallery">
        {% for order in orders reversed %}
            <li class="status-list">
                <div class="{{ order.status }} status-block">
                    {{ order.status }}
                </div>
                <div id="order-id-{{ order.id }}" class="postcard-toggle postcard-{{ order.postcard_ordered }} status-block">
                </div>
                <div class="status-meshu">
                    {% autoescape off %}
                        {{ order.meshu.svg }}
                    {% endautoescape %}
                </div>
                <div class="status-information">
                    <b><a href="{{ order.meshu.get_absolute_url }}" target="{{ order.meshu.id }}">{{ order.meshu.title }} by {{ order.shipping_name }}, {{ order.contact }}</a></b>
                    <br />
                    <span class="link"><a href="/admin/meshu/meshu/{{ order.meshu.id }}/">meshu #{{ order.meshu.id }}</a> | <a href="/admin/meshu/order/{{ order.id }}/">order #{{ order.id}}</a></span> | <span class="link"><a href="/orders/postcard/{{ order.meshu.id }}/">postcard link</a></span>
                    <br />
                    <span class="product">{{ order.get_display_name }}</span>
                    <form action="/orders/{{ order.id }}/update/">
                        <select name="status">
                            <option value="OR">Ordered</option>
                            <option value="PR">Processed</option>
                            <option value="SE">Sent to Fabricator</option>
                            <option value="RE">Received from Fabricator</option>
                            <option value="PA">Packaged</option>
                            <option value="SH">Shipped</option>
                        </select>
                        <label for="tracking">tracking number</label>
                        <input type="text" value="" name="tracking">
                        <input type="submit" value="Notify!">
                    </form>
                </div>
            </li>
        {% endfor %}
    </ul>

    <br />
    <h2>{{ orders_shipped|length }} orders have been shipped! Yay!</h2>
    <br /><br />
    <ul class="gallery">
        {% for order in orders_shipped reversed %}
            <li>
                <b><a href="{{ order.meshu.get_absolute_url }}" target="_new">{{ order.meshu.title }} by {{ order.contact }}</a></b>
                <span class="date">Ordered on {{ order.date_created }}</span>
                <span class="date">Shipped on {{ order.ship_date }}</span>
                <br /><br />
            </li>
        {% endfor %}
    </ul>
    <br /><br /><br />
    </div>
{% endblock %}


{% block script %}
    <script type="text/javascript" src="{{ STATIC_URL }}lib/d3.v2.min.js"></script>
    <script type="text/javascript">

        d3.selectAll("#master-svg").attr("class","meshu-svg")
        d3.selectAll(".delaunay").each(function(){
            var node = d3.select(this);
            var t = node.attr("transform").split('rotate(').pop() || "";
            
            if (t.length) {
                t = 'rotate(' + t;
            }

            node.attr("transform","scale(.15) translate(-80, -80)" + t); // + t);
        });

        $(".postcard-toggle").click(function(e) {
            var clicked = e.target,
                id = clicked.id.split('-').pop();
            $.get('/orders/' + id + '/toggle_postcard/', {}, function(data) {
                if (data.postcard_ordered == 'true') {
                    $(clicked).removeClass('postcard-false');
                    $(clicked).addClass('postcard-true');
                } else {
                    $(clicked).removeClass('postcard-true');
                    $(clicked).addClass('postcard-false');
                }
            }, 'json');
        });

    </script>
{% endblock %}